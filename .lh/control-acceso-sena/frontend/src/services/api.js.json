{
    "sourceFile": "control-acceso-sena/frontend/src/services/api.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1764311031085,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764319581846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -392,8 +392,11 @@\n   \n   getAccessByProgram: (codigo, filters = {}) =>\n     api.get(`/catalog/programs/${codigo}/access`, { params: filters }).then(res => res.data),\n   \n+  getAccessByFicha: (codigoFicha, filters = {}) =>\n+    api.get(`/catalog/fichas/${codigoFicha}/access`, { params: filters }).then(res => res.data),\n+  \n   getAmbientOccupation: (codigo) =>\n     api.get(`/catalog/ambientes/${codigo}/occupation`).then(res => res.data),\n };\n \n"
                }
            ],
            "date": 1764311031085,
            "name": "Commit-0",
            "content": "// API Service\n\n// services/api.js\nimport axios from 'axios';\n\nconst API_URL = import.meta.env.VITE_API_URL || 'http://localhost:4000/api';\n\nconst api = axios.create({\n  baseURL: API_URL,\n});\n\n// Interceptor para agregar token a las requests\napi.interceptors.request.use((config) => {\n  const token = localStorage.getItem('token');\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`;\n  }\n  return config;\n});\n\n// Interceptor para manejar errores de autenticaciÃ³n\napi.interceptors.response.use(\n  (response) => response,\n  (error) => {\n    if (error.response?.status === 401) {\n      // Solo redirigir si no estamos ya en la pÃ¡gina de login\n      // y si el error es realmente de autenticaciÃ³n (no de verificaciÃ³n de token durante carga inicial)\n      const currentPath = window.location.pathname;\n      if (currentPath !== '/login' && !currentPath.startsWith('/login')) {\n        localStorage.removeItem('token');\n        localStorage.removeItem('userRole');\n        // Usar replace para evitar agregar al historial\n        window.location.replace('/login');\n      }\n    }\n    return Promise.reject(error);\n  }\n);\n\nexport const authAPI = {\n  login: (email, password) => \n    api.post('/auth/login', { email, password }).then(res => res.data),\n  \n  verifyToken: () => \n    api.get('/auth/verify').then(res => res.data),\n};\n\nexport const accessAPI = {\n  scanQR: (qrData) => \n    api.post('/access/scan', { qrData }).then(res => res.data),\n  \n  scanComplete: (qrData) =>\n    api.post('/access/scan-complete', { qrData }).then(res => res.data),\n  \n  getCurrentPeople: () => \n    api.get('/access/current').then(res => res.data),\n  \n  getDailyStats: (date) =>\n    api.get('/access/stats/daily', { params: { date } }).then(res => res.data),\n};\n\nexport const analyticsAPI = {\n  getCurrentOccupancy: () =>\n    api.get('/analytics/current-occupancy').then(res => res.data),\n  \n  getStatsByFicha: (ficha) =>\n    api.get(`/analytics/by-ficha/${ficha}`).then(res => res.data),\n  \n  getStatsByPrograma: (programa) =>\n    api.get(`/analytics/by-programa/${programa}`).then(res => res.data),\n  \n  getAttendanceHistory: (documento, limit = 30) =>\n    api.get(`/analytics/attendance-history/${documento}`, { params: { limit } }).then(res => res.data),\n  \n  getDailyStats: (date) =>\n    api.get('/analytics/daily-stats', { params: { date } }).then(res => res.data),\n};\n\nexport const visitorAPI = {\n  create: (visitorData) => \n    api.post('/visitors', visitorData).then(res => res.data),\n  \n  generateQR: (visitorId) => \n    api.post(`/visitors/${visitorId}/qr`).then(res => res.data),\n  \n  getAll: () =>\n    api.get('/visitors').then(res => res.data),\n};\n\nexport const userAPI = {\n  getAll: () =>\n    api.get('/users').then(res => res.data),\n  \n  create: (userData) =>\n    api.post('/users', userData).then(res => res.data),\n  \n  update: (id, userData) =>\n    api.put(`/users/${id}`, userData).then(res => res.data),\n  \n  delete: (id) =>\n    api.delete(`/users/${id}`).then(res => res.data),\n};\n\nexport const dashboardAPI = {\n  getMetrics: () =>\n    api.get('/dashboard/metrics')\n      .then(res => {\n        console.log('ðŸ“Š [API] Respuesta de mÃ©tricas:', res.data);\n        return res.data;\n      })\n      .catch(err => {\n        console.error('âŒ [API] Error en getMetrics:', err);\n        throw err;\n      }),\n  \n  getRecentAccess: (limit = 20) =>\n    api.get('/dashboard/recent-access', { params: { limit } })\n      .then(res => {\n        console.log('ðŸ” [API] Respuesta de accesos recientes:', {\n          success: res.data.success,\n          total: res.data.data?.length || 0,\n          metadata: res.data.metadata,\n          request_id: res.data.metadata?.request_id\n        });\n        return res.data;\n      })\n      .catch(err => {\n        console.error('âŒ [API] Error en getRecentAccess:', {\n          message: err.message,\n          response: err.response?.data,\n          status: err.response?.status\n        });\n        throw err;\n      }),\n  \n  getAlerts: () =>\n    api.get('/dashboard/alerts')\n      .then(res => {\n        console.log('ðŸš¨ [API] Respuesta de alertas:', res.data);\n        return res.data;\n      })\n      .catch(err => {\n        console.error('âŒ [API] Error en getAlerts:', err);\n        throw err;\n      }),\n  resolveAlert: (alertId) =>\n    api.post(`/dashboard/alerts/${alertId}/resolve`)\n      .then(res => res.data)\n      .catch(err => {\n        console.error('âŒ [API] Error en resolveAlert:', err);\n        throw err;\n      }),\n  \n  getAccessStats: () =>\n    api.get('/dashboard/access-stats')\n      .then(res => {\n        console.log('ðŸ“ˆ [API] EstadÃ­sticas de diagnÃ³stico:', res.data);\n        return res.data;\n      })\n      .catch(err => {\n        console.error('âŒ [API] Error en getAccessStats:', err);\n        throw err;\n      }),\n  \n  diagnoseTables: () =>\n    api.get('/dashboard/diagnose-tables')\n      .then(res => {\n        console.log('ðŸ” [API] DiagnÃ³stico de tablas:', res.data);\n        return res.data;\n      })\n      .catch(err => {\n        console.error('âŒ [API] Error en diagnoseTables:', err);\n        throw err;\n      }),\n};\n\nexport const reportAPI = {\n  getDaily: (fecha) =>\n    api.get('/reports/daily', { params: { fecha } }).then(res => res.data),\n  \n  getWeekly: (semana) =>\n    api.get('/reports/weekly', { params: { semana } }).then(res => res.data),\n  \n  getVisitors: (desde, hasta) =>\n    api.get('/reports/visitors', { params: { desde, hasta } }).then(res => res.data),\n  \n  getByRole: (rol, desde, hasta) =>\n    api.get('/reports/role', { params: { rol, desde, hasta } }).then(res => res.data),\n  \n  exportCSV: (tipo, params) =>\n    api.post('/reports/export-csv', { tipo, ...params }, { \n      responseType: 'blob' \n    }).then(res => {\n      const blob = new Blob([res.data], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      const url = URL.createObjectURL(blob);\n      link.setAttribute('href', url);\n      link.setAttribute('download', `reporte_${tipo}_${new Date().toISOString().split('T')[0]}.csv`);\n      link.style.visibility = 'hidden';\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      return { success: true };\n    }),\n};\n\nexport const configAPI = {\n  getAll: () =>\n    api.get('/config').then(res => res.data),\n  \n  update: (clave, valor) =>\n    api.put('/config', { clave, valor }).then(res => res.data),\n  \n  updateMultiple: (configs) =>\n    api.put('/config/multiple', { configs }).then(res => res.data),\n  \n  create: (clave, valor, tipo, descripcion) =>\n    api.post('/config', { clave, valor, tipo, descripcion }).then(res => res.data),\n};\n\nexport const securityAPI = {\n  // Alertas\n  getAlerts: (filters = {}) =>\n    api.get('/security/alerts', { params: filters }).then(res => res.data),\n  \n  markAlertAsRead: (alertId) =>\n    api.post(`/security/alerts/${alertId}/read`).then(res => res.data),\n  \n  deleteAlert: (alertId) =>\n    api.delete(`/security/alerts/${alertId}`).then(res => res.data),\n  \n  deleteOldReadAlerts: (days = 30) =>\n    api.delete('/security/alerts/old/read', { params: { days } }).then(res => res.data),\n  \n  getAlertStats: () =>\n    api.get('/security/alerts/stats').then(res => res.data),\n  \n  checkAlertsNow: () =>\n    api.post('/security/alerts/check-now').then(res => res.data),\n  \n  // Seguridad\n  getSystemHealth: () =>\n    api.get('/security/system-health').then(res => res.data),\n  \n  detectFraud: () =>\n    api.get('/security/fraud-detection').then(res => res.data),\n  \n  getSuspiciousAttempts: (limit = 20) =>\n    api.get('/security/suspicious-attempts', { params: { limit } }).then(res => res.data),\n  \n  getSecurityMetrics: () =>\n    api.get('/security/security-metrics').then(res => res.data),\n  \n  // AuditorÃ­a\n  getAuditLogs: (filters = {}) =>\n    api.get('/security/audit-logs', { params: filters }).then(res => res.data),\n  \n  getSecurityLogs: (filters = {}) =>\n    api.get('/security/security-logs', { params: filters }).then(res => res.data),\n  \n  getAccessHistory: (filters = {}) =>\n    api.get('/security/access-history', { params: filters }).then(res => res.data),\n};\n\nexport const importAPI = {\n  uploadFile: (file) => {\n    const formData = new FormData();\n    formData.append('file', file);\n    return api.post('/import/upload', formData, {\n      headers: { 'Content-Type': 'multipart/form-data' }\n    }).then(res => res.data);\n  },\n  \n  validateData: (dataOrFileId, fieldMapping) => {\n    const body = typeof dataOrFileId === 'string' && dataOrFileId.startsWith('file_')\n      ? { fileId: dataOrFileId, fieldMapping }\n      : { data: dataOrFileId, fieldMapping };\n    return api.post('/import/validate', body).then(res => res.data);\n  },\n  \n  executeImport: (dataOrFileId, fieldMapping) => {\n    const body = typeof dataOrFileId === 'string' && dataOrFileId.startsWith('file_')\n      ? { fileId: dataOrFileId, fieldMapping }\n      : { data: dataOrFileId, fieldMapping };\n    return api.post('/import/execute', body).then(res => res.data);\n  },\n  \n  getProgress: (jobId) =>\n    api.get(`/import/progress/${jobId}`).then(res => res.data),\n  \n  getResults: (jobId) =>\n    api.get(`/import/results/${jobId}`).then(res => res.data),\n};\n\nexport const reportsAPI = {\n  // HU9 - Personas actualmente dentro\n  getCurrentPeople: (filters = {}) =>\n    api.get('/reports/current-people', { params: filters }).then(res => res.data),\n  \n  // HU7 - Flujos predictivos\n  getPredictiveFlows: (filters = {}) =>\n    api.get('/reports/predictive-flows', { params: filters }).then(res => res.data),\n  \n  // Historial de accesos\n  getAccessHistory: (filters = {}, pagination = {}) =>\n    api.get('/reports/access-history', { \n      params: { ...filters, ...pagination } \n    }).then(res => res.data),\n};\n\nexport const searchAPI = {\n  // HU26 - BÃºsqueda avanzada de usuarios\n  searchUsers: (filters = {}, pagination = {}) =>\n    api.get('/search/users', { \n      params: { ...filters, ...pagination } \n    }).then(res => res.data),\n  \n  // HU12 - BÃºsqueda de accesos\n  searchAccess: (filters = {}, pagination = {}) =>\n    api.get('/search/access', { \n      params: { ...filters, ...pagination } \n    }).then(res => res.data),\n  \n  // HU33 - BÃºsqueda de visitantes\n  searchVisitors: (filters = {}, pagination = {}) =>\n    api.get('/search/visitors', { \n      params: { ...filters, ...pagination } \n    }).then(res => res.data),\n};\n\nexport const exportAPI = {\n  // HU8 - Exportar a PDF\n  exportToPDF: (reportType, filters = {}, data = null) =>\n    api.post('/export/pdf', { reportType, filters, data }).then(res => res.data),\n  \n  // HU8 - Exportar a Excel\n  exportToExcel: (reportType, filters = {}) =>\n    api.post('/export/excel', { reportType, filters }, { \n      responseType: 'blob' \n    }).then(res => {\n      const blob = new Blob([res.data], { \n        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' \n      });\n      const link = document.createElement('a');\n      const url = URL.createObjectURL(blob);\n      link.setAttribute('href', url);\n      const timestamp = new Date().toISOString().split('T')[0];\n      link.setAttribute('download', `reporte_${reportType}_${timestamp}.xlsx`);\n      link.style.visibility = 'hidden';\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      return { success: true };\n    }),\n};\n\nexport const catalogAPI = {\n  // Programas de formaciÃ³n\n  getAllPrograms: (filters = {}) =>\n    api.get('/catalog/programs', { params: filters }).then(res => res.data),\n  createProgram: (programData) =>\n    api.post('/catalog/programs', programData).then(res => res.data),\n  createFicha: (fichaData) =>\n    api.post('/catalog/fichas', fichaData).then(res => res.data),\n  \n  getProgramByCode: (codigo) =>\n    api.get(`/catalog/programs/${codigo}`).then(res => res.data),\n  \n  // Fichas\n  getAllFichas: (filters = {}) =>\n    api.get('/catalog/fichas', { params: filters }).then(res => res.data),\n  \n  getFichaByCode: (codigo) =>\n    api.get(`/catalog/fichas/${codigo}`).then(res => res.data),\n  \n  getStudentsByFicha: (codigo, filters = {}) =>\n    api.get(`/catalog/fichas/${codigo}/students`, { params: filters }).then(res => res.data),\n  \n  // Ambientes\n  getAllAmbientes: (filters = {}) =>\n    api.get('/catalog/ambientes', { params: filters }).then(res => res.data),\n  \n  getAmbienteByCode: (codigo) =>\n    api.get(`/catalog/ambientes/${codigo}`).then(res => res.data),\n  \n  getAmbientesByType: (tipo) =>\n    api.get(`/catalog/ambientes/tipo/${tipo}`).then(res => res.data),\n  \n  // Consultas enriquecidas\n  getStudentsByProgram: (codigo, filters = {}) =>\n    api.get(`/catalog/programs/${codigo}/students`, { params: filters }).then(res => res.data),\n  \n  getAccessByProgram: (codigo, filters = {}) =>\n    api.get(`/catalog/programs/${codigo}/access`, { params: filters }).then(res => res.data),\n  \n  getAmbientOccupation: (codigo) =>\n    api.get(`/catalog/ambientes/${codigo}/occupation`).then(res => res.data),\n};\n\nexport default api;"
        }
    ]
}