{
    "sourceFile": "control-acceso-sena/frontend/src/components/scanner/ScannerQRMejorado.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1764022924466,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764023135522,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,11 +53,11 @@\n   const handleScanSuccess = async (decodedText) => {\n     // Evitar procesar si ya estamos procesando\n     if (scannerState === 'processing') return;\n \n-    // Throttling: evitar escaneos muy frecuentes (m치ximo 1 por segundo)\n+    // Throttling reducido: m치ximo 1 cada 300ms para respuesta m치s r치pida\n     const now = Date.now();\n-    if (scanThrottleRef.current && (now - scanThrottleRef.current) < 1000) {\n+    if (scanThrottleRef.current && (now - scanThrottleRef.current) < 300) {\n       return; // Ignorar escaneos muy frecuentes\n     }\n     scanThrottleRef.current = now;\n \n@@ -77,26 +77,26 @@\n       if (result.success) {\n         setScanHistory(prev => [result, ...prev.slice(0, 9)]);\n       }\n \n-      // Reiniciar scanner despu칠s de procesar (reducido de 3000ms a 1500ms)\n+      // Reiniciar scanner m치s r치pido (reducido a 800ms)\n       setTimeout(() => {\n         setScanResult(null);\n         lastScannedRef.current = null; // Limpiar despu칠s del timeout\n         if (scannerState === 'scanning') {\n           setScannerState('scanning');\n         }\n-      }, 1500);\n+      }, 800);\n     } catch (error) {\n       const handledError = ScannerErrorHandler.handleQRProcessingError(error);\n       setScanResult({\n         success: false,\n         ...handledError\n       });\n-      // Limpiar el 칰ltimo escaneado en caso de error para permitir reintento\n+      // Limpiar el 칰ltimo escaneado en caso de error para permitir reintento m치s r치pido\n       setTimeout(() => {\n         lastScannedRef.current = null;\n-      }, 2000);\n+      }, 1000);\n     } finally {\n       setScannerState('scanning');\n     }\n   };\n"
                },
                {
                    "date": 1764023294187,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,11 +53,11 @@\n   const handleScanSuccess = async (decodedText) => {\n     // Evitar procesar si ya estamos procesando\n     if (scannerState === 'processing') return;\n \n-    // Throttling reducido: m치ximo 1 cada 300ms para respuesta m치s r치pida\n+    // Throttling: evitar escaneos muy frecuentes (m치ximo 1 por segundo)\n     const now = Date.now();\n-    if (scanThrottleRef.current && (now - scanThrottleRef.current) < 300) {\n+    if (scanThrottleRef.current && (now - scanThrottleRef.current) < 1000) {\n       return; // Ignorar escaneos muy frecuentes\n     }\n     scanThrottleRef.current = now;\n \n@@ -77,26 +77,26 @@\n       if (result.success) {\n         setScanHistory(prev => [result, ...prev.slice(0, 9)]);\n       }\n \n-      // Reiniciar scanner m치s r치pido (reducido a 800ms)\n+      // Reiniciar scanner despu칠s de procesar (reducido de 3000ms a 1500ms)\n       setTimeout(() => {\n         setScanResult(null);\n         lastScannedRef.current = null; // Limpiar despu칠s del timeout\n         if (scannerState === 'scanning') {\n           setScannerState('scanning');\n         }\n-      }, 800);\n+      }, 1500);\n     } catch (error) {\n       const handledError = ScannerErrorHandler.handleQRProcessingError(error);\n       setScanResult({\n         success: false,\n         ...handledError\n       });\n-      // Limpiar el 칰ltimo escaneado en caso de error para permitir reintento m치s r치pido\n+      // Limpiar el 칰ltimo escaneado en caso de error para permitir reintento\n       setTimeout(() => {\n         lastScannedRef.current = null;\n-      }, 1000);\n+      }, 2000);\n     } finally {\n       setScannerState('scanning');\n     }\n   };\n@@ -305,13 +305,13 @@\n           onClose={() => setScanResult(null)}\n         />\n       )}\n \n-      <div className=\"max-w-7xl mx-auto p-2 md:p-4\">\n+      <div className=\"max-w-6xl mx-auto p-4\">\n         <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n           {/* 츼rea principal */}\n           <div className=\"lg:col-span-2\">\n-            <div className=\"bg-white rounded-lg shadow-lg p-2 md:p-4\">\n+            <div className=\"bg-white rounded-lg shadow-lg p-3 md:p-4\">\n               {/* Errores de c치mara */}\n               {(cameraError || errorInfo) && (\n                 <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\n                   <p className=\"text-red-700 font-semibold\">Error:</p>\n"
                },
                {
                    "date": 1764100813881,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,9 @@\n import TrainingMode from './modes/TrainingMode';\n import UserCard from '../UserCard';\n import ScannerErrorHandler from '../../utils/scanner/errorHandler';\n import PermissionManager from '../../utils/scanner/permissionManager';\n+import logo from '../../photos/Huella.png';\n \n const ScannerQRMejorado = () => {\n   const { user } = useAuth();\n   const [scannerState, setScannerState] = useState('ready'); // ready, scanning, processing, error\n@@ -191,11 +192,14 @@\n     <div className=\"min-h-screen bg-gray-100\">\n       {/* Header optimizado */}\n       <div className=\"bg-blue-600 text-white p-4 shadow-lg\">\n         <div className=\"max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4\">\n-          <div>\n-            <h1 className=\"text-2xl font-bold\">Scanner QR Optimizado</h1>\n-            <p className=\"text-blue-100 text-sm\">Usuario: {user?.nombre}</p>\n+          <div className=\"flex items-center gap-3\">\n+            <img src={logo} alt=\"Logo SENA\" className=\"h-10 w-10 object-contain\" />\n+            <div>\n+              <h1 className=\"text-2xl font-bold\">Scanner QR Optimizado</h1>\n+              <p className=\"text-blue-100 text-sm\">Usuario: {user?.nombre}</p>\n+            </div>\n           </div>\n           \n           <div className=\"flex flex-wrap gap-2\">\n             {/* Bot칩n de performance */}\n@@ -305,13 +309,13 @@\n           onClose={() => setScanResult(null)}\n         />\n       )}\n \n-      <div className=\"max-w-6xl mx-auto p-4\">\n+      <div className=\"max-w-7xl mx-auto p-4\">\n         <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n           {/* 츼rea principal */}\n           <div className=\"lg:col-span-2\">\n-            <div className=\"bg-white rounded-lg shadow-lg p-3 md:p-4\">\n+            <div className=\"bg-white rounded-lg shadow-lg p-4 md:p-6\">\n               {/* Errores de c치mara */}\n               {(cameraError || errorInfo) && (\n                 <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\n                   <p className=\"text-red-700 font-semibold\">Error:</p>\n"
                },
                {
                    "date": 1764102436936,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -190,24 +190,24 @@\n \n   return (\n     <div className=\"min-h-screen bg-gray-100\">\n       {/* Header optimizado */}\n-      <div className=\"bg-blue-600 text-white p-4 shadow-lg\">\n+      <div className=\"bg-white text-blue-600 p-4 shadow-lg border-b border-gray-200\">\n         <div className=\"max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4\">\n           <div className=\"flex items-center gap-3\">\n             <img src={logo} alt=\"Logo SENA\" className=\"h-10 w-10 object-contain\" />\n             <div>\n-              <h1 className=\"text-2xl font-bold\">Scanner QR Optimizado</h1>\n-              <p className=\"text-blue-100 text-sm\">Usuario: {user?.nombre}</p>\n+              <h1 className=\"text-2xl font-bold text-blue-600\">Scanner</h1>\n+              <p className=\"text-gray-600 text-sm\">Usuario: {user?.nombre}</p>\n             </div>\n           </div>\n           \n           <div className=\"flex flex-wrap gap-2\">\n             {/* Bot칩n de performance */}\n             {performanceStats && (\n               <button\n                 onClick={() => setShowPerformance(!showPerformance)}\n-                className=\"bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm\"\n+                className=\"bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 px-4 py-2 rounded-lg font-semibold transition text-sm\"\n               >\n                 游늵 Stats\n               </button>\n             )}\n@@ -220,10 +220,10 @@\n                   setShowManualInput(false);\n                 }}\n                 className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n                   currentMode === 'normal' \n-                    ? 'bg-white text-blue-600' \n-                    : 'bg-blue-500 text-white hover:bg-blue-700'\n+                    ? 'bg-blue-600 text-white' \n+                    : 'bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200'\n                 }`}\n               >\n                 Normal\n               </button>\n@@ -233,10 +233,10 @@\n                   setShowManualInput(false);\n                 }}\n                 className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n                   currentMode === 'batch' \n-                    ? 'bg-white text-blue-600' \n-                    : 'bg-blue-500 text-white hover:bg-blue-700'\n+                    ? 'bg-blue-600 text-white' \n+                    : 'bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200'\n                 }`}\n               >\n                 Lote\n               </button>\n@@ -246,10 +246,10 @@\n                   setShowManualInput(false);\n                 }}\n                 className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n                   currentMode === 'training' \n-                    ? 'bg-white text-blue-600' \n-                    : 'bg-blue-500 text-white hover:bg-blue-700'\n+                    ? 'bg-blue-600 text-white' \n+                    : 'bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200'\n                 }`}\n               >\n                 Entrenamiento\n               </button>\n@@ -258,9 +258,9 @@\n             {/* Control de scanner */}\n             {scannerState === 'ready' || scannerState === 'error' ? (\n               <button\n                 onClick={handleStartScanner}\n-                className=\"bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition flex items-center gap-2\"\n+                className=\"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2\"\n               >\n                 <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                   <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                 </svg>\n@@ -284,9 +284,9 @@\n               onClick={() => {\n                 setShowManualInput(!showManualInput);\n                 setCurrentMode('normal');\n               }}\n-              className=\"bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition\"\n+              className=\"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition\"\n             >\n               {showManualInput ? 'Ocultar Manual' : 'Ingreso Manual'}\n             </button>\n           </div>\n"
                },
                {
                    "date": 1764102796116,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,9 +11,8 @@\n import TrainingMode from './modes/TrainingMode';\n import UserCard from '../UserCard';\n import ScannerErrorHandler from '../../utils/scanner/errorHandler';\n import PermissionManager from '../../utils/scanner/permissionManager';\n-import logo from '../../photos/Huella.png';\n \n const ScannerQRMejorado = () => {\n   const { user } = useAuth();\n   const [scannerState, setScannerState] = useState('ready'); // ready, scanning, processing, error\n@@ -192,14 +191,11 @@\n     <div className=\"min-h-screen bg-gray-100\">\n       {/* Header optimizado */}\n       <div className=\"bg-white text-blue-600 p-4 shadow-lg border-b border-gray-200\">\n         <div className=\"max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4\">\n-          <div className=\"flex items-center gap-3\">\n-            <img src={logo} alt=\"Logo SENA\" className=\"h-10 w-10 object-contain\" />\n-            <div>\n-              <h1 className=\"text-2xl font-bold text-blue-600\">Scanner</h1>\n-              <p className=\"text-gray-600 text-sm\">Usuario: {user?.nombre}</p>\n-            </div>\n+          <div>\n+            <h1 className=\"text-2xl font-bold text-blue-600\">Scanner</h1>\n+            <p className=\"text-gray-600 text-sm\">Usuario: {user?.nombre}</p>\n           </div>\n           \n           <div className=\"flex flex-wrap gap-2\">\n             {/* Bot칩n de performance */}\n"
                },
                {
                    "date": 1764109099679,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,18 +6,17 @@\n import CameraOptimized from './CameraOptimized';\n import FeedbackInmediato from './FeedbackInmediato';\n import PerformanceOverlay from './PerformanceOverlay';\n import ManualEntryMode from './modes/ManualEntryMode';\n-import BatchScanMode from './modes/BatchScanMode';\n import TrainingMode from './modes/TrainingMode';\n import UserCard from '../UserCard';\n import ScannerErrorHandler from '../../utils/scanner/errorHandler';\n import PermissionManager from '../../utils/scanner/permissionManager';\n \n const ScannerQRMejorado = () => {\n   const { user } = useAuth();\n   const [scannerState, setScannerState] = useState('ready'); // ready, scanning, processing, error\n-  const [currentMode, setCurrentMode] = useState('normal'); // normal, batch, training, manual\n+  const [currentMode, setCurrentMode] = useState('normal'); // normal, training, manual\n   const [scanResult, setScanResult] = useState(null);\n   const [showPerformance, setShowPerformance] = useState(false);\n   const [showManualInput, setShowManualInput] = useState(false);\n   const [errorInfo, setErrorInfo] = useState(null);\n@@ -37,14 +36,23 @@\n     cleanup,\n     updatePerformanceStats\n   } = useScannerOptimizado(accessAPI);\n \n-  // Verificar permisos al montar (sin inicializar c치mara todav칤a)\n+  // Activar scanner autom치ticamente al montar\n   useEffect(() => {\n-    // Solo verificar permisos, no inicializar c치mara todav칤a\n-    initializeScanner().catch(error => {\n-      console.warn('Error verificando permisos:', error);\n-    });\n+    const autoStart = async () => {\n+      const initResult = await initializeScanner();\n+      if (initResult.success) {\n+        setScannerState('scanning');\n+        setErrorInfo(null);\n+      } else {\n+        setErrorInfo(initResult.error);\n+        setScannerState('error');\n+      }\n+    };\n+    \n+    autoStart();\n+    \n     return () => {\n       cleanup();\n     };\n   }, []);\n@@ -224,21 +232,8 @@\n                 Normal\n               </button>\n               <button\n                 onClick={() => {\n-                  setCurrentMode('batch');\n-                  setShowManualInput(false);\n-                }}\n-                className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n-                  currentMode === 'batch' \n-                    ? 'bg-blue-600 text-white' \n-                    : 'bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200'\n-                }`}\n-              >\n-                Lote\n-              </button>\n-              <button\n-                onClick={() => {\n                   setCurrentMode('training');\n                   setShowManualInput(false);\n                 }}\n                 className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n@@ -331,21 +326,8 @@\n                 </div>\n               )}\n \n               {/* Modos especiales */}\n-              {currentMode === 'batch' && (\n-                <BatchScanMode\n-                  onProcess={async (qrData) => {\n-                    const result = await processQRCode(qrData);\n-                    if (result.success) {\n-                      setScanHistory(prev => [result, ...prev.slice(0, 9)]);\n-                    }\n-                  }}\n-                  onClose={() => setCurrentMode('normal')}\n-                  api={accessAPI}\n-                />\n-              )}\n-\n               {currentMode === 'training' && (\n                 <TrainingMode\n                   onClose={() => setCurrentMode('normal')}\n                 />\n"
                }
            ],
            "date": 1764022924466,
            "name": "Commit-0",
            "content": "// ScannerQRMejorado - Componente principal optimizado del scanner QR\nimport React, { useState, useEffect, useRef } from 'react';\nimport { useAuth } from '../../context/AuthContext';\nimport { accessAPI } from '../../services/api';\nimport useScannerOptimizado from '../../hooks/useScannerOptimizado';\nimport CameraOptimized from './CameraOptimized';\nimport FeedbackInmediato from './FeedbackInmediato';\nimport PerformanceOverlay from './PerformanceOverlay';\nimport ManualEntryMode from './modes/ManualEntryMode';\nimport BatchScanMode from './modes/BatchScanMode';\nimport TrainingMode from './modes/TrainingMode';\nimport UserCard from '../UserCard';\nimport ScannerErrorHandler from '../../utils/scanner/errorHandler';\nimport PermissionManager from '../../utils/scanner/permissionManager';\n\nconst ScannerQRMejorado = () => {\n  const { user } = useAuth();\n  const [scannerState, setScannerState] = useState('ready'); // ready, scanning, processing, error\n  const [currentMode, setCurrentMode] = useState('normal'); // normal, batch, training, manual\n  const [scanResult, setScanResult] = useState(null);\n  const [showPerformance, setShowPerformance] = useState(false);\n  const [showManualInput, setShowManualInput] = useState(false);\n  const [errorInfo, setErrorInfo] = useState(null);\n  const [scanHistory, setScanHistory] = useState([]);\n  const lastScannedRef = useRef(null); // Para evitar escaneos duplicados\n  const scanThrottleRef = useRef(null); // Para throttling\n\n  const {\n    isScanning,\n    lastResults,\n    cameraError,\n    permissionStatus,\n    performanceStats,\n    scannerRef,\n    initializeScanner,\n    processQRCode,\n    cleanup,\n    updatePerformanceStats\n  } = useScannerOptimizado(accessAPI);\n\n  // Verificar permisos al montar (sin inicializar c치mara todav칤a)\n  useEffect(() => {\n    // Solo verificar permisos, no inicializar c치mara todav칤a\n    initializeScanner().catch(error => {\n      console.warn('Error verificando permisos:', error);\n    });\n    return () => {\n      cleanup();\n    };\n  }, []);\n\n  // Manejar escaneo exitoso con throttling y prevenci칩n de duplicados\n  const handleScanSuccess = async (decodedText) => {\n    // Evitar procesar si ya estamos procesando\n    if (scannerState === 'processing') return;\n\n    // Throttling: evitar escaneos muy frecuentes (m치ximo 1 por segundo)\n    const now = Date.now();\n    if (scanThrottleRef.current && (now - scanThrottleRef.current) < 1000) {\n      return; // Ignorar escaneos muy frecuentes\n    }\n    scanThrottleRef.current = now;\n\n    // Evitar escaneos duplicados del mismo QR\n    if (lastScannedRef.current === decodedText) {\n      return; // Ignorar si es el mismo QR que el 칰ltimo escaneado\n    }\n\n    setScannerState('processing');\n    lastScannedRef.current = decodedText; // Guardar el 칰ltimo QR escaneado\n    \n    try {\n      const result = await processQRCode(decodedText);\n      \n      setScanResult(result);\n      \n      if (result.success) {\n        setScanHistory(prev => [result, ...prev.slice(0, 9)]);\n      }\n\n      // Reiniciar scanner despu칠s de procesar (reducido de 3000ms a 1500ms)\n      setTimeout(() => {\n        setScanResult(null);\n        lastScannedRef.current = null; // Limpiar despu칠s del timeout\n        if (scannerState === 'scanning') {\n          setScannerState('scanning');\n        }\n      }, 1500);\n    } catch (error) {\n      const handledError = ScannerErrorHandler.handleQRProcessingError(error);\n      setScanResult({\n        success: false,\n        ...handledError\n      });\n      // Limpiar el 칰ltimo escaneado en caso de error para permitir reintento\n      setTimeout(() => {\n        lastScannedRef.current = null;\n      }, 2000);\n    } finally {\n      setScannerState('scanning');\n    }\n  };\n\n  // Manejar errores de escaneo (QR no legible, etc.)\n  const handleScanFailure = (errorMessage) => {\n    // No hacer nada si ya estamos procesando\n    if (scannerState === 'processing') return;\n    \n    // Los errores de escaneo son normales (QR no detectado a칰n)\n    // Solo logueamos en modo desarrollo\n    if (process.env.NODE_ENV === 'development') {\n      console.debug('Error de escaneo (normal):', errorMessage);\n    }\n    \n    // No actualizamos el estado para no interrumpir el flujo de escaneo\n    // El scanner seguir치 intentando escanear autom치ticamente\n  };\n\n  // Manejar errores de c치mara\n  const handleCameraError = (error) => {\n    console.error('Error de c치mara recibido:', error);\n    setErrorInfo({\n      type: error.type,\n      message: error.message,\n      recoverable: error.type !== 'browser_not_supported'\n    });\n    setScannerState('error');\n  };\n\n  // Iniciar scanner\n  const handleStartScanner = async () => {\n    const initResult = await initializeScanner();\n    \n    if (initResult.success) {\n      setScannerState('scanning');\n      setErrorInfo(null);\n    } else {\n      setErrorInfo(initResult.error);\n      setScannerState('error');\n    }\n  };\n\n  // Detener scanner\n  const handleStopScanner = () => {\n    cleanup();\n    setScannerState('ready');\n    setScanResult(null);\n  };\n\n  // Manejar entrada manual\n  const handleManualProcess = async (qrData) => {\n    setScannerState('processing');\n    try {\n      const result = await processQRCode(qrData);\n      setScanResult(result);\n      \n      if (result.success) {\n        setScanHistory(prev => [result, ...prev.slice(0, 9)]);\n        setShowManualInput(false);\n      }\n    } catch (error) {\n      setScanResult({\n        success: false,\n        message: error.message || 'Error al procesar documento'\n      });\n    } finally {\n      setScannerState('ready');\n    }\n  };\n\n  // Formatear timestamp\n  const formatTimestamp = (timestamp) => {\n    if (!timestamp) return 'Ahora';\n    try {\n      if (timestamp instanceof Date) {\n        return timestamp.toLocaleTimeString();\n      }\n      if (typeof timestamp === 'string') {\n        const date = new Date(timestamp);\n        if (!isNaN(date.getTime())) {\n          return date.toLocaleTimeString();\n        }\n      }\n      return 'Ahora';\n    } catch (error) {\n      return 'Ahora';\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-100\">\n      {/* Header optimizado */}\n      <div className=\"bg-blue-600 text-white p-4 shadow-lg\">\n        <div className=\"max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-2xl font-bold\">Scanner QR Optimizado</h1>\n            <p className=\"text-blue-100 text-sm\">Usuario: {user?.nombre}</p>\n          </div>\n          \n          <div className=\"flex flex-wrap gap-2\">\n            {/* Bot칩n de performance */}\n            {performanceStats && (\n              <button\n                onClick={() => setShowPerformance(!showPerformance)}\n                className=\"bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm\"\n              >\n                游늵 Stats\n              </button>\n            )}\n\n            {/* Modos */}\n            <div className=\"flex gap-2\">\n              <button\n                onClick={() => {\n                  setCurrentMode('normal');\n                  setShowManualInput(false);\n                }}\n                className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n                  currentMode === 'normal' \n                    ? 'bg-white text-blue-600' \n                    : 'bg-blue-500 text-white hover:bg-blue-700'\n                }`}\n              >\n                Normal\n              </button>\n              <button\n                onClick={() => {\n                  setCurrentMode('batch');\n                  setShowManualInput(false);\n                }}\n                className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n                  currentMode === 'batch' \n                    ? 'bg-white text-blue-600' \n                    : 'bg-blue-500 text-white hover:bg-blue-700'\n                }`}\n              >\n                Lote\n              </button>\n              <button\n                onClick={() => {\n                  setCurrentMode('training');\n                  setShowManualInput(false);\n                }}\n                className={`px-4 py-2 rounded-lg font-semibold transition text-sm ${\n                  currentMode === 'training' \n                    ? 'bg-white text-blue-600' \n                    : 'bg-blue-500 text-white hover:bg-blue-700'\n                }`}\n              >\n                Entrenamiento\n              </button>\n            </div>\n\n            {/* Control de scanner */}\n            {scannerState === 'ready' || scannerState === 'error' ? (\n              <button\n                onClick={handleStartScanner}\n                className=\"bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition flex items-center gap-2\"\n              >\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                </svg>\n                Activar Scanner\n              </button>\n            ) : (\n              <button\n                onClick={handleStopScanner}\n                className=\"bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2\"\n              >\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z\" />\n                </svg>\n                Detener\n              </button>\n            )}\n\n            {/* Bot칩n manual */}\n            <button\n              onClick={() => {\n                setShowManualInput(!showManualInput);\n                setCurrentMode('normal');\n              }}\n              className=\"bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition\"\n            >\n              {showManualInput ? 'Ocultar Manual' : 'Ingreso Manual'}\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Performance Overlay */}\n      {performanceStats && (\n        <PerformanceOverlay\n          stats={performanceStats}\n          isVisible={showPerformance}\n          onToggle={() => setShowPerformance(!showPerformance)}\n        />\n      )}\n\n      {/* Feedback Inmediato */}\n      {scanResult && (\n        <FeedbackInmediato\n          result={scanResult}\n          onClose={() => setScanResult(null)}\n        />\n      )}\n\n      <div className=\"max-w-7xl mx-auto p-2 md:p-4\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n          {/* 츼rea principal */}\n          <div className=\"lg:col-span-2\">\n            <div className=\"bg-white rounded-lg shadow-lg p-2 md:p-4\">\n              {/* Errores de c치mara */}\n              {(cameraError || errorInfo) && (\n                <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\n                  <p className=\"text-red-700 font-semibold\">Error:</p>\n                  <p className=\"text-red-600 text-sm mt-1\">\n                    {(cameraError || errorInfo)?.message || (cameraError || errorInfo)?.userMessage}\n                  </p>\n                  {permissionStatus === 'denied' && (\n                    <div className=\"mt-3\">\n                      <p className=\"text-red-600 text-xs font-semibold mb-2\">Pasos para resolver:</p>\n                      <ul className=\"text-red-600 text-xs list-disc list-inside space-y-1\">\n                        {PermissionManager.getPermissionHelpSteps().slice(0, 3).map((step, index) => (\n                          <li key={index}>{step}</li>\n                        ))}\n                      </ul>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Modos especiales */}\n              {currentMode === 'batch' && (\n                <BatchScanMode\n                  onProcess={async (qrData) => {\n                    const result = await processQRCode(qrData);\n                    if (result.success) {\n                      setScanHistory(prev => [result, ...prev.slice(0, 9)]);\n                    }\n                  }}\n                  onClose={() => setCurrentMode('normal')}\n                  api={accessAPI}\n                />\n              )}\n\n              {currentMode === 'training' && (\n                <TrainingMode\n                  onClose={() => setCurrentMode('normal')}\n                />\n              )}\n\n              {/* Modo normal */}\n              {currentMode === 'normal' && (\n                <>\n                  {/* Entrada manual */}\n                  {showManualInput && (\n                    <div className=\"mb-4\">\n                      <ManualEntryMode\n                        onProcess={handleManualProcess}\n                        onClose={() => setShowManualInput(false)}\n                        loading={scannerState === 'processing'}\n                      />\n                    </div>\n                  )}\n\n                  {/* C치mara */}\n                  <CameraOptimized\n                    scannerId=\"qr-reader-optimized\"\n                    onScanSuccess={handleScanSuccess}\n                    onScanFailure={handleScanFailure}\n                    onCameraError={handleCameraError}\n                    isActive={scannerState === 'scanning'}\n                  />\n\n                  {/* Estado de procesamiento */}\n                  {scannerState === 'processing' && (\n                    <div className=\"text-center py-4\">\n                      <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n                      <p className=\"mt-2 text-gray-600\">Procesando c칩digo QR...</p>\n                    </div>\n                  )}\n\n                  {/* Resultado del escaneo (sin feedback overlay) */}\n                  {scanResult && !showManualInput && (\n                    <div className={`mt-4 p-4 rounded-lg border-2 ${\n                      scanResult.success \n                        ? (scanResult.action === 'salida' \n                            ? 'bg-blue-50 border-blue-400' \n                            : 'bg-green-50 border-green-400')\n                        : 'bg-red-50 border-red-400'\n                    }`}>\n                      <div className=\"flex items-start gap-3\">\n                        <div className={`flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${\n                          scanResult.success \n                            ? (scanResult.action === 'salida' ? 'bg-blue-500' : 'bg-green-500')\n                            : 'bg-red-500'\n                        }`}>\n                          {scanResult.success ? (\n                            scanResult.action === 'salida' ? (\n                              <svg className=\"w-6 h-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\" />\n                              </svg>\n                            ) : (\n                              <svg className=\"w-6 h-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                              </svg>\n                            )\n                          ) : (\n                            <svg className=\"w-6 h-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                            </svg>\n                          )}\n                        </div>\n                        <div className=\"flex-1\">\n                          <p className={`font-semibold text-lg ${\n                            scanResult.success \n                              ? (scanResult.action === 'salida' ? 'text-blue-800' : 'text-green-800')\n                              : 'text-red-800'\n                          }`}>\n                            {scanResult.message}\n                          </p>\n                          {scanResult.person && (\n                            <UserCard person={scanResult.person} action={scanResult.action} />\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n\n          {/* Historial */}\n          <div className=\"lg:col-span-1\">\n            <div className=\"bg-white rounded-lg shadow-lg p-4 md:p-6\">\n              <h2 className=\"text-xl font-bold mb-4 text-gray-800\">Historial Reciente</h2>\n              {scanHistory.length === 0 ? (\n                <p className=\"text-gray-500 text-center py-8\">No hay escaneos recientes</p>\n              ) : (\n                <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n                  {scanHistory.map((scan, index) => (\n                    <div\n                      key={index}\n                      className={`p-3 rounded-lg border ${\n                        scan.success \n                          ? (scan.action === 'salida' \n                              ? 'bg-blue-50 border-blue-200' \n                              : 'bg-green-50 border-green-200')\n                          : 'bg-red-50 border-red-200'\n                      }`}\n                    >\n                      <div className=\"flex items-center justify-between mb-1\">\n                        <span className={`text-xs font-semibold ${\n                          scan.success \n                            ? (scan.action === 'salida' ? 'text-blue-700' : 'text-green-700')\n                            : 'text-red-700'\n                        }`}>\n                          {scan.action === 'entrada' ? 'ENTRADA' : 'SALIDA'}\n                        </span>\n                        <span className=\"text-xs text-gray-500\">\n                          {formatTimestamp(scan.timestamp)}\n                        </span>\n                      </div>\n                      {scan.person && (\n                        <p className=\"text-sm font-medium text-gray-800\">{scan.person.nombre}</p>\n                      )}\n                      <p className=\"text-xs text-gray-600\">{scan.message}</p>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default ScannerQRMejorado;\n\n"
        }
    ]
}