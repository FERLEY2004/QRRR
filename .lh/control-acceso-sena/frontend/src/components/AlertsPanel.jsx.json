{
    "sourceFile": "control-acceso-sena/frontend/src/components/AlertsPanel.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764961262079,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764961262079,
            "name": "Commit-0",
            "content": "// AlertsPanel Component - Panel de alertas\nimport React, { useState, useMemo } from 'react';\nimport { dashboardAPI } from '../services/api';\n\nconst AlertsPanel = ({ alerts = [], loading = false, onAlertUpdate }) => {\n  const [filterSeverity, setFilterSeverity] = useState('all');\n  const [filterType, setFilterType] = useState('all');\n  const [filterStatus, setFilterStatus] = useState('all'); // 'all', 'pending', 'read' - Cambiado a 'all' por defecto\n  const [resolvingAlerts, setResolvingAlerts] = useState(new Set());\n  const [resolvedAlerts, setResolvedAlerts] = useState(new Set());\n  const [detecting, setDetecting] = useState(false);\n  \n  // Estado para modal de confirmaci√≥n de eliminaci√≥n\n  const [alertToDelete, setAlertToDelete] = useState(null);\n\n  const handleRunDetection = async () => {\n    if (detecting) return;\n    setDetecting(true);\n    try {\n      await dashboardAPI.runAlertDetection();\n      onAlertUpdate?.();\n    } catch (error) {\n      console.error('Error ejecutando detecci√≥n:', error);\n    } finally {\n      setDetecting(false);\n    }\n  };\n\n  const visibleAlerts = useMemo(() => {\n    console.log('üîî [AlertsPanel] Alertas recibidas:', alerts.length, alerts);\n    return alerts.filter(alert => {\n      const alertId = alert.id || alert.id_alerta || `${alert.type || 'alert'}-${alert.createdAt || alert.fecha_creacion}`;\n      return !resolvedAlerts.has(alertId);\n    });\n  }, [alerts, resolvedAlerts]);\n\n  const filteredAlerts = visibleAlerts.filter(alert => {\n    const severity = (alert.severity || alert.severidad || 'media').toLowerCase();\n    const type = alert.type || alert.tipo || 'general';\n    const isRead = alert.leida === true || alert.leida === 1;\n    \n    const matchSeverity = filterSeverity === 'all' || severity === filterSeverity;\n    const matchType = filterType === 'all' || type === filterType;\n    const matchStatus = filterStatus === 'all' || \n                       (filterStatus === 'pending' && !isRead) || \n                       (filterStatus === 'read' && isRead);\n    \n    return matchSeverity && matchType && matchStatus;\n  });\n\n  const getSeverityColor = (severity) => {\n    switch (severity) {\n      case 'alta':\n        return 'bg-red-100 text-red-800 border-red-300';\n      case 'media':\n        return 'bg-yellow-100 text-yellow-800 border-yellow-300';\n      case 'baja':\n        return 'bg-blue-100 text-blue-800 border-blue-300';\n      default:\n        return 'bg-gray-100 text-gray-800 border-gray-300';\n    }\n  };\n\n  const getSeverityIcon = (severity) => {\n    switch (severity) {\n      case 'alta':\n        return 'üî¥';\n      case 'media':\n        return 'üü°';\n      case 'baja':\n        return 'üîµ';\n      default:\n        return '‚ö™';\n    }\n  };\n\n  const getAlertTypeIcon = (type) => {\n    switch (type) {\n      case 'intento_fraudulento':\n      case 'qr_invalido':\n        return 'üö´';\n      case 'documento_no_registrado':\n      case 'acceso_denegado':\n        return '‚õî';\n      case 'comportamiento_sospechoso':\n      case 'acceso_frecuente':\n        return '‚ö†Ô∏è';\n      case 'acceso_fuera_horario':\n        return 'üïê';\n      case 'qr_expirado':\n        return '‚è∞';\n      case 'seguridad':\n        return 'üîí';\n      case 'sistema':\n        return '‚öôÔ∏è';\n      default:\n        return 'üîî';\n    }\n  };\n\n  const getAlertTypeName = (type) => {\n    switch (type) {\n      case 'intento_fraudulento':\n      case 'qr_invalido':\n        return 'QR Inv√°lido';\n      case 'documento_no_registrado':\n      case 'acceso_denegado':\n        return 'Acceso Denegado';\n      case 'comportamiento_sospechoso':\n      case 'acceso_frecuente':\n        return 'Comportamiento Sospechoso';\n      case 'acceso_fuera_horario':\n        return 'Fuera de Horario';\n      case 'qr_expirado':\n        return 'QR por Expirar';\n      case 'seguridad':\n        return 'Seguridad';\n      case 'sistema':\n        return 'Sistema';\n      default:\n        return 'Alerta';\n    }\n  };\n\n  const formatDateTime = (timestamp) => {\n    if (!timestamp) return 'N/A';\n    try {\n      const date = new Date(timestamp);\n      return date.toLocaleString('es-CO', { \n        day: '2-digit',\n        month: '2-digit',\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n    } catch {\n      return 'N/A';\n    }\n  };\n\n  const getSeverity = (alert) => (alert.severity || alert.severidad || 'media').toLowerCase();\n\n  const getAlertId = (alert) => alert.id || alert.id_alerta || `${alert.type || 'alert'}-${alert.createdAt || alert.fecha_creacion}`;\n\n  const handleMarkAsRead = async (alert) => {\n    const alertId = getAlertId(alert);\n    if (resolvingAlerts.has(alertId)) return;\n\n    setResolvingAlerts(prev => new Set(prev).add(alertId));\n\n    try {\n      await dashboardAPI.markAlertAsRead(alertId);\n      setResolvedAlerts(prev => new Set(prev).add(alertId));\n      onAlertUpdate?.();\n    } catch (error) {\n      console.error('Error al marcar alerta como le√≠da:', error);\n    } finally {\n      setResolvingAlerts(prev => {\n        const next = new Set(prev);\n        next.delete(alertId);\n        return next;\n      });\n    }\n  };\n\n  // Mostrar modal de confirmaci√≥n\n  const handleDeleteAlert = (alert) => {\n    const alertId = getAlertId(alert);\n    if (resolvingAlerts.has(alertId)) return;\n    setAlertToDelete(alert);\n  };\n\n  // Confirmar eliminaci√≥n\n  const confirmDeleteAlert = async () => {\n    if (!alertToDelete) return;\n    \n    const alertId = getAlertId(alertToDelete);\n    setResolvingAlerts(prev => new Set(prev).add(alertId));\n    setAlertToDelete(null);\n\n    try {\n      await dashboardAPI.deleteAlert(alertId);\n      setResolvedAlerts(prev => new Set(prev).add(alertId));\n      onAlertUpdate?.();\n    } catch (error) {\n      console.error('Error al eliminar alerta:', error);\n    } finally {\n      setResolvingAlerts(prev => {\n        const next = new Set(prev);\n        next.delete(alertId);\n        return next;\n      });\n    }\n  };\n\n  // Cancelar eliminaci√≥n\n  const cancelDeleteAlert = () => {\n    setAlertToDelete(null);\n  };\n\n  // Alias para compatibilidad\n  const handleResolveAlert = handleMarkAsRead;\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-lg p-4 overflow-hidden\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <h2 className=\"text-lg font-bold text-gray-800\">üîî Alertas</h2>\n          {alerts.length > 0 && (\n            <span className=\"bg-red-100 text-red-800 text-xs font-semibold px-2 py-0.5 rounded-full\">\n              {alerts.length}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={handleRunDetection}\n          disabled={detecting}\n          className=\"px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition disabled:opacity-50 whitespace-nowrap\"\n          title=\"Ejecutar detecci√≥n de alertas\"\n        >\n          {detecting ? '‚è≥' : 'üîç'} Detectar\n        </button>\n      </div>\n      \n      {/* Filtros en columna */}\n      <div className=\"grid grid-cols-1 gap-2 mb-3\">\n        <select\n          value={filterStatus}\n          onChange={(e) => setFilterStatus(e.target.value)}\n          className=\"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none\"\n        >\n          <option value=\"all\">Todas</option>\n          <option value=\"pending\">Pendientes</option>\n          <option value=\"read\">Le√≠das</option>\n        </select>\n        <select\n          value={filterType}\n          onChange={(e) => setFilterType(e.target.value)}\n          className=\"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none\"\n        >\n          <option value=\"all\">Todos los tipos</option>\n          <option value=\"intento_fraudulento\">QR Inv√°lido</option>\n          <option value=\"documento_no_registrado\">Acceso Denegado</option>\n          <option value=\"comportamiento_sospechoso\">Sospechoso</option>\n          <option value=\"acceso_fuera_horario\">Fuera de Horario</option>\n          <option value=\"qr_expirado\">QR Expirado</option>\n        </select>\n        <select\n          value={filterSeverity}\n          onChange={(e) => setFilterSeverity(e.target.value)}\n          className=\"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none\"\n        >\n          <option value=\"all\">Todas</option>\n          <option value=\"critica\">Cr√≠tica</option>\n          <option value=\"alta\">Alta</option>\n          <option value=\"media\">Media</option>\n          <option value=\"baja\">Baja</option>\n        </select>\n      </div>\n\n      {loading ? (\n        <div className=\"text-center py-8\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n          <p className=\"mt-2 text-gray-600\">Cargando...</p>\n        </div>\n      ) : filteredAlerts.length === 0 ? (\n        <div className=\"text-center py-6 text-gray-500\">\n          <svg className=\"w-10 h-10 mx-auto mb-2 text-gray-300\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n          </svg>\n          <p className=\"text-sm\">{filterSeverity !== 'all' || filterType !== 'all' || filterStatus !== 'all' ? 'Sin alertas con los filtros aplicados' : 'Sin alertas pendientes'}</p>\n        </div>\n      ) : (\n        <div className=\"space-y-2 max-h-80 overflow-y-auto\">\n          {filteredAlerts.map((alert, index) => {\n            const severity = getSeverity(alert);\n            const alertId = getAlertId(alert);\n            const createdAt = alert.createdAt || alert.fecha_creacion;\n            const alertType = alert.type || alert.tipo || 'general';\n            const isRead = alert.leida === true || alert.leida === 1;\n            const uniqueKey = `alert-${alert.id_alerta || alertId}-${index}-${createdAt}`;\n            return (\n              <div\n                key={uniqueKey}\n                className={`p-3 rounded-lg border transition-all ${getSeverityColor(severity)} ${isRead ? 'opacity-50 grayscale-[30%]' : 'shadow-sm'}`}\n              >\n                {/* Header de la alerta */}\n                <div className=\"flex items-start justify-between gap-2 mb-1\">\n                  <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n                    <span className={`text-lg flex-shrink-0 ${isRead ? 'grayscale' : ''}`}>{getAlertTypeIcon(alertType)}</span>\n                    <div className=\"min-w-0 flex-1\">\n                      <h3 className=\"font-semibold text-sm truncate\">{alert.title || alert.titulo}</h3>\n                      <div className=\"flex items-center gap-1 flex-wrap\">\n                        <span className=\"text-[10px] px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded\">\n                          {getAlertTypeName(alertType)}\n                        </span>\n                        <span className={`text-[10px] px-1.5 py-0.5 rounded ${getSeverityColor(severity)}`}>\n                          {severity.toUpperCase()}\n                        </span>\n                        {isRead && (\n                          <span className=\"text-[10px] px-1.5 py-0.5 bg-gray-300 text-gray-600 rounded flex items-center gap-0.5\">\n                            ‚úì Le√≠da\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                  {/* Botones de acci√≥n */}\n                  <div className=\"flex items-center gap-1 flex-shrink-0\">\n                    {!isRead && (\n                      <button\n                        onClick={() => handleMarkAsRead(alert)}\n                        disabled={resolvingAlerts.has(alertId)}\n                        className=\"w-6 h-6 flex items-center justify-center bg-green-500 hover:bg-green-600 text-white rounded text-xs transition disabled:opacity-50\"\n                        title=\"Marcar como le√≠da\"\n                      >\n                        {resolvingAlerts.has(alertId) ? '¬∑' : '‚úì'}\n                      </button>\n                    )}\n                    <button\n                      onClick={() => handleDeleteAlert(alert)}\n                      disabled={resolvingAlerts.has(alertId)}\n                      className=\"w-6 h-6 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded text-xs transition disabled:opacity-50\"\n                      title=\"Eliminar alerta\"\n                    >\n                      {resolvingAlerts.has(alertId) ? '¬∑' : '‚úï'}\n                    </button>\n                  </div>\n                </div>\n                {/* Mensaje */}\n                <p className=\"text-xs text-gray-700 mb-1 line-clamp-2\">{alert.message || alert.mensaje}</p>\n                {/* Footer */}\n                <div className=\"flex items-center justify-between text-[10px] text-gray-500\">\n                  <span>{formatDateTime(createdAt)}</span>\n                  {alert.metadata?.documento && (\n                    <span>Doc: {alert.metadata.documento}</span>\n                  )}\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      )}\n      \n      {filteredAlerts.length > 0 && (\n        <div className=\"mt-2 text-xs text-gray-400 text-center\">\n          {filteredAlerts.length} de {alerts.length} alertas\n        </div>\n      )}\n\n      {/* Modal de confirmaci√≥n de eliminaci√≥n */}\n      {alertToDelete && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4 animate-fade-in\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <div className=\"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center\">\n                <svg className=\"w-6 h-6 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                </svg>\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-gray-900\">Eliminar alerta</h3>\n                <p className=\"text-sm text-gray-500\">Esta acci√≥n no se puede deshacer</p>\n              </div>\n            </div>\n            \n            <p className=\"text-gray-600 mb-4 text-sm\">\n              ¬øEst√°s seguro de que deseas eliminar esta alerta?\n            </p>\n            \n            <div className=\"bg-gray-50 rounded-lg p-3 mb-4\">\n              <p className=\"text-xs text-gray-500 font-medium\">Alerta a eliminar:</p>\n              <p className=\"text-sm text-gray-800 font-semibold\">{alertToDelete.title || alertToDelete.titulo}</p>\n            </div>\n            \n            <div className=\"flex gap-3\">\n              <button\n                onClick={cancelDeleteAlert}\n                className=\"flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition\"\n              >\n                Cancelar\n              </button>\n              <button\n                onClick={confirmDeleteAlert}\n                className=\"flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition\"\n              >\n                Eliminar\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default AlertsPanel;\n\n\n\n\n\n\n\n\n\n\n"
        }
    ]
}