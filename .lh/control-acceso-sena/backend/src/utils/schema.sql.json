{
    "sourceFile": "control-acceso-sena/backend/src/utils/schema.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 25,
            "patches": [
                {
                    "date": 1763535516496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763535597021,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -477,7 +477,67 @@\n -- =====================================================\n -- VERIFICAR que las tablas Fichas y Asignaciones_Ambientes existan\n -- (Ya fueron creadas en integrationSchema.sql)\n -- =====================================================\n+-- =====================================================\n+-- TABLA: Fichas\n+-- Sistema de Control de Acceso SENA\n+-- =====================================================\n \n+USE control_acceso_sena;\n \n+-- Crear tabla Fichas si no existe\n+CREATE TABLE IF NOT EXISTS Fichas (\n+    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n+    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n+    id_programa INT NULL COMMENT 'Referencia al programa de formación',\n+    id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha',\n+    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n+    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n+    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n+    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n+    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n+    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n+    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    \n+    -- Foreign Keys\n+    FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL,\n+    FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n+    \n+    -- Índices\n+    INDEX idx_ficha_codigo (codigo_ficha),\n+    INDEX idx_ficha_programa (id_programa),\n+    INDEX idx_ficha_estado (estado),\n+    INDEX idx_ficha_jornada (jornada),\n+    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+    INDEX idx_ficha_ambiente (id_ambiente_principal)\n+    \n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Tabla para gestionar las fichas de formación del SENA';\n \n+-- Agregar foreign key desde Personas a Fichas si no existe\n+-- Nota: MySQL no soporta IF NOT EXISTS en ALTER TABLE ADD FOREIGN KEY\n+-- Se debe ejecutar manualmente si la tabla ya tiene datos y la foreign key no existe\n+-- ALTER TABLE Personas \n+-- ADD CONSTRAINT fk_personas_ficha \n+-- FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n+\n+-- Verificar que la columna id_ficha existe en Personas\n+-- Si no existe, se creará automáticamente al ejecutar el schema completo\n+-- ALTER TABLE Personas \n+-- ADD COLUMN IF NOT EXISTS id_ficha INT NULL AFTER ficha;\n+\n+-- Crear índice en Personas para id_ficha si no existe\n+CREATE INDEX IF NOT EXISTS idx_personas_ficha_id ON Personas(id_ficha);\n+\n+-- Datos de ejemplo (opcional)\n+-- INSERT INTO Fichas (codigo_ficha, programa_formacion, jornada, fecha_inicio, fecha_fin, estado) VALUES\n+-- ('3066232', 'Técnico en Programación de Software', 'diurna', '2024-01-15', '2025-01-15', 'activa'),\n+-- ('3066233', 'Tecnólogo en Análisis y Desarrollo de Software', 'nocturna', '2024-02-01', '2026-02-01', 'activa')\n+-- ON DUPLICATE KEY UPDATE codigo_ficha=codigo_ficha;\n+\n+\n+\n+\n"
                },
                {
                    "date": 1763601290131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -540,4 +540,115 @@\n \n \n \n \n+-- =====================================================\n+-- INSERCIÓN DE PROGRAMAS DE FORMACIÓN - CBI PALMIRA\n+-- Sistema de Control de Acceso SENA\n+-- =====================================================\n+\n+USE control_acceso_sena;\n+\n+-- =====================================================\n+-- PROGRAMAS TÉCNICOS\n+-- =====================================================\n+\n+INSERT INTO Programas_Formacion \n+(codigo_programa, nombre_programa, nivel, duracion_meses, area_conocimiento, estado)\n+VALUES\n+-- Programas Administrativos y Comerciales\n+('TEC-AA-001', 'Asistencia Administrativa', 'Técnico', 12, 'Gestión Administrativa', 'activo'),\n+('TEC-AOA-001', 'Asistencia en Organización de Archivos', 'Técnico', 12, 'Gestión Documental', 'activo'),\n+('TEC-COCF-001', 'Contabilización de Operaciones Comerciales y Financieras', 'Técnico', 12, 'Contabilidad y Finanzas', 'activo'),\n+('TEC-NPS-001', 'Nómina y Prestaciones Sociales', 'Técnico', 12, 'Recursos Humanos', 'activo'),\n+('TEC-OCR-001', 'Operaciones Comerciales en Retail', 'Técnico', 12, 'Comercio y Ventas', 'activo'),\n+('TEC-PEL-001', 'Peluquería', 'Técnico', 12, 'Belleza y Estética', 'activo'),\n+('TEC-RH-001', 'Recursos Humanos', 'Técnico', 12, 'Recursos Humanos', 'activo'),\n+('TEC-SCF-001', 'Servicios Comerciales y Financieros', 'Técnico', 12, 'Servicios Financieros', 'activo'),\n+\n+-- Programas Tecnológicos y Científicos\n+('TEC-AMQ-001', 'Análisis de Muestras Químicas', 'Técnico', 12, 'Química y Laboratorio', 'activo'),\n+('TEC-DIM-001', 'Diseño e Integración de Multimedia', 'Técnico', 12, 'Tecnología Multimedia', 'activo'),\n+('TEC-ICD-001', 'Integración de Contenidos Digitales', 'Técnico', 12, 'Contenidos Digitales', 'activo'),\n+('TEC-IOL-001', 'Integración de Operaciones Logísticas', 'Técnico', 12, 'Logística', 'activo'),\n+('TEC-MAM-001', 'Monitoreo Ambiental', 'Técnico', 12, 'Medio Ambiente', 'activo'),\n+('TEC-PBFI-001', 'Producción de Biocombustibles y Fermentaciones Industriales', 'Técnico', 12, 'Biotecnología', 'activo'),\n+('TEC-PS-001', 'Programación de Software', 'Técnico', 12, 'Desarrollo de Software', 'activo'),\n+('TEC-PAG-001', 'Proyectos Agropecuarios', 'Técnico', 12, 'Agropecuaria', 'activo'),\n+('TEC-SIS-001', 'Sistemas', 'Técnico', 12, 'Sistemas Informáticos', 'activo'),\n+\n+-- Programas de Construcción y Mecánica\n+('TEC-CED-001', 'Construcción de Edificaciones', 'Técnico', 12, 'Construcción', 'activo'),\n+('TEC-CLIS-001', 'Construcciones Livianas Industrializadas en Seco', 'Técnico', 12, 'Construcción', 'activo'),\n+('TEC-DMEC-001', 'Dibujo Mecánico', 'Técnico', 12, 'Diseño Mecánico', 'activo'),\n+('TEC-EI-001', 'Electricista Industrial', 'Técnico', 12, 'Electricidad Industrial', 'activo'),\n+('TEC-ISERC-001', 'Instalación de Sistemas Eléctricos Residenciales y Comerciales', 'Técnico', 12, 'Instalaciones Eléctricas', 'activo'),\n+('TEC-MMD-001', 'Mantenimiento de Motores Diésel', 'Técnico', 12, 'Mantenimiento Mecánico', 'activo'),\n+('TEC-MVL-001', 'Mantenimiento de Vehículos Livianos', 'Técnico', 12, 'Mantenimiento Automotriz', 'activo'),\n+('TEC-MECEA-001', 'Mantenimiento Eléctrico y Control Electrónico de Automotores', 'Técnico', 12, 'Mecánica Automotriz', 'activo'),\n+('TEC-MMI-001', 'Mecánica de Maquinaria Industrial', 'Técnico', 12, 'Mecánica Industrial', 'activo'),\n+('TEC-SPMP-001', 'Soldadura de Productos Metálicos en Plaina (placa metálica)', 'Técnico', 12, 'Soldadura', 'activo')\n+\n+ON DUPLICATE KEY UPDATE\n+nombre_programa = VALUES(nombre_programa),\n+nivel = VALUES(nivel),\n+duracion_meses = VALUES(duracion_meses),\n+area_conocimiento = VALUES(area_conocimiento),\n+fecha_actualizacion = NOW();\n+\n+-- =====================================================\n+-- PROGRAMAS TECNOLÓGICOS\n+-- =====================================================\n+\n+INSERT INTO Programas_Formacion \n+(codigo_programa, nombre_programa, nivel, duracion_meses, area_conocimiento, estado)\n+VALUES\n+-- Programas de Gestión y Administración\n+('TECN-GBEF-001', 'Gestión Bancaria y de Entidades Financieras', 'Tecnológico', 24, 'Gestión Financiera', 'activo'),\n+('TECN-GADM-001', 'Gestión Administrativa', 'Tecnológico', 24, 'Gestión Administrativa', 'activo'),\n+('TECN-GEMP-001', 'Gestión Empresarial', 'Tecnológico', 24, 'Gestión Empresarial', 'activo'),\n+('TECN-GTH-001', 'Gestión del Talento Humano', 'Tecnológico', 24, 'Recursos Humanos', 'activo'),\n+('TECN-DV-001', 'Dirección de Ventas', 'Tecnológico', 24, 'Ventas y Marketing', 'activo'),\n+('TECN-GPDES-001', 'Gestión de Proyectos de Desarrollo Económico y Social', 'Tecnológico', 24, 'Gestión de Proyectos', 'activo'),\n+('TECN-GDOC-001', 'Gestión Documental', 'Tecnológico', 24, 'Gestión Documental', 'activo'),\n+('TECN-GCIF-001', 'Gestión Contable y de Información Financiera', 'Tecnológico', 24, 'Contabilidad', 'activo'),\n+('TECN-GTRF-001', 'Gestión de Tesorería y Recursos Financieros', 'Tecnológico', 24, 'Finanzas', 'activo'),\n+('TECN-GICMSSO-001', 'Gestión Integrada de la Calidad, Medio Ambiente, Seguridad y Salud Ocupacional', 'Tecnológico', 24, 'Gestión Integral', 'activo'),\n+('TECN-GPI-001', 'Gestión de la Producción Industrial', 'Tecnológico', 24, 'Producción Industrial', 'activo'),\n+('TECN-GMA-001', 'Gestión del Mantenimiento de Automotores', 'Tecnológico', 24, 'Gestión Automotriz', 'activo'),\n+\n+-- Programas Deportivos y de Actividad Física\n+('TECN-ED-001', 'Entrenamiento Deportivo', 'Tecnológico', 24, 'Deporte', 'activo'),\n+('TECN-AF-001', 'Actividad Física', 'Tecnológico', 24, 'Actividad Física', 'activo'),\n+\n+-- Programas de Biotecnología y Medio Ambiente\n+('TECN-BCS-001', 'Biocomercio Sostenible', 'Tecnológico', 24, 'Biotecnología', 'activo'),\n+('TECN-CBI-001', 'Control de Bioprocesos Industriales', 'Tecnológico', 24, 'Biotecnología', 'activo'),\n+('TECN-PCA-001', 'Prevención y Control Ambiental', 'Tecnológico', 24, 'Medio Ambiente', 'activo'),\n+\n+-- Programas de Tecnología y Desarrollo\n+('TECN-ADS-001', 'Análisis y Desarrollo de Software', 'Tecnológico', 24, 'Desarrollo de Software', 'activo'),\n+('TECN-MEII-001', 'Mantenimiento Electrónico e Instrumental Industrial', 'Tecnológico', 24, 'Electrónica Industrial', 'activo'),\n+('TECN-DMPI-001', 'Desarrollo y Modelado de Productos Industriales', 'Tecnológico', 24, 'Diseño Industrial', 'activo'),\n+\n+-- Programas de Mantenimiento Industrial\n+('TECN-MMI-001', 'Mantenimiento Mecánico Industrial', 'Tecnológico', 24, 'Mantenimiento Industrial', 'activo'),\n+('TECN-MEI-001', 'Mantenimiento Electromecánico Industrial', 'Tecnológico', 24, 'Electromecánica', 'activo'),\n+\n+-- Programas de Logística\n+('TECN-CPL-001', 'Coordinación de Procesos Logísticos', 'Tecnológico', 24, 'Logística', 'activo')\n+\n+ON DUPLICATE KEY UPDATE\n+nombre_programa = VALUES(nombre_programa),\n+nivel = VALUES(nivel),\n+duracion_meses = VALUES(duracion_meses),\n+area_conocimiento = VALUES(area_conocimiento),\n+fecha_actualizacion = NOW();\n+\n+-- =====================================================\n+-- RESUMEN DE INSERCIÓN\n+-- =====================================================\n+-- Total de programas técnicos: 28\n+-- Total de programas tecnológicos: 22\n+-- Total general: 50 programas\n+-- =====================================================\n+\n"
                },
                {
                    "date": 1763665319813,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -651,4 +651,349 @@\n -- Total de programas tecnológicos: 22\n -- Total general: 50 programas\n -- =====================================================\n \n+-- =====================================================\n+-- MODIFICACIÓN A CIRCUITO ABIERTO\n+-- Sistema de Control de Acceso SENA\n+-- =====================================================\n+\n+USE control_acceso_sena;\n+\n+-- =====================================================\n+-- PASO 1: ELIMINAR DEPENDENCIAS Y TABLA ACCESOS ORIGINAL\n+-- =====================================================\n+-- Primero eliminar foreign keys que referencian a Accesos\n+-- Nota: Ejecutar manualmente si es necesario:\n+-- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n+\n+-- Ahora eliminar la tabla Accesos\n+DROP TABLE IF EXISTS Accesos;\n+\n+-- =====================================================\n+-- PASO 2: CREAR NUEVA TABLA DE REGISTRO DE ACCESOS\n+-- Cada registro es INDEPENDIENTE (entrada o salida)\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Registros_Acceso (\n+    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    id_usuario_registro INT,\n+    tipo_movimiento ENUM('entrada', 'salida') NOT NULL,\n+    fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+    id_ambiente INT NULL COMMENT 'Ambiente donde ocurrió el registro',\n+    metodo_registro ENUM('qr', 'manual', 'biometrico', 'tarjeta') DEFAULT 'qr',\n+    ip_address VARCHAR(45),\n+    geolocalizacion VARCHAR(100),\n+    observaciones TEXT,\n+    metadata JSON COMMENT 'Información adicional del registro',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    \n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n+    \n+    INDEX idx_registro_persona (id_persona),\n+    INDEX idx_registro_tipo (tipo_movimiento),\n+    INDEX idx_registro_fecha (fecha_hora),\n+    INDEX idx_registro_ambiente (id_ambiente),\n+    INDEX idx_registro_usuario (id_usuario_registro),\n+    INDEX idx_registro_metodo (metodo_registro),\n+    INDEX idx_persona_fecha (id_persona, fecha_hora)\n+    \n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n+\n+-- =====================================================\n+-- PASO 3: TABLA DE SESIONES (OPCIONAL - Para análisis)\n+-- Esta tabla es solo para CONSULTAS y REPORTES\n+-- NO es obligatoria para el funcionamiento del sistema\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Sesiones_Acceso (\n+    id_sesion INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    id_registro_entrada INT NOT NULL,\n+    id_registro_salida INT NULL,\n+    fecha_entrada TIMESTAMP NOT NULL,\n+    fecha_salida TIMESTAMP NULL,\n+    duracion_minutos INT NULL,\n+    estado ENUM('abierta', 'cerrada', 'anomala') DEFAULT 'abierta',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    \n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_registro_entrada) REFERENCES Registros_Acceso(id_registro) ON DELETE CASCADE,\n+    FOREIGN KEY (id_registro_salida) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n+    \n+    INDEX idx_sesion_persona (id_persona),\n+    INDEX idx_sesion_entrada (id_registro_entrada),\n+    INDEX idx_sesion_salida (id_registro_salida),\n+    INDEX idx_sesion_estado (estado),\n+    INDEX idx_sesion_fechas (fecha_entrada, fecha_salida)\n+    \n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Vista consolidada de sesiones - Generada automáticamente';\n+\n+-- =====================================================\n+-- PASO 4: ACTUALIZAR TABLA DE ALERTAS\n+-- Referenciar a Registros_Acceso en lugar de Accesos\n+-- =====================================================\n+-- IMPORTANTE: Si la tabla Alertas ya existe, ejecutar manualmente antes:\n+-- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n+\n+-- Cambiar nombre de columna id_acceso a id_registro_acceso\n+ALTER TABLE Alertas \n+CHANGE COLUMN id_acceso id_registro_acceso INT NULL;\n+\n+-- Agregar nueva foreign key\n+-- Nota: Si ya existe una foreign key con el mismo nombre, eliminar primero:\n+-- ALTER TABLE Alertas DROP FOREIGN KEY fk_alertas_registro;\n+ALTER TABLE Alertas \n+ADD CONSTRAINT fk_alertas_registro \n+FOREIGN KEY (id_registro_acceso) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL;\n+\n+-- Agregar índice\n+CREATE INDEX idx_alertas_registro ON Alertas(id_registro_acceso);\n+\n+-- =====================================================\n+-- PASO 5: TRIGGER PARA AUTO-GENERAR SESIONES\n+-- =====================================================\n+DELIMITER $$\n+\n+DROP TRIGGER IF EXISTS trg_generar_sesion_entrada$$\n+\n+CREATE TRIGGER trg_generar_sesion_entrada\n+AFTER INSERT ON Registros_Acceso\n+FOR EACH ROW\n+BEGIN\n+    -- Si es una ENTRADA, crear nueva sesión abierta\n+    IF NEW.tipo_movimiento = 'entrada' THEN\n+        INSERT INTO Sesiones_Acceso \n+        (id_persona, id_registro_entrada, fecha_entrada, estado)\n+        VALUES \n+        (NEW.id_persona, NEW.id_registro, NEW.fecha_hora, 'abierta');\n+    END IF;\n+    \n+    -- Si es una SALIDA, intentar cerrar la última sesión abierta\n+    IF NEW.tipo_movimiento = 'salida' THEN\n+        UPDATE Sesiones_Acceso \n+        SET \n+            id_registro_salida = NEW.id_registro,\n+            fecha_salida = NEW.fecha_hora,\n+            duracion_minutos = TIMESTAMPDIFF(MINUTE, fecha_entrada, NEW.fecha_hora),\n+            estado = 'cerrada'\n+        WHERE \n+            id_persona = NEW.id_persona \n+            AND estado = 'abierta'\n+            AND id_registro_salida IS NULL\n+        ORDER BY fecha_entrada DESC\n+        LIMIT 1;\n+    END IF;\n+END$$\n+\n+DELIMITER ;\n+\n+-- =====================================================\n+-- PASO 6: VISTAS ÚTILES PARA CONSULTAS\n+-- =====================================================\n+\n+-- Vista: Últimos registros de acceso\n+CREATE OR REPLACE VIEW v_ultimos_registros AS\n+SELECT \n+    r.id_registro,\n+    r.tipo_movimiento,\n+    r.fecha_hora,\n+    p.id_persona,\n+    p.nombre,\n+    p.documento,\n+    p.rol,\n+    a.nombre_ambiente,\n+    r.metodo_registro,\n+    u.nombre as usuario_registro\n+FROM Registros_Acceso r\n+INNER JOIN Personas p ON r.id_persona = p.id_persona\n+LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n+LEFT JOIN Usuarios u ON r.id_usuario_registro = u.id_usuario\n+ORDER BY r.fecha_hora DESC;\n+\n+-- Vista: Sesiones abiertas (personas actualmente dentro)\n+CREATE OR REPLACE VIEW v_sesiones_abiertas AS\n+SELECT \n+    s.id_sesion,\n+    s.id_persona,\n+    p.nombre,\n+    p.documento,\n+    p.rol,\n+    p.foto,\n+    s.fecha_entrada,\n+    TIMESTAMPDIFF(MINUTE, s.fecha_entrada, NOW()) as minutos_dentro,\n+    r.id_ambiente,\n+    a.nombre_ambiente\n+FROM Sesiones_Acceso s\n+INNER JOIN Personas p ON s.id_persona = p.id_persona\n+LEFT JOIN Registros_Acceso r ON s.id_registro_entrada = r.id_registro\n+LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n+WHERE s.estado = 'abierta';\n+\n+-- Vista: Resumen de asistencia por persona\n+CREATE OR REPLACE VIEW v_resumen_asistencia AS\n+SELECT \n+    p.id_persona,\n+    p.nombre,\n+    p.documento,\n+    p.rol,\n+    COUNT(DISTINCT DATE(r.fecha_hora)) as dias_asistencia,\n+    COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) as total_entradas,\n+    COUNT(CASE WHEN r.tipo_movimiento = 'salida' THEN 1 END) as total_salidas,\n+    MAX(r.fecha_hora) as ultimo_registro\n+FROM Personas p\n+LEFT JOIN Registros_Acceso r ON p.id_persona = r.id_persona\n+WHERE p.estado = 'activo'\n+GROUP BY p.id_persona, p.nombre, p.documento, p.rol;\n+\n+-- Vista: Flujo de acceso por día\n+CREATE OR REPLACE VIEW v_flujo_diario AS\n+SELECT \n+    DATE(fecha_hora) as fecha,\n+    tipo_movimiento,\n+    COUNT(*) as cantidad,\n+    HOUR(fecha_hora) as hora\n+FROM Registros_Acceso\n+GROUP BY DATE(fecha_hora), tipo_movimiento, HOUR(fecha_hora)\n+ORDER BY fecha DESC, hora;\n+\n+-- =====================================================\n+-- PASO 7: PROCEDIMIENTOS ALMACENADOS ÚTILES\n+-- =====================================================\n+\n+-- Registrar entrada\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_registrar_entrada$$\n+\n+CREATE PROCEDURE sp_registrar_entrada(\n+    IN p_id_persona INT,\n+    IN p_id_usuario INT,\n+    IN p_id_ambiente INT,\n+    IN p_metodo VARCHAR(20),\n+    IN p_observaciones TEXT\n+)\n+BEGIN\n+    INSERT INTO Registros_Acceso \n+    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n+    VALUES \n+    (p_id_persona, p_id_usuario, 'entrada', p_id_ambiente, p_metodo, p_observaciones);\n+    \n+    SELECT LAST_INSERT_ID() as id_registro;\n+END$$\n+\n+DELIMITER ;\n+\n+-- Registrar salida\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_registrar_salida$$\n+\n+CREATE PROCEDURE sp_registrar_salida(\n+    IN p_id_persona INT,\n+    IN p_id_usuario INT,\n+    IN p_id_ambiente INT,\n+    IN p_metodo VARCHAR(20),\n+    IN p_observaciones TEXT\n+)\n+BEGIN\n+    INSERT INTO Registros_Acceso \n+    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n+    VALUES \n+    (p_id_persona, p_id_usuario, 'salida', p_id_ambiente, p_metodo, p_observaciones);\n+    \n+    SELECT LAST_INSERT_ID() as id_registro;\n+END$$\n+\n+DELIMITER ;\n+\n+-- Obtener personas actualmente dentro\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_personas_dentro$$\n+\n+CREATE PROCEDURE sp_personas_dentro()\n+BEGIN\n+    SELECT * FROM v_sesiones_abiertas;\n+END$$\n+\n+DELIMITER ;\n+\n+-- Verificar última acción de una persona\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_ultima_accion_persona$$\n+\n+CREATE PROCEDURE sp_ultima_accion_persona(IN p_id_persona INT)\n+BEGIN\n+    SELECT \n+        tipo_movimiento,\n+        fecha_hora,\n+        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n+    FROM Registros_Acceso\n+    WHERE id_persona = p_id_persona\n+    ORDER BY fecha_hora DESC\n+    LIMIT 1;\n+END$$\n+\n+DELIMITER ;\n+\n+-- =====================================================\n+-- PASO 8: ÍNDICES ADICIONALES PARA OPTIMIZACIÓN\n+-- =====================================================\n+CREATE INDEX idx_registro_persona_fecha_tipo ON Registros_Acceso(id_persona, fecha_hora, tipo_movimiento);\n+CREATE INDEX idx_sesion_persona_estado ON Sesiones_Acceso(id_persona, estado);\n+\n+-- =====================================================\n+-- DOCUMENTACIÓN DEL MODELO DE CIRCUITO ABIERTO\n+-- =====================================================\n+/*\n+VENTAJAS DEL CIRCUITO ABIERTO:\n+\n+1. FLEXIBILIDAD TOTAL\n+   - No requiere emparejar entradas con salidas\n+   - Permite registros independientes\n+   - Soporta casos de uso complejos\n+\n+2. RESILIENCIA\n+   - Si alguien olvida registrar salida, no afecta entradas futuras\n+   - Permite correcciones posteriores\n+   - No bloquea el sistema por registros incompletos\n+\n+3. ESCALABILIDAD\n+   - Mejor rendimiento en consultas\n+   - Menos complejidad en transacciones\n+   - Facilita integraciones con otros sistemas\n+\n+4. ANÁLISIS\n+   - Datos más granulares\n+   - Permite análisis de patrones\n+   - Facilita reportes y estadísticas\n+\n+5. CASOS DE USO SOPORTADOS\n+   - Entrada sin salida registrada\n+   - Múltiples entradas consecutivas\n+   - Salida sin entrada previa\n+   - Corrección de registros erróneos\n+\n+CONSULTAS COMUNES:\n+\n+1. Personas actualmente dentro:\n+   SELECT * FROM v_sesiones_abiertas;\n+\n+2. Último registro de una persona:\n+   CALL sp_ultima_accion_persona(1);\n+\n+3. Todos los registros de hoy:\n+   SELECT * FROM Registros_Acceso \n+   WHERE DATE(fecha_hora) = CURDATE();\n+\n+4. Historial completo de una persona:\n+   SELECT * FROM Registros_Acceso \n+   WHERE id_persona = 1 \n+   ORDER BY fecha_hora DESC;\n+*/\n+\n"
                },
                {
                    "date": 1763667702824,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,31 +92,8 @@\n     INDEX idx_personas_ficha_id (id_ficha),\n     UNIQUE KEY uk_documento_tipo (documento, tipo_documento)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n--- =====================================================\n--- TABLA: Accesos\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Accesos (\n-    id_acceso INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_usuario_registro INT,\n-    tipo_acceso ENUM('entrada', 'salida') NOT NULL DEFAULT 'entrada',\n-    fecha_entrada TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-    fecha_salida TIMESTAMP NULL,\n-    estado ENUM('activo', 'finalizado', 'cancelado') NOT NULL DEFAULT 'activo',\n-    observaciones TEXT,\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    INDEX idx_id_persona (id_persona),\n-    INDEX idx_fecha_entrada (fecha_entrada),\n-    INDEX idx_fecha_salida (fecha_salida),\n-    INDEX idx_estado (estado),\n-    INDEX idx_tipo_acceso (tipo_acceso),\n-    INDEX idx_usuario_registro (id_usuario_registro)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n -- TABLA: Visitantes\n -- =====================================================\n@@ -157,35 +134,8 @@\n ('system_name', 'Control de Acceso SENA', 'string', 'Nombre del sistema'),\n ('max_visitors_per_day', '100', 'number', 'Máximo de visitantes por día')\n ON DUPLICATE KEY UPDATE clave=clave;\n \n--- =====================================================\n--- TABLA: Alertas\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Alertas (\n-    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\n-    tipo ENUM('acceso_fuera_horario', 'intento_fraudulento', 'qr_expirado', 'documento_no_registrado', 'comportamiento_sospechoso', 'sistema', 'seguridad') NOT NULL,\n-    severidad ENUM('critica', 'alta', 'media', 'baja') NOT NULL DEFAULT 'media',\n-    titulo VARCHAR(255) NOT NULL,\n-    mensaje TEXT NOT NULL,\n-    id_persona INT,\n-    id_acceso INT,\n-    id_usuario INT,\n-    leida BOOLEAN DEFAULT FALSE,\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_lectura TIMESTAMP NULL,\n-    id_usuario_lectura INT,\n-    metadata JSON,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\n-    FOREIGN KEY (id_acceso) REFERENCES Accesos(id_acceso) ON DELETE SET NULL,\n-    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    FOREIGN KEY (id_usuario_lectura) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    INDEX idx_tipo (tipo),\n-    INDEX idx_severidad (severidad),\n-    INDEX idx_leida (leida),\n-    INDEX idx_fecha_creacion (fecha_creacion),\n-    INDEX idx_id_persona (id_persona)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n -- TABLA: Logs_Seguridad\n -- =====================================================\n@@ -296,8 +246,102 @@\n     INDEX idx_ambiente_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n+-- TABLA: Registros_Acceso (CIRCUITO ABIERTO)\n+-- Cada registro es INDEPENDIENTE (entrada o salida)\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Registros_Acceso (\n+    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    id_usuario_registro INT,\n+    tipo_movimiento ENUM('entrada', 'salida') NOT NULL,\n+    fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+    id_ambiente INT NULL COMMENT 'Ambiente donde ocurrió el registro',\n+    metodo_registro ENUM('qr', 'manual', 'biometrico', 'tarjeta') DEFAULT 'qr',\n+    ip_address VARCHAR(45),\n+    geolocalizacion VARCHAR(100),\n+    observaciones TEXT,\n+    metadata JSON COMMENT 'Información adicional del registro',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    \n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n+    \n+    INDEX idx_registro_persona (id_persona),\n+    INDEX idx_registro_tipo (tipo_movimiento),\n+    INDEX idx_registro_fecha (fecha_hora),\n+    INDEX idx_registro_ambiente (id_ambiente),\n+    INDEX idx_registro_usuario (id_usuario_registro),\n+    INDEX idx_registro_metodo (metodo_registro),\n+    INDEX idx_persona_fecha (id_persona, fecha_hora),\n+    INDEX idx_registro_persona_fecha_tipo (id_persona, fecha_hora, tipo_movimiento)\n+    \n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n+\n+-- =====================================================\n+-- TABLA: Sesiones_Acceso (OPCIONAL - Para análisis)\n+-- Esta tabla es solo para CONSULTAS y REPORTES\n+-- NO es obligatoria para el funcionamiento del sistema\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Sesiones_Acceso (\n+    id_sesion INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    id_registro_entrada INT NOT NULL,\n+    id_registro_salida INT NULL,\n+    fecha_entrada TIMESTAMP NOT NULL,\n+    fecha_salida TIMESTAMP NULL,\n+    duracion_minutos INT NULL,\n+    estado ENUM('abierta', 'cerrada', 'anomala') DEFAULT 'abierta',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    \n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_registro_entrada) REFERENCES Registros_Acceso(id_registro) ON DELETE CASCADE,\n+    FOREIGN KEY (id_registro_salida) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n+    \n+    INDEX idx_sesion_persona (id_persona),\n+    INDEX idx_sesion_entrada (id_registro_entrada),\n+    INDEX idx_sesion_salida (id_registro_salida),\n+    INDEX idx_sesion_estado (estado),\n+    INDEX idx_sesion_fechas (fecha_entrada, fecha_salida),\n+    INDEX idx_sesion_persona_estado (id_persona, estado)\n+    \n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Vista consolidada de sesiones - Generada automáticamente';\n+\n+-- =====================================================\n+-- TABLA: Alertas\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Alertas (\n+    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\n+    tipo ENUM('acceso_fuera_horario', 'intento_fraudulento', 'qr_expirado', 'documento_no_registrado', 'comportamiento_sospechoso', 'sistema', 'seguridad') NOT NULL,\n+    severidad ENUM('critica', 'alta', 'media', 'baja') NOT NULL DEFAULT 'media',\n+    titulo VARCHAR(255) NOT NULL,\n+    mensaje TEXT NOT NULL,\n+    id_persona INT,\n+    id_registro_acceso INT NULL COMMENT 'Referencia a Registros_Acceso (circuito abierto)',\n+    id_usuario INT,\n+    leida BOOLEAN DEFAULT FALSE,\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_lectura TIMESTAMP NULL,\n+    id_usuario_lectura INT,\n+    metadata JSON,\n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\n+    FOREIGN KEY (id_registro_acceso) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario_lectura) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    INDEX idx_tipo (tipo),\n+    INDEX idx_severidad (severidad),\n+    INDEX idx_leida (leida),\n+    INDEX idx_fecha_creacion (fecha_creacion),\n+    INDEX idx_id_persona (id_persona),\n+    INDEX idx_alertas_registro (id_registro_acceso)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n -- MODIFICAR TABLA: Personas\n -- Agregar relación con programas de formación\n -- =====================================================\n ALTER TABLE Personas \n@@ -652,111 +696,17 @@\n -- Total general: 50 programas\n -- =====================================================\n \n -- =====================================================\n--- MODIFICACIÓN A CIRCUITO ABIERTO\n+-- TRIGGERS, VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n USE control_acceso_sena;\n \n -- =====================================================\n--- PASO 1: ELIMINAR DEPENDENCIAS Y TABLA ACCESOS ORIGINAL\n+-- TRIGGER PARA AUTO-GENERAR SESIONES\n -- =====================================================\n--- Primero eliminar foreign keys que referencian a Accesos\n--- Nota: Ejecutar manualmente si es necesario:\n--- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n-\n--- Ahora eliminar la tabla Accesos\n-DROP TABLE IF EXISTS Accesos;\n-\n--- =====================================================\n--- PASO 2: CREAR NUEVA TABLA DE REGISTRO DE ACCESOS\n--- Cada registro es INDEPENDIENTE (entrada o salida)\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Registros_Acceso (\n-    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_usuario_registro INT,\n-    tipo_movimiento ENUM('entrada', 'salida') NOT NULL,\n-    fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-    id_ambiente INT NULL COMMENT 'Ambiente donde ocurrió el registro',\n-    metodo_registro ENUM('qr', 'manual', 'biometrico', 'tarjeta') DEFAULT 'qr',\n-    ip_address VARCHAR(45),\n-    geolocalizacion VARCHAR(100),\n-    observaciones TEXT,\n-    metadata JSON COMMENT 'Información adicional del registro',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    \n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    \n-    INDEX idx_registro_persona (id_persona),\n-    INDEX idx_registro_tipo (tipo_movimiento),\n-    INDEX idx_registro_fecha (fecha_hora),\n-    INDEX idx_registro_ambiente (id_ambiente),\n-    INDEX idx_registro_usuario (id_usuario_registro),\n-    INDEX idx_registro_metodo (metodo_registro),\n-    INDEX idx_persona_fecha (id_persona, fecha_hora)\n-    \n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n-\n--- =====================================================\n--- PASO 3: TABLA DE SESIONES (OPCIONAL - Para análisis)\n--- Esta tabla es solo para CONSULTAS y REPORTES\n--- NO es obligatoria para el funcionamiento del sistema\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Sesiones_Acceso (\n-    id_sesion INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_registro_entrada INT NOT NULL,\n-    id_registro_salida INT NULL,\n-    fecha_entrada TIMESTAMP NOT NULL,\n-    fecha_salida TIMESTAMP NULL,\n-    duracion_minutos INT NULL,\n-    estado ENUM('abierta', 'cerrada', 'anomala') DEFAULT 'abierta',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    \n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_registro_entrada) REFERENCES Registros_Acceso(id_registro) ON DELETE CASCADE,\n-    FOREIGN KEY (id_registro_salida) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n-    \n-    INDEX idx_sesion_persona (id_persona),\n-    INDEX idx_sesion_entrada (id_registro_entrada),\n-    INDEX idx_sesion_salida (id_registro_salida),\n-    INDEX idx_sesion_estado (estado),\n-    INDEX idx_sesion_fechas (fecha_entrada, fecha_salida)\n-    \n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Vista consolidada de sesiones - Generada automáticamente';\n-\n--- =====================================================\n--- PASO 4: ACTUALIZAR TABLA DE ALERTAS\n--- Referenciar a Registros_Acceso en lugar de Accesos\n--- =====================================================\n--- IMPORTANTE: Si la tabla Alertas ya existe, ejecutar manualmente antes:\n--- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n-\n--- Cambiar nombre de columna id_acceso a id_registro_acceso\n-ALTER TABLE Alertas \n-CHANGE COLUMN id_acceso id_registro_acceso INT NULL;\n-\n--- Agregar nueva foreign key\n--- Nota: Si ya existe una foreign key con el mismo nombre, eliminar primero:\n--- ALTER TABLE Alertas DROP FOREIGN KEY fk_alertas_registro;\n-ALTER TABLE Alertas \n-ADD CONSTRAINT fk_alertas_registro \n-FOREIGN KEY (id_registro_acceso) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL;\n-\n--- Agregar índice\n-CREATE INDEX idx_alertas_registro ON Alertas(id_registro_acceso);\n-\n--- =====================================================\n--- PASO 5: TRIGGER PARA AUTO-GENERAR SESIONES\n--- =====================================================\n DELIMITER $$\n \n DROP TRIGGER IF EXISTS trg_generar_sesion_entrada$$\n \n@@ -791,9 +741,9 @@\n \n DELIMITER ;\n \n -- =====================================================\n--- PASO 6: VISTAS ÚTILES PARA CONSULTAS\n+-- VISTAS ÚTILES PARA CONSULTAS\n -- =====================================================\n \n -- Vista: Últimos registros de acceso\n CREATE OR REPLACE VIEW v_ultimos_registros AS\n@@ -860,9 +810,9 @@\n GROUP BY DATE(fecha_hora), tipo_movimiento, HOUR(fecha_hora)\n ORDER BY fecha DESC, hora;\n \n -- =====================================================\n--- PASO 7: PROCEDIMIENTOS ALMACENADOS ÚTILES\n+-- PROCEDIMIENTOS ALMACENADOS ÚTILES\n -- =====================================================\n \n -- Registrar entrada\n DELIMITER $$\n@@ -940,13 +890,9 @@\n END$$\n \n DELIMITER ;\n \n--- =====================================================\n--- PASO 8: ÍNDICES ADICIONALES PARA OPTIMIZACIÓN\n--- =====================================================\n-CREATE INDEX idx_registro_persona_fecha_tipo ON Registros_Acceso(id_persona, fecha_hora, tipo_movimiento);\n-CREATE INDEX idx_sesion_persona_estado ON Sesiones_Acceso(id_persona, estado);\n+-- Nota: Los índices adicionales ya están incluidos en las definiciones de las tablas\n \n -- =====================================================\n -- DOCUMENTACIÓN DEL MODELO DE CIRCUITO ABIERTO\n -- =====================================================\n"
                },
                {
                    "date": 1763667785900,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,8 +246,18 @@\n     INDEX idx_ambiente_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n+-- MIGRACIÓN A CIRCUITO ABIERTO\n+-- Eliminar tabla Accesos antigua y sus dependencias\n+-- =====================================================\n+-- IMPORTANTE: Si la base de datos ya existe, ejecutar manualmente antes:\n+-- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n+-- ALTER TABLE Historial_Asistencias DROP FOREIGN KEY IF EXISTS historial_asistencias_ibfk_X;\n+\n+DROP TABLE IF EXISTS Accesos;\n+\n+-- =====================================================\n -- TABLA: Registros_Acceso (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n -- =====================================================\n CREATE TABLE IF NOT EXISTS Registros_Acceso (\n@@ -448,30 +458,36 @@\n CREATE INDEX idx_personas_ficha_id ON Personas(id_ficha);\n -- ALTER TABLE Personas ADD FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n \n -- =====================================================\n--- TABLA: Historial_Asistencias\n+-- TABLA: Historial_Asistencias (CIRCUITO ABIERTO)\n+-- Esta tabla ahora referencia a Registros_Acceso\n+-- Se puede usar para consolidar datos diarios o mantener compatibilidad\n -- =====================================================\n CREATE TABLE IF NOT EXISTS Historial_Asistencias (\n     id_registro INT AUTO_INCREMENT PRIMARY KEY,\n     id_persona INT NOT NULL,\n     id_ficha INT NULL,\n     id_ambiente INT NULL,\n+    id_registro_acceso INT NULL COMMENT 'Referencia al registro de acceso en circuito abierto',\n     fecha DATE NOT NULL,\n     hora_entrada TIME,\n     hora_salida TIME,\n-    tipo_acceso ENUM('entrada', 'salida') NOT NULL,\n+    tipo_movimiento ENUM('entrada', 'salida') NOT NULL COMMENT 'Tipo de movimiento (circuito abierto)',\n     estado ENUM('presente', 'ausente', 'tardanza', 'salida_anticipada') DEFAULT 'presente',\n     observaciones TEXT,\n     fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n     FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n     FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL,\n     FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n+    FOREIGN KEY (id_registro_acceso) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n     INDEX idx_historial_persona (id_persona),\n     INDEX idx_historial_ficha (id_ficha),\n     INDEX idx_historial_fecha (fecha),\n-    INDEX idx_historial_ambiente (id_ambiente)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+    INDEX idx_historial_ambiente (id_ambiente),\n+    INDEX idx_historial_registro_acceso (id_registro_acceso)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Historial de asistencias - Referencia a Registros_Acceso (circuito abierto)';\n \n -- =====================================================\n -- TABLA: Alertas_Sistema\n -- =====================================================\n@@ -809,8 +825,31 @@\n FROM Registros_Acceso\n GROUP BY DATE(fecha_hora), tipo_movimiento, HOUR(fecha_hora)\n ORDER BY fecha DESC, hora;\n \n+-- Vista: Historial de asistencias consolidado desde Registros_Acceso\n+-- Esta vista consolida los registros diarios para compatibilidad con código existente\n+CREATE OR REPLACE VIEW v_historial_asistencias_consolidado AS\n+SELECT \n+    r.id_registro as id_registro_acceso,\n+    r.id_persona,\n+    p.id_ficha,\n+    r.id_ambiente,\n+    DATE(r.fecha_hora) as fecha,\n+    MIN(CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END) as hora_entrada,\n+    MAX(CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END) as hora_salida,\n+    r.tipo_movimiento,\n+    CASE \n+        WHEN COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) > 0 THEN 'presente'\n+        ELSE 'ausente'\n+    END as estado,\n+    GROUP_CONCAT(r.observaciones SEPARATOR ' | ') as observaciones,\n+    MIN(r.fecha_creacion) as fecha_creacion\n+FROM Registros_Acceso r\n+INNER JOIN Personas p ON r.id_persona = p.id_persona\n+GROUP BY r.id_persona, DATE(r.fecha_hora), r.id_ambiente, r.tipo_movimiento\n+ORDER BY fecha DESC, hora_entrada DESC;\n+\n -- =====================================================\n -- PROCEDIMIENTOS ALMACENADOS ÚTILES\n -- =====================================================\n \n@@ -890,8 +929,42 @@\n END$$\n \n DELIMITER ;\n \n+-- Sincronizar Historial_Asistencias desde Registros_Acceso (opcional)\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_sincronizar_historial_asistencias$$\n+\n+CREATE PROCEDURE sp_sincronizar_historial_asistencias(IN p_fecha DATE)\n+BEGIN\n+    -- Eliminar registros existentes para la fecha especificada\n+    DELETE FROM Historial_Asistencias WHERE fecha = p_fecha;\n+    \n+    -- Insertar registros consolidados desde Registros_Acceso\n+    INSERT INTO Historial_Asistencias \n+    (id_persona, id_ficha, id_ambiente, id_registro_acceso, fecha, hora_entrada, hora_salida, tipo_movimiento, estado, observaciones)\n+    SELECT \n+        r.id_persona,\n+        p.id_ficha,\n+        r.id_ambiente,\n+        r.id_registro,\n+        DATE(r.fecha_hora) as fecha,\n+        CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END as hora_entrada,\n+        CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END as hora_salida,\n+        r.tipo_movimiento,\n+        'presente' as estado,\n+        r.observaciones\n+    FROM Registros_Acceso r\n+    INNER JOIN Personas p ON r.id_persona = p.id_persona\n+    WHERE DATE(r.fecha_hora) = p_fecha\n+    ORDER BY r.fecha_hora;\n+    \n+    SELECT CONCAT('Historial sincronizado para fecha: ', p_fecha) as resultado;\n+END$$\n+\n+DELIMITER ;\n+\n -- Nota: Los índices adicionales ya están incluidos en las definiciones de las tablas\n \n -- =====================================================\n -- DOCUMENTACIÓN DEL MODELO DE CIRCUITO ABIERTO\n@@ -940,6 +1013,63 @@\n 4. Historial completo de una persona:\n    SELECT * FROM Registros_Acceso \n    WHERE id_persona = 1 \n    ORDER BY fecha_hora DESC;\n+\n+MIGRACIÓN DE DATOS EXISTENTES:\n+\n+Si tienes datos en la tabla Accesos antigua, ejecuta este script para migrarlos:\n+\n+-- Migrar entradas desde tabla Accesos antigua\n+INSERT INTO Registros_Acceso \n+(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n+SELECT \n+    id_persona,\n+    id_usuario_registro,\n+    tipo_acceso,\n+    fecha_entrada,\n+    observaciones,\n+    fecha_creacion\n+FROM Accesos\n+WHERE tipo_acceso = 'entrada' AND fecha_entrada IS NOT NULL;\n+\n+-- Migrar salidas desde tabla Accesos antigua\n+INSERT INTO Registros_Acceso \n+(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n+SELECT \n+    id_persona,\n+    id_usuario_registro,\n+    'salida',\n+    fecha_salida,\n+    observaciones,\n+    fecha_actualizacion\n+FROM Accesos\n+WHERE tipo_acceso = 'salida' AND fecha_salida IS NOT NULL;\n+\n+-- Si la tabla Accesos tenía registros con fecha_entrada pero sin fecha_salida,\n+-- migrar solo como entrada\n+INSERT INTO Registros_Acceso \n+(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n+SELECT \n+    id_persona,\n+    id_usuario_registro,\n+    'entrada',\n+    fecha_entrada,\n+    observaciones,\n+    fecha_creacion\n+FROM Accesos\n+WHERE fecha_entrada IS NOT NULL \n+  AND fecha_salida IS NULL\n+  AND tipo_acceso = 'entrada';\n+\n+NOTAS IMPORTANTES:\n+\n+1. La tabla Historial_Asistencias ahora es OPCIONAL y puede ser poblada usando:\n+   CALL sp_sincronizar_historial_asistencias('2024-01-15');\n+\n+2. Para consultas diarias, usa la vista v_historial_asistencias_consolidado\n+\n+3. Todos los nuevos registros deben hacerse directamente en Registros_Acceso\n+\n+4. La tabla Sesiones_Acceso se genera automáticamente mediante triggers\n */\n \n"
                },
                {
                    "date": 1763668347565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -114,29 +114,10 @@\n     INDEX idx_fecha_inicio (fecha_inicio),\n     INDEX idx_fecha_fin (fecha_fin)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n--- =====================================================\n--- TABLA: Configuracion\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Configuracion (\n-    id_config INT AUTO_INCREMENT PRIMARY KEY,\n-    clave VARCHAR(100) NOT NULL UNIQUE,\n-    valor TEXT,\n-    tipo ENUM('string', 'number', 'boolean', 'json') NOT NULL DEFAULT 'string',\n-    descripcion VARCHAR(255),\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_clave (clave)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n-INSERT INTO Configuracion (clave, valor, tipo, descripcion) VALUES\n-('qr_visitor_expiry_hours', '24', 'number', 'Horas de validez del QR de visitante'),\n-('system_name', 'Control de Acceso SENA', 'string', 'Nombre del sistema'),\n-('max_visitors_per_day', '100', 'number', 'Máximo de visitantes por día')\n-ON DUPLICATE KEY UPDATE clave=clave;\n \n-\n -- =====================================================\n -- TABLA: Logs_Seguridad\n -- =====================================================\n CREATE TABLE IF NOT EXISTS Logs_Seguridad (\n@@ -198,8 +179,28 @@\n     INDEX idx_fecha (fecha)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n+-- TABLA: Configuracion\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Configuracion (\n+    id_config INT AUTO_INCREMENT PRIMARY KEY,\n+    clave VARCHAR(100) NOT NULL UNIQUE,\n+    valor TEXT,\n+    tipo ENUM('string', 'number', 'boolean', 'json') NOT NULL DEFAULT 'string',\n+    descripcion VARCHAR(255),\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    INDEX idx_clave (clave)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+INSERT INTO Configuracion (clave, valor, tipo, descripcion) VALUES\n+('qr_visitor_expiry_hours', '24', 'number', 'Horas de validez del QR de visitante'),\n+('system_name', 'Control de Acceso SENA', 'string', 'Nombre del sistema'),\n+('max_visitors_per_day', '100', 'number', 'Máximo de visitantes por día')\n+ON DUPLICATE KEY UPDATE clave=clave;\n+\n+-- =====================================================\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n@@ -370,24 +371,10 @@\n -- ADD CONSTRAINT fk_personas_programa \n -- FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL;\n \n -- =====================================================\n--- TABLA: Zonas (si no existe, crear para relacionar con ambientes)\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Zonas (\n-    id_zona INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre_zona VARCHAR(100) NOT NULL,\n-    id_ambiente INT NULL,\n-    tipo_zona ENUM('academica', 'administrativa', 'recreativa') DEFAULT 'academica',\n-    descripcion TEXT,\n-    estado ENUM('activo', 'inactivo') DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    INDEX idx_zona_ambiente (id_ambiente),\n-    INDEX idx_zona_tipo (tipo_zona)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n+\n -- =====================================================\n -- ESQUEMA DE INTEGRACIÓN QR + BD\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n"
                },
                {
                    "date": 1763669441231,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,115 +1,117 @@\n -- =====================================================\n -- ESQUEMA COMPLETO DE BASE DE DATOS\n--- Sistema de Control de Acceso SENA\n+-- Sistema de Control de Acceso SENA - CIRCUITO ABIERTO\n -- =====================================================\n \n -- Crear base de datos si no existe\n-CREATE DATABASE IF NOT EXISTS control_acceso_sena \n+CREATE DATABASE IF NOT EXISTS sena_acceso \n CHARACTER SET utf8mb4 \n COLLATE utf8mb4_unicode_ci;\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n--- TABLA: Roles\n+-- TABLA: usuarios\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Roles (\n-    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n-    descripcion VARCHAR(255),\n-    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_nombre_rol (nombre_rol),\n-    INDEX idx_estado (estado)\n+CREATE TABLE IF NOT EXISTS usuarios (\n+  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre VARCHAR(100),\n+  email VARCHAR(100),\n+  passwords VARCHAR(255),\n+  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\n+  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  ultimo_acceso TIMESTAMP NULL,\n+  INDEX idx_email (email),\n+  INDEX idx_rol (rol),\n+  INDEX idx_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n-INSERT INTO Roles (nombre_rol, descripcion) VALUES\n-('aprendiz', 'Aprendiz del SENA'),\n-('instructor', 'Instructor del SENA'),\n-('administrativo', 'Personal administrativo'),\n-('visitante', 'Visitante temporal'),\n-('guarda', 'Guarda de seguridad'),\n-('admin', 'Administrador del sistema')\n-ON DUPLICATE KEY UPDATE nombre_rol=nombre_rol;\n+-- =====================================================\n+-- TABLA: estados_personas (Catálogo)\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS estados_personas (\n+  id_estado_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre_estado VARCHAR(20) NOT NULL UNIQUE,\n+  INDEX idx_nombre_estado (nombre_estado)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n+-- Insertar estados por defecto\n+INSERT INTO estados_personas (nombre_estado) VALUES\n+('ACTIVO'),\n+('INACTIVO'),\n+('SUSPENDIDO')\n+ON DUPLICATE KEY UPDATE nombre_estado=nombre_estado;\n+\n -- =====================================================\n--- TABLA: Usuarios\n+-- TABLA: roles_personas (Catálogo)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Usuarios (\n-    id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre VARCHAR(255) NOT NULL,\n-    email VARCHAR(255) UNIQUE NOT NULL,\n-    password_hash VARCHAR(255) NOT NULL,\n-    rol ENUM('admin', 'guarda') NOT NULL DEFAULT 'guarda',\n-    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_email (email),\n-    INDEX idx_rol (rol),\n-    INDEX idx_estado (estado)\n+CREATE TABLE IF NOT EXISTS roles_personas (\n+  id_rol_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre_rol_persona VARCHAR(30) NOT NULL UNIQUE,\n+  INDEX idx_nombre_rol (nombre_rol_persona)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n+-- Insertar roles por defecto\n+INSERT INTO roles_personas (nombre_rol_persona) VALUES\n+('APRENDIZ'),\n+('INSTRUCTOR'),\n+('ADMINISTRATIVO'),\n+('VISITANTE'),\n+('GUARDA'),\n+('ADMINISTRADOR')\n+ON DUPLICATE KEY UPDATE nombre_rol_persona=nombre_rol_persona;\n+\n -- =====================================================\n--- TABLA: Personas\n+-- TABLA: personas\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Personas (\n-    id_persona INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre VARCHAR(255) NOT NULL,\n-    documento VARCHAR(50) NOT NULL,\n-    tipo_documento ENUM('CC', 'CE', 'TI', 'PA', 'NIT') NOT NULL DEFAULT 'CC',\n-    email VARCHAR(255),\n-    telefono VARCHAR(20),\n-    rh VARCHAR(10) NULL COMMENT 'Grupo sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)',\n-    foto VARCHAR(500),\n-    id_rol INT,\n-    rol VARCHAR(50) DEFAULT 'aprendiz',\n-    estado ENUM('activo', 'inactivo', 'suspendido') NOT NULL DEFAULT 'activo',\n-    -- Campos académicos\n-    id_programa INT NULL COMMENT 'Referencia a Programas_Formacion',\n-    ficha VARCHAR(50) NULL COMMENT 'Código de ficha del aprendiz',\n-    id_ficha INT NULL COMMENT 'Referencia a tabla Fichas',\n-    programa VARCHAR(100) NULL COMMENT 'Nombre del programa (legacy)',\n-    jornada ENUM('diurna', 'nocturna', 'mixta') NULL COMMENT 'Jornada de formación',\n-    fecha_inicio_formacion DATE NULL COMMENT 'Fecha de inicio de formación',\n-    fecha_fin_formacion DATE NULL COMMENT 'Fecha de fin de formación',\n-    -- Campos laborales\n-    cargo VARCHAR(100) NULL COMMENT 'Cargo para instructores y administrativos',\n-    -- Campos de control\n-    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_rol) REFERENCES Roles(id_rol) ON DELETE SET NULL,\n-    INDEX idx_documento (documento),\n-    INDEX idx_tipo_documento (tipo_documento),\n-    INDEX idx_rol (rol),\n-    INDEX idx_estado (estado),\n-    INDEX idx_id_rol (id_rol),\n-    INDEX idx_rh (rh),\n-    INDEX idx_jornada (jornada),\n-    INDEX idx_fechas_formacion (fecha_inicio_formacion, fecha_fin_formacion),\n-    INDEX idx_personas_programa (id_programa),\n-    INDEX idx_personas_ficha (ficha),\n-    INDEX idx_personas_ficha_id (id_ficha),\n-    UNIQUE KEY uk_documento_tipo (documento, tipo_documento)\n+CREATE TABLE IF NOT EXISTS personas (\n+  id_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\n+  documento VARCHAR(50) UNIQUE,\n+  nombres VARCHAR(100),\n+  apellidos VARCHAR(100),\n+  codigo_qr VARCHAR(255),\n+  programa VARCHAR(200),\n+  ficha VARCHAR(50),\n+  zona VARCHAR(200) COMMENT 'Zona o destino donde va la persona o visitante',\n+  foto VARCHAR(500) COMMENT 'Ruta del archivo de foto (formato: uploads/fotos/[documento]-[timestamp].jpg)',\n+  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+  fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_expiracion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Hora exacta de registro de la persona',\n+  id_usuario INT,\n+  id_estado_persona INT,\n+  id_rol_persona INT,\n+  FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n+  FOREIGN KEY (id_estado_persona) REFERENCES estados_personas (id_estado_persona) ON DELETE SET NULL,\n+  FOREIGN KEY (id_rol_persona) REFERENCES roles_personas (id_rol_persona) ON DELETE SET NULL,\n+  INDEX idx_documento (documento),\n+  INDEX idx_tipo_documento (tipo_documento),\n+  INDEX idx_codigo_qr (codigo_qr),\n+  INDEX idx_estado (estado),\n+  INDEX idx_id_usuario (id_usuario),\n+  INDEX idx_id_estado_persona (id_estado_persona),\n+  INDEX idx_id_rol_persona (id_rol_persona)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n \n -- =====================================================\n--- TABLA: Visitantes\n+-- TABLA: Visitantes (Opcional - puede ser eliminada si no se usa)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Visitantes (\n+CREATE TABLE IF NOT EXISTS visitantes (\n     id_visitante INT AUTO_INCREMENT PRIMARY KEY,\n     id_persona INT NOT NULL,\n     motivo_visita TEXT NOT NULL,\n     contacto VARCHAR(255),\n     persona_visita VARCHAR(255),\n     fecha_inicio TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n     fecha_fin TIMESTAMP NULL,\n-    estado ENUM('activo', 'finalizado', 'expirado') NOT NULL DEFAULT 'activo',\n+    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') NOT NULL DEFAULT 'ACTIVO',\n     fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n     fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\n     INDEX idx_id_persona (id_persona),\n     INDEX idx_estado (estado),\n     INDEX idx_fecha_inicio (fecha_inicio),\n     INDEX idx_fecha_fin (fecha_fin)\n@@ -117,11 +119,11 @@\n \n \n \n -- =====================================================\n--- TABLA: Logs_Seguridad\n+-- TABLA: logs_seguridad (Opcional)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Logs_Seguridad (\n+CREATE TABLE IF NOT EXISTS logs_seguridad (\n     id_log INT AUTO_INCREMENT PRIMARY KEY,\n     tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', 'modificacion_usuario', 'modificacion_config', 'generacion_reporte', 'acceso_sistema', 'operacion_admin') NOT NULL,\n     id_usuario INT,\n     ip_address VARCHAR(45),\n@@ -129,9 +131,9 @@\n     accion TEXT NOT NULL,\n     detalles JSON,\n     exito BOOLEAN DEFAULT TRUE,\n     fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n     INDEX idx_tipo (tipo),\n     INDEX idx_id_usuario (id_usuario),\n     INDEX idx_ip_address (ip_address),\n     INDEX idx_fecha (fecha),\n@@ -203,9 +205,9 @@\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- TABLA: Programas_Formacion\n -- =====================================================\n@@ -247,48 +249,22 @@\n     INDEX idx_ambiente_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n--- MIGRACIÓN A CIRCUITO ABIERTO\n--- Eliminar tabla Accesos antigua y sus dependencias\n--- =====================================================\n--- IMPORTANTE: Si la base de datos ya existe, ejecutar manualmente antes:\n--- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n--- ALTER TABLE Historial_Asistencias DROP FOREIGN KEY IF EXISTS historial_asistencias_ibfk_X;\n-\n-DROP TABLE IF EXISTS Accesos;\n-\n--- =====================================================\n--- TABLA: Registros_Acceso (CIRCUITO ABIERTO)\n+-- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Registros_Acceso (\n-    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_usuario_registro INT,\n-    tipo_movimiento ENUM('entrada', 'salida') NOT NULL,\n-    fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-    id_ambiente INT NULL COMMENT 'Ambiente donde ocurrió el registro',\n-    metodo_registro ENUM('qr', 'manual', 'biometrico', 'tarjeta') DEFAULT 'qr',\n-    ip_address VARCHAR(45),\n-    geolocalizacion VARCHAR(100),\n-    observaciones TEXT,\n-    metadata JSON COMMENT 'Información adicional del registro',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    \n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    \n-    INDEX idx_registro_persona (id_persona),\n-    INDEX idx_registro_tipo (tipo_movimiento),\n-    INDEX idx_registro_fecha (fecha_hora),\n-    INDEX idx_registro_ambiente (id_ambiente),\n-    INDEX idx_registro_usuario (id_usuario_registro),\n-    INDEX idx_registro_metodo (metodo_registro),\n-    INDEX idx_persona_fecha (id_persona, fecha_hora),\n-    INDEX idx_registro_persona_fecha_tipo (id_persona, fecha_hora, tipo_movimiento)\n-    \n+CREATE TABLE IF NOT EXISTS registros_entrada_salida (\n+  id_registro_entrada_salida INT AUTO_INCREMENT PRIMARY KEY,\n+  id_persona INT,\n+  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\n+  fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha y hora exacta del registro (entrada o salida)',\n+  FOREIGN KEY (id_persona) REFERENCES personas (id_persona) ON DELETE CASCADE,\n+  INDEX idx_registro_persona (id_persona),\n+  INDEX idx_registro_tipo (tipo),\n+  INDEX idx_registro_fecha (fecha_hora),\n+  INDEX idx_persona_fecha (id_persona, fecha_hora),\n+  INDEX idx_persona_tipo_fecha (id_persona, tipo, fecha_hora)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n \n -- =====================================================\n@@ -378,9 +354,9 @@\n -- ESQUEMA DE INTEGRACIÓN QR + BD\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- TABLA: Fichas\n -- =====================================================\n@@ -502,9 +478,9 @@\n -- ACTUALIZACIÓN DE ESQUEMA PARA IMPORTACIÓN MASIVA\n -- Campos adicionales por rol\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- MODIFICAR TABLA: Personas\n -- Agregar campos adicionales para importación\n@@ -529,9 +505,9 @@\n -- TABLA: Fichas\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- Crear tabla Fichas si no existe\n CREATE TABLE IF NOT EXISTS Fichas (\n     id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n@@ -592,9 +568,9 @@\n -- INSERCIÓN DE PROGRAMAS DE FORMACIÓN - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- PROGRAMAS TÉCNICOS\n -- =====================================================\n@@ -699,143 +675,91 @@\n -- Total general: 50 programas\n -- =====================================================\n \n -- =====================================================\n--- TRIGGERS, VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n+-- VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n--- TRIGGER PARA AUTO-GENERAR SESIONES\n--- =====================================================\n-DELIMITER $$\n-\n-DROP TRIGGER IF EXISTS trg_generar_sesion_entrada$$\n-\n-CREATE TRIGGER trg_generar_sesion_entrada\n-AFTER INSERT ON Registros_Acceso\n-FOR EACH ROW\n-BEGIN\n-    -- Si es una ENTRADA, crear nueva sesión abierta\n-    IF NEW.tipo_movimiento = 'entrada' THEN\n-        INSERT INTO Sesiones_Acceso \n-        (id_persona, id_registro_entrada, fecha_entrada, estado)\n-        VALUES \n-        (NEW.id_persona, NEW.id_registro, NEW.fecha_hora, 'abierta');\n-    END IF;\n-    \n-    -- Si es una SALIDA, intentar cerrar la última sesión abierta\n-    IF NEW.tipo_movimiento = 'salida' THEN\n-        UPDATE Sesiones_Acceso \n-        SET \n-            id_registro_salida = NEW.id_registro,\n-            fecha_salida = NEW.fecha_hora,\n-            duracion_minutos = TIMESTAMPDIFF(MINUTE, fecha_entrada, NEW.fecha_hora),\n-            estado = 'cerrada'\n-        WHERE \n-            id_persona = NEW.id_persona \n-            AND estado = 'abierta'\n-            AND id_registro_salida IS NULL\n-        ORDER BY fecha_entrada DESC\n-        LIMIT 1;\n-    END IF;\n-END$$\n-\n-DELIMITER ;\n-\n--- =====================================================\n -- VISTAS ÚTILES PARA CONSULTAS\n -- =====================================================\n \n -- Vista: Últimos registros de acceso\n CREATE OR REPLACE VIEW v_ultimos_registros AS\n SELECT \n-    r.id_registro,\n-    r.tipo_movimiento,\n+    r.id_registro_entrada_salida,\n+    r.tipo,\n     r.fecha_hora,\n     p.id_persona,\n-    p.nombre,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n     p.documento,\n-    p.rol,\n-    a.nombre_ambiente,\n-    r.metodo_registro,\n-    u.nombre as usuario_registro\n-FROM Registros_Acceso r\n-INNER JOIN Personas p ON r.id_persona = p.id_persona\n-LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n-LEFT JOIN Usuarios u ON r.id_usuario_registro = u.id_usuario\n+    rp.nombre_rol_persona as rol,\n+    p.zona\n+FROM registros_entrada_salida r\n+INNER JOIN personas p ON r.id_persona = p.id_persona\n+LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n ORDER BY r.fecha_hora DESC;\n \n--- Vista: Sesiones abiertas (personas actualmente dentro)\n-CREATE OR REPLACE VIEW v_sesiones_abiertas AS\n+-- Vista: Personas actualmente dentro (última acción fue ENTRADA sin SALIDA posterior)\n+CREATE OR REPLACE VIEW v_personas_dentro AS\n SELECT \n-    s.id_sesion,\n-    s.id_persona,\n-    p.nombre,\n+    p.id_persona,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n     p.documento,\n-    p.rol,\n+    rp.nombre_rol_persona as rol,\n     p.foto,\n-    s.fecha_entrada,\n-    TIMESTAMPDIFF(MINUTE, s.fecha_entrada, NOW()) as minutos_dentro,\n-    r.id_ambiente,\n-    a.nombre_ambiente\n-FROM Sesiones_Acceso s\n-INNER JOIN Personas p ON s.id_persona = p.id_persona\n-LEFT JOIN Registros_Acceso r ON s.id_registro_entrada = r.id_registro\n-LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n-WHERE s.estado = 'abierta';\n+    r.fecha_hora as fecha_entrada,\n+    TIMESTAMPDIFF(MINUTE, r.fecha_hora, NOW()) as minutos_dentro,\n+    p.zona\n+FROM personas p\n+INNER JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n+LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+WHERE r.tipo = 'ENTRADA'\n+  AND r.fecha_hora = (\n+    SELECT MAX(fecha_hora) \n+    FROM registros_entrada_salida \n+    WHERE id_persona = p.id_persona\n+  )\n+  AND NOT EXISTS (\n+    SELECT 1 \n+    FROM registros_entrada_salida r2 \n+    WHERE r2.id_persona = p.id_persona \n+      AND r2.tipo = 'SALIDA' \n+      AND r2.fecha_hora > r.fecha_hora\n+  )\n+  AND p.estado = 'ACTIVO';\n \n -- Vista: Resumen de asistencia por persona\n CREATE OR REPLACE VIEW v_resumen_asistencia AS\n SELECT \n     p.id_persona,\n-    p.nombre,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n     p.documento,\n-    p.rol,\n+    rp.nombre_rol_persona as rol,\n     COUNT(DISTINCT DATE(r.fecha_hora)) as dias_asistencia,\n-    COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) as total_entradas,\n-    COUNT(CASE WHEN r.tipo_movimiento = 'salida' THEN 1 END) as total_salidas,\n+    COUNT(CASE WHEN r.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n+    COUNT(CASE WHEN r.tipo = 'SALIDA' THEN 1 END) as total_salidas,\n     MAX(r.fecha_hora) as ultimo_registro\n-FROM Personas p\n-LEFT JOIN Registros_Acceso r ON p.id_persona = r.id_persona\n-WHERE p.estado = 'activo'\n-GROUP BY p.id_persona, p.nombre, p.documento, p.rol;\n+FROM personas p\n+LEFT JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n+LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+WHERE p.estado = 'ACTIVO'\n+GROUP BY p.id_persona, p.nombres, p.apellidos, p.documento, rp.nombre_rol_persona;\n \n -- Vista: Flujo de acceso por día\n CREATE OR REPLACE VIEW v_flujo_diario AS\n SELECT \n     DATE(fecha_hora) as fecha,\n-    tipo_movimiento,\n+    tipo,\n     COUNT(*) as cantidad,\n     HOUR(fecha_hora) as hora\n-FROM Registros_Acceso\n-GROUP BY DATE(fecha_hora), tipo_movimiento, HOUR(fecha_hora)\n+FROM registros_entrada_salida\n+GROUP BY DATE(fecha_hora), tipo, HOUR(fecha_hora)\n ORDER BY fecha DESC, hora;\n \n--- Vista: Historial de asistencias consolidado desde Registros_Acceso\n--- Esta vista consolida los registros diarios para compatibilidad con código existente\n-CREATE OR REPLACE VIEW v_historial_asistencias_consolidado AS\n-SELECT \n-    r.id_registro as id_registro_acceso,\n-    r.id_persona,\n-    p.id_ficha,\n-    r.id_ambiente,\n-    DATE(r.fecha_hora) as fecha,\n-    MIN(CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END) as hora_entrada,\n-    MAX(CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END) as hora_salida,\n-    r.tipo_movimiento,\n-    CASE \n-        WHEN COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) > 0 THEN 'presente'\n-        ELSE 'ausente'\n-    END as estado,\n-    GROUP_CONCAT(r.observaciones SEPARATOR ' | ') as observaciones,\n-    MIN(r.fecha_creacion) as fecha_creacion\n-FROM Registros_Acceso r\n-INNER JOIN Personas p ON r.id_persona = p.id_persona\n-GROUP BY r.id_persona, DATE(r.fecha_hora), r.id_ambiente, r.tipo_movimiento\n-ORDER BY fecha DESC, hora_entrada DESC;\n \n -- =====================================================\n -- PROCEDIMIENTOS ALMACENADOS ÚTILES\n -- =====================================================\n@@ -844,22 +768,16 @@\n DELIMITER $$\n \n DROP PROCEDURE IF EXISTS sp_registrar_entrada$$\n \n-CREATE PROCEDURE sp_registrar_entrada(\n-    IN p_id_persona INT,\n-    IN p_id_usuario INT,\n-    IN p_id_ambiente INT,\n-    IN p_metodo VARCHAR(20),\n-    IN p_observaciones TEXT\n-)\n+CREATE PROCEDURE sp_registrar_entrada(IN p_id_persona INT)\n BEGIN\n-    INSERT INTO Registros_Acceso \n-    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n+    INSERT INTO registros_entrada_salida \n+    (id_persona, tipo, fecha_hora)\n     VALUES \n-    (p_id_persona, p_id_usuario, 'entrada', p_id_ambiente, p_metodo, p_observaciones);\n+    (p_id_persona, 'ENTRADA', NOW());\n     \n-    SELECT LAST_INSERT_ID() as id_registro;\n+    SELECT LAST_INSERT_ID() as id_registro_entrada_salida;\n END$$\n \n DELIMITER ;\n \n@@ -867,22 +785,16 @@\n DELIMITER $$\n \n DROP PROCEDURE IF EXISTS sp_registrar_salida$$\n \n-CREATE PROCEDURE sp_registrar_salida(\n-    IN p_id_persona INT,\n-    IN p_id_usuario INT,\n-    IN p_id_ambiente INT,\n-    IN p_metodo VARCHAR(20),\n-    IN p_observaciones TEXT\n-)\n+CREATE PROCEDURE sp_registrar_salida(IN p_id_persona INT)\n BEGIN\n-    INSERT INTO Registros_Acceso \n-    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n+    INSERT INTO registros_entrada_salida \n+    (id_persona, tipo, fecha_hora)\n     VALUES \n-    (p_id_persona, p_id_usuario, 'salida', p_id_ambiente, p_metodo, p_observaciones);\n+    (p_id_persona, 'SALIDA', NOW());\n     \n-    SELECT LAST_INSERT_ID() as id_registro;\n+    SELECT LAST_INSERT_ID() as id_registro_entrada_salida;\n END$$\n \n DELIMITER ;\n \n@@ -892,9 +804,9 @@\n DROP PROCEDURE IF EXISTS sp_personas_dentro$$\n \n CREATE PROCEDURE sp_personas_dentro()\n BEGIN\n-    SELECT * FROM v_sesiones_abiertas;\n+    SELECT * FROM v_personas_dentro;\n END$$\n \n DELIMITER ;\n \n@@ -905,59 +817,35 @@\n \n CREATE PROCEDURE sp_ultima_accion_persona(IN p_id_persona INT)\n BEGIN\n     SELECT \n-        tipo_movimiento,\n+        tipo,\n         fecha_hora,\n         TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n-    FROM Registros_Acceso\n+    FROM registros_entrada_salida\n     WHERE id_persona = p_id_persona\n     ORDER BY fecha_hora DESC\n     LIMIT 1;\n END$$\n \n DELIMITER ;\n \n--- Sincronizar Historial_Asistencias desde Registros_Acceso (opcional)\n-DELIMITER $$\n \n-DROP PROCEDURE IF EXISTS sp_sincronizar_historial_asistencias$$\n-\n-CREATE PROCEDURE sp_sincronizar_historial_asistencias(IN p_fecha DATE)\n-BEGIN\n-    -- Eliminar registros existentes para la fecha especificada\n-    DELETE FROM Historial_Asistencias WHERE fecha = p_fecha;\n-    \n-    -- Insertar registros consolidados desde Registros_Acceso\n-    INSERT INTO Historial_Asistencias \n-    (id_persona, id_ficha, id_ambiente, id_registro_acceso, fecha, hora_entrada, hora_salida, tipo_movimiento, estado, observaciones)\n-    SELECT \n-        r.id_persona,\n-        p.id_ficha,\n-        r.id_ambiente,\n-        r.id_registro,\n-        DATE(r.fecha_hora) as fecha,\n-        CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END as hora_entrada,\n-        CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END as hora_salida,\n-        r.tipo_movimiento,\n-        'presente' as estado,\n-        r.observaciones\n-    FROM Registros_Acceso r\n-    INNER JOIN Personas p ON r.id_persona = p.id_persona\n-    WHERE DATE(r.fecha_hora) = p_fecha\n-    ORDER BY r.fecha_hora;\n-    \n-    SELECT CONCAT('Historial sincronizado para fecha: ', p_fecha) as resultado;\n-END$$\n-\n-DELIMITER ;\n-\n -- Nota: Los índices adicionales ya están incluidos en las definiciones de las tablas\n \n -- =====================================================\n -- DOCUMENTACIÓN DEL MODELO DE CIRCUITO ABIERTO\n -- =====================================================\n /*\n+MODELO DE CIRCUITO ABIERTO - Sistema de Control de Acceso SENA\n+\n+ESTRUCTURA PRINCIPAL:\n+- usuarios: Usuarios del sistema (GUARDA, ADMINISTRADOR)\n+- estados_personas: Catálogo de estados (ACTIVO, INACTIVO, SUSPENDIDO)\n+- roles_personas: Catálogo de roles (APRENDIZ, INSTRUCTOR, etc.)\n+- personas: Información de las personas registradas\n+- registros_entrada_salida: Registros independientes de entrada/salida (CIRCUITO ABIERTO)\n+\n VENTAJAS DEL CIRCUITO ABIERTO:\n \n 1. FLEXIBILIDAD TOTAL\n    - No requiere emparejar entradas con salidas\n@@ -973,90 +861,45 @@\n    - Mejor rendimiento en consultas\n    - Menos complejidad en transacciones\n    - Facilita integraciones con otros sistemas\n \n-4. ANÁLISIS\n-   - Datos más granulares\n-   - Permite análisis de patrones\n-   - Facilita reportes y estadísticas\n-\n-5. CASOS DE USO SOPORTADOS\n+CASOS DE USO SOPORTADOS:\n    - Entrada sin salida registrada\n    - Múltiples entradas consecutivas\n    - Salida sin entrada previa\n    - Corrección de registros erróneos\n \n CONSULTAS COMUNES:\n \n 1. Personas actualmente dentro:\n-   SELECT * FROM v_sesiones_abiertas;\n+   SELECT * FROM v_personas_dentro;\n+   O también: CALL sp_personas_dentro();\n \n 2. Último registro de una persona:\n    CALL sp_ultima_accion_persona(1);\n \n 3. Todos los registros de hoy:\n-   SELECT * FROM Registros_Acceso \n+   SELECT * FROM registros_entrada_salida \n    WHERE DATE(fecha_hora) = CURDATE();\n \n 4. Historial completo de una persona:\n-   SELECT * FROM Registros_Acceso \n+   SELECT * FROM registros_entrada_salida \n    WHERE id_persona = 1 \n    ORDER BY fecha_hora DESC;\n \n-MIGRACIÓN DE DATOS EXISTENTES:\n+5. Registrar entrada:\n+   CALL sp_registrar_entrada(1);\n \n-Si tienes datos en la tabla Accesos antigua, ejecuta este script para migrarlos:\n+6. Registrar salida:\n+   CALL sp_registrar_salida(1);\n \n--- Migrar entradas desde tabla Accesos antigua\n-INSERT INTO Registros_Acceso \n-(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n-SELECT \n-    id_persona,\n-    id_usuario_registro,\n-    tipo_acceso,\n-    fecha_entrada,\n-    observaciones,\n-    fecha_creacion\n-FROM Accesos\n-WHERE tipo_acceso = 'entrada' AND fecha_entrada IS NOT NULL;\n+7. Resumen de asistencia:\n+   SELECT * FROM v_resumen_asistencia;\n \n--- Migrar salidas desde tabla Accesos antigua\n-INSERT INTO Registros_Acceso \n-(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n-SELECT \n-    id_persona,\n-    id_usuario_registro,\n-    'salida',\n-    fecha_salida,\n-    observaciones,\n-    fecha_actualizacion\n-FROM Accesos\n-WHERE tipo_acceso = 'salida' AND fecha_salida IS NOT NULL;\n-\n--- Si la tabla Accesos tenía registros con fecha_entrada pero sin fecha_salida,\n--- migrar solo como entrada\n-INSERT INTO Registros_Acceso \n-(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n-SELECT \n-    id_persona,\n-    id_usuario_registro,\n-    'entrada',\n-    fecha_entrada,\n-    observaciones,\n-    fecha_creacion\n-FROM Accesos\n-WHERE fecha_entrada IS NOT NULL \n-  AND fecha_salida IS NULL\n-  AND tipo_acceso = 'entrada';\n-\n NOTAS IMPORTANTES:\n \n-1. La tabla Historial_Asistencias ahora es OPCIONAL y puede ser poblada usando:\n-   CALL sp_sincronizar_historial_asistencias('2024-01-15');\n-\n-2. Para consultas diarias, usa la vista v_historial_asistencias_consolidado\n-\n-3. Todos los nuevos registros deben hacerse directamente en Registros_Acceso\n-\n-4. La tabla Sesiones_Acceso se genera automáticamente mediante triggers\n+1. Cada registro en registros_entrada_salida es INDEPENDIENTE\n+2. No se requiere emparejar entradas con salidas\n+3. La vista v_personas_dentro muestra personas cuya última acción fue ENTRADA\n+4. Los procedimientos almacenados simplifican las operaciones comunes\n */\n \n"
                },
                {
                    "date": 1763669510878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,117 +1,115 @@\n -- =====================================================\n -- ESQUEMA COMPLETO DE BASE DE DATOS\n--- Sistema de Control de Acceso SENA - CIRCUITO ABIERTO\n+-- Sistema de Control de Acceso SENA\n -- =====================================================\n \n -- Crear base de datos si no existe\n-CREATE DATABASE IF NOT EXISTS sena_acceso \n+CREATE DATABASE IF NOT EXISTS control_acceso_sena \n CHARACTER SET utf8mb4 \n COLLATE utf8mb4_unicode_ci;\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n--- TABLA: usuarios\n+-- TABLA: Roles\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS usuarios (\n-  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n-  nombre VARCHAR(100),\n-  email VARCHAR(100),\n-  passwords VARCHAR(255),\n-  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\n-  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-  ultimo_acceso TIMESTAMP NULL,\n-  INDEX idx_email (email),\n-  INDEX idx_rol (rol),\n-  INDEX idx_estado (estado)\n+CREATE TABLE IF NOT EXISTS Roles (\n+    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n+    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n+    descripcion VARCHAR(255),\n+    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    INDEX idx_nombre_rol (nombre_rol),\n+    INDEX idx_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n--- =====================================================\n--- TABLA: estados_personas (Catálogo)\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS estados_personas (\n-  id_estado_persona INT AUTO_INCREMENT PRIMARY KEY,\n-  nombre_estado VARCHAR(20) NOT NULL UNIQUE,\n-  INDEX idx_nombre_estado (nombre_estado)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+INSERT INTO Roles (nombre_rol, descripcion) VALUES\n+('aprendiz', 'Aprendiz del SENA'),\n+('instructor', 'Instructor del SENA'),\n+('administrativo', 'Personal administrativo'),\n+('visitante', 'Visitante temporal'),\n+('guarda', 'Guarda de seguridad'),\n+('admin', 'Administrador del sistema')\n+ON DUPLICATE KEY UPDATE nombre_rol=nombre_rol;\n \n--- Insertar estados por defecto\n-INSERT INTO estados_personas (nombre_estado) VALUES\n-('ACTIVO'),\n-('INACTIVO'),\n-('SUSPENDIDO')\n-ON DUPLICATE KEY UPDATE nombre_estado=nombre_estado;\n-\n -- =====================================================\n--- TABLA: roles_personas (Catálogo)\n+-- TABLA: Usuarios\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS roles_personas (\n-  id_rol_persona INT AUTO_INCREMENT PRIMARY KEY,\n-  nombre_rol_persona VARCHAR(30) NOT NULL UNIQUE,\n-  INDEX idx_nombre_rol (nombre_rol_persona)\n+CREATE TABLE IF NOT EXISTS Usuarios (\n+    id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n+    nombre VARCHAR(255) NOT NULL,\n+    email VARCHAR(255) UNIQUE NOT NULL,\n+    password_hash VARCHAR(255) NOT NULL,\n+    rol ENUM('admin', 'guarda') NOT NULL DEFAULT 'guarda',\n+    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    INDEX idx_email (email),\n+    INDEX idx_rol (rol),\n+    INDEX idx_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n--- Insertar roles por defecto\n-INSERT INTO roles_personas (nombre_rol_persona) VALUES\n-('APRENDIZ'),\n-('INSTRUCTOR'),\n-('ADMINISTRATIVO'),\n-('VISITANTE'),\n-('GUARDA'),\n-('ADMINISTRADOR')\n-ON DUPLICATE KEY UPDATE nombre_rol_persona=nombre_rol_persona;\n-\n -- =====================================================\n--- TABLA: personas\n+-- TABLA: Personas\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS personas (\n-  id_persona INT AUTO_INCREMENT PRIMARY KEY,\n-  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\n-  documento VARCHAR(50) UNIQUE,\n-  nombres VARCHAR(100),\n-  apellidos VARCHAR(100),\n-  codigo_qr VARCHAR(255),\n-  programa VARCHAR(200),\n-  ficha VARCHAR(50),\n-  zona VARCHAR(200) COMMENT 'Zona o destino donde va la persona o visitante',\n-  foto VARCHAR(500) COMMENT 'Ruta del archivo de foto (formato: uploads/fotos/[documento]-[timestamp].jpg)',\n-  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n-  fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-  fecha_expiracion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Hora exacta de registro de la persona',\n-  id_usuario INT,\n-  id_estado_persona INT,\n-  id_rol_persona INT,\n-  FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n-  FOREIGN KEY (id_estado_persona) REFERENCES estados_personas (id_estado_persona) ON DELETE SET NULL,\n-  FOREIGN KEY (id_rol_persona) REFERENCES roles_personas (id_rol_persona) ON DELETE SET NULL,\n-  INDEX idx_documento (documento),\n-  INDEX idx_tipo_documento (tipo_documento),\n-  INDEX idx_codigo_qr (codigo_qr),\n-  INDEX idx_estado (estado),\n-  INDEX idx_id_usuario (id_usuario),\n-  INDEX idx_id_estado_persona (id_estado_persona),\n-  INDEX idx_id_rol_persona (id_rol_persona)\n+CREATE TABLE IF NOT EXISTS Personas (\n+    id_persona INT AUTO_INCREMENT PRIMARY KEY,\n+    nombre VARCHAR(255) NOT NULL,\n+    documento VARCHAR(50) NOT NULL,\n+    tipo_documento ENUM('CC', 'CE', 'TI', 'PA', 'NIT') NOT NULL DEFAULT 'CC',\n+    email VARCHAR(255),\n+    telefono VARCHAR(20),\n+    rh VARCHAR(10) NULL COMMENT 'Grupo sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)',\n+    foto VARCHAR(500),\n+    id_rol INT,\n+    rol VARCHAR(50) DEFAULT 'aprendiz',\n+    estado ENUM('activo', 'inactivo', 'suspendido') NOT NULL DEFAULT 'activo',\n+    -- Campos académicos\n+    id_programa INT NULL COMMENT 'Referencia a Programas_Formacion',\n+    ficha VARCHAR(50) NULL COMMENT 'Código de ficha del aprendiz',\n+    id_ficha INT NULL COMMENT 'Referencia a tabla Fichas',\n+    programa VARCHAR(100) NULL COMMENT 'Nombre del programa (legacy)',\n+    jornada ENUM('diurna', 'nocturna', 'mixta') NULL COMMENT 'Jornada de formación',\n+    fecha_inicio_formacion DATE NULL COMMENT 'Fecha de inicio de formación',\n+    fecha_fin_formacion DATE NULL COMMENT 'Fecha de fin de formación',\n+    -- Campos laborales\n+    cargo VARCHAR(100) NULL COMMENT 'Cargo para instructores y administrativos',\n+    -- Campos de control\n+    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    FOREIGN KEY (id_rol) REFERENCES Roles(id_rol) ON DELETE SET NULL,\n+    INDEX idx_documento (documento),\n+    INDEX idx_tipo_documento (tipo_documento),\n+    INDEX idx_rol (rol),\n+    INDEX idx_estado (estado),\n+    INDEX idx_id_rol (id_rol),\n+    INDEX idx_rh (rh),\n+    INDEX idx_jornada (jornada),\n+    INDEX idx_fechas_formacion (fecha_inicio_formacion, fecha_fin_formacion),\n+    INDEX idx_personas_programa (id_programa),\n+    INDEX idx_personas_ficha (ficha),\n+    INDEX idx_personas_ficha_id (id_ficha),\n+    UNIQUE KEY uk_documento_tipo (documento, tipo_documento)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n \n -- =====================================================\n--- TABLA: Visitantes (Opcional - puede ser eliminada si no se usa)\n+-- TABLA: Visitantes\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS visitantes (\n+CREATE TABLE IF NOT EXISTS Visitantes (\n     id_visitante INT AUTO_INCREMENT PRIMARY KEY,\n     id_persona INT NOT NULL,\n     motivo_visita TEXT NOT NULL,\n     contacto VARCHAR(255),\n     persona_visita VARCHAR(255),\n     fecha_inicio TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n     fecha_fin TIMESTAMP NULL,\n-    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') NOT NULL DEFAULT 'ACTIVO',\n+    estado ENUM('activo', 'finalizado', 'expirado') NOT NULL DEFAULT 'activo',\n     fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n     fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n     INDEX idx_id_persona (id_persona),\n     INDEX idx_estado (estado),\n     INDEX idx_fecha_inicio (fecha_inicio),\n     INDEX idx_fecha_fin (fecha_fin)\n@@ -119,11 +117,11 @@\n \n \n \n -- =====================================================\n--- TABLA: logs_seguridad (Opcional)\n+-- TABLA: Logs_Seguridad\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS logs_seguridad (\n+CREATE TABLE IF NOT EXISTS Logs_Seguridad (\n     id_log INT AUTO_INCREMENT PRIMARY KEY,\n     tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', 'modificacion_usuario', 'modificacion_config', 'generacion_reporte', 'acceso_sistema', 'operacion_admin') NOT NULL,\n     id_usuario INT,\n     ip_address VARCHAR(45),\n@@ -131,9 +129,9 @@\n     accion TEXT NOT NULL,\n     detalles JSON,\n     exito BOOLEAN DEFAULT TRUE,\n     fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n     INDEX idx_tipo (tipo),\n     INDEX idx_id_usuario (id_usuario),\n     INDEX idx_ip_address (ip_address),\n     INDEX idx_fecha (fecha),\n@@ -205,9 +203,9 @@\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n -- TABLA: Programas_Formacion\n -- =====================================================\n@@ -249,22 +247,48 @@\n     INDEX idx_ambiente_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n--- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n+-- MIGRACIÓN A CIRCUITO ABIERTO\n+-- Eliminar tabla Accesos antigua y sus dependencias\n+-- =====================================================\n+-- IMPORTANTE: Si la base de datos ya existe, ejecutar manualmente antes:\n+-- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n+-- ALTER TABLE Historial_Asistencias DROP FOREIGN KEY IF EXISTS historial_asistencias_ibfk_X;\n+\n+DROP TABLE IF EXISTS Accesos;\n+\n+-- =====================================================\n+-- TABLA: Registros_Acceso (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS registros_entrada_salida (\n-  id_registro_entrada_salida INT AUTO_INCREMENT PRIMARY KEY,\n-  id_persona INT,\n-  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\n-  fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha y hora exacta del registro (entrada o salida)',\n-  FOREIGN KEY (id_persona) REFERENCES personas (id_persona) ON DELETE CASCADE,\n-  INDEX idx_registro_persona (id_persona),\n-  INDEX idx_registro_tipo (tipo),\n-  INDEX idx_registro_fecha (fecha_hora),\n-  INDEX idx_persona_fecha (id_persona, fecha_hora),\n-  INDEX idx_persona_tipo_fecha (id_persona, tipo, fecha_hora)\n+CREATE TABLE IF NOT EXISTS Registros_Acceso (\n+    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    id_usuario_registro INT,\n+    tipo_movimiento ENUM('entrada', 'salida') NOT NULL,\n+    fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+    id_ambiente INT NULL COMMENT 'Ambiente donde ocurrió el registro',\n+    metodo_registro ENUM('qr', 'manual', 'biometrico', 'tarjeta') DEFAULT 'qr',\n+    ip_address VARCHAR(45),\n+    geolocalizacion VARCHAR(100),\n+    observaciones TEXT,\n+    metadata JSON COMMENT 'Información adicional del registro',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    \n+    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n+    \n+    INDEX idx_registro_persona (id_persona),\n+    INDEX idx_registro_tipo (tipo_movimiento),\n+    INDEX idx_registro_fecha (fecha_hora),\n+    INDEX idx_registro_ambiente (id_ambiente),\n+    INDEX idx_registro_usuario (id_usuario_registro),\n+    INDEX idx_registro_metodo (metodo_registro),\n+    INDEX idx_persona_fecha (id_persona, fecha_hora),\n+    INDEX idx_registro_persona_fecha_tipo (id_persona, fecha_hora, tipo_movimiento)\n+    \n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n \n -- =====================================================\n@@ -354,9 +378,9 @@\n -- ESQUEMA DE INTEGRACIÓN QR + BD\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n -- TABLA: Fichas\n -- =====================================================\n@@ -478,9 +502,9 @@\n -- ACTUALIZACIÓN DE ESQUEMA PARA IMPORTACIÓN MASIVA\n -- Campos adicionales por rol\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n -- MODIFICAR TABLA: Personas\n -- Agregar campos adicionales para importación\n@@ -505,9 +529,9 @@\n -- TABLA: Fichas\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- Crear tabla Fichas si no existe\n CREATE TABLE IF NOT EXISTS Fichas (\n     id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n@@ -568,9 +592,9 @@\n -- INSERCIÓN DE PROGRAMAS DE FORMACIÓN - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n -- PROGRAMAS TÉCNICOS\n -- =====================================================\n@@ -675,91 +699,143 @@\n -- Total general: 50 programas\n -- =====================================================\n \n -- =====================================================\n--- VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n+-- TRIGGERS, VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n+-- TRIGGER PARA AUTO-GENERAR SESIONES\n+-- =====================================================\n+DELIMITER $$\n+\n+DROP TRIGGER IF EXISTS trg_generar_sesion_entrada$$\n+\n+CREATE TRIGGER trg_generar_sesion_entrada\n+AFTER INSERT ON Registros_Acceso\n+FOR EACH ROW\n+BEGIN\n+    -- Si es una ENTRADA, crear nueva sesión abierta\n+    IF NEW.tipo_movimiento = 'entrada' THEN\n+        INSERT INTO Sesiones_Acceso \n+        (id_persona, id_registro_entrada, fecha_entrada, estado)\n+        VALUES \n+        (NEW.id_persona, NEW.id_registro, NEW.fecha_hora, 'abierta');\n+    END IF;\n+    \n+    -- Si es una SALIDA, intentar cerrar la última sesión abierta\n+    IF NEW.tipo_movimiento = 'salida' THEN\n+        UPDATE Sesiones_Acceso \n+        SET \n+            id_registro_salida = NEW.id_registro,\n+            fecha_salida = NEW.fecha_hora,\n+            duracion_minutos = TIMESTAMPDIFF(MINUTE, fecha_entrada, NEW.fecha_hora),\n+            estado = 'cerrada'\n+        WHERE \n+            id_persona = NEW.id_persona \n+            AND estado = 'abierta'\n+            AND id_registro_salida IS NULL\n+        ORDER BY fecha_entrada DESC\n+        LIMIT 1;\n+    END IF;\n+END$$\n+\n+DELIMITER ;\n+\n+-- =====================================================\n -- VISTAS ÚTILES PARA CONSULTAS\n -- =====================================================\n \n -- Vista: Últimos registros de acceso\n CREATE OR REPLACE VIEW v_ultimos_registros AS\n SELECT \n-    r.id_registro_entrada_salida,\n-    r.tipo,\n+    r.id_registro,\n+    r.tipo_movimiento,\n     r.fecha_hora,\n     p.id_persona,\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.nombre,\n     p.documento,\n-    rp.nombre_rol_persona as rol,\n-    p.zona\n-FROM registros_entrada_salida r\n-INNER JOIN personas p ON r.id_persona = p.id_persona\n-LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+    p.rol,\n+    a.nombre_ambiente,\n+    r.metodo_registro,\n+    u.nombre as usuario_registro\n+FROM Registros_Acceso r\n+INNER JOIN Personas p ON r.id_persona = p.id_persona\n+LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n+LEFT JOIN Usuarios u ON r.id_usuario_registro = u.id_usuario\n ORDER BY r.fecha_hora DESC;\n \n--- Vista: Personas actualmente dentro (última acción fue ENTRADA sin SALIDA posterior)\n-CREATE OR REPLACE VIEW v_personas_dentro AS\n+-- Vista: Sesiones abiertas (personas actualmente dentro)\n+CREATE OR REPLACE VIEW v_sesiones_abiertas AS\n SELECT \n-    p.id_persona,\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    s.id_sesion,\n+    s.id_persona,\n+    p.nombre,\n     p.documento,\n-    rp.nombre_rol_persona as rol,\n+    p.rol,\n     p.foto,\n-    r.fecha_hora as fecha_entrada,\n-    TIMESTAMPDIFF(MINUTE, r.fecha_hora, NOW()) as minutos_dentro,\n-    p.zona\n-FROM personas p\n-INNER JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n-LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n-WHERE r.tipo = 'ENTRADA'\n-  AND r.fecha_hora = (\n-    SELECT MAX(fecha_hora) \n-    FROM registros_entrada_salida \n-    WHERE id_persona = p.id_persona\n-  )\n-  AND NOT EXISTS (\n-    SELECT 1 \n-    FROM registros_entrada_salida r2 \n-    WHERE r2.id_persona = p.id_persona \n-      AND r2.tipo = 'SALIDA' \n-      AND r2.fecha_hora > r.fecha_hora\n-  )\n-  AND p.estado = 'ACTIVO';\n+    s.fecha_entrada,\n+    TIMESTAMPDIFF(MINUTE, s.fecha_entrada, NOW()) as minutos_dentro,\n+    r.id_ambiente,\n+    a.nombre_ambiente\n+FROM Sesiones_Acceso s\n+INNER JOIN Personas p ON s.id_persona = p.id_persona\n+LEFT JOIN Registros_Acceso r ON s.id_registro_entrada = r.id_registro\n+LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n+WHERE s.estado = 'abierta';\n \n -- Vista: Resumen de asistencia por persona\n CREATE OR REPLACE VIEW v_resumen_asistencia AS\n SELECT \n     p.id_persona,\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.nombre,\n     p.documento,\n-    rp.nombre_rol_persona as rol,\n+    p.rol,\n     COUNT(DISTINCT DATE(r.fecha_hora)) as dias_asistencia,\n-    COUNT(CASE WHEN r.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n-    COUNT(CASE WHEN r.tipo = 'SALIDA' THEN 1 END) as total_salidas,\n+    COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) as total_entradas,\n+    COUNT(CASE WHEN r.tipo_movimiento = 'salida' THEN 1 END) as total_salidas,\n     MAX(r.fecha_hora) as ultimo_registro\n-FROM personas p\n-LEFT JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n-LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n-WHERE p.estado = 'ACTIVO'\n-GROUP BY p.id_persona, p.nombres, p.apellidos, p.documento, rp.nombre_rol_persona;\n+FROM Personas p\n+LEFT JOIN Registros_Acceso r ON p.id_persona = r.id_persona\n+WHERE p.estado = 'activo'\n+GROUP BY p.id_persona, p.nombre, p.documento, p.rol;\n \n -- Vista: Flujo de acceso por día\n CREATE OR REPLACE VIEW v_flujo_diario AS\n SELECT \n     DATE(fecha_hora) as fecha,\n-    tipo,\n+    tipo_movimiento,\n     COUNT(*) as cantidad,\n     HOUR(fecha_hora) as hora\n-FROM registros_entrada_salida\n-GROUP BY DATE(fecha_hora), tipo, HOUR(fecha_hora)\n+FROM Registros_Acceso\n+GROUP BY DATE(fecha_hora), tipo_movimiento, HOUR(fecha_hora)\n ORDER BY fecha DESC, hora;\n \n+-- Vista: Historial de asistencias consolidado desde Registros_Acceso\n+-- Esta vista consolida los registros diarios para compatibilidad con código existente\n+CREATE OR REPLACE VIEW v_historial_asistencias_consolidado AS\n+SELECT \n+    r.id_registro as id_registro_acceso,\n+    r.id_persona,\n+    p.id_ficha,\n+    r.id_ambiente,\n+    DATE(r.fecha_hora) as fecha,\n+    MIN(CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END) as hora_entrada,\n+    MAX(CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END) as hora_salida,\n+    r.tipo_movimiento,\n+    CASE \n+        WHEN COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) > 0 THEN 'presente'\n+        ELSE 'ausente'\n+    END as estado,\n+    GROUP_CONCAT(r.observaciones SEPARATOR ' | ') as observaciones,\n+    MIN(r.fecha_creacion) as fecha_creacion\n+FROM Registros_Acceso r\n+INNER JOIN Personas p ON r.id_persona = p.id_persona\n+GROUP BY r.id_persona, DATE(r.fecha_hora), r.id_ambiente, r.tipo_movimiento\n+ORDER BY fecha DESC, hora_entrada DESC;\n \n -- =====================================================\n -- PROCEDIMIENTOS ALMACENADOS ÚTILES\n -- =====================================================\n@@ -768,16 +844,22 @@\n DELIMITER $$\n \n DROP PROCEDURE IF EXISTS sp_registrar_entrada$$\n \n-CREATE PROCEDURE sp_registrar_entrada(IN p_id_persona INT)\n+CREATE PROCEDURE sp_registrar_entrada(\n+    IN p_id_persona INT,\n+    IN p_id_usuario INT,\n+    IN p_id_ambiente INT,\n+    IN p_metodo VARCHAR(20),\n+    IN p_observaciones TEXT\n+)\n BEGIN\n-    INSERT INTO registros_entrada_salida \n-    (id_persona, tipo, fecha_hora)\n+    INSERT INTO Registros_Acceso \n+    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n     VALUES \n-    (p_id_persona, 'ENTRADA', NOW());\n+    (p_id_persona, p_id_usuario, 'entrada', p_id_ambiente, p_metodo, p_observaciones);\n     \n-    SELECT LAST_INSERT_ID() as id_registro_entrada_salida;\n+    SELECT LAST_INSERT_ID() as id_registro;\n END$$\n \n DELIMITER ;\n \n@@ -785,16 +867,22 @@\n DELIMITER $$\n \n DROP PROCEDURE IF EXISTS sp_registrar_salida$$\n \n-CREATE PROCEDURE sp_registrar_salida(IN p_id_persona INT)\n+CREATE PROCEDURE sp_registrar_salida(\n+    IN p_id_persona INT,\n+    IN p_id_usuario INT,\n+    IN p_id_ambiente INT,\n+    IN p_metodo VARCHAR(20),\n+    IN p_observaciones TEXT\n+)\n BEGIN\n-    INSERT INTO registros_entrada_salida \n-    (id_persona, tipo, fecha_hora)\n+    INSERT INTO Registros_Acceso \n+    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n     VALUES \n-    (p_id_persona, 'SALIDA', NOW());\n+    (p_id_persona, p_id_usuario, 'salida', p_id_ambiente, p_metodo, p_observaciones);\n     \n-    SELECT LAST_INSERT_ID() as id_registro_entrada_salida;\n+    SELECT LAST_INSERT_ID() as id_registro;\n END$$\n \n DELIMITER ;\n \n@@ -804,9 +892,9 @@\n DROP PROCEDURE IF EXISTS sp_personas_dentro$$\n \n CREATE PROCEDURE sp_personas_dentro()\n BEGIN\n-    SELECT * FROM v_personas_dentro;\n+    SELECT * FROM v_sesiones_abiertas;\n END$$\n \n DELIMITER ;\n \n@@ -817,35 +905,59 @@\n \n CREATE PROCEDURE sp_ultima_accion_persona(IN p_id_persona INT)\n BEGIN\n     SELECT \n-        tipo,\n+        tipo_movimiento,\n         fecha_hora,\n         TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n-    FROM registros_entrada_salida\n+    FROM Registros_Acceso\n     WHERE id_persona = p_id_persona\n     ORDER BY fecha_hora DESC\n     LIMIT 1;\n END$$\n \n DELIMITER ;\n \n+-- Sincronizar Historial_Asistencias desde Registros_Acceso (opcional)\n+DELIMITER $$\n \n+DROP PROCEDURE IF EXISTS sp_sincronizar_historial_asistencias$$\n+\n+CREATE PROCEDURE sp_sincronizar_historial_asistencias(IN p_fecha DATE)\n+BEGIN\n+    -- Eliminar registros existentes para la fecha especificada\n+    DELETE FROM Historial_Asistencias WHERE fecha = p_fecha;\n+    \n+    -- Insertar registros consolidados desde Registros_Acceso\n+    INSERT INTO Historial_Asistencias \n+    (id_persona, id_ficha, id_ambiente, id_registro_acceso, fecha, hora_entrada, hora_salida, tipo_movimiento, estado, observaciones)\n+    SELECT \n+        r.id_persona,\n+        p.id_ficha,\n+        r.id_ambiente,\n+        r.id_registro,\n+        DATE(r.fecha_hora) as fecha,\n+        CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END as hora_entrada,\n+        CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END as hora_salida,\n+        r.tipo_movimiento,\n+        'presente' as estado,\n+        r.observaciones\n+    FROM Registros_Acceso r\n+    INNER JOIN Personas p ON r.id_persona = p.id_persona\n+    WHERE DATE(r.fecha_hora) = p_fecha\n+    ORDER BY r.fecha_hora;\n+    \n+    SELECT CONCAT('Historial sincronizado para fecha: ', p_fecha) as resultado;\n+END$$\n+\n+DELIMITER ;\n+\n -- Nota: Los índices adicionales ya están incluidos en las definiciones de las tablas\n \n -- =====================================================\n -- DOCUMENTACIÓN DEL MODELO DE CIRCUITO ABIERTO\n -- =====================================================\n /*\n-MODELO DE CIRCUITO ABIERTO - Sistema de Control de Acceso SENA\n-\n-ESTRUCTURA PRINCIPAL:\n-- usuarios: Usuarios del sistema (GUARDA, ADMINISTRADOR)\n-- estados_personas: Catálogo de estados (ACTIVO, INACTIVO, SUSPENDIDO)\n-- roles_personas: Catálogo de roles (APRENDIZ, INSTRUCTOR, etc.)\n-- personas: Información de las personas registradas\n-- registros_entrada_salida: Registros independientes de entrada/salida (CIRCUITO ABIERTO)\n-\n VENTAJAS DEL CIRCUITO ABIERTO:\n \n 1. FLEXIBILIDAD TOTAL\n    - No requiere emparejar entradas con salidas\n@@ -861,45 +973,90 @@\n    - Mejor rendimiento en consultas\n    - Menos complejidad en transacciones\n    - Facilita integraciones con otros sistemas\n \n-CASOS DE USO SOPORTADOS:\n+4. ANÁLISIS\n+   - Datos más granulares\n+   - Permite análisis de patrones\n+   - Facilita reportes y estadísticas\n+\n+5. CASOS DE USO SOPORTADOS\n    - Entrada sin salida registrada\n    - Múltiples entradas consecutivas\n    - Salida sin entrada previa\n    - Corrección de registros erróneos\n \n CONSULTAS COMUNES:\n \n 1. Personas actualmente dentro:\n-   SELECT * FROM v_personas_dentro;\n-   O también: CALL sp_personas_dentro();\n+   SELECT * FROM v_sesiones_abiertas;\n \n 2. Último registro de una persona:\n    CALL sp_ultima_accion_persona(1);\n \n 3. Todos los registros de hoy:\n-   SELECT * FROM registros_entrada_salida \n+   SELECT * FROM Registros_Acceso \n    WHERE DATE(fecha_hora) = CURDATE();\n \n 4. Historial completo de una persona:\n-   SELECT * FROM registros_entrada_salida \n+   SELECT * FROM Registros_Acceso \n    WHERE id_persona = 1 \n    ORDER BY fecha_hora DESC;\n \n-5. Registrar entrada:\n-   CALL sp_registrar_entrada(1);\n+MIGRACIÓN DE DATOS EXISTENTES:\n \n-6. Registrar salida:\n-   CALL sp_registrar_salida(1);\n+Si tienes datos en la tabla Accesos antigua, ejecuta este script para migrarlos:\n \n-7. Resumen de asistencia:\n-   SELECT * FROM v_resumen_asistencia;\n+-- Migrar entradas desde tabla Accesos antigua\n+INSERT INTO Registros_Acceso \n+(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n+SELECT \n+    id_persona,\n+    id_usuario_registro,\n+    tipo_acceso,\n+    fecha_entrada,\n+    observaciones,\n+    fecha_creacion\n+FROM Accesos\n+WHERE tipo_acceso = 'entrada' AND fecha_entrada IS NOT NULL;\n \n+-- Migrar salidas desde tabla Accesos antigua\n+INSERT INTO Registros_Acceso \n+(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n+SELECT \n+    id_persona,\n+    id_usuario_registro,\n+    'salida',\n+    fecha_salida,\n+    observaciones,\n+    fecha_actualizacion\n+FROM Accesos\n+WHERE tipo_acceso = 'salida' AND fecha_salida IS NOT NULL;\n+\n+-- Si la tabla Accesos tenía registros con fecha_entrada pero sin fecha_salida,\n+-- migrar solo como entrada\n+INSERT INTO Registros_Acceso \n+(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n+SELECT \n+    id_persona,\n+    id_usuario_registro,\n+    'entrada',\n+    fecha_entrada,\n+    observaciones,\n+    fecha_creacion\n+FROM Accesos\n+WHERE fecha_entrada IS NOT NULL \n+  AND fecha_salida IS NULL\n+  AND tipo_acceso = 'entrada';\n+\n NOTAS IMPORTANTES:\n \n-1. Cada registro en registros_entrada_salida es INDEPENDIENTE\n-2. No se requiere emparejar entradas con salidas\n-3. La vista v_personas_dentro muestra personas cuya última acción fue ENTRADA\n-4. Los procedimientos almacenados simplifican las operaciones comunes\n+1. La tabla Historial_Asistencias ahora es OPCIONAL y puede ser poblada usando:\n+   CALL sp_sincronizar_historial_asistencias('2024-01-15');\n+\n+2. Para consultas diarias, usa la vista v_historial_asistencias_consolidado\n+\n+3. Todos los nuevos registros deben hacerse directamente en Registros_Acceso\n+\n+4. La tabla Sesiones_Acceso se genera automáticamente mediante triggers\n */\n \n"
                },
                {
                    "date": 1763669585667,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,97 +1,99 @@\n -- =====================================================\n -- ESQUEMA COMPLETO DE BASE DE DATOS\n--- Sistema de Control de Acceso SENA\n+-- Sistema de Control de Acceso SENA - CIRCUITO ABIERTO\n -- =====================================================\n \n -- Crear base de datos si no existe\n-CREATE DATABASE IF NOT EXISTS control_acceso_sena \n+CREATE DATABASE IF NOT EXISTS sena_acceso \n CHARACTER SET utf8mb4 \n COLLATE utf8mb4_unicode_ci;\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n--- TABLA: Roles\n+-- TABLA: usuarios\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Roles (\n-    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n-    descripcion VARCHAR(255),\n-    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_nombre_rol (nombre_rol),\n-    INDEX idx_estado (estado)\n+CREATE TABLE IF NOT EXISTS usuarios (\n+  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre VARCHAR(100),\n+  email VARCHAR(100),\n+  passwords VARCHAR(255),\n+  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\n+  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  ultimo_acceso TIMESTAMP NULL,\n+  INDEX idx_email (email),\n+  INDEX idx_rol (rol),\n+  INDEX idx_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n-INSERT INTO Roles (nombre_rol, descripcion) VALUES\n-('aprendiz', 'Aprendiz del SENA'),\n-('instructor', 'Instructor del SENA'),\n-('administrativo', 'Personal administrativo'),\n-('visitante', 'Visitante temporal'),\n-('guarda', 'Guarda de seguridad'),\n-('admin', 'Administrador del sistema')\n-ON DUPLICATE KEY UPDATE nombre_rol=nombre_rol;\n+-- =====================================================\n+-- TABLA: estados_personas (Catálogo)\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS estados_personas (\n+  id_estado_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre_estado VARCHAR(20),\n+  INDEX idx_nombre_estado (nombre_estado)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n+-- Insertar estados por defecto\n+INSERT INTO estados_personas (nombre_estado) VALUES\n+('ACTIVO'),\n+('INACTIVO'),\n+('SUSPENDIDO')\n+ON DUPLICATE KEY UPDATE nombre_estado=nombre_estado;\n+\n -- =====================================================\n--- TABLA: Usuarios\n+-- TABLA: roles_personas (Catálogo)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Usuarios (\n-    id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre VARCHAR(255) NOT NULL,\n-    email VARCHAR(255) UNIQUE NOT NULL,\n-    password_hash VARCHAR(255) NOT NULL,\n-    rol ENUM('admin', 'guarda') NOT NULL DEFAULT 'guarda',\n-    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_email (email),\n-    INDEX idx_rol (rol),\n-    INDEX idx_estado (estado)\n+CREATE TABLE IF NOT EXISTS roles_personas (\n+  id_rol_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre_rol_persona VARCHAR(30),\n+  INDEX idx_nombre_rol (nombre_rol_persona)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n+-- Insertar roles por defecto\n+INSERT INTO roles_personas (nombre_rol_persona) VALUES\n+('APRENDIZ'),\n+('INSTRUCTOR'),\n+('ADMINISTRATIVO'),\n+('VISITANTE'),\n+('GUARDA'),\n+('ADMINISTRADOR')\n+ON DUPLICATE KEY UPDATE nombre_rol_persona=nombre_rol_persona;\n+\n -- =====================================================\n--- TABLA: Personas\n+-- TABLA: personas\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Personas (\n-    id_persona INT AUTO_INCREMENT PRIMARY KEY,\n-    nombre VARCHAR(255) NOT NULL,\n-    documento VARCHAR(50) NOT NULL,\n-    tipo_documento ENUM('CC', 'CE', 'TI', 'PA', 'NIT') NOT NULL DEFAULT 'CC',\n-    email VARCHAR(255),\n-    telefono VARCHAR(20),\n-    rh VARCHAR(10) NULL COMMENT 'Grupo sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)',\n-    foto VARCHAR(500),\n-    id_rol INT,\n-    rol VARCHAR(50) DEFAULT 'aprendiz',\n-    estado ENUM('activo', 'inactivo', 'suspendido') NOT NULL DEFAULT 'activo',\n-    -- Campos académicos\n-    id_programa INT NULL COMMENT 'Referencia a Programas_Formacion',\n-    ficha VARCHAR(50) NULL COMMENT 'Código de ficha del aprendiz',\n-    id_ficha INT NULL COMMENT 'Referencia a tabla Fichas',\n-    programa VARCHAR(100) NULL COMMENT 'Nombre del programa (legacy)',\n-    jornada ENUM('diurna', 'nocturna', 'mixta') NULL COMMENT 'Jornada de formación',\n-    fecha_inicio_formacion DATE NULL COMMENT 'Fecha de inicio de formación',\n-    fecha_fin_formacion DATE NULL COMMENT 'Fecha de fin de formación',\n-    -- Campos laborales\n-    cargo VARCHAR(100) NULL COMMENT 'Cargo para instructores y administrativos',\n-    -- Campos de control\n-    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_rol) REFERENCES Roles(id_rol) ON DELETE SET NULL,\n-    INDEX idx_documento (documento),\n-    INDEX idx_tipo_documento (tipo_documento),\n-    INDEX idx_rol (rol),\n-    INDEX idx_estado (estado),\n-    INDEX idx_id_rol (id_rol),\n-    INDEX idx_rh (rh),\n-    INDEX idx_jornada (jornada),\n-    INDEX idx_fechas_formacion (fecha_inicio_formacion, fecha_fin_formacion),\n-    INDEX idx_personas_programa (id_programa),\n-    INDEX idx_personas_ficha (ficha),\n-    INDEX idx_personas_ficha_id (id_ficha),\n-    UNIQUE KEY uk_documento_tipo (documento, tipo_documento)\n+CREATE TABLE IF NOT EXISTS personas (\n+  id_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\n+  documento VARCHAR(50) UNIQUE,\n+  nombres VARCHAR(100),\n+  apellidos VARCHAR(100),\n+  codigo_qr VARCHAR(255),\n+  programa VARCHAR(200),\n+  ficha VARCHAR(50),\n+  zona VARCHAR(200) COMMENT 'Zona o destino donde va la persona o visitante',\n+  foto VARCHAR(500) COMMENT 'Ruta del archivo de foto (formato: uploads/fotos/[documento]-[timestamp].jpg)',\n+  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+  fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_expiracion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Hora exacta de registro de la persona',\n+  id_usuario INT,\n+  id_estado_persona INT,\n+  id_rol_persona INT,\n+  FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n+  FOREIGN KEY (id_estado_persona) REFERENCES estados_personas (id_estado_persona) ON DELETE SET NULL,\n+  FOREIGN KEY (id_rol_persona) REFERENCES roles_personas (id_rol_persona) ON DELETE SET NULL,\n+  INDEX idx_documento (documento),\n+  INDEX idx_tipo_documento (tipo_documento),\n+  INDEX idx_codigo_qr (codigo_qr),\n+  INDEX idx_estado (estado),\n+  INDEX idx_id_usuario (id_usuario),\n+  INDEX idx_id_estado_persona (id_estado_persona),\n+  INDEX idx_id_rol_persona (id_rol_persona)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n \n -- =====================================================\n@@ -203,95 +205,166 @@\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n--- TABLA: Programas_Formacion\n+-- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n+-- Cada registro es INDEPENDIENTE (entrada o salida)\n+-- IMPORTANTE: Esta es la estructura de CIRCUITO ABIERTO\n+-- Cada registro tiene un solo campo fecha_hora con el tipo (ENTRADA o SALIDA)\n+-- NO usa fecha_entrada y fecha_salida separadas (eso sería circuito cerrado)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Programas_Formacion (\n-    id_programa INT AUTO_INCREMENT PRIMARY KEY,\n-    codigo_programa VARCHAR(20) UNIQUE NOT NULL,\n-    nombre_programa VARCHAR(200) NOT NULL,\n-    nivel ENUM('Técnico', 'Tecnológico', 'Especialización') NOT NULL,\n-    duracion_meses INT NOT NULL,\n-    area_conocimiento VARCHAR(100) NOT NULL,\n-    descripcion TEXT,\n-    estado ENUM('activo', 'inactivo') DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_programa_codigo (codigo_programa),\n-    INDEX idx_programa_nivel (nivel),\n-    INDEX idx_programa_area (area_conocimiento),\n-    INDEX idx_programa_estado (estado)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+CREATE TABLE IF NOT EXISTS registros_entrada_salida (\n+  id_registro_entrada_salida INT AUTO_INCREMENT PRIMARY KEY,\n+  id_persona INT,\n+  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\n+  fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha y hora exacta del registro (entrada o salida)',\n+  FOREIGN KEY (id_persona) REFERENCES personas (id_persona) ON DELETE CASCADE,\n+  INDEX idx_registro_persona (id_persona),\n+  INDEX idx_registro_tipo (tipo),\n+  INDEX idx_registro_fecha (fecha_hora),\n+  INDEX idx_persona_fecha (id_persona, fecha_hora),\n+  INDEX idx_persona_tipo_fecha (id_persona, tipo, fecha_hora)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n \n -- =====================================================\n--- TABLA: Ambientes\n+-- VISTAS ÚTILES PARA CIRCUITO ABIERTO\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Ambientes (\n-    id_ambiente INT AUTO_INCREMENT PRIMARY KEY,\n-    codigo_ambiente VARCHAR(20) UNIQUE NOT NULL,\n-    nombre_ambiente VARCHAR(100) NOT NULL,\n-    tipo_ambiente ENUM('aula', 'laboratorio', 'taller', 'oficina', 'auditorio', 'biblioteca', 'cafeteria', 'sala_reuniones') NOT NULL,\n-    capacidad INT NOT NULL,\n-    bloque VARCHAR(50) NOT NULL,\n-    piso INT NOT NULL,\n-    equipamiento TEXT COMMENT 'JSON con equipamiento disponible',\n-    estado ENUM('activo', 'mantenimiento', 'inactivo') DEFAULT 'activo',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_ambiente_codigo (codigo_ambiente),\n-    INDEX idx_ambiente_tipo (tipo_ambiente),\n-    INDEX idx_ambiente_bloque (bloque),\n-    INDEX idx_ambiente_estado (estado)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n+-- Vista: Últimos registros de acceso\n+CREATE OR REPLACE VIEW v_ultimos_registros AS\n+SELECT \n+    r.id_registro_entrada_salida,\n+    r.tipo,\n+    r.fecha_hora,\n+    p.id_persona,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.documento,\n+    rp.nombre_rol_persona as rol,\n+    p.zona\n+FROM registros_entrada_salida r\n+INNER JOIN personas p ON r.id_persona = p.id_persona\n+LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+ORDER BY r.fecha_hora DESC;\n+\n+-- Vista: Personas actualmente dentro (última acción fue ENTRADA sin SALIDA posterior)\n+CREATE OR REPLACE VIEW v_personas_dentro AS\n+SELECT \n+    p.id_persona,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.documento,\n+    rp.nombre_rol_persona as rol,\n+    p.foto,\n+    r.fecha_hora as fecha_entrada,\n+    TIMESTAMPDIFF(MINUTE, r.fecha_hora, NOW()) as minutos_dentro,\n+    p.zona\n+FROM personas p\n+INNER JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n+LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+WHERE r.tipo = 'ENTRADA'\n+  AND r.fecha_hora = (\n+    SELECT MAX(fecha_hora) \n+    FROM registros_entrada_salida \n+    WHERE id_persona = p.id_persona\n+  )\n+  AND NOT EXISTS (\n+    SELECT 1 \n+    FROM registros_entrada_salida r2 \n+    WHERE r2.id_persona = p.id_persona \n+      AND r2.tipo = 'SALIDA' \n+      AND r2.fecha_hora > r.fecha_hora\n+  )\n+  AND p.estado = 'ACTIVO';\n+\n+-- Vista: Resumen de asistencia por persona\n+CREATE OR REPLACE VIEW v_resumen_asistencia AS\n+SELECT \n+    p.id_persona,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.documento,\n+    rp.nombre_rol_persona as rol,\n+    COUNT(DISTINCT DATE(r.fecha_hora)) as dias_asistencia,\n+    COUNT(CASE WHEN r.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n+    COUNT(CASE WHEN r.tipo = 'SALIDA' THEN 1 END) as total_salidas,\n+    MAX(r.fecha_hora) as ultimo_registro\n+FROM personas p\n+LEFT JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n+LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+WHERE p.estado = 'ACTIVO'\n+GROUP BY p.id_persona, p.nombres, p.apellidos, p.documento, rp.nombre_rol_persona;\n+\n -- =====================================================\n--- MIGRACIÓN A CIRCUITO ABIERTO\n--- Eliminar tabla Accesos antigua y sus dependencias\n+-- PROCEDIMIENTOS ALMACENADOS ÚTILES\n -- =====================================================\n--- IMPORTANTE: Si la base de datos ya existe, ejecutar manualmente antes:\n--- ALTER TABLE Alertas DROP FOREIGN KEY alertas_ibfk_2;\n--- ALTER TABLE Historial_Asistencias DROP FOREIGN KEY IF EXISTS historial_asistencias_ibfk_X;\n \n-DROP TABLE IF EXISTS Accesos;\n+-- Registrar entrada\n+DELIMITER $$\n \n--- =====================================================\n--- TABLA: Registros_Acceso (CIRCUITO ABIERTO)\n--- Cada registro es INDEPENDIENTE (entrada o salida)\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Registros_Acceso (\n-    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_usuario_registro INT,\n-    tipo_movimiento ENUM('entrada', 'salida') NOT NULL,\n-    fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-    id_ambiente INT NULL COMMENT 'Ambiente donde ocurrió el registro',\n-    metodo_registro ENUM('qr', 'manual', 'biometrico', 'tarjeta') DEFAULT 'qr',\n-    ip_address VARCHAR(45),\n-    geolocalizacion VARCHAR(100),\n-    observaciones TEXT,\n-    metadata JSON COMMENT 'Información adicional del registro',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+DROP PROCEDURE IF EXISTS sp_registrar_entrada$$\n+\n+CREATE PROCEDURE sp_registrar_entrada(IN p_id_persona INT)\n+BEGIN\n+    INSERT INTO registros_entrada_salida \n+    (id_persona, tipo, fecha_hora)\n+    VALUES \n+    (p_id_persona, 'ENTRADA', NOW());\n     \n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n+    SELECT LAST_INSERT_ID() as id_registro_entrada_salida;\n+END$$\n+\n+DELIMITER ;\n+\n+-- Registrar salida\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_registrar_salida$$\n+\n+CREATE PROCEDURE sp_registrar_salida(IN p_id_persona INT)\n+BEGIN\n+    INSERT INTO registros_entrada_salida \n+    (id_persona, tipo, fecha_hora)\n+    VALUES \n+    (p_id_persona, 'SALIDA', NOW());\n     \n-    INDEX idx_registro_persona (id_persona),\n-    INDEX idx_registro_tipo (tipo_movimiento),\n-    INDEX idx_registro_fecha (fecha_hora),\n-    INDEX idx_registro_ambiente (id_ambiente),\n-    INDEX idx_registro_usuario (id_usuario_registro),\n-    INDEX idx_registro_metodo (metodo_registro),\n-    INDEX idx_persona_fecha (id_persona, fecha_hora),\n-    INDEX idx_registro_persona_fecha_tipo (id_persona, fecha_hora, tipo_movimiento)\n-    \n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Registros independientes de entrada y salida - Circuito Abierto';\n+    SELECT LAST_INSERT_ID() as id_registro_entrada_salida;\n+END$$\n \n+DELIMITER ;\n+\n+-- Obtener personas actualmente dentro\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_personas_dentro$$\n+\n+CREATE PROCEDURE sp_personas_dentro()\n+BEGIN\n+    SELECT * FROM v_personas_dentro;\n+END$$\n+\n+DELIMITER ;\n+\n+-- Verificar última acción de una persona\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_ultima_accion_persona$$\n+\n+CREATE PROCEDURE sp_ultima_accion_persona(IN p_id_persona INT)\n+BEGIN\n+    SELECT \n+        tipo,\n+        fecha_hora,\n+        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n+    FROM registros_entrada_salida\n+    WHERE id_persona = p_id_persona\n+    ORDER BY fecha_hora DESC\n+    LIMIT 1;\n+END$$\n+\n+DELIMITER ;\n+\n -- =====================================================\n -- TABLA: Sesiones_Acceso (OPCIONAL - Para análisis)\n -- Esta tabla es solo para CONSULTAS y REPORTES\n -- NO es obligatoria para el funcionamiento del sistema\n@@ -378,9 +451,9 @@\n -- ESQUEMA DE INTEGRACIÓN QR + BD\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- TABLA: Fichas\n -- =====================================================\n@@ -502,9 +575,9 @@\n -- ACTUALIZACIÓN DE ESQUEMA PARA IMPORTACIÓN MASIVA\n -- Campos adicionales por rol\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- MODIFICAR TABLA: Personas\n -- Agregar campos adicionales para importación\n@@ -529,9 +602,9 @@\n -- TABLA: Fichas\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- Crear tabla Fichas si no existe\n CREATE TABLE IF NOT EXISTS Fichas (\n     id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n@@ -592,9 +665,9 @@\n -- INSERCIÓN DE PROGRAMAS DE FORMACIÓN - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- PROGRAMAS TÉCNICOS\n -- =====================================================\n@@ -703,9 +776,9 @@\n -- TRIGGERS, VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE control_acceso_sena;\n+USE sena_acceso;\n \n -- =====================================================\n -- TRIGGER PARA AUTO-GENERAR SESIONES\n -- =====================================================\n"
                },
                {
                    "date": 1763670469797,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,13 +3,13 @@\n -- Sistema de Control de Acceso SENA - CIRCUITO ABIERTO\n -- =====================================================\n \n -- Crear base de datos si no existe\n-CREATE DATABASE IF NOT EXISTS sena_acceso \n+CREATE DATABASE IF NOT EXISTS control_acceso_sena \n CHARACTER SET utf8mb4 \n COLLATE utf8mb4_unicode_ci;\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n -- TABLA: usuarios\n -- =====================================================\n@@ -96,22 +96,22 @@\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n \n -- =====================================================\n--- TABLA: Visitantes\n+-- TABLA: visitantes\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Visitantes (\n+CREATE TABLE IF NOT EXISTS visitantes (\n     id_visitante INT AUTO_INCREMENT PRIMARY KEY,\n     id_persona INT NOT NULL,\n     motivo_visita TEXT NOT NULL,\n     contacto VARCHAR(255),\n     persona_visita VARCHAR(255),\n     fecha_inicio TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n     fecha_fin TIMESTAMP NULL,\n-    estado ENUM('activo', 'finalizado', 'expirado') NOT NULL DEFAULT 'activo',\n+    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') NOT NULL DEFAULT 'ACTIVO',\n     fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n     fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_persona) REFERENCES personas (id_persona) ON DELETE CASCADE,\n     INDEX idx_id_persona (id_persona),\n     INDEX idx_estado (estado),\n     INDEX idx_fecha_inicio (fecha_inicio),\n     INDEX idx_fecha_fin (fecha_fin)\n@@ -119,11 +119,11 @@\n \n \n \n -- =====================================================\n--- TABLA: Logs_Seguridad\n+-- TABLA: logs_seguridad\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Logs_Seguridad (\n+CREATE TABLE IF NOT EXISTS logs_seguridad (\n     id_log INT AUTO_INCREMENT PRIMARY KEY,\n     tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', 'modificacion_usuario', 'modificacion_config', 'generacion_reporte', 'acceso_sistema', 'operacion_admin') NOT NULL,\n     id_usuario INT,\n     ip_address VARCHAR(45),\n@@ -131,20 +131,20 @@\n     accion TEXT NOT NULL,\n     detalles JSON,\n     exito BOOLEAN DEFAULT TRUE,\n     fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n     INDEX idx_tipo (tipo),\n     INDEX idx_id_usuario (id_usuario),\n     INDEX idx_ip_address (ip_address),\n     INDEX idx_fecha (fecha),\n     INDEX idx_exito (exito)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n--- TABLA: Evidencia_Fotografica\n+-- TABLA: evidencia_fotografica\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Evidencia_Fotografica (\n+CREATE TABLE IF NOT EXISTS evidencia_fotografica (\n     id_evidencia INT AUTO_INCREMENT PRIMARY KEY,\n     id_incidente INT,\n     tipo_incidente ENUM('acceso_denegado', 'comportamiento_sospechoso', 'incidente_seguridad', 'evidencia_general') NOT NULL,\n     url_foto VARCHAR(500) NOT NULL,\n@@ -153,18 +153,18 @@\n     id_usuario_captura INT,\n     descripcion TEXT,\n     coordenadas_gps VARCHAR(100),\n     metadata JSON,\n-    FOREIGN KEY (id_usuario_captura) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario_captura) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n     INDEX idx_tipo_incidente (tipo_incidente),\n     INDEX idx_fecha_captura (fecha_captura),\n     INDEX idx_id_usuario_captura (id_usuario_captura)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n--- TABLA: Auditoria\n+-- TABLA: auditoria\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Auditoria (\n+CREATE TABLE IF NOT EXISTS auditoria (\n     id_auditoria INT AUTO_INCREMENT PRIMARY KEY,\n     tabla_afectada VARCHAR(100) NOT NULL,\n     id_registro INT,\n     accion ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,\n@@ -172,20 +172,20 @@\n     datos_nuevos JSON,\n     id_usuario INT,\n     ip_address VARCHAR(45),\n     fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n     INDEX idx_tabla_afectada (tabla_afectada),\n     INDEX idx_id_registro (id_registro),\n     INDEX idx_accion (accion),\n     INDEX idx_id_usuario (id_usuario),\n     INDEX idx_fecha (fecha)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n--- TABLA: Configuracion\n+-- TABLA: configuracion\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Configuracion (\n+CREATE TABLE IF NOT EXISTS configuracion (\n     id_config INT AUTO_INCREMENT PRIMARY KEY,\n     clave VARCHAR(100) NOT NULL UNIQUE,\n     valor TEXT,\n     tipo ENUM('string', 'number', 'boolean', 'json') NOT NULL DEFAULT 'string',\n@@ -194,9 +194,9 @@\n     fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n     INDEX idx_clave (clave)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n-INSERT INTO Configuracion (clave, valor, tipo, descripcion) VALUES\n+INSERT INTO configuracion (clave, valor, tipo, descripcion) VALUES\n ('qr_visitor_expiry_hours', '24', 'number', 'Horas de validez del QR de visitante'),\n ('system_name', 'Control de Acceso SENA', 'string', 'Nombre del sistema'),\n ('max_visitors_per_day', '100', 'number', 'Máximo de visitantes por día')\n ON DUPLICATE KEY UPDATE clave=clave;\n@@ -205,9 +205,9 @@\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n \n-USE sena_acceso;\n+USE control_acceso_sena;\n \n -- =====================================================\n -- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n@@ -364,667 +364,28 @@\n \n DELIMITER ;\n \n -- =====================================================\n--- TABLA: Sesiones_Acceso (OPCIONAL - Para análisis)\n--- Esta tabla es solo para CONSULTAS y REPORTES\n--- NO es obligatoria para el funcionamiento del sistema\n+-- NOTA: Las siguientes tablas son OPCIONALES y pueden ser\n+-- agregadas más adelante si se necesitan funcionalidades adicionales\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Sesiones_Acceso (\n-    id_sesion INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_registro_entrada INT NOT NULL,\n-    id_registro_salida INT NULL,\n-    fecha_entrada TIMESTAMP NOT NULL,\n-    fecha_salida TIMESTAMP NULL,\n-    duracion_minutos INT NULL,\n-    estado ENUM('abierta', 'cerrada', 'anomala') DEFAULT 'abierta',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    \n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_registro_entrada) REFERENCES Registros_Acceso(id_registro) ON DELETE CASCADE,\n-    FOREIGN KEY (id_registro_salida) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n-    \n-    INDEX idx_sesion_persona (id_persona),\n-    INDEX idx_sesion_entrada (id_registro_entrada),\n-    INDEX idx_sesion_salida (id_registro_salida),\n-    INDEX idx_sesion_estado (estado),\n-    INDEX idx_sesion_fechas (fecha_entrada, fecha_salida),\n-    INDEX idx_sesion_persona_estado (id_persona, estado)\n-    \n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Vista consolidada de sesiones - Generada automáticamente';\n+-- Tablas opcionales: Sesiones_Acceso, Alertas, Fichas, Ambientes, etc.\n+-- Estas tablas requieren tablas adicionales que no están en la estructura básica\n \n--- =====================================================\n--- TABLA: Alertas\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Alertas (\n-    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\n-    tipo ENUM('acceso_fuera_horario', 'intento_fraudulento', 'qr_expirado', 'documento_no_registrado', 'comportamiento_sospechoso', 'sistema', 'seguridad') NOT NULL,\n-    severidad ENUM('critica', 'alta', 'media', 'baja') NOT NULL DEFAULT 'media',\n-    titulo VARCHAR(255) NOT NULL,\n-    mensaje TEXT NOT NULL,\n-    id_persona INT,\n-    id_registro_acceso INT NULL COMMENT 'Referencia a Registros_Acceso (circuito abierto)',\n-    id_usuario INT,\n-    leida BOOLEAN DEFAULT FALSE,\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_lectura TIMESTAMP NULL,\n-    id_usuario_lectura INT,\n-    metadata JSON,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\n-    FOREIGN KEY (id_registro_acceso) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n-    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    FOREIGN KEY (id_usuario_lectura) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n-    INDEX idx_tipo (tipo),\n-    INDEX idx_severidad (severidad),\n-    INDEX idx_leida (leida),\n-    INDEX idx_fecha_creacion (fecha_creacion),\n-    INDEX idx_id_persona (id_persona),\n-    INDEX idx_alertas_registro (id_registro_acceso)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n--- =====================================================\n--- MODIFICAR TABLA: Personas\n--- Agregar relación con programas de formación\n--- =====================================================\n-ALTER TABLE Personas \n-ADD COLUMN id_programa INT NULL AFTER rol,\n-ADD COLUMN ficha VARCHAR(50) NULL AFTER id_programa,\n-ADD COLUMN programa VARCHAR(100) NULL AFTER ficha;\n \n--- Agregar índices si no existen\n-CREATE INDEX idx_personas_programa ON Personas(id_programa);\n-CREATE INDEX idx_personas_ficha ON Personas(ficha);\n \n--- Agregar foreign key si no existe\n--- Nota: MySQL no soporta IF NOT EXISTS en ALTER TABLE ADD FOREIGN KEY\n--- Se debe ejecutar manualmente si la tabla ya tiene datos\n--- ALTER TABLE Personas \n--- ADD CONSTRAINT fk_personas_programa \n--- FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL;\n-\n -- =====================================================\n-\n-\n+-- NOTA: La inserción de programas de formación se puede hacer\n+-- manualmente si se necesita la tabla Programas_Formacion\n -- =====================================================\n--- ESQUEMA DE INTEGRACIÓN QR + BD\n--- Sistema de Control de Acceso SENA\n--- =====================================================\n \n-USE sena_acceso;\n-\n -- =====================================================\n--- TABLA: Fichas\n+-- NOTA: Las vistas y procedimientos básicos ya están definidos\n+-- arriba en la sección \"VISTAS ÚTILES PARA CIRCUITO ABIERTO\"\n+-- y \"PROCEDIMIENTOS ALMACENADOS ÚTILES\"\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS Fichas (\n-    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n-    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n-    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n-    id_programa INT NULL COMMENT 'Referencia al programa de formación',\n-    id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha',\n-    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n-    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n-    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n-    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n-    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n-    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n-    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL,\n-    FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    INDEX idx_ficha_codigo (codigo_ficha),\n-    INDEX idx_ficha_programa (id_programa),\n-    INDEX idx_ficha_estado (estado),\n-    INDEX idx_ficha_jornada (jornada),\n-    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n-    INDEX idx_ficha_ambiente (id_ambiente_principal)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Tabla para gestionar las fichas de formación del SENA';\n \n--- =====================================================\n--- TABLA: Asignaciones_Ambientes\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Asignaciones_Ambientes (\n-    id_asignacion INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_ambiente INT NOT NULL,\n-    tipo_asignacion ENUM('aprendiz', 'instructor', 'administrativo') NOT NULL,\n-    horario_asignado TEXT COMMENT 'JSON con horarios: {\"lunes\": \"8:00-12:00\", ...}',\n-    fecha_asignacion DATE DEFAULT (CURDATE()),\n-    fecha_fin_asignacion DATE NULL,\n-    activa BOOLEAN DEFAULT TRUE,\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE CASCADE,\n-    INDEX idx_asignacion_persona (id_persona),\n-    INDEX idx_asignacion_ambiente (id_ambiente),\n-    INDEX idx_asignacion_tipo (tipo_asignacion),\n-    INDEX idx_asignacion_activa (activa)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n-\n--- =====================================================\n--- MODIFICAR TABLA: Personas\n--- Agregar campos adicionales si no existen\n--- =====================================================\n-ALTER TABLE Personas \n-ADD COLUMN rh VARCHAR(10) NULL AFTER telefono,\n-ADD COLUMN id_ficha INT NULL AFTER ficha,\n-ADD COLUMN jornada ENUM('diurna', 'nocturna', 'mixta') NULL AFTER id_ficha;\n-\n--- Agregar foreign key para ficha si no existe\n-CREATE INDEX idx_personas_ficha_id ON Personas(id_ficha);\n--- ALTER TABLE Personas ADD FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n-\n--- =====================================================\n--- TABLA: Historial_Asistencias (CIRCUITO ABIERTO)\n--- Esta tabla ahora referencia a Registros_Acceso\n--- Se puede usar para consolidar datos diarios o mantener compatibilidad\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Historial_Asistencias (\n-    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n-    id_persona INT NOT NULL,\n-    id_ficha INT NULL,\n-    id_ambiente INT NULL,\n-    id_registro_acceso INT NULL COMMENT 'Referencia al registro de acceso en circuito abierto',\n-    fecha DATE NOT NULL,\n-    hora_entrada TIME,\n-    hora_salida TIME,\n-    tipo_movimiento ENUM('entrada', 'salida') NOT NULL COMMENT 'Tipo de movimiento (circuito abierto)',\n-    estado ENUM('presente', 'ausente', 'tardanza', 'salida_anticipada') DEFAULT 'presente',\n-    observaciones TEXT,\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n-    FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    FOREIGN KEY (id_registro_acceso) REFERENCES Registros_Acceso(id_registro) ON DELETE SET NULL,\n-    INDEX idx_historial_persona (id_persona),\n-    INDEX idx_historial_ficha (id_ficha),\n-    INDEX idx_historial_fecha (fecha),\n-    INDEX idx_historial_ambiente (id_ambiente),\n-    INDEX idx_historial_registro_acceso (id_registro_acceso)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Historial de asistencias - Referencia a Registros_Acceso (circuito abierto)';\n-\n--- =====================================================\n--- TABLA: Alertas_Sistema\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS Alertas_Sistema (\n-    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\n-    tipo_alerta ENUM('capacidad', 'acceso_denegado', 'irregularidad', 'tardanza', 'ausencia') NOT NULL,\n-    id_ambiente INT NULL,\n-    id_persona INT NULL,\n-    severidad ENUM('baja', 'media', 'alta', 'critica') DEFAULT 'media',\n-    mensaje TEXT NOT NULL,\n-    datos_adicionales JSON,\n-    resuelta BOOLEAN DEFAULT FALSE,\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_resolucion TIMESTAMP NULL,\n-    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\n-    INDEX idx_alerta_tipo (tipo_alerta),\n-    INDEX idx_alerta_resuelta (resuelta),\n-    INDEX idx_alerta_fecha (fecha_creacion)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n-\n-\n-\n--- =====================================================\n--- ACTUALIZACIÓN DE ESQUEMA PARA IMPORTACIÓN MASIVA\n--- Campos adicionales por rol\n--- =====================================================\n-\n-USE sena_acceso;\n-\n--- =====================================================\n--- MODIFICAR TABLA: Personas\n--- Agregar campos adicionales para importación\n--- =====================================================\n-ALTER TABLE Personas \n-ADD COLUMN rh VARCHAR(10) NULL AFTER telefono,\n-ADD COLUMN fecha_inicio_formacion DATE NULL AFTER rh,\n-ADD COLUMN fecha_fin_formacion DATE NULL AFTER fecha_inicio_formacion,\n-ADD COLUMN id_ficha INT NULL AFTER ficha,\n-ADD COLUMN cargo VARCHAR(100) NULL AFTER id_ficha,\n-ADD COLUMN tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL AFTER cargo;\n-\n--- Agregar índices\n-CREATE INDEX  idx_personas_rh ON Personas(rh);\n-CREATE INDEX  idx_personas_cargo ON Personas(cargo);\n-\n--- =====================================================\n--- VERIFICAR que las tablas Fichas y Asignaciones_Ambientes existan\n--- (Ya fueron creadas en integrationSchema.sql)\n--- =====================================================\n--- =====================================================\n--- TABLA: Fichas\n--- Sistema de Control de Acceso SENA\n--- =====================================================\n-\n-USE sena_acceso;\n-\n--- Crear tabla Fichas si no existe\n-CREATE TABLE IF NOT EXISTS Fichas (\n-    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n-    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n-    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n-    id_programa INT NULL COMMENT 'Referencia al programa de formación',\n-    id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha',\n-    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n-    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n-    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n-    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n-    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n-    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n-    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    \n-    -- Foreign Keys\n-    FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL,\n-    FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n-    \n-    -- Índices\n-    INDEX idx_ficha_codigo (codigo_ficha),\n-    INDEX idx_ficha_programa (id_programa),\n-    INDEX idx_ficha_estado (estado),\n-    INDEX idx_ficha_jornada (jornada),\n-    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n-    INDEX idx_ficha_ambiente (id_ambiente_principal)\n-    \n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Tabla para gestionar las fichas de formación del SENA';\n-\n--- Agregar foreign key desde Personas a Fichas si no existe\n--- Nota: MySQL no soporta IF NOT EXISTS en ALTER TABLE ADD FOREIGN KEY\n--- Se debe ejecutar manualmente si la tabla ya tiene datos y la foreign key no existe\n--- ALTER TABLE Personas \n--- ADD CONSTRAINT fk_personas_ficha \n--- FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n-\n--- Verificar que la columna id_ficha existe en Personas\n--- Si no existe, se creará automáticamente al ejecutar el schema completo\n--- ALTER TABLE Personas \n--- ADD COLUMN IF NOT EXISTS id_ficha INT NULL AFTER ficha;\n-\n--- Crear índice en Personas para id_ficha si no existe\n-CREATE INDEX IF NOT EXISTS idx_personas_ficha_id ON Personas(id_ficha);\n-\n--- Datos de ejemplo (opcional)\n--- INSERT INTO Fichas (codigo_ficha, programa_formacion, jornada, fecha_inicio, fecha_fin, estado) VALUES\n--- ('3066232', 'Técnico en Programación de Software', 'diurna', '2024-01-15', '2025-01-15', 'activa'),\n--- ('3066233', 'Tecnólogo en Análisis y Desarrollo de Software', 'nocturna', '2024-02-01', '2026-02-01', 'activa')\n--- ON DUPLICATE KEY UPDATE codigo_ficha=codigo_ficha;\n-\n-\n-\n-\n--- =====================================================\n--- INSERCIÓN DE PROGRAMAS DE FORMACIÓN - CBI PALMIRA\n--- Sistema de Control de Acceso SENA\n--- =====================================================\n-\n-USE sena_acceso;\n-\n--- =====================================================\n--- PROGRAMAS TÉCNICOS\n--- =====================================================\n-\n-INSERT INTO Programas_Formacion \n-(codigo_programa, nombre_programa, nivel, duracion_meses, area_conocimiento, estado)\n-VALUES\n--- Programas Administrativos y Comerciales\n-('TEC-AA-001', 'Asistencia Administrativa', 'Técnico', 12, 'Gestión Administrativa', 'activo'),\n-('TEC-AOA-001', 'Asistencia en Organización de Archivos', 'Técnico', 12, 'Gestión Documental', 'activo'),\n-('TEC-COCF-001', 'Contabilización de Operaciones Comerciales y Financieras', 'Técnico', 12, 'Contabilidad y Finanzas', 'activo'),\n-('TEC-NPS-001', 'Nómina y Prestaciones Sociales', 'Técnico', 12, 'Recursos Humanos', 'activo'),\n-('TEC-OCR-001', 'Operaciones Comerciales en Retail', 'Técnico', 12, 'Comercio y Ventas', 'activo'),\n-('TEC-PEL-001', 'Peluquería', 'Técnico', 12, 'Belleza y Estética', 'activo'),\n-('TEC-RH-001', 'Recursos Humanos', 'Técnico', 12, 'Recursos Humanos', 'activo'),\n-('TEC-SCF-001', 'Servicios Comerciales y Financieros', 'Técnico', 12, 'Servicios Financieros', 'activo'),\n-\n--- Programas Tecnológicos y Científicos\n-('TEC-AMQ-001', 'Análisis de Muestras Químicas', 'Técnico', 12, 'Química y Laboratorio', 'activo'),\n-('TEC-DIM-001', 'Diseño e Integración de Multimedia', 'Técnico', 12, 'Tecnología Multimedia', 'activo'),\n-('TEC-ICD-001', 'Integración de Contenidos Digitales', 'Técnico', 12, 'Contenidos Digitales', 'activo'),\n-('TEC-IOL-001', 'Integración de Operaciones Logísticas', 'Técnico', 12, 'Logística', 'activo'),\n-('TEC-MAM-001', 'Monitoreo Ambiental', 'Técnico', 12, 'Medio Ambiente', 'activo'),\n-('TEC-PBFI-001', 'Producción de Biocombustibles y Fermentaciones Industriales', 'Técnico', 12, 'Biotecnología', 'activo'),\n-('TEC-PS-001', 'Programación de Software', 'Técnico', 12, 'Desarrollo de Software', 'activo'),\n-('TEC-PAG-001', 'Proyectos Agropecuarios', 'Técnico', 12, 'Agropecuaria', 'activo'),\n-('TEC-SIS-001', 'Sistemas', 'Técnico', 12, 'Sistemas Informáticos', 'activo'),\n-\n--- Programas de Construcción y Mecánica\n-('TEC-CED-001', 'Construcción de Edificaciones', 'Técnico', 12, 'Construcción', 'activo'),\n-('TEC-CLIS-001', 'Construcciones Livianas Industrializadas en Seco', 'Técnico', 12, 'Construcción', 'activo'),\n-('TEC-DMEC-001', 'Dibujo Mecánico', 'Técnico', 12, 'Diseño Mecánico', 'activo'),\n-('TEC-EI-001', 'Electricista Industrial', 'Técnico', 12, 'Electricidad Industrial', 'activo'),\n-('TEC-ISERC-001', 'Instalación de Sistemas Eléctricos Residenciales y Comerciales', 'Técnico', 12, 'Instalaciones Eléctricas', 'activo'),\n-('TEC-MMD-001', 'Mantenimiento de Motores Diésel', 'Técnico', 12, 'Mantenimiento Mecánico', 'activo'),\n-('TEC-MVL-001', 'Mantenimiento de Vehículos Livianos', 'Técnico', 12, 'Mantenimiento Automotriz', 'activo'),\n-('TEC-MECEA-001', 'Mantenimiento Eléctrico y Control Electrónico de Automotores', 'Técnico', 12, 'Mecánica Automotriz', 'activo'),\n-('TEC-MMI-001', 'Mecánica de Maquinaria Industrial', 'Técnico', 12, 'Mecánica Industrial', 'activo'),\n-('TEC-SPMP-001', 'Soldadura de Productos Metálicos en Plaina (placa metálica)', 'Técnico', 12, 'Soldadura', 'activo')\n-\n-ON DUPLICATE KEY UPDATE\n-nombre_programa = VALUES(nombre_programa),\n-nivel = VALUES(nivel),\n-duracion_meses = VALUES(duracion_meses),\n-area_conocimiento = VALUES(area_conocimiento),\n-fecha_actualizacion = NOW();\n-\n--- =====================================================\n--- PROGRAMAS TECNOLÓGICOS\n--- =====================================================\n-\n-INSERT INTO Programas_Formacion \n-(codigo_programa, nombre_programa, nivel, duracion_meses, area_conocimiento, estado)\n-VALUES\n--- Programas de Gestión y Administración\n-('TECN-GBEF-001', 'Gestión Bancaria y de Entidades Financieras', 'Tecnológico', 24, 'Gestión Financiera', 'activo'),\n-('TECN-GADM-001', 'Gestión Administrativa', 'Tecnológico', 24, 'Gestión Administrativa', 'activo'),\n-('TECN-GEMP-001', 'Gestión Empresarial', 'Tecnológico', 24, 'Gestión Empresarial', 'activo'),\n-('TECN-GTH-001', 'Gestión del Talento Humano', 'Tecnológico', 24, 'Recursos Humanos', 'activo'),\n-('TECN-DV-001', 'Dirección de Ventas', 'Tecnológico', 24, 'Ventas y Marketing', 'activo'),\n-('TECN-GPDES-001', 'Gestión de Proyectos de Desarrollo Económico y Social', 'Tecnológico', 24, 'Gestión de Proyectos', 'activo'),\n-('TECN-GDOC-001', 'Gestión Documental', 'Tecnológico', 24, 'Gestión Documental', 'activo'),\n-('TECN-GCIF-001', 'Gestión Contable y de Información Financiera', 'Tecnológico', 24, 'Contabilidad', 'activo'),\n-('TECN-GTRF-001', 'Gestión de Tesorería y Recursos Financieros', 'Tecnológico', 24, 'Finanzas', 'activo'),\n-('TECN-GICMSSO-001', 'Gestión Integrada de la Calidad, Medio Ambiente, Seguridad y Salud Ocupacional', 'Tecnológico', 24, 'Gestión Integral', 'activo'),\n-('TECN-GPI-001', 'Gestión de la Producción Industrial', 'Tecnológico', 24, 'Producción Industrial', 'activo'),\n-('TECN-GMA-001', 'Gestión del Mantenimiento de Automotores', 'Tecnológico', 24, 'Gestión Automotriz', 'activo'),\n-\n--- Programas Deportivos y de Actividad Física\n-('TECN-ED-001', 'Entrenamiento Deportivo', 'Tecnológico', 24, 'Deporte', 'activo'),\n-('TECN-AF-001', 'Actividad Física', 'Tecnológico', 24, 'Actividad Física', 'activo'),\n-\n--- Programas de Biotecnología y Medio Ambiente\n-('TECN-BCS-001', 'Biocomercio Sostenible', 'Tecnológico', 24, 'Biotecnología', 'activo'),\n-('TECN-CBI-001', 'Control de Bioprocesos Industriales', 'Tecnológico', 24, 'Biotecnología', 'activo'),\n-('TECN-PCA-001', 'Prevención y Control Ambiental', 'Tecnológico', 24, 'Medio Ambiente', 'activo'),\n-\n--- Programas de Tecnología y Desarrollo\n-('TECN-ADS-001', 'Análisis y Desarrollo de Software', 'Tecnológico', 24, 'Desarrollo de Software', 'activo'),\n-('TECN-MEII-001', 'Mantenimiento Electrónico e Instrumental Industrial', 'Tecnológico', 24, 'Electrónica Industrial', 'activo'),\n-('TECN-DMPI-001', 'Desarrollo y Modelado de Productos Industriales', 'Tecnológico', 24, 'Diseño Industrial', 'activo'),\n-\n--- Programas de Mantenimiento Industrial\n-('TECN-MMI-001', 'Mantenimiento Mecánico Industrial', 'Tecnológico', 24, 'Mantenimiento Industrial', 'activo'),\n-('TECN-MEI-001', 'Mantenimiento Electromecánico Industrial', 'Tecnológico', 24, 'Electromecánica', 'activo'),\n-\n--- Programas de Logística\n-('TECN-CPL-001', 'Coordinación de Procesos Logísticos', 'Tecnológico', 24, 'Logística', 'activo')\n-\n-ON DUPLICATE KEY UPDATE\n-nombre_programa = VALUES(nombre_programa),\n-nivel = VALUES(nivel),\n-duracion_meses = VALUES(duracion_meses),\n-area_conocimiento = VALUES(area_conocimiento),\n-fecha_actualizacion = NOW();\n-\n--- =====================================================\n--- RESUMEN DE INSERCIÓN\n--- =====================================================\n--- Total de programas técnicos: 28\n--- Total de programas tecnológicos: 22\n--- Total general: 50 programas\n--- =====================================================\n-\n--- =====================================================\n--- TRIGGERS, VISTAS Y PROCEDIMIENTOS PARA CIRCUITO ABIERTO\n--- Sistema de Control de Acceso SENA\n--- =====================================================\n-\n-USE sena_acceso;\n-\n--- =====================================================\n--- TRIGGER PARA AUTO-GENERAR SESIONES\n--- =====================================================\n-DELIMITER $$\n-\n-DROP TRIGGER IF EXISTS trg_generar_sesion_entrada$$\n-\n-CREATE TRIGGER trg_generar_sesion_entrada\n-AFTER INSERT ON Registros_Acceso\n-FOR EACH ROW\n-BEGIN\n-    -- Si es una ENTRADA, crear nueva sesión abierta\n-    IF NEW.tipo_movimiento = 'entrada' THEN\n-        INSERT INTO Sesiones_Acceso \n-        (id_persona, id_registro_entrada, fecha_entrada, estado)\n-        VALUES \n-        (NEW.id_persona, NEW.id_registro, NEW.fecha_hora, 'abierta');\n-    END IF;\n-    \n-    -- Si es una SALIDA, intentar cerrar la última sesión abierta\n-    IF NEW.tipo_movimiento = 'salida' THEN\n-        UPDATE Sesiones_Acceso \n-        SET \n-            id_registro_salida = NEW.id_registro,\n-            fecha_salida = NEW.fecha_hora,\n-            duracion_minutos = TIMESTAMPDIFF(MINUTE, fecha_entrada, NEW.fecha_hora),\n-            estado = 'cerrada'\n-        WHERE \n-            id_persona = NEW.id_persona \n-            AND estado = 'abierta'\n-            AND id_registro_salida IS NULL\n-        ORDER BY fecha_entrada DESC\n-        LIMIT 1;\n-    END IF;\n-END$$\n-\n-DELIMITER ;\n-\n--- =====================================================\n--- VISTAS ÚTILES PARA CONSULTAS\n--- =====================================================\n-\n--- Vista: Últimos registros de acceso\n-CREATE OR REPLACE VIEW v_ultimos_registros AS\n-SELECT \n-    r.id_registro,\n-    r.tipo_movimiento,\n-    r.fecha_hora,\n-    p.id_persona,\n-    p.nombre,\n-    p.documento,\n-    p.rol,\n-    a.nombre_ambiente,\n-    r.metodo_registro,\n-    u.nombre as usuario_registro\n-FROM Registros_Acceso r\n-INNER JOIN Personas p ON r.id_persona = p.id_persona\n-LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n-LEFT JOIN Usuarios u ON r.id_usuario_registro = u.id_usuario\n-ORDER BY r.fecha_hora DESC;\n-\n--- Vista: Sesiones abiertas (personas actualmente dentro)\n-CREATE OR REPLACE VIEW v_sesiones_abiertas AS\n-SELECT \n-    s.id_sesion,\n-    s.id_persona,\n-    p.nombre,\n-    p.documento,\n-    p.rol,\n-    p.foto,\n-    s.fecha_entrada,\n-    TIMESTAMPDIFF(MINUTE, s.fecha_entrada, NOW()) as minutos_dentro,\n-    r.id_ambiente,\n-    a.nombre_ambiente\n-FROM Sesiones_Acceso s\n-INNER JOIN Personas p ON s.id_persona = p.id_persona\n-LEFT JOIN Registros_Acceso r ON s.id_registro_entrada = r.id_registro\n-LEFT JOIN Ambientes a ON r.id_ambiente = a.id_ambiente\n-WHERE s.estado = 'abierta';\n-\n--- Vista: Resumen de asistencia por persona\n-CREATE OR REPLACE VIEW v_resumen_asistencia AS\n-SELECT \n-    p.id_persona,\n-    p.nombre,\n-    p.documento,\n-    p.rol,\n-    COUNT(DISTINCT DATE(r.fecha_hora)) as dias_asistencia,\n-    COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) as total_entradas,\n-    COUNT(CASE WHEN r.tipo_movimiento = 'salida' THEN 1 END) as total_salidas,\n-    MAX(r.fecha_hora) as ultimo_registro\n-FROM Personas p\n-LEFT JOIN Registros_Acceso r ON p.id_persona = r.id_persona\n-WHERE p.estado = 'activo'\n-GROUP BY p.id_persona, p.nombre, p.documento, p.rol;\n-\n--- Vista: Flujo de acceso por día\n-CREATE OR REPLACE VIEW v_flujo_diario AS\n-SELECT \n-    DATE(fecha_hora) as fecha,\n-    tipo_movimiento,\n-    COUNT(*) as cantidad,\n-    HOUR(fecha_hora) as hora\n-FROM Registros_Acceso\n-GROUP BY DATE(fecha_hora), tipo_movimiento, HOUR(fecha_hora)\n-ORDER BY fecha DESC, hora;\n-\n--- Vista: Historial de asistencias consolidado desde Registros_Acceso\n--- Esta vista consolida los registros diarios para compatibilidad con código existente\n-CREATE OR REPLACE VIEW v_historial_asistencias_consolidado AS\n-SELECT \n-    r.id_registro as id_registro_acceso,\n-    r.id_persona,\n-    p.id_ficha,\n-    r.id_ambiente,\n-    DATE(r.fecha_hora) as fecha,\n-    MIN(CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END) as hora_entrada,\n-    MAX(CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END) as hora_salida,\n-    r.tipo_movimiento,\n-    CASE \n-        WHEN COUNT(CASE WHEN r.tipo_movimiento = 'entrada' THEN 1 END) > 0 THEN 'presente'\n-        ELSE 'ausente'\n-    END as estado,\n-    GROUP_CONCAT(r.observaciones SEPARATOR ' | ') as observaciones,\n-    MIN(r.fecha_creacion) as fecha_creacion\n-FROM Registros_Acceso r\n-INNER JOIN Personas p ON r.id_persona = p.id_persona\n-GROUP BY r.id_persona, DATE(r.fecha_hora), r.id_ambiente, r.tipo_movimiento\n-ORDER BY fecha DESC, hora_entrada DESC;\n-\n--- =====================================================\n--- PROCEDIMIENTOS ALMACENADOS ÚTILES\n--- =====================================================\n-\n--- Registrar entrada\n-DELIMITER $$\n-\n-DROP PROCEDURE IF EXISTS sp_registrar_entrada$$\n-\n-CREATE PROCEDURE sp_registrar_entrada(\n-    IN p_id_persona INT,\n-    IN p_id_usuario INT,\n-    IN p_id_ambiente INT,\n-    IN p_metodo VARCHAR(20),\n-    IN p_observaciones TEXT\n-)\n-BEGIN\n-    INSERT INTO Registros_Acceso \n-    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n-    VALUES \n-    (p_id_persona, p_id_usuario, 'entrada', p_id_ambiente, p_metodo, p_observaciones);\n-    \n-    SELECT LAST_INSERT_ID() as id_registro;\n-END$$\n-\n-DELIMITER ;\n-\n--- Registrar salida\n-DELIMITER $$\n-\n-DROP PROCEDURE IF EXISTS sp_registrar_salida$$\n-\n-CREATE PROCEDURE sp_registrar_salida(\n-    IN p_id_persona INT,\n-    IN p_id_usuario INT,\n-    IN p_id_ambiente INT,\n-    IN p_metodo VARCHAR(20),\n-    IN p_observaciones TEXT\n-)\n-BEGIN\n-    INSERT INTO Registros_Acceso \n-    (id_persona, id_usuario_registro, tipo_movimiento, id_ambiente, metodo_registro, observaciones)\n-    VALUES \n-    (p_id_persona, p_id_usuario, 'salida', p_id_ambiente, p_metodo, p_observaciones);\n-    \n-    SELECT LAST_INSERT_ID() as id_registro;\n-END$$\n-\n-DELIMITER ;\n-\n--- Obtener personas actualmente dentro\n-DELIMITER $$\n-\n-DROP PROCEDURE IF EXISTS sp_personas_dentro$$\n-\n-CREATE PROCEDURE sp_personas_dentro()\n-BEGIN\n-    SELECT * FROM v_sesiones_abiertas;\n-END$$\n-\n-DELIMITER ;\n-\n--- Verificar última acción de una persona\n-DELIMITER $$\n-\n-DROP PROCEDURE IF EXISTS sp_ultima_accion_persona$$\n-\n-CREATE PROCEDURE sp_ultima_accion_persona(IN p_id_persona INT)\n-BEGIN\n-    SELECT \n-        tipo_movimiento,\n-        fecha_hora,\n-        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n-    FROM Registros_Acceso\n-    WHERE id_persona = p_id_persona\n-    ORDER BY fecha_hora DESC\n-    LIMIT 1;\n-END$$\n-\n-DELIMITER ;\n-\n--- Sincronizar Historial_Asistencias desde Registros_Acceso (opcional)\n-DELIMITER $$\n-\n-DROP PROCEDURE IF EXISTS sp_sincronizar_historial_asistencias$$\n-\n-CREATE PROCEDURE sp_sincronizar_historial_asistencias(IN p_fecha DATE)\n-BEGIN\n-    -- Eliminar registros existentes para la fecha especificada\n-    DELETE FROM Historial_Asistencias WHERE fecha = p_fecha;\n-    \n-    -- Insertar registros consolidados desde Registros_Acceso\n-    INSERT INTO Historial_Asistencias \n-    (id_persona, id_ficha, id_ambiente, id_registro_acceso, fecha, hora_entrada, hora_salida, tipo_movimiento, estado, observaciones)\n-    SELECT \n-        r.id_persona,\n-        p.id_ficha,\n-        r.id_ambiente,\n-        r.id_registro,\n-        DATE(r.fecha_hora) as fecha,\n-        CASE WHEN r.tipo_movimiento = 'entrada' THEN TIME(r.fecha_hora) END as hora_entrada,\n-        CASE WHEN r.tipo_movimiento = 'salida' THEN TIME(r.fecha_hora) END as hora_salida,\n-        r.tipo_movimiento,\n-        'presente' as estado,\n-        r.observaciones\n-    FROM Registros_Acceso r\n-    INNER JOIN Personas p ON r.id_persona = p.id_persona\n-    WHERE DATE(r.fecha_hora) = p_fecha\n-    ORDER BY r.fecha_hora;\n-    \n-    SELECT CONCAT('Historial sincronizado para fecha: ', p_fecha) as resultado;\n-END$$\n-\n-DELIMITER ;\n-\n -- Nota: Los índices adicionales ya están incluidos en las definiciones de las tablas\n \n -- =====================================================\n -- DOCUMENTACIÓN DEL MODELO DE CIRCUITO ABIERTO\n@@ -1060,76 +421,45 @@\n \n CONSULTAS COMUNES:\n \n 1. Personas actualmente dentro:\n-   SELECT * FROM v_sesiones_abiertas;\n+   SELECT * FROM v_personas_dentro;\n+   O también: CALL sp_personas_dentro();\n \n 2. Último registro de una persona:\n    CALL sp_ultima_accion_persona(1);\n \n 3. Todos los registros de hoy:\n-   SELECT * FROM Registros_Acceso \n+   SELECT * FROM registros_entrada_salida \n    WHERE DATE(fecha_hora) = CURDATE();\n \n 4. Historial completo de una persona:\n-   SELECT * FROM Registros_Acceso \n+   SELECT * FROM registros_entrada_salida \n    WHERE id_persona = 1 \n    ORDER BY fecha_hora DESC;\n \n-MIGRACIÓN DE DATOS EXISTENTES:\n+5. Registrar entrada:\n+   CALL sp_registrar_entrada(1);\n \n-Si tienes datos en la tabla Accesos antigua, ejecuta este script para migrarlos:\n+6. Registrar salida:\n+   CALL sp_registrar_salida(1);\n \n--- Migrar entradas desde tabla Accesos antigua\n-INSERT INTO Registros_Acceso \n-(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n-SELECT \n-    id_persona,\n-    id_usuario_registro,\n-    tipo_acceso,\n-    fecha_entrada,\n-    observaciones,\n-    fecha_creacion\n-FROM Accesos\n-WHERE tipo_acceso = 'entrada' AND fecha_entrada IS NOT NULL;\n+7. Resumen de asistencia:\n+   SELECT * FROM v_resumen_asistencia;\n \n--- Migrar salidas desde tabla Accesos antigua\n-INSERT INTO Registros_Acceso \n-(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n-SELECT \n-    id_persona,\n-    id_usuario_registro,\n-    'salida',\n-    fecha_salida,\n-    observaciones,\n-    fecha_actualizacion\n-FROM Accesos\n-WHERE tipo_acceso = 'salida' AND fecha_salida IS NOT NULL;\n+ESTRUCTURA DE TABLAS BÁSICAS:\n \n--- Si la tabla Accesos tenía registros con fecha_entrada pero sin fecha_salida,\n--- migrar solo como entrada\n-INSERT INTO Registros_Acceso \n-(id_persona, id_usuario_registro, tipo_movimiento, fecha_hora, observaciones, fecha_creacion)\n-SELECT \n-    id_persona,\n-    id_usuario_registro,\n-    'entrada',\n-    fecha_entrada,\n-    observaciones,\n-    fecha_creacion\n-FROM Accesos\n-WHERE fecha_entrada IS NOT NULL \n-  AND fecha_salida IS NULL\n-  AND tipo_acceso = 'entrada';\n+- usuarios: Usuarios del sistema (GUARDA, ADMINISTRADOR)\n+- estados_personas: Catálogo de estados (ACTIVO, INACTIVO, SUSPENDIDO)\n+- roles_personas: Catálogo de roles (APRENDIZ, INSTRUCTOR, etc.)\n+- personas: Información de las personas registradas\n+- registros_entrada_salida: Registros independientes de entrada/salida (CIRCUITO ABIERTO)\n \n NOTAS IMPORTANTES:\n \n-1. La tabla Historial_Asistencias ahora es OPCIONAL y puede ser poblada usando:\n-   CALL sp_sincronizar_historial_asistencias('2024-01-15');\n-\n-2. Para consultas diarias, usa la vista v_historial_asistencias_consolidado\n-\n-3. Todos los nuevos registros deben hacerse directamente en Registros_Acceso\n-\n-4. La tabla Sesiones_Acceso se genera automáticamente mediante triggers\n+1. Cada registro en registros_entrada_salida es INDEPENDIENTE\n+2. No se requiere emparejar entradas con salidas\n+3. La vista v_personas_dentro muestra personas cuya última acción fue ENTRADA\n+4. Los procedimientos almacenados simplifican las operaciones comunes\n+5. La tabla usa tipo ENUM('ENTRADA', 'SALIDA') y fecha_hora (circuito abierto)\n */\n \n"
                },
                {
                    "date": 1763671420911,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,8 +27,28 @@\n   INDEX idx_estado (estado)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n+-- CREDENCIALES POR DEFECTO\n+-- =====================================================\n+-- Insertar usuarios por defecto con contraseñas hasheadas con bcrypt\n+-- Contraseñas por defecto:\n+--   - admin@sena.edu.co / admin123 (ADMINISTRADOR)\n+--   - guarda@sena.edu.co / guarda123 (GUARDA)\n+-- \n+-- NOTA: Los hashes bcrypt fueron generados con bcryptjs (10 rounds)\n+-- Si necesitas regenerar los hashes, ejecuta: node src/utils/generatePasswordHashes.js\n+-- =====================================================\n+INSERT INTO usuarios (nombre, email, passwords, rol, estado) VALUES\n+('Administrador', 'admin@sena.edu.co', '$2a$10$3666f.g.6YwF2m2MFJCtn.R8ftn9RkRcV6/f1yzdj3VlGZ7EESzeK', 'ADMINISTRADOR', 'ACTIVO'),\n+('Guarda de Seguridad', 'guarda@sena.edu.co', '$2a$10$DMCaQbx2V5QUTMYuSZvJaOk4OGfltNh2ClwOByuofhDQwBh1641dK', 'GUARDA', 'ACTIVO')\n+ON DUPLICATE KEY UPDATE \n+  nombre = VALUES(nombre),\n+  passwords = VALUES(passwords),\n+  rol = VALUES(rol),\n+  estado = VALUES(estado);\n+\n+-- =====================================================\n -- TABLA: estados_personas (Catálogo)\n -- =====================================================\n CREATE TABLE IF NOT EXISTS estados_personas (\n   id_estado_persona INT AUTO_INCREMENT PRIMARY KEY,\n@@ -180,28 +200,13 @@\n     INDEX idx_id_usuario (id_usuario),\n     INDEX idx_fecha (fecha)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n--- =====================================================\n--- TABLA: configuracion\n--- =====================================================\n-CREATE TABLE IF NOT EXISTS configuracion (\n-    id_config INT AUTO_INCREMENT PRIMARY KEY,\n-    clave VARCHAR(100) NOT NULL UNIQUE,\n-    valor TEXT,\n-    tipo ENUM('string', 'number', 'boolean', 'json') NOT NULL DEFAULT 'string',\n-    descripcion VARCHAR(255),\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_clave (clave)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n-INSERT INTO configuracion (clave, valor, tipo, descripcion) VALUES\n-('qr_visitor_expiry_hours', '24', 'number', 'Horas de validez del QR de visitante'),\n-('system_name', 'Control de Acceso SENA', 'string', 'Nombre del sistema'),\n-('max_visitors_per_day', '100', 'number', 'Máximo de visitantes por día')\n-ON DUPLICATE KEY UPDATE clave=clave;\n \n+\n+\n+\n -- =====================================================\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n"
                },
                {
                    "date": 1763672507773,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -93,8 +93,9 @@\n   apellidos VARCHAR(100),\n   codigo_qr VARCHAR(255),\n   programa VARCHAR(200),\n   ficha VARCHAR(50),\n+  id_ficha INT NULL COMMENT 'Referencia a la ficha de formación',\n   zona VARCHAR(200) COMMENT 'Zona o destino donde va la persona o visitante',\n   foto VARCHAR(500) COMMENT 'Ruta del archivo de foto (formato: uploads/fotos/[documento]-[timestamp].jpg)',\n   estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n   fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n@@ -111,9 +112,10 @@\n   INDEX idx_codigo_qr (codigo_qr),\n   INDEX idx_estado (estado),\n   INDEX idx_id_usuario (id_usuario),\n   INDEX idx_id_estado_persona (id_estado_persona),\n-  INDEX idx_id_rol_persona (id_rol_persona)\n+  INDEX idx_id_rol_persona (id_rol_persona),\n+  INDEX idx_id_ficha (id_ficha)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n \n -- =====================================================\n@@ -213,8 +215,41 @@\n \n USE control_acceso_sena;\n \n -- =====================================================\n+-- TABLA: Fichas\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Fichas (\n+  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n+  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n+  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional)',\n+  id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n+  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n+  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n+  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n+  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n+  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n+  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n+  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  INDEX idx_ficha_codigo (codigo_ficha),\n+  INDEX idx_ficha_programa (id_programa),\n+  INDEX idx_ficha_estado (estado),\n+  INDEX idx_ficha_jornada (jornada),\n+  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+  INDEX idx_ficha_ambiente (id_ambiente_principal)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Tabla para gestionar las fichas de formación del SENA';\n+\n+-- Agregar foreign key desde personas a Fichas (opcional, solo si la tabla ya existe)\n+-- Nota: Esta foreign key se agregará automáticamente si ambas tablas existen\n+-- Si la tabla personas ya existe sin id_ficha, se debe ejecutar manualmente:\n+-- ALTER TABLE personas ADD COLUMN id_ficha INT NULL AFTER ficha;\n+-- ALTER TABLE personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n+\n+-- =====================================================\n -- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n -- IMPORTANTE: Esta es la estructura de CIRCUITO ABIERTO\n -- Cada registro tiene un solo campo fecha_hora con el tipo (ENTRADA o SALIDA)\n"
                },
                {
                    "date": 1763673054044,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,40 +82,79 @@\n ('ADMINISTRADOR')\n ON DUPLICATE KEY UPDATE nombre_rol_persona=nombre_rol_persona;\n \n -- =====================================================\n--- TABLA: personas\n+-- TABLA: Roles (Para compatibilidad con código existente)\n -- =====================================================\n-CREATE TABLE IF NOT EXISTS personas (\n+CREATE TABLE IF NOT EXISTS Roles (\n+    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n+    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n+    descripcion VARCHAR(255),\n+    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    INDEX idx_nombre_rol (nombre_rol),\n+    INDEX idx_estado (estado)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- Insertar roles por defecto\n+INSERT INTO Roles (nombre_rol, descripcion) VALUES\n+('aprendiz', 'Aprendiz del SENA'),\n+('instructor', 'Instructor del SENA'),\n+('administrativo', 'Personal administrativo'),\n+('visitante', 'Visitante temporal'),\n+('guarda', 'Guarda de seguridad'),\n+('admin', 'Administrador del sistema')\n+ON DUPLICATE KEY UPDATE nombre_rol=nombre_rol;\n+\n+-- =====================================================\n+-- TABLA: Personas (alias personas también funciona)\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Personas (\n   id_persona INT AUTO_INCREMENT PRIMARY KEY,\n   tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\n   documento VARCHAR(50) UNIQUE,\n   nombres VARCHAR(100),\n   apellidos VARCHAR(100),\n+  nombre VARCHAR(200) COMMENT 'Nombre completo (para compatibilidad)',\n   codigo_qr VARCHAR(255),\n   programa VARCHAR(200),\n   ficha VARCHAR(50),\n   id_ficha INT NULL COMMENT 'Referencia a la ficha de formación',\n   zona VARCHAR(200) COMMENT 'Zona o destino donde va la persona o visitante',\n   foto VARCHAR(500) COMMENT 'Ruta del archivo de foto (formato: uploads/fotos/[documento]-[timestamp].jpg)',\n-  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+  estado ENUM('ACTIVO', 'INACTIVO', 'activo', 'inactivo', 'suspendido') DEFAULT 'ACTIVO',\n   fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n   fecha_expiracion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n   fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Hora exacta de registro de la persona',\n   id_usuario INT,\n   id_estado_persona INT,\n   id_rol_persona INT,\n+  id_rol INT NULL COMMENT 'Referencia a Roles (para compatibilidad)',\n+  rol VARCHAR(50) COMMENT 'Nombre del rol (para compatibilidad)',\n+  email VARCHAR(255),\n+  telefono VARCHAR(20),\n+  rh VARCHAR(10) COMMENT 'Grupo sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)',\n+  id_programa INT NULL COMMENT 'Referencia al programa de formación',\n+  fecha_inicio_formacion DATE NULL,\n+  fecha_fin_formacion DATE NULL,\n+  jornada ENUM('diurna', 'nocturna', 'mixta') NULL,\n+  cargo VARCHAR(100) COMMENT 'Cargo para instructores y administrativos',\n+  tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL,\n   FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n   FOREIGN KEY (id_estado_persona) REFERENCES estados_personas (id_estado_persona) ON DELETE SET NULL,\n   FOREIGN KEY (id_rol_persona) REFERENCES roles_personas (id_rol_persona) ON DELETE SET NULL,\n+  FOREIGN KEY (id_rol) REFERENCES Roles (id_rol) ON DELETE SET NULL\n   INDEX idx_documento (documento),\n   INDEX idx_tipo_documento (tipo_documento),\n   INDEX idx_codigo_qr (codigo_qr),\n   INDEX idx_estado (estado),\n   INDEX idx_id_usuario (id_usuario),\n   INDEX idx_id_estado_persona (id_estado_persona),\n   INDEX idx_id_rol_persona (id_rol_persona),\n-  INDEX idx_id_ficha (id_ficha)\n+  INDEX idx_id_ficha (id_ficha),\n+  INDEX idx_id_rol (id_rol),\n+  INDEX idx_email (email)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n \n -- =====================================================\n@@ -131,9 +170,9 @@\n     fecha_fin TIMESTAMP NULL,\n     estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') NOT NULL DEFAULT 'ACTIVO',\n     fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n     fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    FOREIGN KEY (id_persona) REFERENCES personas (id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_persona) REFERENCES Personas (id_persona) ON DELETE CASCADE,\n     INDEX idx_id_persona (id_persona),\n     INDEX idx_estado (estado),\n     INDEX idx_fecha_inicio (fecha_inicio),\n     INDEX idx_fecha_fin (fecha_fin)\n@@ -218,36 +257,36 @@\n -- =====================================================\n -- TABLA: Fichas\n -- =====================================================\n CREATE TABLE IF NOT EXISTS Fichas (\n-  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n-  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n-  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n+    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n+    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n   id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional)',\n   id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n-  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n-  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n-  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n-  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n-  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n-  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n-  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-  INDEX idx_ficha_codigo (codigo_ficha),\n-  INDEX idx_ficha_programa (id_programa),\n-  INDEX idx_ficha_estado (estado),\n-  INDEX idx_ficha_jornada (jornada),\n-  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n-  INDEX idx_ficha_ambiente (id_ambiente_principal)\n+    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n+    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n+    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n+    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n+    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n+    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n+    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    INDEX idx_ficha_codigo (codigo_ficha),\n+    INDEX idx_ficha_programa (id_programa),\n+    INDEX idx_ficha_estado (estado),\n+    INDEX idx_ficha_jornada (jornada),\n+    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+    INDEX idx_ficha_ambiente (id_ambiente_principal)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n COMMENT='Tabla para gestionar las fichas de formación del SENA';\n \n--- Agregar foreign key desde personas a Fichas (opcional, solo si la tabla ya existe)\n+-- Agregar foreign key desde Personas a Fichas (opcional, solo si la tabla ya existe)\n -- Nota: Esta foreign key se agregará automáticamente si ambas tablas existen\n--- Si la tabla personas ya existe sin id_ficha, se debe ejecutar manualmente:\n--- ALTER TABLE personas ADD COLUMN id_ficha INT NULL AFTER ficha;\n--- ALTER TABLE personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n+-- Si la tabla Personas ya existe sin id_ficha, se debe ejecutar manualmente:\n+-- ALTER TABLE Personas ADD COLUMN id_ficha INT NULL AFTER ficha;\n+-- ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n \n -- =====================================================\n -- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n@@ -259,9 +298,9 @@\n   id_registro_entrada_salida INT AUTO_INCREMENT PRIMARY KEY,\n   id_persona INT,\n   tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\n   fecha_hora TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha y hora exacta del registro (entrada o salida)',\n-  FOREIGN KEY (id_persona) REFERENCES personas (id_persona) ON DELETE CASCADE,\n+  FOREIGN KEY (id_persona) REFERENCES Personas (id_persona) ON DELETE CASCADE,\n   INDEX idx_registro_persona (id_persona),\n   INDEX idx_registro_tipo (tipo),\n   INDEX idx_registro_fecha (fecha_hora),\n   INDEX idx_persona_fecha (id_persona, fecha_hora),\n@@ -284,9 +323,9 @@\n     p.documento,\n     rp.nombre_rol_persona as rol,\n     p.zona\n FROM registros_entrada_salida r\n-INNER JOIN personas p ON r.id_persona = p.id_persona\n+INNER JOIN Personas p ON r.id_persona = p.id_persona\n LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n ORDER BY r.fecha_hora DESC;\n \n -- Vista: Personas actualmente dentro (última acción fue ENTRADA sin SALIDA posterior)\n@@ -299,9 +338,9 @@\n     p.foto,\n     r.fecha_hora as fecha_entrada,\n     TIMESTAMPDIFF(MINUTE, r.fecha_hora, NOW()) as minutos_dentro,\n     p.zona\n-FROM personas p\n+FROM Personas p\n INNER JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n WHERE r.tipo = 'ENTRADA'\n   AND r.fecha_hora = (\n@@ -328,9 +367,9 @@\n     COUNT(DISTINCT DATE(r.fecha_hora)) as dias_asistencia,\n     COUNT(CASE WHEN r.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n     COUNT(CASE WHEN r.tipo = 'SALIDA' THEN 1 END) as total_salidas,\n     MAX(r.fecha_hora) as ultimo_registro\n-FROM personas p\n+FROM Personas p\n LEFT JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n WHERE p.estado = 'ACTIVO'\n GROUP BY p.id_persona, p.nombres, p.apellidos, p.documento, rp.nombre_rol_persona;\n"
                },
                {
                    "date": 1763674345665,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,9 +121,9 @@\n   ficha VARCHAR(50),\n   id_ficha INT NULL COMMENT 'Referencia a la ficha de formación',\n   zona VARCHAR(200) COMMENT 'Zona o destino donde va la persona o visitante',\n   foto VARCHAR(500) COMMENT 'Ruta del archivo de foto (formato: uploads/fotos/[documento]-[timestamp].jpg)',\n-  estado ENUM('ACTIVO', 'INACTIVO', 'activo', 'inactivo', 'suspendido') DEFAULT 'ACTIVO',\n+  estado ENUM('ACTIVO', 'INACTIVO', 'suspendido') DEFAULT 'ACTIVO',  -- VALORES ÚNICOS\n   fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n   fecha_expiracion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n   fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Hora exacta de registro de la persona',\n   id_usuario INT,\n@@ -132,19 +132,23 @@\n   id_rol INT NULL COMMENT 'Referencia a Roles (para compatibilidad)',\n   rol VARCHAR(50) COMMENT 'Nombre del rol (para compatibilidad)',\n   email VARCHAR(255),\n   telefono VARCHAR(20),\n-  rh VARCHAR(10) COMMENT 'Grupo sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)',\n+  rh VARCHAR(10) COMMENT 'Grupo sanguíneo (A+, A-, B+, AB+, AB-, O+, O-)',\n   id_programa INT NULL COMMENT 'Referencia al programa de formación',\n   fecha_inicio_formacion DATE NULL,\n   fecha_fin_formacion DATE NULL,\n   jornada ENUM('diurna', 'nocturna', 'mixta') NULL,\n   cargo VARCHAR(100) COMMENT 'Cargo para instructores y administrativos',\n   tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL,\n+  \n+  -- FOREIGN KEYS\n   FOREIGN KEY (id_usuario) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n   FOREIGN KEY (id_estado_persona) REFERENCES estados_personas (id_estado_persona) ON DELETE SET NULL,\n   FOREIGN KEY (id_rol_persona) REFERENCES roles_personas (id_rol_persona) ON DELETE SET NULL,\n-  FOREIGN KEY (id_rol) REFERENCES Roles (id_rol) ON DELETE SET NULL\n+  FOREIGN KEY (id_rol) REFERENCES Roles (id_rol) ON DELETE SET NULL,\n+  \n+  -- ÍNDICES\n   INDEX idx_documento (documento),\n   INDEX idx_tipo_documento (tipo_documento),\n   INDEX idx_codigo_qr (codigo_qr),\n   INDEX idx_estado (estado),\n@@ -154,10 +158,8 @@\n   INDEX idx_id_ficha (id_ficha),\n   INDEX idx_id_rol (id_rol),\n   INDEX idx_email (email)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n-\n-\n -- =====================================================\n -- TABLA: visitantes\n -- =====================================================\n CREATE TABLE IF NOT EXISTS visitantes (\n@@ -257,31 +259,42 @@\n -- =====================================================\n -- TABLA: Fichas\n -- =====================================================\n CREATE TABLE IF NOT EXISTS Fichas (\n-    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n-    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n-    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n+  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n+  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n   id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional)',\n   id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n-    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n-    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n-    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n-    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n-    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n-    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n-    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n-    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-    INDEX idx_ficha_codigo (codigo_ficha),\n-    INDEX idx_ficha_programa (id_programa),\n-    INDEX idx_ficha_estado (estado),\n-    INDEX idx_ficha_jornada (jornada),\n-    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n-    INDEX idx_ficha_ambiente (id_ambiente_principal)\n+  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n+  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n+  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n+  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n+  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n+  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n+  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  INDEX idx_ficha_codigo (codigo_ficha),\n+  INDEX idx_ficha_programa (id_programa),\n+  INDEX idx_ficha_estado (estado),\n+  INDEX idx_ficha_jornada (jornada),\n+  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+  INDEX idx_ficha_ambiente (id_ambiente_principal)\n+  -- NOTA: Las foreign keys a Programas_Formacion y Ambientes se agregan después\n+  -- si esas tablas existen, para evitar errores de creación\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n COMMENT='Tabla para gestionar las fichas de formación del SENA';\n \n+-- Crear vista de compatibilidad para fichas (minúscula)\n+-- Esto permite que el código use tanto Fichas como fichas\n+CREATE OR REPLACE VIEW fichas AS SELECT * FROM Fichas;\n+\n+-- Intentar agregar foreign keys opcionales (solo si las tablas relacionadas existen)\n+-- Estas foreign keys se pueden agregar manualmente después si se necesitan\n+-- ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL;\n+-- ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_ambiente FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL;\n+\n -- Agregar foreign key desde Personas a Fichas (opcional, solo si la tabla ya existe)\n -- Nota: Esta foreign key se agregará automáticamente si ambas tablas existen\n -- Si la tabla Personas ya existe sin id_ficha, se debe ejecutar manualmente:\n -- ALTER TABLE Personas ADD COLUMN id_ficha INT NULL AFTER ficha;\n"
                },
                {
                    "date": 1763676791519,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -284,11 +284,34 @@\n   -- si esas tablas existen, para evitar errores de creación\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n COMMENT='Tabla para gestionar las fichas de formación del SENA';\n \n--- Crear vista de compatibilidad para fichas (minúscula)\n--- Esto permite que el código use tanto Fichas como fichas\n-CREATE OR REPLACE VIEW fichas AS SELECT * FROM Fichas;\n+-- Crear tabla fichas (minúscula) - El código de importación busca 'fichas' en minúscula\n+-- NOTA: Si tu MySQL es case-sensitive (Linux), necesitarás usar el mismo case en todo el código\n+-- Si prefieres usar solo 'Fichas' (mayúscula), actualiza el código para usar 'Fichas' consistentemente\n+CREATE TABLE IF NOT EXISTS fichas (\n+  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n+  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n+  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional)',\n+  id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n+  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n+  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n+  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n+  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n+  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n+  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n+  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  INDEX idx_ficha_codigo (codigo_ficha),\n+  INDEX idx_ficha_programa (id_programa),\n+  INDEX idx_ficha_estado (estado),\n+  INDEX idx_ficha_jornada (jornada),\n+  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+  INDEX idx_ficha_ambiente (id_ambiente_principal)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Tabla para gestionar las fichas de formación del SENA';\n \n -- Intentar agregar foreign keys opcionales (solo si las tablas relacionadas existen)\n -- Estas foreign keys se pueden agregar manualmente después si se necesitan\n -- ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL;\n"
                },
                {
                    "date": 1763677492202,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -364,21 +364,30 @@\n LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n ORDER BY r.fecha_hora DESC;\n \n -- Vista: Personas actualmente dentro (última acción fue ENTRADA sin SALIDA posterior)\n+-- Incluye visitantes, aprendices, instructores, etc.\n CREATE OR REPLACE VIEW v_personas_dentro AS\n SELECT \n     p.id_persona,\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    COALESCE(\n+      CONCAT(p.nombres, ' ', p.apellidos),\n+      p.nombre,\n+      CONCAT(p.nombres, p.apellidos)\n+    ) as nombre_completo,\n     p.documento,\n-    rp.nombre_rol_persona as rol,\n+    COALESCE(rp.nombre_rol_persona, rol_tabla.nombre_rol, p.rol) as rol,\n     p.foto,\n     r.fecha_hora as fecha_entrada,\n     TIMESTAMPDIFF(MINUTE, r.fecha_hora, NOW()) as minutos_dentro,\n-    p.zona\n+    p.zona,\n+    v.id_visitante,\n+    v.motivo_visita\n FROM Personas p\n INNER JOIN registros_entrada_salida r ON p.id_persona = r.id_persona\n LEFT JOIN roles_personas rp ON p.id_rol_persona = rp.id_rol_persona\n+LEFT JOIN Roles rol_tabla ON p.id_rol = rol_tabla.id_rol\n+LEFT JOIN visitantes v ON p.id_persona = v.id_persona AND v.estado = 'ACTIVO'\n WHERE r.tipo = 'ENTRADA'\n   AND r.fecha_hora = (\n     SELECT MAX(fecha_hora) \n     FROM registros_entrada_salida \n@@ -390,9 +399,9 @@\n     WHERE r2.id_persona = p.id_persona \n       AND r2.tipo = 'SALIDA' \n       AND r2.fecha_hora > r.fecha_hora\n   )\n-  AND p.estado = 'ACTIVO';\n+  AND (p.estado = 'ACTIVO' OR p.estado = 'activo');\n \n -- Vista: Resumen de asistencia por persona\n CREATE OR REPLACE VIEW v_resumen_asistencia AS\n SELECT \n"
                },
                {
                    "date": 1763678942173,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,8 +125,9 @@\n   estado ENUM('ACTIVO', 'INACTIVO', 'suspendido') DEFAULT 'ACTIVO',  -- VALORES ÚNICOS\n   fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n   fecha_expiracion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n   fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Hora exacta de registro de la persona',\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización del registro',\n   id_usuario INT,\n   id_estado_persona INT,\n   id_rol_persona INT,\n   id_rol INT NULL COMMENT 'Referencia a Roles (para compatibilidad)',\n@@ -586,4 +587,29 @@\n 4. Los procedimientos almacenados simplifican las operaciones comunes\n 5. La tabla usa tipo ENUM('ENTRADA', 'SALIDA') y fecha_hora (circuito abierto)\n */\n \n+-- =====================================================\n+-- MIGRACIONES: Agregar columna fecha_actualizacion si no existe\n+-- =====================================================\n+-- Ejecutar este script si la base de datos ya existe y necesita agregar la columna\n+-- O ejecutar el schema completo que ya incluye esta columna\n+\n+-- Agregar fecha_actualizacion a Personas si no existe\n+SET @dbname = DATABASE();\n+SET @tablename = 'Personas';\n+SET @columnname = 'fecha_actualizacion';\n+SET @preparedStatement = (SELECT IF(\n+  (\n+    SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS\n+    WHERE\n+      (TABLE_SCHEMA = @dbname)\n+      AND (TABLE_NAME = @tablename)\n+      AND (COLUMN_NAME = @columnname)\n+  ) > 0,\n+  'SELECT 1',\n+  CONCAT('ALTER TABLE ', @tablename, ' ADD COLUMN ', @columnname, ' TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT ''Fecha de última actualización del registro''')\n+));\n+PREPARE alterIfNotExists FROM @preparedStatement;\n+EXECUTE alterIfNotExists;\n+DEALLOCATE PREPARE alterIfNotExists;\n+\n"
                },
                {
                    "date": 1763684711675,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -324,8 +324,35 @@\n -- ALTER TABLE Personas ADD COLUMN id_ficha INT NULL AFTER ficha;\n -- ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n \n -- =====================================================\n+-- TABLA: Accesos (CIRCUITO CERRADO - Para compatibilidad)\n+-- NOTA: Esta tabla se mantiene para compatibilidad con código existente\n+-- El sistema principal usa registros_entrada_salida (circuito abierto)\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Accesos (\n+  id_acceso INT AUTO_INCREMENT PRIMARY KEY,\n+  id_persona INT NOT NULL,\n+  id_usuario_registro INT NULL,\n+  tipo_acceso ENUM('entrada', 'salida') NOT NULL DEFAULT 'entrada',\n+  fecha_entrada TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+  fecha_salida TIMESTAMP NULL,\n+  estado ENUM('activo', 'finalizado', 'cancelado') NOT NULL DEFAULT 'activo',\n+  observaciones TEXT NULL,\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  FOREIGN KEY (id_persona) REFERENCES Personas (id_persona) ON DELETE CASCADE,\n+  FOREIGN KEY (id_usuario_registro) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n+  INDEX idx_id_persona (id_persona),\n+  INDEX idx_fecha_entrada (fecha_entrada),\n+  INDEX idx_fecha_salida (fecha_salida),\n+  INDEX idx_estado (estado),\n+  INDEX idx_tipo_acceso (tipo_acceso),\n+  INDEX idx_usuario_registro (id_usuario_registro)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Tabla de accesos (circuito cerrado) - Mantenida para compatibilidad';\n+\n+-- =====================================================\n -- TABLA: registros_entrada_salida (CIRCUITO ABIERTO)\n -- Cada registro es INDEPENDIENTE (entrada o salida)\n -- IMPORTANTE: Esta es la estructura de CIRCUITO ABIERTO\n -- Cada registro tiene un solo campo fecha_hora con el tipo (ENTRADA o SALIDA)\n"
                },
                {
                    "date": 1763685152416,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -639,4 +639,104 @@\n PREPARE alterIfNotExists FROM @preparedStatement;\n EXECUTE alterIfNotExists;\n DEALLOCATE PREPARE alterIfNotExists;\n \n+-- =====================================================\n+-- MIGRACIÓN: Crear tabla Accesos si no existe\n+-- =====================================================\n+-- Esta tabla se mantiene para compatibilidad con código existente\n+-- El sistema principal usa registros_entrada_salida (circuito abierto)\n+\n+SET @tablename = 'Accesos';\n+SET @preparedStatement = (SELECT IF(\n+  (\n+    SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES\n+    WHERE\n+      (TABLE_SCHEMA = @dbname)\n+      AND (TABLE_NAME = @tablename)\n+  ) > 0,\n+  'SELECT 1',\n+  CONCAT('CREATE TABLE ', @tablename, ' (\n+    id_acceso INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    id_usuario_registro INT NULL,\n+    tipo_acceso ENUM(\\'entrada\\', \\'salida\\') NOT NULL DEFAULT \\'entrada\\',\n+    fecha_entrada TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+    fecha_salida TIMESTAMP NULL,\n+    estado ENUM(\\'activo\\', \\'finalizado\\', \\'cancelado\\') NOT NULL DEFAULT \\'activo\\',\n+    observaciones TEXT NULL,\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+    FOREIGN KEY (id_persona) REFERENCES Personas (id_persona) ON DELETE CASCADE,\n+    FOREIGN KEY (id_usuario_registro) REFERENCES usuarios (id_usuario) ON DELETE SET NULL,\n+    INDEX idx_id_persona (id_persona),\n+    INDEX idx_fecha_entrada (fecha_entrada),\n+    INDEX idx_fecha_salida (fecha_salida),\n+    INDEX idx_estado (estado),\n+    INDEX idx_tipo_acceso (tipo_acceso),\n+    INDEX idx_usuario_registro (id_usuario_registro)\n+  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+  COMMENT=\\'Tabla de accesos (circuito cerrado) - Mantenida para compatibilidad\\'')\n+));\n+PREPARE createIfNotExists FROM @preparedStatement;\n+EXECUTE createIfNotExists;\n+DEALLOCATE PREPARE createIfNotExists;\n+\n+-- =====================================================\n+-- TRIGGER: Sincronizar registros_entrada_salida a Accesos\n+-- =====================================================\n+-- Este trigger mantiene sincronizada la tabla Accesos con registros_entrada_salida\n+-- para compatibilidad con código que aún usa Accesos\n+\n+DELIMITER $$\n+\n+DROP TRIGGER IF EXISTS tr_sync_accesos_entrada$$\n+CREATE TRIGGER tr_sync_accesos_entrada\n+AFTER INSERT ON registros_entrada_salida\n+FOR EACH ROW\n+BEGIN\n+  IF NEW.tipo = 'ENTRADA' THEN\n+    -- Insertar nuevo acceso en Accesos\n+    INSERT INTO Accesos (\n+      id_persona,\n+      tipo_acceso,\n+      fecha_entrada,\n+      estado\n+    ) VALUES (\n+      NEW.id_persona,\n+      'entrada',\n+      NEW.fecha_hora,\n+      'activo'\n+    );\n+  ELSEIF NEW.tipo = 'SALIDA' THEN\n+    -- Actualizar el último acceso activo de la persona\n+    UPDATE Accesos\n+    SET fecha_salida = NEW.fecha_hora,\n+        estado = 'finalizado',\n+        fecha_actualizacion = NOW()\n+    WHERE id_persona = NEW.id_persona\n+      AND estado = 'activo'\n+      AND fecha_salida IS NULL\n+    ORDER BY fecha_entrada DESC\n+    LIMIT 1;\n+    \n+    -- Si no hay acceso activo, crear uno nuevo\n+    IF ROW_COUNT() = 0 THEN\n+      INSERT INTO Accesos (\n+        id_persona,\n+        tipo_acceso,\n+        fecha_entrada,\n+        fecha_salida,\n+        estado\n+      ) VALUES (\n+        NEW.id_persona,\n+        'salida',\n+        NEW.fecha_hora,\n+        NEW.fecha_hora,\n+        'finalizado'\n+      );\n+    END IF;\n+  END IF;\n+END$$\n+\n+DELIMITER ;\n+\n"
                },
                {
                    "date": 1763686472648,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -689,54 +689,202 @@\n \n DELIMITER $$\n \n DROP TRIGGER IF EXISTS tr_sync_accesos_entrada$$\n+\n CREATE TRIGGER tr_sync_accesos_entrada\n AFTER INSERT ON registros_entrada_salida\n FOR EACH ROW\n BEGIN\n+  DECLARE v_id_usuario_registro INT DEFAULT NULL;\n+  \n   IF NEW.tipo = 'ENTRADA' THEN\n     -- Insertar nuevo acceso en Accesos\n     INSERT INTO Accesos (\n       id_persona,\n+      id_usuario_registro,\n       tipo_acceso,\n       fecha_entrada,\n-      estado\n+      estado,\n+      fecha_creacion,\n+      fecha_actualizacion\n     ) VALUES (\n       NEW.id_persona,\n+      v_id_usuario_registro,\n       'entrada',\n       NEW.fecha_hora,\n-      'activo'\n+      'activo',\n+      NEW.fecha_hora,\n+      NEW.fecha_hora\n     );\n   ELSEIF NEW.tipo = 'SALIDA' THEN\n     -- Actualizar el último acceso activo de la persona\n+    -- Usar subconsulta para obtener el ID del último acceso activo\n     UPDATE Accesos\n     SET fecha_salida = NEW.fecha_hora,\n         estado = 'finalizado',\n         fecha_actualizacion = NOW()\n-    WHERE id_persona = NEW.id_persona\n-      AND estado = 'activo'\n-      AND fecha_salida IS NULL\n-    ORDER BY fecha_entrada DESC\n-    LIMIT 1;\n+    WHERE id_acceso = (\n+      SELECT id_acceso FROM (\n+        SELECT id_acceso\n+        FROM Accesos\n+        WHERE id_persona = NEW.id_persona\n+          AND estado = 'activo'\n+          AND fecha_salida IS NULL\n+        ORDER BY fecha_entrada DESC\n+        LIMIT 1\n+      ) AS temp\n+    );\n     \n-    -- Si no hay acceso activo, crear uno nuevo\n+    -- Si no hay acceso activo, crear uno nuevo (salida sin entrada previa)\n     IF ROW_COUNT() = 0 THEN\n       INSERT INTO Accesos (\n         id_persona,\n+        id_usuario_registro,\n         tipo_acceso,\n         fecha_entrada,\n         fecha_salida,\n-        estado\n+        estado,\n+        fecha_creacion,\n+        fecha_actualizacion\n       ) VALUES (\n         NEW.id_persona,\n+        v_id_usuario_registro,\n         'salida',\n         NEW.fecha_hora,\n         NEW.fecha_hora,\n-        'finalizado'\n+        'finalizado',\n+        NEW.fecha_hora,\n+        NEW.fecha_hora\n       );\n     END IF;\n   END IF;\n END$$\n \n DELIMITER ;\n \n+-- =====================================================\n+-- SCRIPT DE MIGRACIÓN: Poblar Accesos con datos existentes\n+-- =====================================================\n+-- Este script migra los datos existentes de registros_entrada_salida a Accesos\n+-- Ejecutar manualmente si es necesario poblar datos históricos\n+\n+-- Procedimiento para migrar datos existentes\n+DELIMITER $$\n+\n+DROP PROCEDURE IF EXISTS sp_migrar_accesos_existentes$$\n+\n+CREATE PROCEDURE sp_migrar_accesos_existentes()\n+BEGIN\n+  DECLARE done INT DEFAULT FALSE;\n+  DECLARE v_id_persona INT;\n+  DECLARE v_tipo VARCHAR(10);\n+  DECLARE v_fecha_hora TIMESTAMP;\n+  DECLARE v_ultima_entrada_id INT DEFAULT NULL;\n+  \n+  -- Cursor para recorrer registros de entrada\n+  DECLARE cur_entradas CURSOR FOR\n+    SELECT id_persona, fecha_hora\n+    FROM registros_entrada_salida\n+    WHERE tipo = 'ENTRADA'\n+    ORDER BY id_persona, fecha_hora;\n+  \n+  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;\n+  \n+  -- Limpiar tabla Accesos antes de migrar (opcional, comentar si no se desea)\n+  -- TRUNCATE TABLE Accesos;\n+  \n+  -- Procesar entradas y crear registros en Accesos\n+  OPEN cur_entradas;\n+  \n+  read_loop: LOOP\n+    FETCH cur_entradas INTO v_id_persona, v_fecha_hora;\n+    IF done THEN\n+      LEAVE read_loop;\n+    END IF;\n+    \n+    -- Insertar entrada en Accesos\n+    INSERT INTO Accesos (\n+      id_persona,\n+      id_usuario_registro,\n+      tipo_acceso,\n+      fecha_entrada,\n+      estado,\n+      fecha_creacion,\n+      fecha_actualizacion\n+    ) VALUES (\n+      v_id_persona,\n+      NULL,\n+      'entrada',\n+      v_fecha_hora,\n+      'activo',\n+      v_fecha_hora,\n+      v_fecha_hora\n+    );\n+    \n+    SET v_ultima_entrada_id = LAST_INSERT_ID();\n+    \n+    -- Buscar la siguiente salida para esta persona después de esta entrada\n+    SELECT id_acceso INTO v_ultima_entrada_id\n+    FROM Accesos\n+    WHERE id_persona = v_id_persona\n+      AND tipo_acceso = 'entrada'\n+      AND fecha_entrada = v_fecha_hora\n+      AND estado = 'activo'\n+    ORDER BY fecha_entrada DESC\n+    LIMIT 1;\n+    \n+    -- Buscar salida correspondiente\n+    SELECT fecha_hora INTO v_fecha_hora\n+    FROM registros_entrada_salida\n+    WHERE id_persona = v_id_persona\n+      AND tipo = 'SALIDA'\n+      AND fecha_hora > v_fecha_hora\n+    ORDER BY fecha_hora ASC\n+    LIMIT 1;\n+    \n+    -- Si hay salida, actualizar el acceso\n+    IF v_fecha_hora IS NOT NULL AND v_ultima_entrada_id IS NOT NULL THEN\n+      UPDATE Accesos\n+      SET fecha_salida = v_fecha_hora,\n+          estado = 'finalizado',\n+          fecha_actualizacion = v_fecha_hora\n+      WHERE id_acceso = v_ultima_entrada_id;\n+    END IF;\n+    \n+  END LOOP;\n+  \n+  CLOSE cur_entradas;\n+  \n+  -- Procesar salidas sin entrada previa\n+  INSERT INTO Accesos (\n+    id_persona,\n+    id_usuario_registro,\n+    tipo_acceso,\n+    fecha_entrada,\n+    fecha_salida,\n+    estado,\n+    fecha_creacion,\n+    fecha_actualizacion\n+  )\n+  SELECT \n+    id_persona,\n+    NULL,\n+    'salida',\n+    fecha_hora,\n+    fecha_hora,\n+    'finalizado',\n+    fecha_hora,\n+    fecha_hora\n+  FROM registros_entrada_salida\n+  WHERE tipo = 'SALIDA'\n+    AND NOT EXISTS (\n+      SELECT 1 FROM Accesos a\n+      WHERE a.id_persona = registros_entrada_salida.id_persona\n+        AND a.fecha_salida = registros_entrada_salida.fecha_hora\n+    );\n+  \n+  SELECT CONCAT('Migración completada. Registros procesados.') as resultado;\n+END$$\n+\n+DELIMITER ;\n+\n"
                },
                {
                    "date": 1763691055501,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -244,13 +244,8 @@\n     INDEX idx_id_usuario (id_usuario),\n     INDEX idx_fecha (fecha)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n-\n-\n-\n-\n-\n -- =====================================================\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n -- Sistema de Control de Acceso SENA\n -- =====================================================\n@@ -524,9 +519,8 @@\n -- Estas tablas requieren tablas adicionales que no están en la estructura básica\n \n \n \n-\n -- =====================================================\n -- NOTA: La inserción de programas de formación se puede hacer\n -- manualmente si se necesita la tabla Programas_Formacion\n -- =====================================================\n@@ -886,5 +880,4 @@\n   SELECT CONCAT('Migración completada. Registros procesados.') as resultado;\n END$$\n \n DELIMITER ;\n-\n"
                },
                {
                    "date": 1763696219638,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,80 +246,76 @@\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n \n -- =====================================================\n -- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n--- Sistema de Control de Acceso SENA\n+-- Sistema de Control de Acceso SENA - CIRCUITO ABIERTO\n -- =====================================================\n \n USE control_acceso_sena;\n \n -- =====================================================\n+-- TABLA: Programas_Formacion\n+-- CIRCUITO ABIERTO: Sin foreign keys restrictivas\n+-- =====================================================\n+CREATE TABLE IF NOT EXISTS Programas_Formacion (\n+  id_programa INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_programa VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único del programa (ej: TEC-PS-001)',\n+  nombre_programa VARCHAR(200) NOT NULL COMMENT 'Nombre completo del programa de formación',\n+  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Formación Complementaria') DEFAULT 'Técnico' COMMENT 'Nivel de formación',\n+  duracion_meses INT DEFAULT 12 COMMENT 'Duración del programa en meses',\n+  area_conocimiento VARCHAR(100) NULL COMMENT 'Área de conocimiento o especialidad',\n+  descripcion TEXT NULL COMMENT 'Descripción detallada del programa',\n+  estado ENUM('activo', 'inactivo', 'suspendido') DEFAULT 'activo' COMMENT 'Estado del programa',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\n+  \n+  -- Índices para optimización\n+  INDEX idx_codigo_programa (codigo_programa),\n+  INDEX idx_nivel (nivel),\n+  INDEX idx_area_conocimiento (area_conocimiento),\n+  INDEX idx_estado (estado),\n+  INDEX idx_nombre_programa (nombre_programa(100))\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Catálogo de programas de formación del SENA - Circuito Abierto';\n+\n+-- =====================================================\n -- TABLA: Fichas\n+-- CIRCUITO ABIERTO: Sin foreign keys restrictivas\n -- =====================================================\n CREATE TABLE IF NOT EXISTS Fichas (\n   id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n   codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n   programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n-  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional)',\n+  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional, para relación flexible)',\n   id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n   jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n   fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n   fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n   estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n   numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n   capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n   observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\n+  \n+  -- Índices para optimización (sin foreign keys restrictivas para circuito abierto)\n   INDEX idx_ficha_codigo (codigo_ficha),\n   INDEX idx_ficha_programa (id_programa),\n   INDEX idx_ficha_estado (estado),\n   INDEX idx_ficha_jornada (jornada),\n   INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n-  INDEX idx_ficha_ambiente (id_ambiente_principal)\n-  -- NOTA: Las foreign keys a Programas_Formacion y Ambientes se agregan después\n-  -- si esas tablas existen, para evitar errores de creación\n+  INDEX idx_ficha_ambiente (id_ambiente_principal),\n+  INDEX idx_programa_formacion (programa_formacion(100))\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Tabla para gestionar las fichas de formación del SENA';\n+COMMENT='Tabla para gestionar las fichas de formación del SENA - Circuito Abierto';\n \n--- Crear tabla fichas (minúscula) - El código de importación busca 'fichas' en minúscula\n--- NOTA: Si tu MySQL es case-sensitive (Linux), necesitarás usar el mismo case en todo el código\n--- Si prefieres usar solo 'Fichas' (mayúscula), actualiza el código para usar 'Fichas' consistentemente\n-CREATE TABLE IF NOT EXISTS fichas (\n-  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n-  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n-  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n-  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional)',\n-  id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n-  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n-  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n-  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n-  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n-  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n-  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n-  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n-  INDEX idx_ficha_codigo (codigo_ficha),\n-  INDEX idx_ficha_programa (id_programa),\n-  INDEX idx_ficha_estado (estado),\n-  INDEX idx_ficha_jornada (jornada),\n-  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n-  INDEX idx_ficha_ambiente (id_ambiente_principal)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n-COMMENT='Tabla para gestionar las fichas de formación del SENA';\n+-- NOTA: En CIRCUITO ABIERTO no usamos FOREIGN KEYS restrictivas\n+-- Las relaciones se manejan a nivel de aplicación para mayor flexibilidad\n+-- Esto permite:\n+-- 1. Crear fichas sin requerir que exista el programa previamente\n+-- 2. Eliminar programas sin afectar fichas existentes (solo se limpia la referencia)\n+-- 3. Mayor flexibilidad en la gestión de datos\n \n--- Intentar agregar foreign keys opcionales (solo si las tablas relacionadas existen)\n--- Estas foreign keys se pueden agregar manualmente después si se necesitan\n--- ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL;\n--- ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_ambiente FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL;\n-\n--- Agregar foreign key desde Personas a Fichas (opcional, solo si la tabla ya existe)\n--- Nota: Esta foreign key se agregará automáticamente si ambas tablas existen\n--- Si la tabla Personas ya existe sin id_ficha, se debe ejecutar manualmente:\n--- ALTER TABLE Personas ADD COLUMN id_ficha INT NULL AFTER ficha;\n--- ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n-\n -- =====================================================\n -- TABLA: Accesos (CIRCUITO CERRADO - Para compatibilidad)\n -- NOTA: Esta tabla se mantiene para compatibilidad con código existente\n -- El sistema principal usa registros_entrada_salida (circuito abierto)\n@@ -609,15 +605,90 @@\n 5. La tabla usa tipo ENUM('ENTRADA', 'SALIDA') y fecha_hora (circuito abierto)\n */\n \n -- =====================================================\n--- MIGRACIONES: Agregar columna fecha_actualizacion si no existe\n+-- MIGRACIONES: Crear tablas de catálogo (Programas_Formacion y Fichas)\n+-- CIRCUITO ABIERTO: Sin foreign keys restrictivas\n -- =====================================================\n--- Ejecutar este script si la base de datos ya existe y necesita agregar la columna\n--- O ejecutar el schema completo que ya incluye esta columna\n+SET @dbname = DATABASE();\n \n+-- Crear tabla Programas_Formacion si no existe\n+SET @tablename = 'Programas_Formacion';\n+SET @preparedStatement = (SELECT IF(\n+  (\n+    SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES\n+    WHERE\n+      (TABLE_SCHEMA = @dbname)\n+      AND (TABLE_NAME = @tablename)\n+  ) > 0,\n+  'SELECT 1',\n+  CONCAT('CREATE TABLE ', @tablename, ' (\n+    id_programa INT AUTO_INCREMENT PRIMARY KEY,\n+    codigo_programa VARCHAR(50) UNIQUE NOT NULL COMMENT ''Código único del programa (ej: TEC-PS-001)'',\n+    nombre_programa VARCHAR(200) NOT NULL COMMENT ''Nombre completo del programa de formación'',\n+    nivel ENUM(''Técnico'', ''Tecnológico'', ''Especialización'', ''Formación Complementaria'') DEFAULT ''Técnico'' COMMENT ''Nivel de formación'',\n+    duracion_meses INT DEFAULT 12 COMMENT ''Duración del programa en meses'',\n+    area_conocimiento VARCHAR(100) NULL COMMENT ''Área de conocimiento o especialidad'',\n+    descripcion TEXT NULL COMMENT ''Descripción detallada del programa'',\n+    estado ENUM(''activo'', ''inactivo'', ''suspendido'') DEFAULT ''activo'' COMMENT ''Estado del programa'',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT ''Fecha de creación del registro'',\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT ''Fecha de última actualización'',\n+    INDEX idx_codigo_programa (codigo_programa),\n+    INDEX idx_nivel (nivel),\n+    INDEX idx_area_conocimiento (area_conocimiento),\n+    INDEX idx_estado (estado),\n+    INDEX idx_nombre_programa (nombre_programa(100))\n+  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+  COMMENT=''Catálogo de programas de formación del SENA - Circuito Abierto''')\n+));\n+PREPARE createIfNotExists FROM @preparedStatement;\n+EXECUTE createIfNotExists;\n+DEALLOCATE PREPARE createIfNotExists;\n+\n+-- Crear tabla Fichas si no existe (asegurar que sea única, no duplicada)\n+SET @tablename = 'Fichas';\n+SET @preparedStatement = (SELECT IF(\n+  (\n+    SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES\n+    WHERE\n+      (TABLE_SCHEMA = @dbname)\n+      AND (TABLE_NAME = @tablename)\n+  ) > 0,\n+  'SELECT 1',\n+  CONCAT('CREATE TABLE ', @tablename, ' (\n+    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT ''Código único de la ficha (ej: 3066232)'',\n+    programa_formacion VARCHAR(200) NOT NULL COMMENT ''Nombre del programa de formación'',\n+    id_programa INT NULL COMMENT ''Referencia al programa de formación (opcional, para relación flexible)'',\n+    id_ambiente_principal INT NULL COMMENT ''Ambiente principal asignado a la ficha (opcional)'',\n+    jornada ENUM(''diurna'', ''nocturna'', ''mixta'') DEFAULT ''diurna'' COMMENT ''Jornada de formación'',\n+    fecha_inicio DATE NULL COMMENT ''Fecha de inicio de la ficha'',\n+    fecha_fin DATE NULL COMMENT ''Fecha de finalización de la ficha'',\n+    estado ENUM(''activa'', ''finalizada'', ''cancelada'') DEFAULT ''activa'' COMMENT ''Estado actual de la ficha'',\n+    numero_aprendices INT DEFAULT 0 COMMENT ''Número de aprendices asignados'',\n+    capacidad_maxima INT NULL COMMENT ''Capacidad máxima de aprendices'',\n+    observaciones TEXT NULL COMMENT ''Observaciones adicionales'',\n+    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT ''Fecha de creación del registro'',\n+    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT ''Fecha de última actualización'',\n+    INDEX idx_ficha_codigo (codigo_ficha),\n+    INDEX idx_ficha_programa (id_programa),\n+    INDEX idx_ficha_estado (estado),\n+    INDEX idx_ficha_jornada (jornada),\n+    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+    INDEX idx_ficha_ambiente (id_ambiente_principal),\n+    INDEX idx_programa_formacion (programa_formacion(100))\n+  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+  COMMENT=''Tabla para gestionar las fichas de formación del SENA - Circuito Abierto''')\n+));\n+PREPARE createIfNotExists FROM @preparedStatement;\n+EXECUTE createIfNotExists;\n+DEALLOCATE PREPARE createIfNotExists;\n+\n+-- Eliminar tabla duplicada 'fichas' (minúscula) si existe\n+-- NOTA: Mantener solo 'Fichas' (mayúscula) para consistencia\n+DROP TABLE IF EXISTS fichas;\n+\n -- Agregar fecha_actualizacion a Personas si no existe\n-SET @dbname = DATABASE();\n SET @tablename = 'Personas';\n SET @columnname = 'fecha_actualizacion';\n SET @preparedStatement = (SELECT IF(\n   (\n"
                },
                {
                    "date": 1763696657126,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -610,8 +610,54 @@\n -- CIRCUITO ABIERTO: Sin foreign keys restrictivas\n -- =====================================================\n SET @dbname = DATABASE();\n \n+-- Eliminar foreign keys restrictivas si existen (CIRCUITO ABIERTO)\n+-- Eliminar foreign key de Personas a Programas_Formacion si existe\n+SET @fk_name = (SELECT CONSTRAINT_NAME \n+                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                WHERE TABLE_SCHEMA = @dbname \n+                  AND TABLE_NAME = 'Personas' \n+                  AND COLUMN_NAME = 'id_programa' \n+                  AND REFERENCED_TABLE_NAME IS NOT NULL\n+                LIMIT 1);\n+SET @sql = IF(@fk_name IS NOT NULL, \n+              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Eliminar foreign key de Personas a Fichas si existe\n+SET @fk_name = (SELECT CONSTRAINT_NAME \n+                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                WHERE TABLE_SCHEMA = @dbname \n+                  AND TABLE_NAME = 'Personas' \n+                  AND COLUMN_NAME = 'id_ficha' \n+                  AND REFERENCED_TABLE_NAME IS NOT NULL\n+                LIMIT 1);\n+SET @sql = IF(@fk_name IS NOT NULL, \n+              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Eliminar foreign key de Fichas a Programas_Formacion si existe\n+SET @fk_name = (SELECT CONSTRAINT_NAME \n+                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                WHERE TABLE_SCHEMA = @dbname \n+                  AND TABLE_NAME = 'Fichas' \n+                  AND COLUMN_NAME = 'id_programa' \n+                  AND REFERENCED_TABLE_NAME IS NOT NULL\n+                LIMIT 1);\n+SET @sql = IF(@fk_name IS NOT NULL, \n+              CONCAT('ALTER TABLE Fichas DROP FOREIGN KEY ', @fk_name), \n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n -- Crear tabla Programas_Formacion si no existe\n SET @tablename = 'Programas_Formacion';\n SET @preparedStatement = (SELECT IF(\n   (\n@@ -643,8 +689,11 @@\n PREPARE createIfNotExists FROM @preparedStatement;\n EXECUTE createIfNotExists;\n DEALLOCATE PREPARE createIfNotExists;\n \n+-- Eliminar tabla duplicada 'fichas' (minúscula) si existe\n+DROP TABLE IF EXISTS fichas;\n+\n -- Crear tabla Fichas si no existe (asegurar que sea única, no duplicada)\n SET @tablename = 'Fichas';\n SET @preparedStatement = (SELECT IF(\n   (\n@@ -682,12 +731,8 @@\n PREPARE createIfNotExists FROM @preparedStatement;\n EXECUTE createIfNotExists;\n DEALLOCATE PREPARE createIfNotExists;\n \n--- Eliminar tabla duplicada 'fichas' (minúscula) si existe\n--- NOTA: Mantener solo 'Fichas' (mayúscula) para consistencia\n-DROP TABLE IF EXISTS fichas;\n-\n -- Agregar fecha_actualizacion a Personas si no existe\n SET @tablename = 'Personas';\n SET @columnname = 'fecha_actualizacion';\n SET @preparedStatement = (SELECT IF(\n"
                },
                {
                    "date": 1763697154326,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -731,8 +731,77 @@\n PREPARE createIfNotExists FROM @preparedStatement;\n EXECUTE createIfNotExists;\n DEALLOCATE PREPARE createIfNotExists;\n \n+-- =====================================================\n+-- AGREGAR FOREIGN KEYS (CIRCUITO ABIERTO - ON DELETE SET NULL)\n+-- Todas las tablas quedan enlazadas pero con flexibilidad\n+-- =====================================================\n+\n+-- Agregar foreign key: Personas.id_programa → Programas_Formacion.id_programa\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = @dbname\n+                    AND TABLE_NAME = 'Personas' \n+                    AND COLUMN_NAME = 'id_programa' \n+                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\n+                  LIMIT 1);\n+SET @sql = IF(@fk_exists = 0,\n+              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Agregar foreign key: Personas.id_ficha → Fichas.id_ficha\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = @dbname\n+                    AND TABLE_NAME = 'Personas' \n+                    AND COLUMN_NAME = 'id_ficha' \n+                    AND REFERENCED_TABLE_NAME = 'Fichas'\n+                  LIMIT 1);\n+SET @sql = IF(@fk_exists = 0,\n+              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Agregar foreign key: Fichas.id_programa → Programas_Formacion.id_programa\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = @dbname\n+                    AND TABLE_NAME = 'Fichas' \n+                    AND COLUMN_NAME = 'id_programa' \n+                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\n+                  LIMIT 1);\n+SET @sql = IF(@fk_exists = 0,\n+              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Agregar foreign key: Fichas.id_ambiente_principal → Ambientes.id_ambiente (si existe la tabla Ambientes)\n+SET @ambientes_exists = (SELECT COUNT(*) \n+                         FROM INFORMATION_SCHEMA.TABLES \n+                         WHERE TABLE_SCHEMA = @dbname\n+                           AND TABLE_NAME = 'Ambientes');\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = @dbname\n+                    AND TABLE_NAME = 'Fichas' \n+                    AND COLUMN_NAME = 'id_ambiente_principal' \n+                    AND REFERENCED_TABLE_NAME = 'Ambientes'\n+                  LIMIT 1);\n+SET @sql = IF(@ambientes_exists > 0 AND @fk_exists = 0,\n+              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_ambiente FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n -- Agregar fecha_actualizacion a Personas si no existe\n SET @tablename = 'Personas';\n SET @columnname = 'fecha_actualizacion';\n SET @preparedStatement = (SELECT IF(\n"
                },
                {
                    "date": 1764226613149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,943 @@\n+-- ESQUEMA COMPLETO DE BASE DE DATOS\n+\n+-- Sistema de Control de Acceso SENA\n+\n+-- 100% SIN CIRCUITOS CERRADOS Y SIN REDUNDANCIAS\n+\n -- =====================================================\n+\n+\n+-- =====================================================\n+\n+-- ELIMINAR BASE DE DATOS ANTERIOR (OPCIONAL)\n+\n+-- =====================================================\n+\n+-- DROP DATABASE IF EXISTS control_acceso_sena;\n+\n+\n+CREATE DATABASE IF NOT EXISTS control_acceso_sena \n+\n+CHARACTER SET utf8mb4 \n+\n+COLLATE utf8mb4_unicode_ci;\n+\n+\n+USE control_acceso_sena;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: usuarios\n+\n+-- Sin conexión circular a personas\n+\n+-- =====================================================\n+\n+CREATE TABLE usuarios (\n+\n+  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n+\n+  nombre VARCHAR(100) NOT NULL,\n+\n+  email VARCHAR(100) UNIQUE NOT NULL,\n+\n+  passwords VARCHAR(255) NOT NULL,\n+\n+  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\n+\n+  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+  ultimo_acceso TIMESTAMP NULL,\n+\n+  INDEX idx_email (email),\n+\n+  INDEX idx_rol (rol),\n+\n+  INDEX idx_estado (estado)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- Credenciales por defecto\n+\n+INSERT INTO usuarios (nombre, email, passwords, rol, estado) VALUES\n+\n+('Administrador', 'admin@sena.edu.co', '$2a$10$3666f.g.6YwF2m2MFJCtn.R8ftn9RkRcV6/f1yzdj3VlGZ7EESzeK', 'ADMINISTRADOR', 'ACTIVO'),\n+\n+('Guarda de Seguridad', 'guarda@sena.edu.co', '$2a$10$DMCaQbx2V5QUTMYuSZvJaOk4OGfltNh2ClwOByuofhDQwBh1641dK', 'GUARDA', 'ACTIVO')\n+\n+ON DUPLICATE KEY UPDATE nombre = VALUES(nombre);\n+\n+\n+-- =====================================================\n+\n+-- TABLA: roles\n+\n+-- Catálogo simple sin circuitos\n+\n+-- =====================================================\n+\n+CREATE TABLE roles (\n+\n+    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n+\n+    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n+\n+    descripcion VARCHAR(255),\n+\n+    INDEX idx_nombre_rol (nombre_rol)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+INSERT INTO roles (nombre_rol, descripcion) VALUES\n+\n+('APRENDIZ', 'Aprendiz del SENA'),\n+\n+('INSTRUCTOR', 'Instructor del SENA'),\n+\n+('ADMINISTRATIVO', 'Personal administrativo'),\n+\n+('VISITANTE', 'Visitante temporal'),\n+\n+('GUARDA', 'Guarda de seguridad')\n+\n+ON DUPLICATE KEY UPDATE nombre_rol = nombre_rol;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: programas_formacion\n+\n+-- Tabla independiente, sin foreign keys hacia arriba\n+\n+-- =====================================================\n+\n+CREATE TABLE programas_formacion (\n+\n+  id_programa INT AUTO_INCREMENT PRIMARY KEY,\n+\n+  codigo_programa VARCHAR(50) UNIQUE NOT NULL,\n+\n+  nombre_programa VARCHAR(200) NOT NULL,\n+\n+  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Complementaria') DEFAULT 'Técnico',\n+\n+  duracion_meses INT DEFAULT 12,\n+\n+  area_conocimiento VARCHAR(100),\n+\n+  descripcion TEXT,\n+\n+  estado ENUM('activo', 'inactivo') DEFAULT 'activo',\n+\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+\n+  INDEX idx_codigo (codigo_programa),\n+\n+  INDEX idx_estado (estado),\n+\n+  INDEX idx_nombre (nombre_programa(100))\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: fichas\n+\n+-- Solo referencia a programas (unidireccional)\n+\n+-- =====================================================\n+\n+CREATE TABLE fichas (\n+\n+  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+\n+  codigo_ficha VARCHAR(50) UNIQUE NOT NULL,\n+\n+  id_programa INT NOT NULL,\n+\n+  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna',\n+\n+  fecha_inicio DATE,\n+\n+  fecha_fin DATE,\n+\n+  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa',\n+\n+  numero_aprendices INT DEFAULT 0,\n+\n+  capacidad_maxima INT,\n+\n+  FOREIGN KEY (id_programa) REFERENCES programas_formacion(id_programa) ON DELETE RESTRICT,\n+\n+  INDEX idx_codigo (codigo_ficha),\n+\n+  INDEX idx_programa (id_programa),\n+\n+  INDEX idx_estado (estado),\n+\n+  INDEX idx_fechas (fecha_inicio, fecha_fin)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: personas\n+\n+-- SIN REDUNDANCIAS - Solo campos esenciales\n+\n+-- SIN circuitos cerrados - Solo referencias hacia abajo\n+\n+-- =====================================================\n+\n+CREATE TABLE personas (\n+\n+  id_persona INT AUTO_INCREMENT PRIMARY KEY,\n+\n+  \n+\n+  -- Datos de identificación (NO REDUNDANTES)\n+\n+  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\n+\n+  documento VARCHAR(50) UNIQUE NOT NULL,\n+\n+  nombres VARCHAR(100) NOT NULL,\n+\n+  apellidos VARCHAR(100) NOT NULL,\n+\n+  \n+\n+  -- Datos de contacto\n+\n+  email VARCHAR(255),\n+\n+  telefono VARCHAR(20),\n+\n+  rh VARCHAR(10) COMMENT 'Grupo sanguíneo',\n+\n+  \n+\n+  -- Referencias UNIDIRECCIONALES (sin circuitos)\n+\n+  id_rol INT NOT NULL,\n+\n+  id_ficha INT NULL COMMENT 'Solo para aprendices',\n+\n+  \n+\n+  -- Campos específicos por rol\n+\n+  cargo VARCHAR(100) NULL COMMENT 'Solo para instructores/administrativos',\n+\n+  tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL COMMENT 'Solo para instructores',\n+\n+  \n+\n+  -- Datos del sistema\n+\n+  codigo_qr VARCHAR(255),\n+\n+  foto VARCHAR(500),\n+\n+  estado ENUM('ACTIVO', 'INACTIVO', 'SUSPENDIDO') DEFAULT 'ACTIVO',\n+\n+  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+\n+  \n+\n+  -- Foreign Keys UNIDIRECCIONALES (sin ciclos)\n+\n+  FOREIGN KEY (id_rol) REFERENCES roles(id_rol) ON DELETE RESTRICT,\n+\n+  FOREIGN KEY (id_ficha) REFERENCES fichas(id_ficha) ON DELETE SET NULL,\n+\n+  \n+\n+  -- Índices\n+\n+  INDEX idx_documento (documento),\n+\n+  INDEX idx_tipo_doc (tipo_documento),\n+\n+  INDEX idx_rol (id_rol),\n+\n+  INDEX idx_ficha (id_ficha),\n+\n+  INDEX idx_estado (estado),\n+\n+  INDEX idx_email (email)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+\n+COMMENT='Tabla personas - SIN redundancias ni circuitos cerrados';\n+\n+\n+-- =====================================================\n+\n+-- TABLA: visitantes\n+\n+-- Información adicional SOLO para visitantes\n+\n+-- =====================================================\n+\n+CREATE TABLE visitantes (\n+\n+    id_visitante INT AUTO_INCREMENT PRIMARY KEY,\n+\n+    id_persona INT NOT NULL,\n+\n+    motivo_visita TEXT NOT NULL,\n+\n+    contacto VARCHAR(255),\n+\n+    persona_visita VARCHAR(255),\n+\n+    zona VARCHAR(200) COMMENT 'Destino dentro de las instalaciones',\n+\n+    fecha_inicio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+    fecha_fin TIMESTAMP NULL,\n+\n+    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') DEFAULT 'ACTIVO',\n+\n+    FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\n+\n+    INDEX idx_persona (id_persona),\n+\n+    INDEX idx_estado (estado),\n+\n+    INDEX idx_fecha_inicio (fecha_inicio)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: registros_entrada_salida\n+\n+-- CIRCUITO ABIERTO: Registros independientes\n+\n+-- =====================================================\n+\n+CREATE TABLE registros_entrada_salida (\n+\n+  id_registro INT AUTO_INCREMENT PRIMARY KEY,\n+\n+  id_persona INT NOT NULL,\n+\n+  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\n+\n+  fecha_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+  id_usuario_registro INT NULL COMMENT 'Guarda que registró',\n+\n+  FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\n+\n+  FOREIGN KEY (id_usuario_registro) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+\n+  INDEX idx_persona (id_persona),\n+\n+  INDEX idx_tipo (tipo),\n+\n+  INDEX idx_fecha (fecha_hora),\n+\n+  INDEX idx_persona_fecha (id_persona, fecha_hora DESC)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+\n+COMMENT='Registros independientes - Sin circuitos cerrados';\n+\n+\n+-- =====================================================\n+\n+-- TABLA: logs_seguridad\n+\n+-- Solo para auditoría, sin conexión circular\n+\n+-- =====================================================\n+\n+CREATE TABLE logs_seguridad (\n+\n+    id_log INT AUTO_INCREMENT PRIMARY KEY,\n+\n+    tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', \n+\n+              'modificacion_usuario', 'acceso_sistema') NOT NULL,\n+\n+    id_usuario INT NULL,\n+\n+    ip_address VARCHAR(45),\n+\n+    user_agent TEXT,\n+\n+    accion TEXT NOT NULL,\n+\n+    detalles JSON,\n+\n+    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+\n+    INDEX idx_tipo (tipo),\n+\n+    INDEX idx_usuario (id_usuario),\n+\n+    INDEX idx_fecha (fecha)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: auditoria\n+\n+-- Tabla de auditoría general\n+\n+-- =====================================================\n+\n+CREATE TABLE auditoria (\n+\n+    id_auditoria INT AUTO_INCREMENT PRIMARY KEY,\n+\n+    tabla_afectada VARCHAR(100) NOT NULL,\n+\n+    id_registro INT,\n+\n+    accion ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,\n+\n+    datos_anteriores JSON,\n+\n+    datos_nuevos JSON,\n+\n+    id_usuario INT NULL,\n+\n+    ip_address VARCHAR(45),\n+\n+    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+\n+    INDEX idx_tabla (tabla_afectada),\n+\n+    INDEX idx_accion (accion),\n+\n+    INDEX idx_fecha (fecha)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- =====================================================\n+\n+-- TABLA: evidencia_fotografica\n+\n+-- Evidencias de incidentes\n+\n+-- =====================================================\n+\n+CREATE TABLE evidencia_fotografica (\n+\n+    id_evidencia INT AUTO_INCREMENT PRIMARY KEY,\n+\n+    tipo_incidente ENUM('acceso_denegado', 'comportamiento_sospechoso', \n+\n+                        'incidente_seguridad', 'evidencia_general') NOT NULL,\n+\n+    url_foto VARCHAR(500) NOT NULL,\n+\n+    hash_archivo VARCHAR(64),\n+\n+    fecha_captura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+\n+    id_usuario_captura INT NULL,\n+\n+    descripcion TEXT,\n+\n+    metadata JSON,\n+\n+    FOREIGN KEY (id_usuario_captura) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+\n+    INDEX idx_tipo (tipo_incidente),\n+\n+    INDEX idx_fecha (fecha_captura)\n+\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+\n+-- =====================================================\n+\n+-- VISTAS OPTIMIZADAS\n+\n+-- =====================================================\n+\n+\n+-- Vista: Información completa de personas (eliminando redundancias)\n+\n+CREATE OR REPLACE VIEW v_personas_completo AS\n+\n+SELECT \n+\n+    p.id_persona,\n+\n+    p.tipo_documento,\n+\n+    p.documento,\n+\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+\n+    p.nombres,\n+\n+    p.apellidos,\n+\n+    p.email,\n+\n+    p.telefono,\n+\n+    p.rh,\n+\n+    r.nombre_rol,\n+\n+    r.descripcion as rol_descripcion,\n+\n+    p.id_ficha,\n+\n+    f.codigo_ficha,\n+\n+    prog.nombre_programa,\n+\n+    prog.codigo_programa,\n+\n+    f.jornada,\n+\n+    p.cargo,\n+\n+    p.tipo_contrato,\n+\n+    p.codigo_qr,\n+\n+    p.foto,\n+\n+    p.estado,\n+\n+    p.fecha_registro\n+\n+FROM personas p\n+\n+INNER JOIN roles r ON p.id_rol = r.id_rol\n+\n+LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+\n+LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa;\n+\n+\n+-- Vista: Personas actualmente dentro\n+\n+CREATE OR REPLACE VIEW v_personas_dentro AS\n+\n+SELECT \n+\n+    p.id_persona,\n+\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+\n+    p.documento,\n+\n+    r.nombre_rol,\n+\n+    p.foto,\n+\n+    reg.fecha_hora as fecha_entrada,\n+\n+    TIMESTAMPDIFF(MINUTE, reg.fecha_hora, NOW()) as minutos_dentro,\n+\n+    f.codigo_ficha,\n+\n+    prog.nombre_programa,\n+\n+    v.zona,\n+\n+    v.motivo_visita,\n+\n+    v.persona_visita\n+\n+FROM personas p\n+\n+INNER JOIN roles r ON p.id_rol = r.id_rol\n+\n+INNER JOIN registros_entrada_salida reg ON p.id_persona = reg.id_persona\n+\n+LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+\n+LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\n+\n+LEFT JOIN visitantes v ON p.id_persona = v.id_persona AND v.estado = 'ACTIVO'\n+\n+WHERE reg.tipo = 'ENTRADA'\n+\n+  AND reg.fecha_hora = (\n+\n+    SELECT MAX(fecha_hora) \n+\n+    FROM registros_entrada_salida \n+\n+    WHERE id_persona = p.id_persona\n+\n+  )\n+\n+  AND NOT EXISTS (\n+\n+    SELECT 1 \n+\n+    FROM registros_entrada_salida r2 \n+\n+    WHERE r2.id_persona = p.id_persona \n+\n+      AND r2.tipo = 'SALIDA' \n+\n+      AND r2.fecha_hora > reg.fecha_hora\n+\n+  )\n+\n+  AND p.estado = 'ACTIVO';\n+\n+\n+-- Vista: Historial de accesos\n+\n+CREATE OR REPLACE VIEW v_historial_accesos AS\n+\n+SELECT \n+\n+    reg.id_registro,\n+\n+    reg.id_persona,\n+\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+\n+    p.documento,\n+\n+    r.nombre_rol,\n+\n+    reg.tipo,\n+\n+    reg.fecha_hora,\n+\n+    DATE(reg.fecha_hora) as fecha,\n+\n+    TIME(reg.fecha_hora) as hora,\n+\n+    f.codigo_ficha,\n+\n+    prog.nombre_programa,\n+\n+    u.nombre as registrado_por\n+\n+FROM registros_entrada_salida reg\n+\n+INNER JOIN personas p ON reg.id_persona = p.id_persona\n+\n+INNER JOIN roles r ON p.id_rol = r.id_rol\n+\n+LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+\n+LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\n+\n+LEFT JOIN usuarios u ON reg.id_usuario_registro = u.id_usuario\n+\n+ORDER BY reg.fecha_hora DESC;\n+\n+\n+-- Vista: Estadísticas diarias\n+\n+CREATE OR REPLACE VIEW v_estadisticas_diarias AS\n+\n+SELECT \n+\n+    DATE(fecha_hora) as fecha,\n+\n+    COUNT(CASE WHEN tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n+\n+    COUNT(CASE WHEN tipo = 'SALIDA' THEN 1 END) as total_salidas,\n+\n+    COUNT(DISTINCT id_persona) as personas_unicas\n+\n+FROM registros_entrada_salida\n+\n+GROUP BY DATE(fecha_hora)\n+\n+ORDER BY fecha DESC;\n+\n+\n+-- =====================================================\n+\n+-- PROCEDIMIENTOS ALMACENADOS\n+\n+-- =====================================================\n+\n+\n+DELIMITER $$\n+\n+\n+-- Registrar entrada\n+\n+CREATE PROCEDURE sp_registrar_entrada(\n+\n+    IN p_id_persona INT,\n+\n+    IN p_id_usuario INT\n+\n+)\n+\n+BEGIN\n+\n+    INSERT INTO registros_entrada_salida \n+\n+    (id_persona, tipo, fecha_hora, id_usuario_registro)\n+\n+    VALUES \n+\n+    (p_id_persona, 'ENTRADA', NOW(), p_id_usuario);\n+\n+    \n+\n+    SELECT LAST_INSERT_ID() as id_registro;\n+\n+END$$\n+\n+\n+-- Registrar salida\n+\n+CREATE PROCEDURE sp_registrar_salida(\n+\n+    IN p_id_persona INT,\n+\n+    IN p_id_usuario INT\n+\n+)\n+\n+BEGIN\n+\n+    INSERT INTO registros_entrada_salida \n+\n+    (id_persona, tipo, fecha_hora, id_usuario_registro)\n+\n+    VALUES \n+\n+    (p_id_persona, 'SALIDA', NOW(), p_id_usuario);\n+\n+    \n+\n+    SELECT LAST_INSERT_ID() as id_registro;\n+\n+END$$\n+\n+\n+-- Obtener personas dentro\n+\n+CREATE PROCEDURE sp_personas_dentro()\n+\n+BEGIN\n+\n+    SELECT * FROM v_personas_dentro\n+\n+    ORDER BY fecha_entrada DESC;\n+\n+END$$\n+\n+\n+-- Verificar última acción\n+\n+CREATE PROCEDURE sp_ultima_accion(IN p_id_persona INT)\n+\n+BEGIN\n+\n+    SELECT \n+\n+        tipo,\n+\n+        fecha_hora,\n+\n+        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n+\n+    FROM registros_entrada_salida\n+\n+    WHERE id_persona = p_id_persona\n+\n+    ORDER BY fecha_hora DESC\n+\n+    LIMIT 1;\n+\n+END$$\n+\n+\n+-- Reporte de asistencia por ficha\n+\n+CREATE PROCEDURE sp_reporte_asistencia_ficha(\n+\n+    IN p_id_ficha INT,\n+\n+    IN p_fecha_inicio DATE,\n+\n+    IN p_fecha_fin DATE\n+\n+)\n+\n+BEGIN\n+\n+    SELECT \n+\n+        p.id_persona,\n+\n+        p.documento,\n+\n+        CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+\n+        COUNT(DISTINCT DATE(reg.fecha_hora)) as dias_asistencia,\n+\n+        COUNT(CASE WHEN reg.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n+\n+        COUNT(CASE WHEN reg.tipo = 'SALIDA' THEN 1 END) as total_salidas\n+\n+    FROM personas p\n+\n+    LEFT JOIN registros_entrada_salida reg \n+\n+        ON p.id_persona = reg.id_persona\n+\n+        AND DATE(reg.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin\n+\n+    WHERE p.id_ficha = p_id_ficha\n+\n+      AND p.estado = 'ACTIVO'\n+\n+    GROUP BY p.id_persona, p.documento, p.nombres, p.apellidos\n+\n+    ORDER BY dias_asistencia DESC;\n+\n+END$$\n+\n+\n+DELIMITER ;\n+\n+\n+-- =====================================================\n+\n+-- VERIFICACIÓN DE ESTRUCTURA\n+\n+-- =====================================================\n+\n+SELECT 'Base de datos creada exitosamente' as estado;\n+\n+SELECT 'Sin circuitos cerrados ✓' as verificacion_1;\n+\n+SELECT 'Sin redundancias ✓' as verificacion_2;\n+\n+SELECT 'Estructura normalizada ✓' as verificacion_3;\n+\n+\n+-- =====================================================\n+\n+-- DOCUMENTACIÓN\n+\n+-- =====================================================\n+\n+/*\n+\n+CAMBIOS IMPLEMENTADOS PARA ELIMINAR CIRCUITOS CERRADOS Y REDUNDANCIAS:\n+\n+\n+1. ELIMINADAS las siguientes columnas REDUNDANTES de 'personas':\n+\n+   ❌ programa VARCHAR(200)        - Ya existe id_ficha → fichas → programas_formacion\n+\n+   ❌ ficha VARCHAR(50)            - Ya existe id_ficha\n+\n+   ❌ nombre VARCHAR(200)          - Ya existe nombres + apellidos\n+\n+   ❌ rol VARCHAR(50)              - Ya existe id_rol → roles\n+\n+   ❌ id_rol_persona               - Duplicado con id_rol\n+\n+   ❌ id_estado_persona            - Ya existe estado ENUM\n+\n+   ❌ id_usuario                   - Creaba circuito cerrado\n+\n+   ❌ zona VARCHAR(200)            - Movido a tabla visitantes\n+\n+\n+2. ESTRUCTURA SIN CIRCUITOS:\n+\n+   usuarios (tabla raíz)\n+\n+   ↓\n+\n+   roles (independiente)\n+\n+   ↓\n+\n+   programas_formacion (independiente)\n+\n+   ↓\n+\n+   fichas (solo referencia programas)\n+\n+   ↓\n+\n+   personas (solo referencia roles y fichas)\n+\n+   ↓\n+\n+   visitantes (solo referencia personas)\n+\n+   ↓\n+\n+   registros_entrada_salida (solo referencia personas y usuarios)\n+\n+\n+3. FLUJO UNIDIRECCIONAL (sin ciclos):\n+\n+   - Todas las referencias van hacia \"abajo\"\n+\n+   - No hay foreign keys que vuelvan hacia \"arriba\"\n+\n+   - Cada tabla tiene máximo 2 foreign keys\n+\n+\n+4. VENTAJAS:\n+\n+   ✓ Sin duplicación de datos\n+\n+   ✓ Fácil mantenimiento\n+\n+   ✓ Integridad referencial clara\n+\n+   ✓ Mejor rendimiento\n+\n+   ✓ Cumple normalización 3FN\n+\n+\n+CONSULTAS PRINCIPALES:\n+\n+- Ver personas dentro: SELECT * FROM v_personas_dentro;\n+\n+- Información completa: SELECT * FROM v_personas_completo WHERE documento = '123456';\n+\n+- Historial: SELECT * FROM v_historial_accesos WHERE fecha = CURDATE();\n+\n+- Estadísticas: SELECT * FROM v_estadisticas_diarias WHERE fecha >= CURDATE() - INTERVAL 7 DAY;\n+\n+*/\n+-- =====================================================\n -- ESQUEMA COMPLETO DE BASE DE DATOS\n -- Sistema de Control de Acceso SENA - CIRCUITO ABIERTO\n -- =====================================================\n \n"
                }
            ],
            "date": 1763535516496,
            "name": "Commit-0",
            "content": "-- =====================================================\n-- ESQUEMA COMPLETO DE BASE DE DATOS\n-- Sistema de Control de Acceso SENA\n-- =====================================================\n\n-- Crear base de datos si no existe\nCREATE DATABASE IF NOT EXISTS control_acceso_sena \nCHARACTER SET utf8mb4 \nCOLLATE utf8mb4_unicode_ci;\n\nUSE control_acceso_sena;\n\n-- =====================================================\n-- TABLA: Roles\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Roles (\n    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n    descripcion VARCHAR(255),\n    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    INDEX idx_nombre_rol (nombre_rol),\n    INDEX idx_estado (estado)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\nINSERT INTO Roles (nombre_rol, descripcion) VALUES\n('aprendiz', 'Aprendiz del SENA'),\n('instructor', 'Instructor del SENA'),\n('administrativo', 'Personal administrativo'),\n('visitante', 'Visitante temporal'),\n('guarda', 'Guarda de seguridad'),\n('admin', 'Administrador del sistema')\nON DUPLICATE KEY UPDATE nombre_rol=nombre_rol;\n\n-- =====================================================\n-- TABLA: Usuarios\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Usuarios (\n    id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n    nombre VARCHAR(255) NOT NULL,\n    email VARCHAR(255) UNIQUE NOT NULL,\n    password_hash VARCHAR(255) NOT NULL,\n    rol ENUM('admin', 'guarda') NOT NULL DEFAULT 'guarda',\n    estado ENUM('activo', 'inactivo') NOT NULL DEFAULT 'activo',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    INDEX idx_email (email),\n    INDEX idx_rol (rol),\n    INDEX idx_estado (estado)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Personas\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Personas (\n    id_persona INT AUTO_INCREMENT PRIMARY KEY,\n    nombre VARCHAR(255) NOT NULL,\n    documento VARCHAR(50) NOT NULL,\n    tipo_documento ENUM('CC', 'CE', 'TI', 'PA', 'NIT') NOT NULL DEFAULT 'CC',\n    email VARCHAR(255),\n    telefono VARCHAR(20),\n    rh VARCHAR(10) NULL COMMENT 'Grupo sanguíneo (A+, A-, B+, B-, AB+, AB-, O+, O-)',\n    foto VARCHAR(500),\n    id_rol INT,\n    rol VARCHAR(50) DEFAULT 'aprendiz',\n    estado ENUM('activo', 'inactivo', 'suspendido') NOT NULL DEFAULT 'activo',\n    -- Campos académicos\n    id_programa INT NULL COMMENT 'Referencia a Programas_Formacion',\n    ficha VARCHAR(50) NULL COMMENT 'Código de ficha del aprendiz',\n    id_ficha INT NULL COMMENT 'Referencia a tabla Fichas',\n    programa VARCHAR(100) NULL COMMENT 'Nombre del programa (legacy)',\n    jornada ENUM('diurna', 'nocturna', 'mixta') NULL COMMENT 'Jornada de formación',\n    fecha_inicio_formacion DATE NULL COMMENT 'Fecha de inicio de formación',\n    fecha_fin_formacion DATE NULL COMMENT 'Fecha de fin de formación',\n    -- Campos laborales\n    cargo VARCHAR(100) NULL COMMENT 'Cargo para instructores y administrativos',\n    -- Campos de control\n    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_rol) REFERENCES Roles(id_rol) ON DELETE SET NULL,\n    INDEX idx_documento (documento),\n    INDEX idx_tipo_documento (tipo_documento),\n    INDEX idx_rol (rol),\n    INDEX idx_estado (estado),\n    INDEX idx_id_rol (id_rol),\n    INDEX idx_rh (rh),\n    INDEX idx_jornada (jornada),\n    INDEX idx_fechas_formacion (fecha_inicio_formacion, fecha_fin_formacion),\n    INDEX idx_personas_programa (id_programa),\n    INDEX idx_personas_ficha (ficha),\n    INDEX idx_personas_ficha_id (id_ficha),\n    UNIQUE KEY uk_documento_tipo (documento, tipo_documento)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Accesos\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Accesos (\n    id_acceso INT AUTO_INCREMENT PRIMARY KEY,\n    id_persona INT NOT NULL,\n    id_usuario_registro INT,\n    tipo_acceso ENUM('entrada', 'salida') NOT NULL DEFAULT 'entrada',\n    fecha_entrada TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    fecha_salida TIMESTAMP NULL,\n    estado ENUM('activo', 'finalizado', 'cancelado') NOT NULL DEFAULT 'activo',\n    observaciones TEXT,\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n    FOREIGN KEY (id_usuario_registro) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n    INDEX idx_id_persona (id_persona),\n    INDEX idx_fecha_entrada (fecha_entrada),\n    INDEX idx_fecha_salida (fecha_salida),\n    INDEX idx_estado (estado),\n    INDEX idx_tipo_acceso (tipo_acceso),\n    INDEX idx_usuario_registro (id_usuario_registro)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Visitantes\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Visitantes (\n    id_visitante INT AUTO_INCREMENT PRIMARY KEY,\n    id_persona INT NOT NULL,\n    motivo_visita TEXT NOT NULL,\n    contacto VARCHAR(255),\n    persona_visita VARCHAR(255),\n    fecha_inicio TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    fecha_fin TIMESTAMP NULL,\n    estado ENUM('activo', 'finalizado', 'expirado') NOT NULL DEFAULT 'activo',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n    INDEX idx_id_persona (id_persona),\n    INDEX idx_estado (estado),\n    INDEX idx_fecha_inicio (fecha_inicio),\n    INDEX idx_fecha_fin (fecha_fin)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Configuracion\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Configuracion (\n    id_config INT AUTO_INCREMENT PRIMARY KEY,\n    clave VARCHAR(100) NOT NULL UNIQUE,\n    valor TEXT,\n    tipo ENUM('string', 'number', 'boolean', 'json') NOT NULL DEFAULT 'string',\n    descripcion VARCHAR(255),\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    INDEX idx_clave (clave)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\nINSERT INTO Configuracion (clave, valor, tipo, descripcion) VALUES\n('qr_visitor_expiry_hours', '24', 'number', 'Horas de validez del QR de visitante'),\n('system_name', 'Control de Acceso SENA', 'string', 'Nombre del sistema'),\n('max_visitors_per_day', '100', 'number', 'Máximo de visitantes por día')\nON DUPLICATE KEY UPDATE clave=clave;\n\n-- =====================================================\n-- TABLA: Alertas\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Alertas (\n    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\n    tipo ENUM('acceso_fuera_horario', 'intento_fraudulento', 'qr_expirado', 'documento_no_registrado', 'comportamiento_sospechoso', 'sistema', 'seguridad') NOT NULL,\n    severidad ENUM('critica', 'alta', 'media', 'baja') NOT NULL DEFAULT 'media',\n    titulo VARCHAR(255) NOT NULL,\n    mensaje TEXT NOT NULL,\n    id_persona INT,\n    id_acceso INT,\n    id_usuario INT,\n    leida BOOLEAN DEFAULT FALSE,\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_lectura TIMESTAMP NULL,\n    id_usuario_lectura INT,\n    metadata JSON,\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\n    FOREIGN KEY (id_acceso) REFERENCES Accesos(id_acceso) ON DELETE SET NULL,\n    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n    FOREIGN KEY (id_usuario_lectura) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n    INDEX idx_tipo (tipo),\n    INDEX idx_severidad (severidad),\n    INDEX idx_leida (leida),\n    INDEX idx_fecha_creacion (fecha_creacion),\n    INDEX idx_id_persona (id_persona)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Logs_Seguridad\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Logs_Seguridad (\n    id_log INT AUTO_INCREMENT PRIMARY KEY,\n    tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', 'modificacion_usuario', 'modificacion_config', 'generacion_reporte', 'acceso_sistema', 'operacion_admin') NOT NULL,\n    id_usuario INT,\n    ip_address VARCHAR(45),\n    user_agent TEXT,\n    accion TEXT NOT NULL,\n    detalles JSON,\n    exito BOOLEAN DEFAULT TRUE,\n    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n    INDEX idx_tipo (tipo),\n    INDEX idx_id_usuario (id_usuario),\n    INDEX idx_ip_address (ip_address),\n    INDEX idx_fecha (fecha),\n    INDEX idx_exito (exito)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Evidencia_Fotografica\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Evidencia_Fotografica (\n    id_evidencia INT AUTO_INCREMENT PRIMARY KEY,\n    id_incidente INT,\n    tipo_incidente ENUM('acceso_denegado', 'comportamiento_sospechoso', 'incidente_seguridad', 'evidencia_general') NOT NULL,\n    url_foto VARCHAR(500) NOT NULL,\n    hash_archivo VARCHAR(64),\n    fecha_captura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    id_usuario_captura INT,\n    descripcion TEXT,\n    coordenadas_gps VARCHAR(100),\n    metadata JSON,\n    FOREIGN KEY (id_usuario_captura) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n    INDEX idx_tipo_incidente (tipo_incidente),\n    INDEX idx_fecha_captura (fecha_captura),\n    INDEX idx_id_usuario_captura (id_usuario_captura)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Auditoria\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Auditoria (\n    id_auditoria INT AUTO_INCREMENT PRIMARY KEY,\n    tabla_afectada VARCHAR(100) NOT NULL,\n    id_registro INT,\n    accion ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,\n    datos_anteriores JSON,\n    datos_nuevos JSON,\n    id_usuario INT,\n    ip_address VARCHAR(45),\n    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE SET NULL,\n    INDEX idx_tabla_afectada (tabla_afectada),\n    INDEX idx_id_registro (id_registro),\n    INDEX idx_accion (accion),\n    INDEX idx_id_usuario (id_usuario),\n    INDEX idx_fecha (fecha)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- CATÁLOGO DE PROGRAMAS Y AMBIENTES - CBI PALMIRA\n-- Sistema de Control de Acceso SENA\n-- =====================================================\n\nUSE control_acceso_sena;\n\n-- =====================================================\n-- TABLA: Programas_Formacion\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Programas_Formacion (\n    id_programa INT AUTO_INCREMENT PRIMARY KEY,\n    codigo_programa VARCHAR(20) UNIQUE NOT NULL,\n    nombre_programa VARCHAR(200) NOT NULL,\n    nivel ENUM('Técnico', 'Tecnológico', 'Especialización') NOT NULL,\n    duracion_meses INT NOT NULL,\n    area_conocimiento VARCHAR(100) NOT NULL,\n    descripcion TEXT,\n    estado ENUM('activo', 'inactivo') DEFAULT 'activo',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    INDEX idx_programa_codigo (codigo_programa),\n    INDEX idx_programa_nivel (nivel),\n    INDEX idx_programa_area (area_conocimiento),\n    INDEX idx_programa_estado (estado)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Ambientes\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Ambientes (\n    id_ambiente INT AUTO_INCREMENT PRIMARY KEY,\n    codigo_ambiente VARCHAR(20) UNIQUE NOT NULL,\n    nombre_ambiente VARCHAR(100) NOT NULL,\n    tipo_ambiente ENUM('aula', 'laboratorio', 'taller', 'oficina', 'auditorio', 'biblioteca', 'cafeteria', 'sala_reuniones') NOT NULL,\n    capacidad INT NOT NULL,\n    bloque VARCHAR(50) NOT NULL,\n    piso INT NOT NULL,\n    equipamiento TEXT COMMENT 'JSON con equipamiento disponible',\n    estado ENUM('activo', 'mantenimiento', 'inactivo') DEFAULT 'activo',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    INDEX idx_ambiente_codigo (codigo_ambiente),\n    INDEX idx_ambiente_tipo (tipo_ambiente),\n    INDEX idx_ambiente_bloque (bloque),\n    INDEX idx_ambiente_estado (estado)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- MODIFICAR TABLA: Personas\n-- Agregar relación con programas de formación\n-- =====================================================\nALTER TABLE Personas \nADD COLUMN id_programa INT NULL AFTER rol,\nADD COLUMN ficha VARCHAR(50) NULL AFTER id_programa,\nADD COLUMN programa VARCHAR(100) NULL AFTER ficha;\n\n-- Agregar índices si no existen\nCREATE INDEX idx_personas_programa ON Personas(id_programa);\nCREATE INDEX idx_personas_ficha ON Personas(ficha);\n\n-- Agregar foreign key si no existe\n-- Nota: MySQL no soporta IF NOT EXISTS en ALTER TABLE ADD FOREIGN KEY\n-- Se debe ejecutar manualmente si la tabla ya tiene datos\n-- ALTER TABLE Personas \n-- ADD CONSTRAINT fk_personas_programa \n-- FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL;\n\n-- =====================================================\n-- TABLA: Zonas (si no existe, crear para relacionar con ambientes)\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Zonas (\n    id_zona INT AUTO_INCREMENT PRIMARY KEY,\n    nombre_zona VARCHAR(100) NOT NULL,\n    id_ambiente INT NULL,\n    tipo_zona ENUM('academica', 'administrativa', 'recreativa') DEFAULT 'academica',\n    descripcion TEXT,\n    estado ENUM('activo', 'inactivo') DEFAULT 'activo',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n    INDEX idx_zona_ambiente (id_ambiente),\n    INDEX idx_zona_tipo (tipo_zona)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- ESQUEMA DE INTEGRACIÓN QR + BD\n-- Sistema de Control de Acceso SENA\n-- =====================================================\n\nUSE control_acceso_sena;\n\n-- =====================================================\n-- TABLA: Fichas\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Fichas (\n    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n    id_programa INT NULL COMMENT 'Referencia al programa de formación',\n    id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha',\n    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL,\n    FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n    INDEX idx_ficha_codigo (codigo_ficha),\n    INDEX idx_ficha_programa (id_programa),\n    INDEX idx_ficha_estado (estado),\n    INDEX idx_ficha_jornada (jornada),\n    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n    INDEX idx_ficha_ambiente (id_ambiente_principal)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\nCOMMENT='Tabla para gestionar las fichas de formación del SENA';\n\n-- =====================================================\n-- TABLA: Asignaciones_Ambientes\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Asignaciones_Ambientes (\n    id_asignacion INT AUTO_INCREMENT PRIMARY KEY,\n    id_persona INT NOT NULL,\n    id_ambiente INT NOT NULL,\n    tipo_asignacion ENUM('aprendiz', 'instructor', 'administrativo') NOT NULL,\n    horario_asignado TEXT COMMENT 'JSON con horarios: {\"lunes\": \"8:00-12:00\", ...}',\n    fecha_asignacion DATE DEFAULT (CURDATE()),\n    fecha_fin_asignacion DATE NULL,\n    activa BOOLEAN DEFAULT TRUE,\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE CASCADE,\n    INDEX idx_asignacion_persona (id_persona),\n    INDEX idx_asignacion_ambiente (id_ambiente),\n    INDEX idx_asignacion_tipo (tipo_asignacion),\n    INDEX idx_asignacion_activa (activa)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- MODIFICAR TABLA: Personas\n-- Agregar campos adicionales si no existen\n-- =====================================================\nALTER TABLE Personas \nADD COLUMN rh VARCHAR(10) NULL AFTER telefono,\nADD COLUMN id_ficha INT NULL AFTER ficha,\nADD COLUMN jornada ENUM('diurna', 'nocturna', 'mixta') NULL AFTER id_ficha;\n\n-- Agregar foreign key para ficha si no existe\nCREATE INDEX idx_personas_ficha_id ON Personas(id_ficha);\n-- ALTER TABLE Personas ADD FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\n\n-- =====================================================\n-- TABLA: Historial_Asistencias\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Historial_Asistencias (\n    id_registro INT AUTO_INCREMENT PRIMARY KEY,\n    id_persona INT NOT NULL,\n    id_ficha INT NULL,\n    id_ambiente INT NULL,\n    fecha DATE NOT NULL,\n    hora_entrada TIME,\n    hora_salida TIME,\n    tipo_acceso ENUM('entrada', 'salida') NOT NULL,\n    estado ENUM('presente', 'ausente', 'tardanza', 'salida_anticipada') DEFAULT 'presente',\n    observaciones TEXT,\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\n    FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL,\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n    INDEX idx_historial_persona (id_persona),\n    INDEX idx_historial_ficha (id_ficha),\n    INDEX idx_historial_fecha (fecha),\n    INDEX idx_historial_ambiente (id_ambiente)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- =====================================================\n-- TABLA: Alertas_Sistema\n-- =====================================================\nCREATE TABLE IF NOT EXISTS Alertas_Sistema (\n    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\n    tipo_alerta ENUM('capacidad', 'acceso_denegado', 'irregularidad', 'tardanza', 'ausencia') NOT NULL,\n    id_ambiente INT NULL,\n    id_persona INT NULL,\n    severidad ENUM('baja', 'media', 'alta', 'critica') DEFAULT 'media',\n    mensaje TEXT NOT NULL,\n    datos_adicionales JSON,\n    resuelta BOOLEAN DEFAULT FALSE,\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_resolucion TIMESTAMP NULL,\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\n    INDEX idx_alerta_tipo (tipo_alerta),\n    INDEX idx_alerta_resuelta (resuelta),\n    INDEX idx_alerta_fecha (fecha_creacion)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n\n\n-- =====================================================\n-- ACTUALIZACIÓN DE ESQUEMA PARA IMPORTACIÓN MASIVA\n-- Campos adicionales por rol\n-- =====================================================\n\nUSE control_acceso_sena;\n\n-- =====================================================\n-- MODIFICAR TABLA: Personas\n-- Agregar campos adicionales para importación\n-- =====================================================\nALTER TABLE Personas \nADD COLUMN rh VARCHAR(10) NULL AFTER telefono,\nADD COLUMN fecha_inicio_formacion DATE NULL AFTER rh,\nADD COLUMN fecha_fin_formacion DATE NULL AFTER fecha_inicio_formacion,\nADD COLUMN id_ficha INT NULL AFTER ficha,\nADD COLUMN cargo VARCHAR(100) NULL AFTER id_ficha,\nADD COLUMN tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL AFTER cargo;\n\n-- Agregar índices\nCREATE INDEX  idx_personas_rh ON Personas(rh);\nCREATE INDEX  idx_personas_cargo ON Personas(cargo);\n\n-- =====================================================\n-- VERIFICAR que las tablas Fichas y Asignaciones_Ambientes existan\n-- (Ya fueron creadas en integrationSchema.sql)\n-- =====================================================\n\n\n\n"
        }
    ]
}