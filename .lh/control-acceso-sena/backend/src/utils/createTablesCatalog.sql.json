{
    "sourceFile": "control-acceso-sena/backend/src/utils/createTablesCatalog.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1763696657069,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763697154279,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,25 +119,115 @@\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\n COMMENT='Tabla para gestionar las fichas de formación del SENA - Circuito Abierto';\r\n \r\n -- =====================================================\r\n--- VERIFICAR CREACIÓN DE TABLAS\r\n+-- AGREGAR FOREIGN KEYS (CIRCUITO ABIERTO - ON DELETE SET NULL)\r\n+-- Todas las tablas quedan enlazadas pero con flexibilidad\r\n -- =====================================================\r\n \r\n+-- Agregar foreign key: Personas.id_programa → Programas_Formacion.id_programa\r\n+SET @fk_exists = (SELECT COUNT(*) \r\n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n+                  WHERE TABLE_SCHEMA = DATABASE() \r\n+                    AND TABLE_NAME = 'Personas' \r\n+                    AND COLUMN_NAME = 'id_programa' \r\n+                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\r\n+                  LIMIT 1);\r\n+SET @sql = IF(@fk_exists = 0,\r\n+              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\r\n+              'SELECT 1');\r\n+PREPARE stmt FROM @sql;\r\n+EXECUTE stmt;\r\n+DEALLOCATE PREPARE stmt;\r\n+\r\n+-- Agregar foreign key: Personas.id_ficha → Fichas.id_ficha\r\n+SET @fk_exists = (SELECT COUNT(*) \r\n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n+                  WHERE TABLE_SCHEMA = DATABASE() \r\n+                    AND TABLE_NAME = 'Personas' \r\n+                    AND COLUMN_NAME = 'id_ficha' \r\n+                    AND REFERENCED_TABLE_NAME = 'Fichas'\r\n+                  LIMIT 1);\r\n+SET @sql = IF(@fk_exists = 0,\r\n+              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL',\r\n+              'SELECT 1');\r\n+PREPARE stmt FROM @sql;\r\n+EXECUTE stmt;\r\n+DEALLOCATE PREPARE stmt;\r\n+\r\n+-- Agregar foreign key: Fichas.id_programa → Programas_Formacion.id_programa\r\n+SET @fk_exists = (SELECT COUNT(*) \r\n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n+                  WHERE TABLE_SCHEMA = DATABASE() \r\n+                    AND TABLE_NAME = 'Fichas' \r\n+                    AND COLUMN_NAME = 'id_programa' \r\n+                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\r\n+                  LIMIT 1);\r\n+SET @sql = IF(@fk_exists = 0,\r\n+              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\r\n+              'SELECT 1');\r\n+PREPARE stmt FROM @sql;\r\n+EXECUTE stmt;\r\n+DEALLOCATE PREPARE stmt;\r\n+\r\n+-- Agregar foreign key: Fichas.id_ambiente_principal → Ambientes.id_ambiente (si existe la tabla Ambientes)\r\n+SET @ambientes_exists = (SELECT COUNT(*) \r\n+                         FROM INFORMATION_SCHEMA.TABLES \r\n+                         WHERE TABLE_SCHEMA = DATABASE() \r\n+                           AND TABLE_NAME = 'Ambientes');\r\n+SET @fk_exists = (SELECT COUNT(*) \r\n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n+                  WHERE TABLE_SCHEMA = DATABASE() \r\n+                    AND TABLE_NAME = 'Fichas' \r\n+                    AND COLUMN_NAME = 'id_ambiente_principal' \r\n+                    AND REFERENCED_TABLE_NAME = 'Ambientes'\r\n+                  LIMIT 1);\r\n+SET @sql = IF(@ambientes_exists > 0 AND @fk_exists = 0,\r\n+              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_ambiente FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL',\r\n+              'SELECT 1');\r\n+PREPARE stmt FROM @sql;\r\n+EXECUTE stmt;\r\n+DEALLOCATE PREPARE stmt;\r\n+\r\n+-- =====================================================\r\n+-- VERIFICAR CREACIÓN DE TABLAS Y RELACIONES\r\n+-- =====================================================\r\n+\r\n SELECT \r\n   TABLE_NAME as 'Tabla',\r\n   TABLE_COMMENT as 'Descripción'\r\n FROM INFORMATION_SCHEMA.TABLES\r\n WHERE TABLE_SCHEMA = DATABASE()\r\n   AND TABLE_NAME IN ('Programas_Formacion', 'Fichas')\r\n ORDER BY TABLE_NAME;\r\n \r\n+-- Mostrar foreign keys creadas\r\n+SELECT \r\n+  TABLE_NAME as 'Tabla',\r\n+  CONSTRAINT_NAME as 'Foreign Key',\r\n+  COLUMN_NAME as 'Columna',\r\n+  REFERENCED_TABLE_NAME as 'Tabla Referenciada',\r\n+  REFERENCED_COLUMN_NAME as 'Columna Referenciada',\r\n+  DELETE_RULE as 'Regla de Eliminación'\r\n+FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE k\r\n+JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS r \r\n+  ON k.CONSTRAINT_NAME = r.CONSTRAINT_NAME \r\n+  AND k.TABLE_SCHEMA = r.CONSTRAINT_SCHEMA\r\n+WHERE k.TABLE_SCHEMA = DATABASE()\r\n+  AND k.REFERENCED_TABLE_NAME IS NOT NULL\r\n+  AND (\r\n+    k.TABLE_NAME = 'Fichas' \r\n+    OR (k.TABLE_NAME = 'Personas' AND k.COLUMN_NAME IN ('id_programa', 'id_ficha'))\r\n+  )\r\n+ORDER BY TABLE_NAME, CONSTRAINT_NAME;\r\n+\r\n -- =====================================================\r\n--- NOTAS IMPORTANTES - CIRCUITO ABIERTO\r\n+-- NOTAS IMPORTANTES - CIRCUITO ABIERTO ENLAZADO\r\n -- =====================================================\r\n--- ✅ NO hay FOREIGN KEYS restrictivas entre estas tablas\r\n--- ✅ Las relaciones se manejan a nivel de aplicación\r\n--- ✅ Puedes crear fichas sin requerir que exista el programa\r\n--- ✅ Puedes eliminar programas sin afectar fichas existentes\r\n--- ✅ Mayor flexibilidad en la gestión de datos\r\n+-- ✅ Todas las tablas están ENLAZADAS con FOREIGN KEYS\r\n+-- ✅ Usa ON DELETE SET NULL para mantener flexibilidad (circuito abierto)\r\n+-- ✅ Si eliminas un programa, las fichas y personas mantienen su registro (id_programa se pone NULL)\r\n+-- ✅ Si eliminas una ficha, las personas mantienen su registro (id_ficha se pone NULL)\r\n+-- ✅ Las relaciones están definidas a nivel de base de datos para integridad\r\n+-- ✅ Puedes crear registros sin requerir que exista la referencia (id_programa/id_ficha pueden ser NULL)\r\n -- =====================================================\r\n \r\n"
                },
                {
                    "date": 1764013565810,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,233 +1,231 @@\n--- =====================================================\r\n--- CREAR TABLAS DE CATÁLOGO - CIRCUITO ABIERTO\r\n--- Programas_Formacion y Fichas\r\n--- =====================================================\r\n-\r\n-USE control_acceso_sena;\r\n-\r\n--- =====================================================\r\n--- ELIMINAR FOREIGN KEYS RESTRICTIVAS SI EXISTEN\r\n--- =====================================================\r\n-\r\n--- Eliminar foreign key de Personas a Programas_Formacion si existe\r\n-SET @fk_name = (SELECT CONSTRAINT_NAME \r\n-                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                WHERE TABLE_SCHEMA = DATABASE() \r\n-                  AND TABLE_NAME = 'Personas' \r\n-                  AND COLUMN_NAME = 'id_programa' \r\n-                  AND REFERENCED_TABLE_NAME IS NOT NULL\r\n-                LIMIT 1);\r\n-SET @sql = IF(@fk_name IS NOT NULL, \r\n-              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- Eliminar foreign key de Personas a Fichas si existe\r\n-SET @fk_name = (SELECT CONSTRAINT_NAME \r\n-                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                WHERE TABLE_SCHEMA = DATABASE() \r\n-                  AND TABLE_NAME = 'Personas' \r\n-                  AND COLUMN_NAME = 'id_ficha' \r\n-                  AND REFERENCED_TABLE_NAME IS NOT NULL\r\n-                LIMIT 1);\r\n-SET @sql = IF(@fk_name IS NOT NULL, \r\n-              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- Eliminar foreign key de Fichas a Programas_Formacion si existe\r\n-SET @fk_name = (SELECT CONSTRAINT_NAME \r\n-                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                WHERE TABLE_SCHEMA = DATABASE() \r\n-                  AND TABLE_NAME = 'Fichas' \r\n-                  AND COLUMN_NAME = 'id_programa' \r\n-                  AND REFERENCED_TABLE_NAME IS NOT NULL\r\n-                LIMIT 1);\r\n-SET @sql = IF(@fk_name IS NOT NULL, \r\n-              CONCAT('ALTER TABLE Fichas DROP FOREIGN KEY ', @fk_name), \r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- =====================================================\r\n--- CREAR TABLA: Programas_Formacion\r\n--- CIRCUITO ABIERTO: SIN FOREIGN KEYS RESTRICTIVAS\r\n--- =====================================================\r\n-\r\n-DROP TABLE IF EXISTS Programas_Formacion;\r\n-\r\n-CREATE TABLE Programas_Formacion (\r\n-  id_programa INT AUTO_INCREMENT PRIMARY KEY,\r\n-  codigo_programa VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único del programa (ej: TEC-PS-001)',\r\n-  nombre_programa VARCHAR(200) NOT NULL COMMENT 'Nombre completo del programa de formación',\r\n-  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Formación Complementaria') DEFAULT 'Técnico' COMMENT 'Nivel de formación',\r\n-  duracion_meses INT DEFAULT 12 COMMENT 'Duración del programa en meses',\r\n-  area_conocimiento VARCHAR(100) NULL COMMENT 'Área de conocimiento o especialidad',\r\n-  descripcion TEXT NULL COMMENT 'Descripción detallada del programa',\r\n-  estado ENUM('activo', 'inactivo', 'suspendido') DEFAULT 'activo' COMMENT 'Estado del programa',\r\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\r\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\r\n-  \r\n-  -- Índices para optimización (SIN FOREIGN KEYS para circuito abierto)\r\n-  INDEX idx_codigo_programa (codigo_programa),\r\n-  INDEX idx_nivel (nivel),\r\n-  INDEX idx_area_conocimiento (area_conocimiento),\r\n-  INDEX idx_estado (estado),\r\n-  INDEX idx_nombre_programa (nombre_programa(100))\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\n-COMMENT='Catálogo de programas de formación del SENA - Circuito Abierto';\r\n-\r\n--- =====================================================\r\n--- CREAR TABLA: Fichas\r\n--- CIRCUITO ABIERTO: SIN FOREIGN KEYS RESTRICTIVAS\r\n--- =====================================================\r\n-\r\n--- Eliminar tabla duplicada si existe\r\n-DROP TABLE IF EXISTS fichas;\r\n-\r\n-DROP TABLE IF EXISTS Fichas;\r\n-\r\n-CREATE TABLE Fichas (\r\n-  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\r\n-  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\r\n-  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\r\n-  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional, para relación flexible)',\r\n-  id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\r\n-  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\r\n-  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\r\n-  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\r\n-  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\r\n-  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\r\n-  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\r\n-  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\r\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\r\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\r\n-  \r\n-  -- Índices para optimización (SIN FOREIGN KEYS para circuito abierto)\r\n-  INDEX idx_ficha_codigo (codigo_ficha),\r\n-  INDEX idx_ficha_programa (id_programa),\r\n-  INDEX idx_ficha_estado (estado),\r\n-  INDEX idx_ficha_jornada (jornada),\r\n-  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\r\n-  INDEX idx_ficha_ambiente (id_ambiente_principal),\r\n-  INDEX idx_programa_formacion (programa_formacion(100))\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\n-COMMENT='Tabla para gestionar las fichas de formación del SENA - Circuito Abierto';\r\n-\r\n--- =====================================================\r\n--- AGREGAR FOREIGN KEYS (CIRCUITO ABIERTO - ON DELETE SET NULL)\r\n--- Todas las tablas quedan enlazadas pero con flexibilidad\r\n--- =====================================================\r\n-\r\n--- Agregar foreign key: Personas.id_programa → Programas_Formacion.id_programa\r\n-SET @fk_exists = (SELECT COUNT(*) \r\n-                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                  WHERE TABLE_SCHEMA = DATABASE() \r\n-                    AND TABLE_NAME = 'Personas' \r\n-                    AND COLUMN_NAME = 'id_programa' \r\n-                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\r\n-                  LIMIT 1);\r\n-SET @sql = IF(@fk_exists = 0,\r\n-              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- Agregar foreign key: Personas.id_ficha → Fichas.id_ficha\r\n-SET @fk_exists = (SELECT COUNT(*) \r\n-                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                  WHERE TABLE_SCHEMA = DATABASE() \r\n-                    AND TABLE_NAME = 'Personas' \r\n-                    AND COLUMN_NAME = 'id_ficha' \r\n-                    AND REFERENCED_TABLE_NAME = 'Fichas'\r\n-                  LIMIT 1);\r\n-SET @sql = IF(@fk_exists = 0,\r\n-              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL',\r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- Agregar foreign key: Fichas.id_programa → Programas_Formacion.id_programa\r\n-SET @fk_exists = (SELECT COUNT(*) \r\n-                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                  WHERE TABLE_SCHEMA = DATABASE() \r\n-                    AND TABLE_NAME = 'Fichas' \r\n-                    AND COLUMN_NAME = 'id_programa' \r\n-                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\r\n-                  LIMIT 1);\r\n-SET @sql = IF(@fk_exists = 0,\r\n-              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- Agregar foreign key: Fichas.id_ambiente_principal → Ambientes.id_ambiente (si existe la tabla Ambientes)\r\n-SET @ambientes_exists = (SELECT COUNT(*) \r\n-                         FROM INFORMATION_SCHEMA.TABLES \r\n-                         WHERE TABLE_SCHEMA = DATABASE() \r\n-                           AND TABLE_NAME = 'Ambientes');\r\n-SET @fk_exists = (SELECT COUNT(*) \r\n-                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n-                  WHERE TABLE_SCHEMA = DATABASE() \r\n-                    AND TABLE_NAME = 'Fichas' \r\n-                    AND COLUMN_NAME = 'id_ambiente_principal' \r\n-                    AND REFERENCED_TABLE_NAME = 'Ambientes'\r\n-                  LIMIT 1);\r\n-SET @sql = IF(@ambientes_exists > 0 AND @fk_exists = 0,\r\n-              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_ambiente FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL',\r\n-              'SELECT 1');\r\n-PREPARE stmt FROM @sql;\r\n-EXECUTE stmt;\r\n-DEALLOCATE PREPARE stmt;\r\n-\r\n--- =====================================================\r\n--- VERIFICAR CREACIÓN DE TABLAS Y RELACIONES\r\n--- =====================================================\r\n-\r\n-SELECT \r\n-  TABLE_NAME as 'Tabla',\r\n-  TABLE_COMMENT as 'Descripción'\r\n-FROM INFORMATION_SCHEMA.TABLES\r\n-WHERE TABLE_SCHEMA = DATABASE()\r\n-  AND TABLE_NAME IN ('Programas_Formacion', 'Fichas')\r\n-ORDER BY TABLE_NAME;\r\n-\r\n--- Mostrar foreign keys creadas\r\n-SELECT \r\n-  TABLE_NAME as 'Tabla',\r\n-  CONSTRAINT_NAME as 'Foreign Key',\r\n-  COLUMN_NAME as 'Columna',\r\n-  REFERENCED_TABLE_NAME as 'Tabla Referenciada',\r\n-  REFERENCED_COLUMN_NAME as 'Columna Referenciada',\r\n-  DELETE_RULE as 'Regla de Eliminación'\r\n-FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE k\r\n-JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS r \r\n-  ON k.CONSTRAINT_NAME = r.CONSTRAINT_NAME \r\n-  AND k.TABLE_SCHEMA = r.CONSTRAINT_SCHEMA\r\n-WHERE k.TABLE_SCHEMA = DATABASE()\r\n-  AND k.REFERENCED_TABLE_NAME IS NOT NULL\r\n-  AND (\r\n-    k.TABLE_NAME = 'Fichas' \r\n-    OR (k.TABLE_NAME = 'Personas' AND k.COLUMN_NAME IN ('id_programa', 'id_ficha'))\r\n-  )\r\n-ORDER BY TABLE_NAME, CONSTRAINT_NAME;\r\n-\r\n--- =====================================================\r\n--- NOTAS IMPORTANTES - CIRCUITO ABIERTO ENLAZADO\r\n--- =====================================================\r\n--- ✅ Todas las tablas están ENLAZADAS con FOREIGN KEYS\r\n--- ✅ Usa ON DELETE SET NULL para mantener flexibilidad (circuito abierto)\r\n--- ✅ Si eliminas un programa, las fichas y personas mantienen su registro (id_programa se pone NULL)\r\n--- ✅ Si eliminas una ficha, las personas mantienen su registro (id_ficha se pone NULL)\r\n--- ✅ Las relaciones están definidas a nivel de base de datos para integridad\r\n--- ✅ Puedes crear registros sin requerir que exista la referencia (id_programa/id_ficha pueden ser NULL)\r\n--- =====================================================\r\n-\r\n+-- =====================================================\n+-- CREAR TABLAS DE CATÁLOGO - CIRCUITO ABIERTO\n+-- Programas_Formacion y Fichas\n+-- =====================================================\n+\n+-- =====================================================\n+-- ELIMINAR FOREIGN KEYS RESTRICTIVAS SI EXISTEN\n+-- =====================================================\n+\n+-- Eliminar foreign key de Personas a Programas_Formacion si existe\n+SET @fk_name = (SELECT CONSTRAINT_NAME \n+                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                WHERE TABLE_SCHEMA = DATABASE() \n+                  AND TABLE_NAME = 'Personas' \n+                  AND COLUMN_NAME = 'id_programa' \n+                  AND REFERENCED_TABLE_NAME IS NOT NULL\n+                LIMIT 1);\n+SET @sql = IF(@fk_name IS NOT NULL, \n+              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Eliminar foreign key de Personas a Fichas si existe\n+SET @fk_name = (SELECT CONSTRAINT_NAME \n+                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                WHERE TABLE_SCHEMA = DATABASE() \n+                  AND TABLE_NAME = 'Personas' \n+                  AND COLUMN_NAME = 'id_ficha' \n+                  AND REFERENCED_TABLE_NAME IS NOT NULL\n+                LIMIT 1);\n+SET @sql = IF(@fk_name IS NOT NULL, \n+              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Eliminar foreign key de Fichas a Programas_Formacion si existe\n+SET @fk_name = (SELECT CONSTRAINT_NAME \n+                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                WHERE TABLE_SCHEMA = DATABASE() \n+                  AND TABLE_NAME = 'Fichas' \n+                  AND COLUMN_NAME = 'id_programa' \n+                  AND REFERENCED_TABLE_NAME IS NOT NULL\n+                LIMIT 1);\n+SET @sql = IF(@fk_name IS NOT NULL, \n+              CONCAT('ALTER TABLE Fichas DROP FOREIGN KEY ', @fk_name), \n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- =====================================================\n+-- CREAR TABLA: Programas_Formacion\n+-- CIRCUITO ABIERTO: SIN FOREIGN KEYS RESTRICTIVAS\n+-- =====================================================\n+\n+DROP TABLE IF EXISTS Programas_Formacion;\n+\n+CREATE TABLE Programas_Formacion (\n+  id_programa INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_programa VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único del programa (ej: TEC-PS-001)',\n+  nombre_programa VARCHAR(200) NOT NULL COMMENT 'Nombre completo del programa de formación',\n+  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Formación Complementaria') DEFAULT 'Técnico' COMMENT 'Nivel de formación',\n+  duracion_meses INT DEFAULT 12 COMMENT 'Duración del programa en meses',\n+  area_conocimiento VARCHAR(100) NULL COMMENT 'Área de conocimiento o especialidad',\n+  descripcion TEXT NULL COMMENT 'Descripción detallada del programa',\n+  estado ENUM('activo', 'inactivo', 'suspendido') DEFAULT 'activo' COMMENT 'Estado del programa',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\n+  \n+  -- Índices para optimización (SIN FOREIGN KEYS para circuito abierto)\n+  INDEX idx_codigo_programa (codigo_programa),\n+  INDEX idx_nivel (nivel),\n+  INDEX idx_area_conocimiento (area_conocimiento),\n+  INDEX idx_estado (estado),\n+  INDEX idx_nombre_programa (nombre_programa(100))\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Catálogo de programas de formación del SENA - Circuito Abierto';\n+\n+-- =====================================================\n+-- CREAR TABLA: Fichas\n+-- CIRCUITO ABIERTO: SIN FOREIGN KEYS RESTRICTIVAS\n+-- =====================================================\n+\n+-- Eliminar tabla duplicada si existe\n+DROP TABLE IF EXISTS fichas;\n+\n+DROP TABLE IF EXISTS Fichas;\n+\n+CREATE TABLE Fichas (\n+  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\n+  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\n+  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional, para relación flexible)',\n+  id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\n+  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\n+  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\n+  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\n+  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\n+  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\n+  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\n+  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\n+  \n+  -- Índices para optimización (SIN FOREIGN KEYS para circuito abierto)\n+  INDEX idx_ficha_codigo (codigo_ficha),\n+  INDEX idx_ficha_programa (id_programa),\n+  INDEX idx_ficha_estado (estado),\n+  INDEX idx_ficha_jornada (jornada),\n+  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\n+  INDEX idx_ficha_ambiente (id_ambiente_principal),\n+  INDEX idx_programa_formacion (programa_formacion(100))\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Tabla para gestionar las fichas de formación del SENA - Circuito Abierto';\n+\n+-- =====================================================\n+-- AGREGAR FOREIGN KEYS (CIRCUITO ABIERTO - ON DELETE SET NULL)\n+-- Todas las tablas quedan enlazadas pero con flexibilidad\n+-- =====================================================\n+\n+-- Agregar foreign key: Personas.id_programa → Programas_Formacion.id_programa\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = DATABASE() \n+                    AND TABLE_NAME = 'Personas' \n+                    AND COLUMN_NAME = 'id_programa' \n+                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\n+                  LIMIT 1);\n+SET @sql = IF(@fk_exists = 0,\n+              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Agregar foreign key: Personas.id_ficha → Fichas.id_ficha\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = DATABASE() \n+                    AND TABLE_NAME = 'Personas' \n+                    AND COLUMN_NAME = 'id_ficha' \n+                    AND REFERENCED_TABLE_NAME = 'Fichas'\n+                  LIMIT 1);\n+SET @sql = IF(@fk_exists = 0,\n+              'ALTER TABLE Personas ADD CONSTRAINT fk_personas_ficha FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Agregar foreign key: Fichas.id_programa → Programas_Formacion.id_programa\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = DATABASE() \n+                    AND TABLE_NAME = 'Fichas' \n+                    AND COLUMN_NAME = 'id_programa' \n+                    AND REFERENCED_TABLE_NAME = 'Programas_Formacion'\n+                  LIMIT 1);\n+SET @sql = IF(@fk_exists = 0,\n+              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_programa FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- Agregar foreign key: Fichas.id_ambiente_principal → Ambientes.id_ambiente (si existe la tabla Ambientes)\n+SET @ambientes_exists = (SELECT COUNT(*) \n+                         FROM INFORMATION_SCHEMA.TABLES \n+                         WHERE TABLE_SCHEMA = DATABASE() \n+                           AND TABLE_NAME = 'Ambientes');\n+SET @fk_exists = (SELECT COUNT(*) \n+                  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \n+                  WHERE TABLE_SCHEMA = DATABASE() \n+                    AND TABLE_NAME = 'Fichas' \n+                    AND COLUMN_NAME = 'id_ambiente_principal' \n+                    AND REFERENCED_TABLE_NAME = 'Ambientes'\n+                  LIMIT 1);\n+SET @sql = IF(@ambientes_exists > 0 AND @fk_exists = 0,\n+              'ALTER TABLE Fichas ADD CONSTRAINT fk_fichas_ambiente FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL',\n+              'SELECT 1');\n+PREPARE stmt FROM @sql;\n+EXECUTE stmt;\n+DEALLOCATE PREPARE stmt;\n+\n+-- =====================================================\n+-- VERIFICAR CREACIÓN DE TABLAS Y RELACIONES\n+-- =====================================================\n+\n+SELECT \n+  TABLE_NAME as 'Tabla',\n+  TABLE_COMMENT as 'Descripción'\n+FROM INFORMATION_SCHEMA.TABLES\n+WHERE TABLE_SCHEMA = DATABASE()\n+  AND TABLE_NAME IN ('Programas_Formacion', 'Fichas')\n+ORDER BY TABLE_NAME;\n+\n+-- Mostrar foreign keys creadas\n+SELECT \n+  TABLE_NAME as 'Tabla',\n+  CONSTRAINT_NAME as 'Foreign Key',\n+  COLUMN_NAME as 'Columna',\n+  REFERENCED_TABLE_NAME as 'Tabla Referenciada',\n+  REFERENCED_COLUMN_NAME as 'Columna Referenciada',\n+  DELETE_RULE as 'Regla de Eliminación'\n+FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE k\n+JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS r \n+  ON k.CONSTRAINT_NAME = r.CONSTRAINT_NAME \n+  AND k.TABLE_SCHEMA = r.CONSTRAINT_SCHEMA\n+WHERE k.TABLE_SCHEMA = DATABASE()\n+  AND k.REFERENCED_TABLE_NAME IS NOT NULL\n+  AND (\n+    k.TABLE_NAME = 'Fichas' \n+    OR (k.TABLE_NAME = 'Personas' AND k.COLUMN_NAME IN ('id_programa', 'id_ficha'))\n+  )\n+ORDER BY TABLE_NAME, CONSTRAINT_NAME;\n+\n+-- =====================================================\n+-- NOTAS IMPORTANTES - CIRCUITO ABIERTO ENLAZADO\n+-- =====================================================\n+-- ✅ Todas las tablas están ENLAZADAS con FOREIGN KEYS\n+-- ✅ Usa ON DELETE SET NULL para mantener flexibilidad (circuito abierto)\n+-- ✅ Si eliminas un programa, las fichas y personas mantienen su registro (id_programa se pone NULL)\n+-- ✅ Si eliminas una ficha, las personas mantienen su registro (id_ficha se pone NULL)\n+-- ✅ Las relaciones están definidas a nivel de base de datos para integridad\n+-- ✅ Puedes crear registros sin requerir que exista la referencia (id_programa/id_ficha pueden ser NULL)\n+-- =====================================================\n+\n"
                },
                {
                    "date": 1764016586427,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,10 @@\n -- CREAR TABLAS DE CATÁLOGO - CIRCUITO ABIERTO\n -- Programas_Formacion y Fichas\n -- =====================================================\n \n+USE control_acceso_sena;\n+\n -- =====================================================\n -- ELIMINAR FOREIGN KEYS RESTRICTIVAS SI EXISTEN\n -- =====================================================\n \n"
                },
                {
                    "date": 1764016609511,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,10 +2,8 @@\n -- CREAR TABLAS DE CATÁLOGO - CIRCUITO ABIERTO\n -- Programas_Formacion y Fichas\n -- =====================================================\n \n-USE control_acceso_sena;\n-\n -- =====================================================\n -- ELIMINAR FOREIGN KEYS RESTRICTIVAS SI EXISTEN\n -- =====================================================\n \n"
                }
            ],
            "date": 1763696657069,
            "name": "Commit-0",
            "content": "-- =====================================================\r\n-- CREAR TABLAS DE CATÁLOGO - CIRCUITO ABIERTO\r\n-- Programas_Formacion y Fichas\r\n-- =====================================================\r\n\r\nUSE control_acceso_sena;\r\n\r\n-- =====================================================\r\n-- ELIMINAR FOREIGN KEYS RESTRICTIVAS SI EXISTEN\r\n-- =====================================================\r\n\r\n-- Eliminar foreign key de Personas a Programas_Formacion si existe\r\nSET @fk_name = (SELECT CONSTRAINT_NAME \r\n                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n                WHERE TABLE_SCHEMA = DATABASE() \r\n                  AND TABLE_NAME = 'Personas' \r\n                  AND COLUMN_NAME = 'id_programa' \r\n                  AND REFERENCED_TABLE_NAME IS NOT NULL\r\n                LIMIT 1);\r\nSET @sql = IF(@fk_name IS NOT NULL, \r\n              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \r\n              'SELECT 1');\r\nPREPARE stmt FROM @sql;\r\nEXECUTE stmt;\r\nDEALLOCATE PREPARE stmt;\r\n\r\n-- Eliminar foreign key de Personas a Fichas si existe\r\nSET @fk_name = (SELECT CONSTRAINT_NAME \r\n                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n                WHERE TABLE_SCHEMA = DATABASE() \r\n                  AND TABLE_NAME = 'Personas' \r\n                  AND COLUMN_NAME = 'id_ficha' \r\n                  AND REFERENCED_TABLE_NAME IS NOT NULL\r\n                LIMIT 1);\r\nSET @sql = IF(@fk_name IS NOT NULL, \r\n              CONCAT('ALTER TABLE Personas DROP FOREIGN KEY ', @fk_name), \r\n              'SELECT 1');\r\nPREPARE stmt FROM @sql;\r\nEXECUTE stmt;\r\nDEALLOCATE PREPARE stmt;\r\n\r\n-- Eliminar foreign key de Fichas a Programas_Formacion si existe\r\nSET @fk_name = (SELECT CONSTRAINT_NAME \r\n                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE \r\n                WHERE TABLE_SCHEMA = DATABASE() \r\n                  AND TABLE_NAME = 'Fichas' \r\n                  AND COLUMN_NAME = 'id_programa' \r\n                  AND REFERENCED_TABLE_NAME IS NOT NULL\r\n                LIMIT 1);\r\nSET @sql = IF(@fk_name IS NOT NULL, \r\n              CONCAT('ALTER TABLE Fichas DROP FOREIGN KEY ', @fk_name), \r\n              'SELECT 1');\r\nPREPARE stmt FROM @sql;\r\nEXECUTE stmt;\r\nDEALLOCATE PREPARE stmt;\r\n\r\n-- =====================================================\r\n-- CREAR TABLA: Programas_Formacion\r\n-- CIRCUITO ABIERTO: SIN FOREIGN KEYS RESTRICTIVAS\r\n-- =====================================================\r\n\r\nDROP TABLE IF EXISTS Programas_Formacion;\r\n\r\nCREATE TABLE Programas_Formacion (\r\n  id_programa INT AUTO_INCREMENT PRIMARY KEY,\r\n  codigo_programa VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único del programa (ej: TEC-PS-001)',\r\n  nombre_programa VARCHAR(200) NOT NULL COMMENT 'Nombre completo del programa de formación',\r\n  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Formación Complementaria') DEFAULT 'Técnico' COMMENT 'Nivel de formación',\r\n  duracion_meses INT DEFAULT 12 COMMENT 'Duración del programa en meses',\r\n  area_conocimiento VARCHAR(100) NULL COMMENT 'Área de conocimiento o especialidad',\r\n  descripcion TEXT NULL COMMENT 'Descripción detallada del programa',\r\n  estado ENUM('activo', 'inactivo', 'suspendido') DEFAULT 'activo' COMMENT 'Estado del programa',\r\n  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\r\n  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\r\n  \r\n  -- Índices para optimización (SIN FOREIGN KEYS para circuito abierto)\r\n  INDEX idx_codigo_programa (codigo_programa),\r\n  INDEX idx_nivel (nivel),\r\n  INDEX idx_area_conocimiento (area_conocimiento),\r\n  INDEX idx_estado (estado),\r\n  INDEX idx_nombre_programa (nombre_programa(100))\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\nCOMMENT='Catálogo de programas de formación del SENA - Circuito Abierto';\r\n\r\n-- =====================================================\r\n-- CREAR TABLA: Fichas\r\n-- CIRCUITO ABIERTO: SIN FOREIGN KEYS RESTRICTIVAS\r\n-- =====================================================\r\n\r\n-- Eliminar tabla duplicada si existe\r\nDROP TABLE IF EXISTS fichas;\r\n\r\nDROP TABLE IF EXISTS Fichas;\r\n\r\nCREATE TABLE Fichas (\r\n  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\r\n  codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\r\n  programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\r\n  id_programa INT NULL COMMENT 'Referencia al programa de formación (opcional, para relación flexible)',\r\n  id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha (opcional)',\r\n  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\r\n  fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\r\n  fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\r\n  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\r\n  numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\r\n  capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\r\n  observaciones TEXT NULL COMMENT 'Observaciones adicionales',\r\n  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del registro',\r\n  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',\r\n  \r\n  -- Índices para optimización (SIN FOREIGN KEYS para circuito abierto)\r\n  INDEX idx_ficha_codigo (codigo_ficha),\r\n  INDEX idx_ficha_programa (id_programa),\r\n  INDEX idx_ficha_estado (estado),\r\n  INDEX idx_ficha_jornada (jornada),\r\n  INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\r\n  INDEX idx_ficha_ambiente (id_ambiente_principal),\r\n  INDEX idx_programa_formacion (programa_formacion(100))\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\nCOMMENT='Tabla para gestionar las fichas de formación del SENA - Circuito Abierto';\r\n\r\n-- =====================================================\r\n-- VERIFICAR CREACIÓN DE TABLAS\r\n-- =====================================================\r\n\r\nSELECT \r\n  TABLE_NAME as 'Tabla',\r\n  TABLE_COMMENT as 'Descripción'\r\nFROM INFORMATION_SCHEMA.TABLES\r\nWHERE TABLE_SCHEMA = DATABASE()\r\n  AND TABLE_NAME IN ('Programas_Formacion', 'Fichas')\r\nORDER BY TABLE_NAME;\r\n\r\n-- =====================================================\r\n-- NOTAS IMPORTANTES - CIRCUITO ABIERTO\r\n-- =====================================================\r\n-- ✅ NO hay FOREIGN KEYS restrictivas entre estas tablas\r\n-- ✅ Las relaciones se manejan a nivel de aplicación\r\n-- ✅ Puedes crear fichas sin requerir que exista el programa\r\n-- ✅ Puedes eliminar programas sin afectar fichas existentes\r\n-- ✅ Mayor flexibilidad en la gestión de datos\r\n-- =====================================================\r\n\r\n"
        }
    ]
}