{
    "sourceFile": "control-acceso-sena/backend/src/utils/Mysql.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1764960634038,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764968079760,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,491 +1,491 @@\n--- =====================================================\r\n--- ESQUEMA COMPLETO DE BASE DE DATOS\r\n--- Sistema de Control de Acceso SENA\r\n--- 100% SIN CIRCUITOS CERRADOS Y SIN REDUNDANCIAS\r\n--- =====================================================\r\n-\r\n--- =====================================================\r\n--- ELIMINAR BASE DE DATOS ANTERIOR (OPCIONAL)\r\n--- =====================================================\r\n--- DROP DATABASE IF EXISTS control_acceso_sena;\r\n-\r\n-CREATE DATABASE IF NOT EXISTS control_acceso_sena \r\n-CHARACTER SET utf8mb4 \r\n-COLLATE utf8mb4_unicode_ci;\r\n-\r\n-USE control_acceso_sena;\r\n-\r\n--- =====================================================\r\n--- TABLA: usuarios\r\n--- Sin conexión circular a personas\r\n--- =====================================================\r\n-CREATE TABLE usuarios (\r\n-  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\r\n-  nombre VARCHAR(100) NOT NULL,\r\n-  email VARCHAR(100) UNIQUE NOT NULL,\r\n-  passwords VARCHAR(255) NOT NULL,\r\n-  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\r\n-  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\r\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-  ultimo_acceso TIMESTAMP NULL,\r\n-  reset_token VARCHAR(64) NULL,\r\n-  reset_token_expires DATETIME NULL,\r\n-  INDEX idx_email (email),\r\n-  INDEX idx_rol (rol),\r\n-  INDEX idx_estado (estado),\r\n-  INDEX idx_reset_token (reset_token)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- Credenciales por defecto\r\n-INSERT INTO usuarios (nombre, email, passwords, rol, estado) VALUES\r\n-('Administrador', 'admin@sena.edu.co', '$2a$10$3666f.g.6YwF2m2MFJCtn.R8ftn9RkRcV6/f1yzdj3VlGZ7EESzeK', 'ADMINISTRADOR', 'ACTIVO'),\r\n-('Guarda de Seguridad', 'guarda@sena.edu.co', '$2a$10$DMCaQbx2V5QUTMYuSZvJaOk4OGfltNh2ClwOByuofhDQwBh1641dK', 'GUARDA', 'ACTIVO')\r\n-ON DUPLICATE KEY UPDATE nombre = VALUES(nombre);\r\n-\r\n--- =====================================================\r\n--- TABLA: roles\r\n--- Catálogo simple sin circuitos\r\n--- =====================================================\r\n-CREATE TABLE roles (\r\n-    id_rol INT AUTO_INCREMENT PRIMARY KEY,\r\n-    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\r\n-    descripcion VARCHAR(255),\r\n-    INDEX idx_nombre_rol (nombre_rol)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n-INSERT INTO roles (nombre_rol, descripcion) VALUES\r\n-('APRENDIZ', 'Aprendiz del SENA'),\r\n-('INSTRUCTOR', 'Instructor del SENA'),\r\n-('ADMINISTRATIVO', 'Personal administrativo'),\r\n-('VISITANTE', 'Visitante temporal'),\r\n-('GUARDA', 'Guarda de seguridad')\r\n-ON DUPLICATE KEY UPDATE nombre_rol = nombre_rol;\r\n-\r\n--- =====================================================\r\n--- TABLA: programas_formacion\r\n--- Tabla independiente, sin foreign keys hacia arriba\r\n--- =====================================================\r\n-CREATE TABLE programas_formacion (\r\n-  id_programa INT AUTO_INCREMENT PRIMARY KEY,\r\n-  codigo_programa VARCHAR(50) UNIQUE NOT NULL,\r\n-  nombre_programa VARCHAR(200) NOT NULL,\r\n-  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Complementaria') DEFAULT 'Técnico',\r\n-  duracion_meses INT DEFAULT 12,\r\n-  area_conocimiento VARCHAR(100),\r\n-  descripcion TEXT,\r\n-  estado ENUM('activo', 'inactivo') DEFAULT 'activo',\r\n-  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n-  INDEX idx_codigo (codigo_programa),\r\n-  INDEX idx_estado (estado),\r\n-  INDEX idx_nombre (nombre_programa(100))\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- =====================================================\r\n--- TABLA: fichas\r\n--- Solo referencia a programas (unidireccional)\r\n--- =====================================================\r\n-CREATE TABLE fichas (\r\n-  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\r\n-  codigo_ficha VARCHAR(50) UNIQUE NOT NULL,\r\n-  id_programa INT NOT NULL,\r\n-  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna',\r\n-  fecha_inicio DATE,\r\n-  fecha_fin DATE,\r\n-  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa',\r\n-  numero_aprendices INT DEFAULT 0,\r\n-  capacidad_maxima INT,\r\n-  FOREIGN KEY (id_programa) REFERENCES programas_formacion(id_programa) ON DELETE RESTRICT,\r\n-  INDEX idx_codigo (codigo_ficha),\r\n-  INDEX idx_programa (id_programa),\r\n-  INDEX idx_estado (estado),\r\n-  INDEX idx_fechas (fecha_inicio, fecha_fin)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- =====================================================\r\n--- TABLA: personas\r\n--- SIN REDUNDANCIAS - Solo campos esenciales\r\n--- SIN circuitos cerrados - Solo referencias hacia abajo\r\n--- =====================================================\r\n-CREATE TABLE personas (\r\n-  id_persona INT AUTO_INCREMENT PRIMARY KEY,\r\n-  \r\n-  -- Datos de identificación (NO REDUNDANTES)\r\n-  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\r\n-  documento VARCHAR(50) UNIQUE NOT NULL,\r\n-  nombres VARCHAR(100) NOT NULL,\r\n-  apellidos VARCHAR(100) NOT NULL,\r\n-  \r\n-  -- Datos de contacto\r\n-  email VARCHAR(255),\r\n-  telefono VARCHAR(20),\r\n-  rh VARCHAR(10) COMMENT 'Grupo sanguíneo',\r\n-  \r\n-  -- Referencias UNIDIRECCIONALES (sin circuitos)\r\n-  id_rol INT NOT NULL,\r\n-  id_ficha INT NULL COMMENT 'Solo para aprendices',\r\n-  \r\n-  -- Campos específicos por rol\r\n-  cargo VARCHAR(100) NULL COMMENT 'Solo para instructores/administrativos',\r\n-  tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL COMMENT 'Solo para instructores',\r\n-  \r\n-  -- Datos del sistema\r\n-  codigo_qr VARCHAR(255),\r\n-  foto VARCHAR(500),\r\n-  estado ENUM('ACTIVO', 'INACTIVO', 'SUSPENDIDO') DEFAULT 'ACTIVO',\r\n-  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n-  \r\n-  -- Foreign Keys UNIDIRECCIONALES (sin ciclos)\r\n-  FOREIGN KEY (id_rol) REFERENCES roles(id_rol) ON DELETE RESTRICT,\r\n-  FOREIGN KEY (id_ficha) REFERENCES fichas(id_ficha) ON DELETE SET NULL,\r\n-  \r\n-  -- Índices\r\n-  INDEX idx_documento (documento),\r\n-  INDEX idx_tipo_doc (tipo_documento),\r\n-  INDEX idx_rol (id_rol),\r\n-  INDEX idx_ficha (id_ficha),\r\n-  INDEX idx_estado (estado),\r\n-  INDEX idx_email (email)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\n-COMMENT='Tabla personas - SIN redundancias ni circuitos cerrados';\r\n-\r\n--- =====================================================\r\n--- TABLA: visitantes\r\n--- Información adicional SOLO para visitantes\r\n--- =====================================================\r\n-CREATE TABLE visitantes (\r\n-    id_visitante INT AUTO_INCREMENT PRIMARY KEY,\r\n-    id_persona INT NOT NULL,\r\n-    motivo_visita TEXT NOT NULL,\r\n-    contacto VARCHAR(255),\r\n-    persona_visita VARCHAR(255),\r\n-    zona VARCHAR(200) COMMENT 'Destino dentro de las instalaciones',\r\n-    fecha_inicio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-    fecha_fin TIMESTAMP NULL,\r\n-    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') DEFAULT 'ACTIVO',\r\n-    FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\r\n-    INDEX idx_persona (id_persona),\r\n-    INDEX idx_estado (estado),\r\n-    INDEX idx_fecha_inicio (fecha_inicio)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- =====================================================\r\n--- TABLA: registros_entrada_salida\r\n--- CIRCUITO ABIERTO: Registros independientes\r\n--- =====================================================\r\n-CREATE TABLE registros_entrada_salida (\r\n-  id_registro INT AUTO_INCREMENT PRIMARY KEY,\r\n-  id_persona INT NOT NULL,\r\n-  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\r\n-  fecha_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-  id_usuario_registro INT NULL COMMENT 'Guarda que registró',\r\n-  FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\r\n-  FOREIGN KEY (id_usuario_registro) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n-  INDEX idx_persona (id_persona),\r\n-  INDEX idx_tipo (tipo),\r\n-  INDEX idx_fecha (fecha_hora),\r\n-  INDEX idx_persona_fecha (id_persona, fecha_hora DESC)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\n-COMMENT='Registros independientes - Sin circuitos cerrados';\r\n-\r\n--- =====================================================\r\n--- TABLA: logs_seguridad\r\n--- Solo para auditoría, sin conexión circular\r\n--- =====================================================\r\n-CREATE TABLE logs_seguridad (\r\n-    id_log INT AUTO_INCREMENT PRIMARY KEY,\r\n-    tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', \r\n-              'modificacion_usuario', 'acceso_sistema') NOT NULL,\r\n-    id_usuario INT NULL,\r\n-    ip_address VARCHAR(45),\r\n-    user_agent TEXT,\r\n-    accion TEXT NOT NULL,\r\n-    detalles JSON,\r\n-    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n-    INDEX idx_tipo (tipo),\r\n-    INDEX idx_usuario (id_usuario),\r\n-    INDEX idx_fecha (fecha)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- =====================================================\r\n--- TABLA: auditoria\r\n--- Tabla de auditoría general\r\n--- =====================================================\r\n-CREATE TABLE auditoria (\r\n-    id_auditoria INT AUTO_INCREMENT PRIMARY KEY,\r\n-    tabla_afectada VARCHAR(100) NOT NULL,\r\n-    id_registro INT,\r\n-    accion ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,\r\n-    datos_anteriores JSON,\r\n-    datos_nuevos JSON,\r\n-    id_usuario INT NULL,\r\n-    ip_address VARCHAR(45),\r\n-    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n-    INDEX idx_tabla (tabla_afectada),\r\n-    INDEX idx_accion (accion),\r\n-    INDEX idx_fecha (fecha)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- =====================================================\r\n--- TABLA: evidencia_fotografica\r\n--- Evidencias de incidentes\r\n--- =====================================================\r\n-CREATE TABLE evidencia_fotografica (\r\n-    id_evidencia INT AUTO_INCREMENT PRIMARY KEY,\r\n-    tipo_incidente ENUM('acceso_denegado', 'comportamiento_sospechoso', \r\n-                        'incidente_seguridad', 'evidencia_general') NOT NULL,\r\n-    url_foto VARCHAR(500) NOT NULL,\r\n-    hash_archivo VARCHAR(64),\r\n-    fecha_captura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n-    id_usuario_captura INT NULL,\r\n-    descripcion TEXT,\r\n-    metadata JSON,\r\n-    FOREIGN KEY (id_usuario_captura) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n-    INDEX idx_tipo (tipo_incidente),\r\n-    INDEX idx_fecha (fecha_captura)\r\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n-\r\n--- =====================================================\r\n--- VISTAS OPTIMIZADAS\r\n--- =====================================================\r\n-\r\n--- Vista: Información completa de personas (eliminando redundancias)\r\n-CREATE OR REPLACE VIEW v_personas_completo AS\r\n-SELECT \r\n-    p.id_persona,\r\n-    p.tipo_documento,\r\n-    p.documento,\r\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n-    p.nombres,\r\n-    p.apellidos,\r\n-    p.email,\r\n-    p.telefono,\r\n-    p.rh,\r\n-    r.nombre_rol,\r\n-    r.descripcion as rol_descripcion,\r\n-    p.id_ficha,\r\n-    f.codigo_ficha,\r\n-    prog.nombre_programa,\r\n-    prog.codigo_programa,\r\n-    f.jornada,\r\n-    p.cargo,\r\n-    p.tipo_contrato,\r\n-    p.codigo_qr,\r\n-    p.foto,\r\n-    p.estado,\r\n-    p.fecha_registro\r\n-FROM personas p\r\n-INNER JOIN roles r ON p.id_rol = r.id_rol\r\n-LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\r\n-LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa;\r\n-\r\n--- Vista: Personas actualmente dentro\r\n-CREATE OR REPLACE VIEW v_personas_dentro AS\r\n-SELECT \r\n-    p.id_persona,\r\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n-    p.documento,\r\n-    r.nombre_rol,\r\n-    p.foto,\r\n-    reg.fecha_hora as fecha_entrada,\r\n-    TIMESTAMPDIFF(MINUTE, reg.fecha_hora, NOW()) as minutos_dentro,\r\n-    f.codigo_ficha,\r\n-    prog.nombre_programa,\r\n-    v.zona,\r\n-    v.motivo_visita,\r\n-    v.persona_visita\r\n-FROM personas p\r\n-INNER JOIN roles r ON p.id_rol = r.id_rol\r\n-INNER JOIN registros_entrada_salida reg ON p.id_persona = reg.id_persona\r\n-LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\r\n-LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\r\n-LEFT JOIN visitantes v ON p.id_persona = v.id_persona AND v.estado = 'ACTIVO'\r\n-WHERE reg.tipo = 'ENTRADA'\r\n-  AND reg.fecha_hora = (\r\n-    SELECT MAX(fecha_hora) \r\n-    FROM registros_entrada_salida \r\n-    WHERE id_persona = p.id_persona\r\n-  )\r\n-  AND NOT EXISTS (\r\n-    SELECT 1 \r\n-    FROM registros_entrada_salida r2 \r\n-    WHERE r2.id_persona = p.id_persona \r\n-      AND r2.tipo = 'SALIDA' \r\n-      AND r2.fecha_hora > reg.fecha_hora\r\n-  )\r\n-  AND p.estado = 'ACTIVO';\r\n-\r\n--- Vista: Historial de accesos\r\n-CREATE OR REPLACE VIEW v_historial_accesos AS\r\n-SELECT \r\n-    reg.id_registro,\r\n-    reg.id_persona,\r\n-    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n-    p.documento,\r\n-    r.nombre_rol,\r\n-    reg.tipo,\r\n-    reg.fecha_hora,\r\n-    DATE(reg.fecha_hora) as fecha,\r\n-    TIME(reg.fecha_hora) as hora,\r\n-    f.codigo_ficha,\r\n-    prog.nombre_programa,\r\n-    u.nombre as registrado_por\r\n-FROM registros_entrada_salida reg\r\n-INNER JOIN personas p ON reg.id_persona = p.id_persona\r\n-INNER JOIN roles r ON p.id_rol = r.id_rol\r\n-LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\r\n-LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\r\n-LEFT JOIN usuarios u ON reg.id_usuario_registro = u.id_usuario\r\n-ORDER BY reg.fecha_hora DESC;\r\n-\r\n--- Vista: Estadísticas diarias\r\n-CREATE OR REPLACE VIEW v_estadisticas_diarias AS\r\n-SELECT \r\n-    DATE(fecha_hora) as fecha,\r\n-    COUNT(CASE WHEN tipo = 'ENTRADA' THEN 1 END) as total_entradas,\r\n-    COUNT(CASE WHEN tipo = 'SALIDA' THEN 1 END) as total_salidas,\r\n-    COUNT(DISTINCT id_persona) as personas_unicas\r\n-FROM registros_entrada_salida\r\n-GROUP BY DATE(fecha_hora)\r\n-ORDER BY fecha DESC;\r\n-\r\n--- =====================================================\r\n--- PROCEDIMIENTOS ALMACENADOS\r\n--- =====================================================\r\n-\r\n-DELIMITER $$\r\n-\r\n--- Registrar entrada\r\n-CREATE PROCEDURE sp_registrar_entrada(\r\n-    IN p_id_persona INT,\r\n-    IN p_id_usuario INT\r\n-)\r\n-BEGIN\r\n-    INSERT INTO registros_entrada_salida \r\n-    (id_persona, tipo, fecha_hora, id_usuario_registro)\r\n-    VALUES \r\n-    (p_id_persona, 'ENTRADA', NOW(), p_id_usuario);\r\n-    \r\n-    SELECT LAST_INSERT_ID() as id_registro;\r\n-END$$\r\n-\r\n--- Registrar salida\r\n-CREATE PROCEDURE sp_registrar_salida(\r\n-    IN p_id_persona INT,\r\n-    IN p_id_usuario INT\r\n-)\r\n-BEGIN\r\n-    INSERT INTO registros_entrada_salida \r\n-    (id_persona, tipo, fecha_hora, id_usuario_registro)\r\n-    VALUES \r\n-    (p_id_persona, 'SALIDA', NOW(), p_id_usuario);\r\n-    \r\n-    SELECT LAST_INSERT_ID() as id_registro;\r\n-END$$\r\n-\r\n--- Obtener personas dentro\r\n-CREATE PROCEDURE sp_personas_dentro()\r\n-BEGIN\r\n-    SELECT * FROM v_personas_dentro\r\n-    ORDER BY fecha_entrada DESC;\r\n-END$$\r\n-\r\n--- Verificar última acción\r\n-CREATE PROCEDURE sp_ultima_accion(IN p_id_persona INT)\r\n-BEGIN\r\n-    SELECT \r\n-        tipo,\r\n-        fecha_hora,\r\n-        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\r\n-    FROM registros_entrada_salida\r\n-    WHERE id_persona = p_id_persona\r\n-    ORDER BY fecha_hora DESC\r\n-    LIMIT 1;\r\n-END$$\r\n-\r\n--- Reporte de asistencia por ficha\r\n-CREATE PROCEDURE sp_reporte_asistencia_ficha(\r\n-    IN p_id_ficha INT,\r\n-    IN p_fecha_inicio DATE,\r\n-    IN p_fecha_fin DATE\r\n-)\r\n-BEGIN\r\n-    SELECT \r\n-        p.id_persona,\r\n-        p.documento,\r\n-        CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n-        COUNT(DISTINCT DATE(reg.fecha_hora)) as dias_asistencia,\r\n-        COUNT(CASE WHEN reg.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\r\n-        COUNT(CASE WHEN reg.tipo = 'SALIDA' THEN 1 END) as total_salidas\r\n-    FROM personas p\r\n-    LEFT JOIN registros_entrada_salida reg \r\n-        ON p.id_persona = reg.id_persona\r\n-        AND DATE(reg.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin\r\n-    WHERE p.id_ficha = p_id_ficha\r\n-      AND p.estado = 'ACTIVO'\r\n-    GROUP BY p.id_persona, p.documento, p.nombres, p.apellidos\r\n-    ORDER BY dias_asistencia DESC;\r\n-END$$\r\n-\r\n-DELIMITER ;\r\n-\r\n--- =====================================================\r\n--- VERIFICACIÓN DE ESTRUCTURA\r\n--- =====================================================\r\n-SELECT 'Base de datos creada exitosamente' as estado;\r\n-SELECT 'Sin circuitos cerrados ✓' as verificacion_1;\r\n-SELECT 'Sin redundancias ✓' as verificacion_2;\r\n-SELECT 'Estructura normalizada ✓' as verificacion_3;\r\n-\r\n--- =====================================================\r\n--- DOCUMENTACIÓN\r\n--- =====================================================\r\n-/*\r\n-CAMBIOS IMPLEMENTADOS PARA ELIMINAR CIRCUITOS CERRADOS Y REDUNDANCIAS:\r\n-\r\n-1. ELIMINADAS las siguientes columnas REDUNDANTES de 'personas':\r\n-   ❌ programa VARCHAR(200)        - Ya existe id_ficha → fichas → programas_formacion\r\n-   ❌ ficha VARCHAR(50)            - Ya existe id_ficha\r\n-   ❌ nombre VARCHAR(200)          - Ya existe nombres + apellidos\r\n-   ❌ rol VARCHAR(50)              - Ya existe id_rol → roles\r\n-   ❌ id_rol_persona               - Duplicado con id_rol\r\n-   ❌ id_estado_persona            - Ya existe estado ENUM\r\n-   ❌ id_usuario                   - Creaba circuito cerrado\r\n-   ❌ zona VARCHAR(200)            - Movido a tabla visitantes\r\n-\r\n-2. ESTRUCTURA SIN CIRCUITOS:\r\n-   usuarios (tabla raíz)\r\n-   ↓\r\n-   roles (independiente)\r\n-   ↓\r\n-   programas_formacion (independiente)\r\n-   ↓\r\n-   fichas (solo referencia programas)\r\n-   ↓\r\n-   personas (solo referencia roles y fichas)\r\n-   ↓\r\n-   visitantes (solo referencia personas)\r\n-   ↓\r\n-   registros_entrada_salida (solo referencia personas y usuarios)\r\n-\r\n-3. FLUJO UNIDIRECCIONAL (sin ciclos):\r\n-   - Todas las referencias van hacia \"abajo\"\r\n-   - No hay foreign keys que vuelvan hacia \"arriba\"\r\n-   - Cada tabla tiene máximo 2 foreign keys\r\n-\r\n-4. VENTAJAS:\r\n-   ✓ Sin duplicación de datos\r\n-   ✓ Fácil mantenimiento\r\n-   ✓ Integridad referencial clara\r\n-   ✓ Mejor rendimiento\r\n-   ✓ Cumple normalización 3FN\r\n-\r\n-CONSULTAS PRINCIPALES:\r\n-- Ver personas dentro: SELECT * FROM v_personas_dentro;\r\n-- Información completa: SELECT * FROM v_personas_completo WHERE documento = '123456';\r\n-- Historial: SELECT * FROM v_historial_accesos WHERE fecha = CURDATE();\r\n-- Estadísticas: SELECT * FROM v_estadisticas_diarias WHERE fecha >= CURDATE() - INTERVAL 7 DAY;\r\n+-- =====================================================\n+-- ESQUEMA COMPLETO DE BASE DE DATOS\n+-- Sistema de Control de Acceso SENA\n+-- 100% SIN CIRCUITOS CERRADOS Y SIN REDUNDANCIAS\n+-- =====================================================\n+\n+-- =====================================================\n+-- ELIMINAR BASE DE DATOS ANTERIOR (OPCIONAL)\n+-- =====================================================\n+-- DROP DATABASE IF EXISTS control_acceso_sena1;\n+\n+CREATE DATABASE IF NOT EXISTS control_acceso_sena1 \n+CHARACTER SET utf8mb4 \n+COLLATE utf8mb4_unicode_ci;\n+\n+USE control_acceso_sena1;\n+\n+-- =====================================================\n+-- TABLA: usuarios\n+-- Sin conexión circular a personas\n+-- =====================================================\n+CREATE TABLE usuarios (\n+  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\n+  nombre VARCHAR(100) NOT NULL,\n+  email VARCHAR(100) UNIQUE NOT NULL,\n+  passwords VARCHAR(255) NOT NULL,\n+  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\n+  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  ultimo_acceso TIMESTAMP NULL,\n+  reset_token VARCHAR(64) NULL,\n+  reset_token_expires DATETIME NULL,\n+  INDEX idx_email (email),\n+  INDEX idx_rol (rol),\n+  INDEX idx_estado (estado),\n+  INDEX idx_reset_token (reset_token)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- Credenciales por defecto\n+INSERT INTO usuarios (nombre, email, passwords, rol, estado) VALUES\n+('Administrador', 'admin@sena.edu.co', '$2a$10$3666f.g.6YwF2m2MFJCtn.R8ftn9RkRcV6/f1yzdj3VlGZ7EESzeK', 'ADMINISTRADOR', 'ACTIVO'),\n+('Guarda de Seguridad', 'guarda@sena.edu.co', '$2a$10$DMCaQbx2V5QUTMYuSZvJaOk4OGfltNh2ClwOByuofhDQwBh1641dK', 'GUARDA', 'ACTIVO')\n+ON DUPLICATE KEY UPDATE nombre = VALUES(nombre);\n+\n+-- =====================================================\n+-- TABLA: roles\n+-- Catálogo simple sin circuitos\n+-- =====================================================\n+CREATE TABLE roles (\n+    id_rol INT AUTO_INCREMENT PRIMARY KEY,\n+    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\n+    descripcion VARCHAR(255),\n+    INDEX idx_nombre_rol (nombre_rol)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+INSERT INTO roles (nombre_rol, descripcion) VALUES\n+('APRENDIZ', 'Aprendiz del SENA'),\n+('INSTRUCTOR', 'Instructor del SENA'),\n+('ADMINISTRATIVO', 'Personal administrativo'),\n+('VISITANTE', 'Visitante temporal'),\n+('GUARDA', 'Guarda de seguridad')\n+ON DUPLICATE KEY UPDATE nombre_rol = nombre_rol;\n+\n+-- =====================================================\n+-- TABLA: programas_formacion\n+-- Tabla independiente, sin foreign keys hacia arriba\n+-- =====================================================\n+CREATE TABLE programas_formacion (\n+  id_programa INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_programa VARCHAR(50) UNIQUE NOT NULL,\n+  nombre_programa VARCHAR(200) NOT NULL,\n+  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Complementaria') DEFAULT 'Técnico',\n+  duracion_meses INT DEFAULT 12,\n+  area_conocimiento VARCHAR(100),\n+  descripcion TEXT,\n+  estado ENUM('activo', 'inactivo') DEFAULT 'activo',\n+  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  INDEX idx_codigo (codigo_programa),\n+  INDEX idx_estado (estado),\n+  INDEX idx_nombre (nombre_programa(100))\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n+-- TABLA: fichas\n+-- Solo referencia a programas (unidireccional)\n+-- =====================================================\n+CREATE TABLE fichas (\n+  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\n+  codigo_ficha VARCHAR(50) UNIQUE NOT NULL,\n+  id_programa INT NOT NULL,\n+  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna',\n+  fecha_inicio DATE,\n+  fecha_fin DATE,\n+  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa',\n+  numero_aprendices INT DEFAULT 0,\n+  capacidad_maxima INT,\n+  FOREIGN KEY (id_programa) REFERENCES programas_formacion(id_programa) ON DELETE RESTRICT,\n+  INDEX idx_codigo (codigo_ficha),\n+  INDEX idx_programa (id_programa),\n+  INDEX idx_estado (estado),\n+  INDEX idx_fechas (fecha_inicio, fecha_fin)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n+-- TABLA: personas\n+-- SIN REDUNDANCIAS - Solo campos esenciales\n+-- SIN circuitos cerrados - Solo referencias hacia abajo\n+-- =====================================================\n+CREATE TABLE personas (\n+  id_persona INT AUTO_INCREMENT PRIMARY KEY,\n+  \n+  -- Datos de identificación (NO REDUNDANTES)\n+  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\n+  documento VARCHAR(50) UNIQUE NOT NULL,\n+  nombres VARCHAR(100) NOT NULL,\n+  apellidos VARCHAR(100) NOT NULL,\n+  \n+  -- Datos de contacto\n+  email VARCHAR(255),\n+  telefono VARCHAR(20),\n+  rh VARCHAR(10) COMMENT 'Grupo sanguíneo',\n+  \n+  -- Referencias UNIDIRECCIONALES (sin circuitos)\n+  id_rol INT NOT NULL,\n+  id_ficha INT NULL COMMENT 'Solo para aprendices',\n+  \n+  -- Campos específicos por rol\n+  cargo VARCHAR(100) NULL COMMENT 'Solo para instructores/administrativos',\n+  tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL COMMENT 'Solo para instructores',\n+  \n+  -- Datos del sistema\n+  codigo_qr VARCHAR(255),\n+  foto VARCHAR(500),\n+  estado ENUM('ACTIVO', 'INACTIVO', 'SUSPENDIDO') DEFAULT 'ACTIVO',\n+  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  \n+  -- Foreign Keys UNIDIRECCIONALES (sin ciclos)\n+  FOREIGN KEY (id_rol) REFERENCES roles(id_rol) ON DELETE RESTRICT,\n+  FOREIGN KEY (id_ficha) REFERENCES fichas(id_ficha) ON DELETE SET NULL,\n+  \n+  -- Índices\n+  INDEX idx_documento (documento),\n+  INDEX idx_tipo_doc (tipo_documento),\n+  INDEX idx_rol (id_rol),\n+  INDEX idx_ficha (id_ficha),\n+  INDEX idx_estado (estado),\n+  INDEX idx_email (email)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Tabla personas - SIN redundancias ni circuitos cerrados';\n+\n+-- =====================================================\n+-- TABLA: visitantes\n+-- Información adicional SOLO para visitantes\n+-- =====================================================\n+CREATE TABLE visitantes (\n+    id_visitante INT AUTO_INCREMENT PRIMARY KEY,\n+    id_persona INT NOT NULL,\n+    motivo_visita TEXT NOT NULL,\n+    contacto VARCHAR(255),\n+    persona_visita VARCHAR(255),\n+    zona VARCHAR(200) COMMENT 'Destino dentro de las instalaciones',\n+    fecha_inicio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    fecha_fin TIMESTAMP NULL,\n+    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') DEFAULT 'ACTIVO',\n+    FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\n+    INDEX idx_persona (id_persona),\n+    INDEX idx_estado (estado),\n+    INDEX idx_fecha_inicio (fecha_inicio)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n+-- TABLA: registros_entrada_salida\n+-- CIRCUITO ABIERTO: Registros independientes\n+-- =====================================================\n+CREATE TABLE registros_entrada_salida (\n+  id_registro INT AUTO_INCREMENT PRIMARY KEY,\n+  id_persona INT NOT NULL,\n+  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\n+  fecha_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+  id_usuario_registro INT NULL COMMENT 'Guarda que registró',\n+  FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\n+  FOREIGN KEY (id_usuario_registro) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+  INDEX idx_persona (id_persona),\n+  INDEX idx_tipo (tipo),\n+  INDEX idx_fecha (fecha_hora),\n+  INDEX idx_persona_fecha (id_persona, fecha_hora DESC)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n+COMMENT='Registros independientes - Sin circuitos cerrados';\n+\n+-- =====================================================\n+-- TABLA: logs_seguridad\n+-- Solo para auditoría, sin conexión circular\n+-- =====================================================\n+CREATE TABLE logs_seguridad (\n+    id_log INT AUTO_INCREMENT PRIMARY KEY,\n+    tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', \n+              'modificacion_usuario', 'acceso_sistema') NOT NULL,\n+    id_usuario INT NULL,\n+    ip_address VARCHAR(45),\n+    user_agent TEXT,\n+    accion TEXT NOT NULL,\n+    detalles JSON,\n+    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+    INDEX idx_tipo (tipo),\n+    INDEX idx_usuario (id_usuario),\n+    INDEX idx_fecha (fecha)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n+-- TABLA: auditoria\n+-- Tabla de auditoría general\n+-- =====================================================\n+CREATE TABLE auditoria (\n+    id_auditoria INT AUTO_INCREMENT PRIMARY KEY,\n+    tabla_afectada VARCHAR(100) NOT NULL,\n+    id_registro INT,\n+    accion ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,\n+    datos_anteriores JSON,\n+    datos_nuevos JSON,\n+    id_usuario INT NULL,\n+    ip_address VARCHAR(45),\n+    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+    INDEX idx_tabla (tabla_afectada),\n+    INDEX idx_accion (accion),\n+    INDEX idx_fecha (fecha)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n+-- TABLA: evidencia_fotografica\n+-- Evidencias de incidentes\n+-- =====================================================\n+CREATE TABLE evidencia_fotografica (\n+    id_evidencia INT AUTO_INCREMENT PRIMARY KEY,\n+    tipo_incidente ENUM('acceso_denegado', 'comportamiento_sospechoso', \n+                        'incidente_seguridad', 'evidencia_general') NOT NULL,\n+    url_foto VARCHAR(500) NOT NULL,\n+    hash_archivo VARCHAR(64),\n+    fecha_captura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n+    id_usuario_captura INT NULL,\n+    descripcion TEXT,\n+    metadata JSON,\n+    FOREIGN KEY (id_usuario_captura) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\n+    INDEX idx_tipo (tipo_incidente),\n+    INDEX idx_fecha (fecha_captura)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n+\n+-- =====================================================\n+-- VISTAS OPTIMIZADAS\n+-- =====================================================\n+\n+-- Vista: Información completa de personas (eliminando redundancias)\n+CREATE OR REPLACE VIEW v_personas_completo AS\n+SELECT \n+    p.id_persona,\n+    p.tipo_documento,\n+    p.documento,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.nombres,\n+    p.apellidos,\n+    p.email,\n+    p.telefono,\n+    p.rh,\n+    r.nombre_rol,\n+    r.descripcion as rol_descripcion,\n+    p.id_ficha,\n+    f.codigo_ficha,\n+    prog.nombre_programa,\n+    prog.codigo_programa,\n+    f.jornada,\n+    p.cargo,\n+    p.tipo_contrato,\n+    p.codigo_qr,\n+    p.foto,\n+    p.estado,\n+    p.fecha_registro\n+FROM personas p\n+INNER JOIN roles r ON p.id_rol = r.id_rol\n+LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa;\n+\n+-- Vista: Personas actualmente dentro\n+CREATE OR REPLACE VIEW v_personas_dentro AS\n+SELECT \n+    p.id_persona,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.documento,\n+    r.nombre_rol,\n+    p.foto,\n+    reg.fecha_hora as fecha_entrada,\n+    TIMESTAMPDIFF(MINUTE, reg.fecha_hora, NOW()) as minutos_dentro,\n+    f.codigo_ficha,\n+    prog.nombre_programa,\n+    v.zona,\n+    v.motivo_visita,\n+    v.persona_visita\n+FROM personas p\n+INNER JOIN roles r ON p.id_rol = r.id_rol\n+INNER JOIN registros_entrada_salida reg ON p.id_persona = reg.id_persona\n+LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\n+LEFT JOIN visitantes v ON p.id_persona = v.id_persona AND v.estado = 'ACTIVO'\n+WHERE reg.tipo = 'ENTRADA'\n+  AND reg.fecha_hora = (\n+    SELECT MAX(fecha_hora) \n+    FROM registros_entrada_salida \n+    WHERE id_persona = p.id_persona\n+  )\n+  AND NOT EXISTS (\n+    SELECT 1 \n+    FROM registros_entrada_salida r2 \n+    WHERE r2.id_persona = p.id_persona \n+      AND r2.tipo = 'SALIDA' \n+      AND r2.fecha_hora > reg.fecha_hora\n+  )\n+  AND p.estado = 'ACTIVO';\n+\n+-- Vista: Historial de accesos\n+CREATE OR REPLACE VIEW v_historial_accesos AS\n+SELECT \n+    reg.id_registro,\n+    reg.id_persona,\n+    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+    p.documento,\n+    r.nombre_rol,\n+    reg.tipo,\n+    reg.fecha_hora,\n+    DATE(reg.fecha_hora) as fecha,\n+    TIME(reg.fecha_hora) as hora,\n+    f.codigo_ficha,\n+    prog.nombre_programa,\n+    u.nombre as registrado_por\n+FROM registros_entrada_salida reg\n+INNER JOIN personas p ON reg.id_persona = p.id_persona\n+INNER JOIN roles r ON p.id_rol = r.id_rol\n+LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+LEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\n+LEFT JOIN usuarios u ON reg.id_usuario_registro = u.id_usuario\n+ORDER BY reg.fecha_hora DESC;\n+\n+-- Vista: Estadísticas diarias\n+CREATE OR REPLACE VIEW v_estadisticas_diarias AS\n+SELECT \n+    DATE(fecha_hora) as fecha,\n+    COUNT(CASE WHEN tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n+    COUNT(CASE WHEN tipo = 'SALIDA' THEN 1 END) as total_salidas,\n+    COUNT(DISTINCT id_persona) as personas_unicas\n+FROM registros_entrada_salida\n+GROUP BY DATE(fecha_hora)\n+ORDER BY fecha DESC;\n+\n+-- =====================================================\n+-- PROCEDIMIENTOS ALMACENADOS\n+-- =====================================================\n+\n+DELIMITER $$\n+\n+-- Registrar entrada\n+CREATE PROCEDURE sp_registrar_entrada(\n+    IN p_id_persona INT,\n+    IN p_id_usuario INT\n+)\n+BEGIN\n+    INSERT INTO registros_entrada_salida \n+    (id_persona, tipo, fecha_hora, id_usuario_registro)\n+    VALUES \n+    (p_id_persona, 'ENTRADA', NOW(), p_id_usuario);\n+    \n+    SELECT LAST_INSERT_ID() as id_registro;\n+END$$\n+\n+-- Registrar salida\n+CREATE PROCEDURE sp_registrar_salida(\n+    IN p_id_persona INT,\n+    IN p_id_usuario INT\n+)\n+BEGIN\n+    INSERT INTO registros_entrada_salida \n+    (id_persona, tipo, fecha_hora, id_usuario_registro)\n+    VALUES \n+    (p_id_persona, 'SALIDA', NOW(), p_id_usuario);\n+    \n+    SELECT LAST_INSERT_ID() as id_registro;\n+END$$\n+\n+-- Obtener personas dentro\n+CREATE PROCEDURE sp_personas_dentro()\n+BEGIN\n+    SELECT * FROM v_personas_dentro\n+    ORDER BY fecha_entrada DESC;\n+END$$\n+\n+-- Verificar última acción\n+CREATE PROCEDURE sp_ultima_accion(IN p_id_persona INT)\n+BEGIN\n+    SELECT \n+        tipo,\n+        fecha_hora,\n+        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\n+    FROM registros_entrada_salida\n+    WHERE id_persona = p_id_persona\n+    ORDER BY fecha_hora DESC\n+    LIMIT 1;\n+END$$\n+\n+-- Reporte de asistencia por ficha\n+CREATE PROCEDURE sp_reporte_asistencia_ficha(\n+    IN p_id_ficha INT,\n+    IN p_fecha_inicio DATE,\n+    IN p_fecha_fin DATE\n+)\n+BEGIN\n+    SELECT \n+        p.id_persona,\n+        p.documento,\n+        CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\n+        COUNT(DISTINCT DATE(reg.fecha_hora)) as dias_asistencia,\n+        COUNT(CASE WHEN reg.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\n+        COUNT(CASE WHEN reg.tipo = 'SALIDA' THEN 1 END) as total_salidas\n+    FROM personas p\n+    LEFT JOIN registros_entrada_salida reg \n+        ON p.id_persona = reg.id_persona\n+        AND DATE(reg.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin\n+    WHERE p.id_ficha = p_id_ficha\n+      AND p.estado = 'ACTIVO'\n+    GROUP BY p.id_persona, p.documento, p.nombres, p.apellidos\n+    ORDER BY dias_asistencia DESC;\n+END$$\n+\n+DELIMITER ;\n+\n+-- =====================================================\n+-- VERIFICACIÓN DE ESTRUCTURA\n+-- =====================================================\n+SELECT 'Base de datos creada exitosamente' as estado;\n+SELECT 'Sin circuitos cerrados ✓' as verificacion_1;\n+SELECT 'Sin redundancias ✓' as verificacion_2;\n+SELECT 'Estructura normalizada ✓' as verificacion_3;\n+\n+-- =====================================================\n+-- DOCUMENTACIÓN\n+-- =====================================================\n+/*\n+CAMBIOS IMPLEMENTADOS PARA ELIMINAR CIRCUITOS CERRADOS Y REDUNDANCIAS:\n+\n+1. ELIMINADAS las siguientes columnas REDUNDANTES de 'personas':\n+   ❌ programa VARCHAR(200)        - Ya existe id_ficha → fichas → programas_formacion\n+   ❌ ficha VARCHAR(50)            - Ya existe id_ficha\n+   ❌ nombre VARCHAR(200)          - Ya existe nombres + apellidos\n+   ❌ rol VARCHAR(50)              - Ya existe id_rol → roles\n+   ❌ id_rol_persona               - Duplicado con id_rol\n+   ❌ id_estado_persona            - Ya existe estado ENUM\n+   ❌ id_usuario                   - Creaba circuito cerrado\n+   ❌ zona VARCHAR(200)            - Movido a tabla visitantes\n+\n+2. ESTRUCTURA SIN CIRCUITOS:\n+   usuarios (tabla raíz)\n+   ↓\n+   roles (independiente)\n+   ↓\n+   programas_formacion (independiente)\n+   ↓\n+   fichas (solo referencia programas)\n+   ↓\n+   personas (solo referencia roles y fichas)\n+   ↓\n+   visitantes (solo referencia personas)\n+   ↓\n+   registros_entrada_salida (solo referencia personas y usuarios)\n+\n+3. FLUJO UNIDIRECCIONAL (sin ciclos):\n+   - Todas las referencias van hacia \"abajo\"\n+   - No hay foreign keys que vuelvan hacia \"arriba\"\n+   - Cada tabla tiene máximo 2 foreign keys\n+\n+4. VENTAJAS:\n+   ✓ Sin duplicación de datos\n+   ✓ Fácil mantenimiento\n+   ✓ Integridad referencial clara\n+   ✓ Mejor rendimiento\n+   ✓ Cumple normalización 3FN\n+\n+CONSULTAS PRINCIPALES:\n+- Ver personas dentro: SELECT * FROM v_personas_dentro;\n+- Información completa: SELECT * FROM v_personas_completo WHERE documento = '123456';\n+- Historial: SELECT * FROM v_historial_accesos WHERE fecha = CURDATE();\n+- Estadísticas: SELECT * FROM v_estadisticas_diarias WHERE fecha >= CURDATE() - INTERVAL 7 DAY;\n */\n\\ No newline at end of file\n"
                }
            ],
            "date": 1764960634038,
            "name": "Commit-0",
            "content": "-- =====================================================\r\n-- ESQUEMA COMPLETO DE BASE DE DATOS\r\n-- Sistema de Control de Acceso SENA\r\n-- 100% SIN CIRCUITOS CERRADOS Y SIN REDUNDANCIAS\r\n-- =====================================================\r\n\r\n-- =====================================================\r\n-- ELIMINAR BASE DE DATOS ANTERIOR (OPCIONAL)\r\n-- =====================================================\r\n-- DROP DATABASE IF EXISTS control_acceso_sena;\r\n\r\nCREATE DATABASE IF NOT EXISTS control_acceso_sena \r\nCHARACTER SET utf8mb4 \r\nCOLLATE utf8mb4_unicode_ci;\r\n\r\nUSE control_acceso_sena;\r\n\r\n-- =====================================================\r\n-- TABLA: usuarios\r\n-- Sin conexión circular a personas\r\n-- =====================================================\r\nCREATE TABLE usuarios (\r\n  id_usuario INT AUTO_INCREMENT PRIMARY KEY,\r\n  nombre VARCHAR(100) NOT NULL,\r\n  email VARCHAR(100) UNIQUE NOT NULL,\r\n  passwords VARCHAR(255) NOT NULL,\r\n  rol ENUM('GUARDA', 'ADMINISTRADOR') DEFAULT 'GUARDA',\r\n  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',\r\n  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n  ultimo_acceso TIMESTAMP NULL,\r\n  reset_token VARCHAR(64) NULL,\r\n  reset_token_expires DATETIME NULL,\r\n  INDEX idx_email (email),\r\n  INDEX idx_rol (rol),\r\n  INDEX idx_estado (estado),\r\n  INDEX idx_reset_token (reset_token)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- Credenciales por defecto\r\nINSERT INTO usuarios (nombre, email, passwords, rol, estado) VALUES\r\n('Administrador', 'admin@sena.edu.co', '$2a$10$3666f.g.6YwF2m2MFJCtn.R8ftn9RkRcV6/f1yzdj3VlGZ7EESzeK', 'ADMINISTRADOR', 'ACTIVO'),\r\n('Guarda de Seguridad', 'guarda@sena.edu.co', '$2a$10$DMCaQbx2V5QUTMYuSZvJaOk4OGfltNh2ClwOByuofhDQwBh1641dK', 'GUARDA', 'ACTIVO')\r\nON DUPLICATE KEY UPDATE nombre = VALUES(nombre);\r\n\r\n-- =====================================================\r\n-- TABLA: roles\r\n-- Catálogo simple sin circuitos\r\n-- =====================================================\r\nCREATE TABLE roles (\r\n    id_rol INT AUTO_INCREMENT PRIMARY KEY,\r\n    nombre_rol VARCHAR(50) NOT NULL UNIQUE,\r\n    descripcion VARCHAR(255),\r\n    INDEX idx_nombre_rol (nombre_rol)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\nINSERT INTO roles (nombre_rol, descripcion) VALUES\r\n('APRENDIZ', 'Aprendiz del SENA'),\r\n('INSTRUCTOR', 'Instructor del SENA'),\r\n('ADMINISTRATIVO', 'Personal administrativo'),\r\n('VISITANTE', 'Visitante temporal'),\r\n('GUARDA', 'Guarda de seguridad')\r\nON DUPLICATE KEY UPDATE nombre_rol = nombre_rol;\r\n\r\n-- =====================================================\r\n-- TABLA: programas_formacion\r\n-- Tabla independiente, sin foreign keys hacia arriba\r\n-- =====================================================\r\nCREATE TABLE programas_formacion (\r\n  id_programa INT AUTO_INCREMENT PRIMARY KEY,\r\n  codigo_programa VARCHAR(50) UNIQUE NOT NULL,\r\n  nombre_programa VARCHAR(200) NOT NULL,\r\n  nivel ENUM('Técnico', 'Tecnológico', 'Especialización', 'Complementaria') DEFAULT 'Técnico',\r\n  duracion_meses INT DEFAULT 12,\r\n  area_conocimiento VARCHAR(100),\r\n  descripcion TEXT,\r\n  estado ENUM('activo', 'inactivo') DEFAULT 'activo',\r\n  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n  INDEX idx_codigo (codigo_programa),\r\n  INDEX idx_estado (estado),\r\n  INDEX idx_nombre (nombre_programa(100))\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- TABLA: fichas\r\n-- Solo referencia a programas (unidireccional)\r\n-- =====================================================\r\nCREATE TABLE fichas (\r\n  id_ficha INT AUTO_INCREMENT PRIMARY KEY,\r\n  codigo_ficha VARCHAR(50) UNIQUE NOT NULL,\r\n  id_programa INT NOT NULL,\r\n  jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna',\r\n  fecha_inicio DATE,\r\n  fecha_fin DATE,\r\n  estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa',\r\n  numero_aprendices INT DEFAULT 0,\r\n  capacidad_maxima INT,\r\n  FOREIGN KEY (id_programa) REFERENCES programas_formacion(id_programa) ON DELETE RESTRICT,\r\n  INDEX idx_codigo (codigo_ficha),\r\n  INDEX idx_programa (id_programa),\r\n  INDEX idx_estado (estado),\r\n  INDEX idx_fechas (fecha_inicio, fecha_fin)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- TABLA: personas\r\n-- SIN REDUNDANCIAS - Solo campos esenciales\r\n-- SIN circuitos cerrados - Solo referencias hacia abajo\r\n-- =====================================================\r\nCREATE TABLE personas (\r\n  id_persona INT AUTO_INCREMENT PRIMARY KEY,\r\n  \r\n  -- Datos de identificación (NO REDUNDANTES)\r\n  tipo_documento ENUM('CC', 'TI', 'CE', 'PASAPORTE') NOT NULL DEFAULT 'CC',\r\n  documento VARCHAR(50) UNIQUE NOT NULL,\r\n  nombres VARCHAR(100) NOT NULL,\r\n  apellidos VARCHAR(100) NOT NULL,\r\n  \r\n  -- Datos de contacto\r\n  email VARCHAR(255),\r\n  telefono VARCHAR(20),\r\n  rh VARCHAR(10) COMMENT 'Grupo sanguíneo',\r\n  \r\n  -- Referencias UNIDIRECCIONALES (sin circuitos)\r\n  id_rol INT NOT NULL,\r\n  id_ficha INT NULL COMMENT 'Solo para aprendices',\r\n  \r\n  -- Campos específicos por rol\r\n  cargo VARCHAR(100) NULL COMMENT 'Solo para instructores/administrativos',\r\n  tipo_contrato ENUM('planta', 'contrato', 'catedra') NULL COMMENT 'Solo para instructores',\r\n  \r\n  -- Datos del sistema\r\n  codigo_qr VARCHAR(255),\r\n  foto VARCHAR(500),\r\n  estado ENUM('ACTIVO', 'INACTIVO', 'SUSPENDIDO') DEFAULT 'ACTIVO',\r\n  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n  fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n  \r\n  -- Foreign Keys UNIDIRECCIONALES (sin ciclos)\r\n  FOREIGN KEY (id_rol) REFERENCES roles(id_rol) ON DELETE RESTRICT,\r\n  FOREIGN KEY (id_ficha) REFERENCES fichas(id_ficha) ON DELETE SET NULL,\r\n  \r\n  -- Índices\r\n  INDEX idx_documento (documento),\r\n  INDEX idx_tipo_doc (tipo_documento),\r\n  INDEX idx_rol (id_rol),\r\n  INDEX idx_ficha (id_ficha),\r\n  INDEX idx_estado (estado),\r\n  INDEX idx_email (email)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\nCOMMENT='Tabla personas - SIN redundancias ni circuitos cerrados';\r\n\r\n-- =====================================================\r\n-- TABLA: visitantes\r\n-- Información adicional SOLO para visitantes\r\n-- =====================================================\r\nCREATE TABLE visitantes (\r\n    id_visitante INT AUTO_INCREMENT PRIMARY KEY,\r\n    id_persona INT NOT NULL,\r\n    motivo_visita TEXT NOT NULL,\r\n    contacto VARCHAR(255),\r\n    persona_visita VARCHAR(255),\r\n    zona VARCHAR(200) COMMENT 'Destino dentro de las instalaciones',\r\n    fecha_inicio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    fecha_fin TIMESTAMP NULL,\r\n    estado ENUM('ACTIVO', 'FINALIZADO', 'EXPIRADO') DEFAULT 'ACTIVO',\r\n    FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\r\n    INDEX idx_persona (id_persona),\r\n    INDEX idx_estado (estado),\r\n    INDEX idx_fecha_inicio (fecha_inicio)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- TABLA: registros_entrada_salida\r\n-- CIRCUITO ABIERTO: Registros independientes\r\n-- =====================================================\r\nCREATE TABLE registros_entrada_salida (\r\n  id_registro INT AUTO_INCREMENT PRIMARY KEY,\r\n  id_persona INT NOT NULL,\r\n  tipo ENUM('ENTRADA', 'SALIDA') NOT NULL,\r\n  fecha_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n  id_usuario_registro INT NULL COMMENT 'Guarda que registró',\r\n  FOREIGN KEY (id_persona) REFERENCES personas(id_persona) ON DELETE CASCADE,\r\n  FOREIGN KEY (id_usuario_registro) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n  INDEX idx_persona (id_persona),\r\n  INDEX idx_tipo (tipo),\r\n  INDEX idx_fecha (fecha_hora),\r\n  INDEX idx_persona_fecha (id_persona, fecha_hora DESC)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\nCOMMENT='Registros independientes - Sin circuitos cerrados';\r\n\r\n-- =====================================================\r\n-- TABLA: logs_seguridad\r\n-- Solo para auditoría, sin conexión circular\r\n-- =====================================================\r\nCREATE TABLE logs_seguridad (\r\n    id_log INT AUTO_INCREMENT PRIMARY KEY,\r\n    tipo ENUM('login_exitoso', 'login_fallido', 'cambio_password', \r\n              'modificacion_usuario', 'acceso_sistema') NOT NULL,\r\n    id_usuario INT NULL,\r\n    ip_address VARCHAR(45),\r\n    user_agent TEXT,\r\n    accion TEXT NOT NULL,\r\n    detalles JSON,\r\n    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n    INDEX idx_tipo (tipo),\r\n    INDEX idx_usuario (id_usuario),\r\n    INDEX idx_fecha (fecha)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- TABLA: auditoria\r\n-- Tabla de auditoría general\r\n-- =====================================================\r\nCREATE TABLE auditoria (\r\n    id_auditoria INT AUTO_INCREMENT PRIMARY KEY,\r\n    tabla_afectada VARCHAR(100) NOT NULL,\r\n    id_registro INT,\r\n    accion ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,\r\n    datos_anteriores JSON,\r\n    datos_nuevos JSON,\r\n    id_usuario INT NULL,\r\n    ip_address VARCHAR(45),\r\n    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n    INDEX idx_tabla (tabla_afectada),\r\n    INDEX idx_accion (accion),\r\n    INDEX idx_fecha (fecha)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- TABLA: evidencia_fotografica\r\n-- Evidencias de incidentes\r\n-- =====================================================\r\nCREATE TABLE evidencia_fotografica (\r\n    id_evidencia INT AUTO_INCREMENT PRIMARY KEY,\r\n    tipo_incidente ENUM('acceso_denegado', 'comportamiento_sospechoso', \r\n                        'incidente_seguridad', 'evidencia_general') NOT NULL,\r\n    url_foto VARCHAR(500) NOT NULL,\r\n    hash_archivo VARCHAR(64),\r\n    fecha_captura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    id_usuario_captura INT NULL,\r\n    descripcion TEXT,\r\n    metadata JSON,\r\n    FOREIGN KEY (id_usuario_captura) REFERENCES usuarios(id_usuario) ON DELETE SET NULL,\r\n    INDEX idx_tipo (tipo_incidente),\r\n    INDEX idx_fecha (fecha_captura)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- VISTAS OPTIMIZADAS\r\n-- =====================================================\r\n\r\n-- Vista: Información completa de personas (eliminando redundancias)\r\nCREATE OR REPLACE VIEW v_personas_completo AS\r\nSELECT \r\n    p.id_persona,\r\n    p.tipo_documento,\r\n    p.documento,\r\n    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n    p.nombres,\r\n    p.apellidos,\r\n    p.email,\r\n    p.telefono,\r\n    p.rh,\r\n    r.nombre_rol,\r\n    r.descripcion as rol_descripcion,\r\n    p.id_ficha,\r\n    f.codigo_ficha,\r\n    prog.nombre_programa,\r\n    prog.codigo_programa,\r\n    f.jornada,\r\n    p.cargo,\r\n    p.tipo_contrato,\r\n    p.codigo_qr,\r\n    p.foto,\r\n    p.estado,\r\n    p.fecha_registro\r\nFROM personas p\r\nINNER JOIN roles r ON p.id_rol = r.id_rol\r\nLEFT JOIN fichas f ON p.id_ficha = f.id_ficha\r\nLEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa;\r\n\r\n-- Vista: Personas actualmente dentro\r\nCREATE OR REPLACE VIEW v_personas_dentro AS\r\nSELECT \r\n    p.id_persona,\r\n    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n    p.documento,\r\n    r.nombre_rol,\r\n    p.foto,\r\n    reg.fecha_hora as fecha_entrada,\r\n    TIMESTAMPDIFF(MINUTE, reg.fecha_hora, NOW()) as minutos_dentro,\r\n    f.codigo_ficha,\r\n    prog.nombre_programa,\r\n    v.zona,\r\n    v.motivo_visita,\r\n    v.persona_visita\r\nFROM personas p\r\nINNER JOIN roles r ON p.id_rol = r.id_rol\r\nINNER JOIN registros_entrada_salida reg ON p.id_persona = reg.id_persona\r\nLEFT JOIN fichas f ON p.id_ficha = f.id_ficha\r\nLEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\r\nLEFT JOIN visitantes v ON p.id_persona = v.id_persona AND v.estado = 'ACTIVO'\r\nWHERE reg.tipo = 'ENTRADA'\r\n  AND reg.fecha_hora = (\r\n    SELECT MAX(fecha_hora) \r\n    FROM registros_entrada_salida \r\n    WHERE id_persona = p.id_persona\r\n  )\r\n  AND NOT EXISTS (\r\n    SELECT 1 \r\n    FROM registros_entrada_salida r2 \r\n    WHERE r2.id_persona = p.id_persona \r\n      AND r2.tipo = 'SALIDA' \r\n      AND r2.fecha_hora > reg.fecha_hora\r\n  )\r\n  AND p.estado = 'ACTIVO';\r\n\r\n-- Vista: Historial de accesos\r\nCREATE OR REPLACE VIEW v_historial_accesos AS\r\nSELECT \r\n    reg.id_registro,\r\n    reg.id_persona,\r\n    CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n    p.documento,\r\n    r.nombre_rol,\r\n    reg.tipo,\r\n    reg.fecha_hora,\r\n    DATE(reg.fecha_hora) as fecha,\r\n    TIME(reg.fecha_hora) as hora,\r\n    f.codigo_ficha,\r\n    prog.nombre_programa,\r\n    u.nombre as registrado_por\r\nFROM registros_entrada_salida reg\r\nINNER JOIN personas p ON reg.id_persona = p.id_persona\r\nINNER JOIN roles r ON p.id_rol = r.id_rol\r\nLEFT JOIN fichas f ON p.id_ficha = f.id_ficha\r\nLEFT JOIN programas_formacion prog ON f.id_programa = prog.id_programa\r\nLEFT JOIN usuarios u ON reg.id_usuario_registro = u.id_usuario\r\nORDER BY reg.fecha_hora DESC;\r\n\r\n-- Vista: Estadísticas diarias\r\nCREATE OR REPLACE VIEW v_estadisticas_diarias AS\r\nSELECT \r\n    DATE(fecha_hora) as fecha,\r\n    COUNT(CASE WHEN tipo = 'ENTRADA' THEN 1 END) as total_entradas,\r\n    COUNT(CASE WHEN tipo = 'SALIDA' THEN 1 END) as total_salidas,\r\n    COUNT(DISTINCT id_persona) as personas_unicas\r\nFROM registros_entrada_salida\r\nGROUP BY DATE(fecha_hora)\r\nORDER BY fecha DESC;\r\n\r\n-- =====================================================\r\n-- PROCEDIMIENTOS ALMACENADOS\r\n-- =====================================================\r\n\r\nDELIMITER $$\r\n\r\n-- Registrar entrada\r\nCREATE PROCEDURE sp_registrar_entrada(\r\n    IN p_id_persona INT,\r\n    IN p_id_usuario INT\r\n)\r\nBEGIN\r\n    INSERT INTO registros_entrada_salida \r\n    (id_persona, tipo, fecha_hora, id_usuario_registro)\r\n    VALUES \r\n    (p_id_persona, 'ENTRADA', NOW(), p_id_usuario);\r\n    \r\n    SELECT LAST_INSERT_ID() as id_registro;\r\nEND$$\r\n\r\n-- Registrar salida\r\nCREATE PROCEDURE sp_registrar_salida(\r\n    IN p_id_persona INT,\r\n    IN p_id_usuario INT\r\n)\r\nBEGIN\r\n    INSERT INTO registros_entrada_salida \r\n    (id_persona, tipo, fecha_hora, id_usuario_registro)\r\n    VALUES \r\n    (p_id_persona, 'SALIDA', NOW(), p_id_usuario);\r\n    \r\n    SELECT LAST_INSERT_ID() as id_registro;\r\nEND$$\r\n\r\n-- Obtener personas dentro\r\nCREATE PROCEDURE sp_personas_dentro()\r\nBEGIN\r\n    SELECT * FROM v_personas_dentro\r\n    ORDER BY fecha_entrada DESC;\r\nEND$$\r\n\r\n-- Verificar última acción\r\nCREATE PROCEDURE sp_ultima_accion(IN p_id_persona INT)\r\nBEGIN\r\n    SELECT \r\n        tipo,\r\n        fecha_hora,\r\n        TIMESTAMPDIFF(MINUTE, fecha_hora, NOW()) as minutos_transcurridos\r\n    FROM registros_entrada_salida\r\n    WHERE id_persona = p_id_persona\r\n    ORDER BY fecha_hora DESC\r\n    LIMIT 1;\r\nEND$$\r\n\r\n-- Reporte de asistencia por ficha\r\nCREATE PROCEDURE sp_reporte_asistencia_ficha(\r\n    IN p_id_ficha INT,\r\n    IN p_fecha_inicio DATE,\r\n    IN p_fecha_fin DATE\r\n)\r\nBEGIN\r\n    SELECT \r\n        p.id_persona,\r\n        p.documento,\r\n        CONCAT(p.nombres, ' ', p.apellidos) as nombre_completo,\r\n        COUNT(DISTINCT DATE(reg.fecha_hora)) as dias_asistencia,\r\n        COUNT(CASE WHEN reg.tipo = 'ENTRADA' THEN 1 END) as total_entradas,\r\n        COUNT(CASE WHEN reg.tipo = 'SALIDA' THEN 1 END) as total_salidas\r\n    FROM personas p\r\n    LEFT JOIN registros_entrada_salida reg \r\n        ON p.id_persona = reg.id_persona\r\n        AND DATE(reg.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin\r\n    WHERE p.id_ficha = p_id_ficha\r\n      AND p.estado = 'ACTIVO'\r\n    GROUP BY p.id_persona, p.documento, p.nombres, p.apellidos\r\n    ORDER BY dias_asistencia DESC;\r\nEND$$\r\n\r\nDELIMITER ;\r\n\r\n-- =====================================================\r\n-- VERIFICACIÓN DE ESTRUCTURA\r\n-- =====================================================\r\nSELECT 'Base de datos creada exitosamente' as estado;\r\nSELECT 'Sin circuitos cerrados ✓' as verificacion_1;\r\nSELECT 'Sin redundancias ✓' as verificacion_2;\r\nSELECT 'Estructura normalizada ✓' as verificacion_3;\r\n\r\n-- =====================================================\r\n-- DOCUMENTACIÓN\r\n-- =====================================================\r\n/*\r\nCAMBIOS IMPLEMENTADOS PARA ELIMINAR CIRCUITOS CERRADOS Y REDUNDANCIAS:\r\n\r\n1. ELIMINADAS las siguientes columnas REDUNDANTES de 'personas':\r\n   ❌ programa VARCHAR(200)        - Ya existe id_ficha → fichas → programas_formacion\r\n   ❌ ficha VARCHAR(50)            - Ya existe id_ficha\r\n   ❌ nombre VARCHAR(200)          - Ya existe nombres + apellidos\r\n   ❌ rol VARCHAR(50)              - Ya existe id_rol → roles\r\n   ❌ id_rol_persona               - Duplicado con id_rol\r\n   ❌ id_estado_persona            - Ya existe estado ENUM\r\n   ❌ id_usuario                   - Creaba circuito cerrado\r\n   ❌ zona VARCHAR(200)            - Movido a tabla visitantes\r\n\r\n2. ESTRUCTURA SIN CIRCUITOS:\r\n   usuarios (tabla raíz)\r\n   ↓\r\n   roles (independiente)\r\n   ↓\r\n   programas_formacion (independiente)\r\n   ↓\r\n   fichas (solo referencia programas)\r\n   ↓\r\n   personas (solo referencia roles y fichas)\r\n   ↓\r\n   visitantes (solo referencia personas)\r\n   ↓\r\n   registros_entrada_salida (solo referencia personas y usuarios)\r\n\r\n3. FLUJO UNIDIRECCIONAL (sin ciclos):\r\n   - Todas las referencias van hacia \"abajo\"\r\n   - No hay foreign keys que vuelvan hacia \"arriba\"\r\n   - Cada tabla tiene máximo 2 foreign keys\r\n\r\n4. VENTAJAS:\r\n   ✓ Sin duplicación de datos\r\n   ✓ Fácil mantenimiento\r\n   ✓ Integridad referencial clara\r\n   ✓ Mejor rendimiento\r\n   ✓ Cumple normalización 3FN\r\n\r\nCONSULTAS PRINCIPALES:\r\n- Ver personas dentro: SELECT * FROM v_personas_dentro;\r\n- Información completa: SELECT * FROM v_personas_completo WHERE documento = '123456';\r\n- Historial: SELECT * FROM v_historial_accesos WHERE fecha = CURDATE();\r\n- Estadísticas: SELECT * FROM v_estadisticas_diarias WHERE fecha >= CURDATE() - INTERVAL 7 DAY;\r\n*/"
        }
    ]
}