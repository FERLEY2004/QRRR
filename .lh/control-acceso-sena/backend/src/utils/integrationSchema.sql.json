{
    "sourceFile": "control-acceso-sena/backend/src/utils/integrationSchema.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763535516475,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763535516474,
            "name": "Commit-0",
            "content": "-- =====================================================\r\n-- ESQUEMA DE INTEGRACIÓN QR + BD\r\n-- Sistema de Control de Acceso SENA\r\n-- =====================================================\r\n\r\nUSE control_acceso_sena;\r\n\r\n-- =====================================================\r\n-- TABLA: Fichas\r\n-- =====================================================\r\nCREATE TABLE IF NOT EXISTS Fichas (\r\n    id_ficha INT AUTO_INCREMENT PRIMARY KEY,\r\n    codigo_ficha VARCHAR(50) UNIQUE NOT NULL COMMENT 'Código único de la ficha (ej: 3066232)',\r\n    programa_formacion VARCHAR(200) NOT NULL COMMENT 'Nombre del programa de formación',\r\n    id_programa INT NULL COMMENT 'Referencia al programa de formación',\r\n    id_ambiente_principal INT NULL COMMENT 'Ambiente principal asignado a la ficha',\r\n    jornada ENUM('diurna', 'nocturna', 'mixta') DEFAULT 'diurna' COMMENT 'Jornada de formación',\r\n    fecha_inicio DATE NULL COMMENT 'Fecha de inicio de la ficha',\r\n    fecha_fin DATE NULL COMMENT 'Fecha de finalización de la ficha',\r\n    estado ENUM('activa', 'finalizada', 'cancelada') DEFAULT 'activa' COMMENT 'Estado actual de la ficha',\r\n    numero_aprendices INT DEFAULT 0 COMMENT 'Número de aprendices asignados',\r\n    capacidad_maxima INT NULL COMMENT 'Capacidad máxima de aprendices',\r\n    observaciones TEXT NULL COMMENT 'Observaciones adicionales',\r\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (id_programa) REFERENCES Programas_Formacion(id_programa) ON DELETE SET NULL,\r\n    FOREIGN KEY (id_ambiente_principal) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\r\n    INDEX idx_ficha_codigo (codigo_ficha),\r\n    INDEX idx_ficha_programa (id_programa),\r\n    INDEX idx_ficha_estado (estado),\r\n    INDEX idx_ficha_jornada (jornada),\r\n    INDEX idx_ficha_fechas (fecha_inicio, fecha_fin),\r\n    INDEX idx_ficha_ambiente (id_ambiente_principal)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\r\nCOMMENT='Tabla para gestionar las fichas de formación del SENA';\r\n\r\n-- =====================================================\r\n-- TABLA: Asignaciones_Ambientes\r\n-- =====================================================\r\nCREATE TABLE IF NOT EXISTS Asignaciones_Ambientes (\r\n    id_asignacion INT AUTO_INCREMENT PRIMARY KEY,\r\n    id_persona INT NOT NULL,\r\n    id_ambiente INT NOT NULL,\r\n    tipo_asignacion ENUM('aprendiz', 'instructor', 'administrativo') NOT NULL,\r\n    horario_asignado TEXT COMMENT 'JSON con horarios: {\"lunes\": \"8:00-12:00\", ...}',\r\n    fecha_asignacion DATE DEFAULT (CURDATE()),\r\n    fecha_fin_asignacion DATE NULL,\r\n    activa BOOLEAN DEFAULT TRUE,\r\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\r\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE CASCADE,\r\n    INDEX idx_asignacion_persona (id_persona),\r\n    INDEX idx_asignacion_ambiente (id_ambiente),\r\n    INDEX idx_asignacion_tipo (tipo_asignacion),\r\n    INDEX idx_asignacion_activa (activa)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- MODIFICAR TABLA: Personas\r\n-- Agregar campos adicionales si no existen\r\n-- =====================================================\r\nALTER TABLE Personas \r\nADD COLUMN IF NOT EXISTS rh VARCHAR(10) NULL AFTER telefono,\r\nADD COLUMN IF NOT EXISTS id_ficha INT NULL AFTER ficha,\r\nADD COLUMN IF NOT EXISTS jornada ENUM('diurna', 'nocturna', 'mixta') NULL AFTER id_ficha;\r\n\r\n-- Agregar foreign key para ficha si no existe\r\nCREATE INDEX IF NOT EXISTS idx_personas_ficha_id ON Personas(id_ficha);\r\n-- ALTER TABLE Personas ADD FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL;\r\n\r\n-- =====================================================\r\n-- TABLA: Historial_Asistencias\r\n-- =====================================================\r\nCREATE TABLE IF NOT EXISTS Historial_Asistencias (\r\n    id_registro INT AUTO_INCREMENT PRIMARY KEY,\r\n    id_persona INT NOT NULL,\r\n    id_ficha INT NULL,\r\n    id_ambiente INT NULL,\r\n    fecha DATE NOT NULL,\r\n    hora_entrada TIME,\r\n    hora_salida TIME,\r\n    tipo_acceso ENUM('entrada', 'salida') NOT NULL,\r\n    estado ENUM('presente', 'ausente', 'tardanza', 'salida_anticipada') DEFAULT 'presente',\r\n    observaciones TEXT,\r\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE CASCADE,\r\n    FOREIGN KEY (id_ficha) REFERENCES Fichas(id_ficha) ON DELETE SET NULL,\r\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\r\n    INDEX idx_historial_persona (id_persona),\r\n    INDEX idx_historial_ficha (id_ficha),\r\n    INDEX idx_historial_fecha (fecha),\r\n    INDEX idx_historial_ambiente (id_ambiente)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n-- =====================================================\r\n-- TABLA: Alertas_Sistema\r\n-- =====================================================\r\nCREATE TABLE IF NOT EXISTS Alertas_Sistema (\r\n    id_alerta INT AUTO_INCREMENT PRIMARY KEY,\r\n    tipo_alerta ENUM('capacidad', 'acceso_denegado', 'irregularidad', 'tardanza', 'ausencia') NOT NULL,\r\n    id_ambiente INT NULL,\r\n    id_persona INT NULL,\r\n    severidad ENUM('baja', 'media', 'alta', 'critica') DEFAULT 'media',\r\n    mensaje TEXT NOT NULL,\r\n    datos_adicionales JSON,\r\n    resuelta BOOLEAN DEFAULT FALSE,\r\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    fecha_resolucion TIMESTAMP NULL,\r\n    FOREIGN KEY (id_ambiente) REFERENCES Ambientes(id_ambiente) ON DELETE SET NULL,\r\n    FOREIGN KEY (id_persona) REFERENCES Personas(id_persona) ON DELETE SET NULL,\r\n    INDEX idx_alerta_tipo (tipo_alerta),\r\n    INDEX idx_alerta_resuelta (resuelta),\r\n    INDEX idx_alerta_fecha (fecha_creacion)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n\r\n"
        }
    ]
}