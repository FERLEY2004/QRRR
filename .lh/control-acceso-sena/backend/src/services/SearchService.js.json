{
    "sourceFile": "control-acceso-sena/backend/src/services/SearchService.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1764227753647,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764228105368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,15 +21,19 @@\n           p.telefono,\n           COALESCE(role.nombre_rol, 'sin rol') as nombre_rol,\n           p.estado,\n           p.fecha_registro,\n+          f.codigo_ficha as ficha,\n+          pf.nombre_programa as programa,\n           (\n             SELECT MAX(r.fecha_hora)\n             FROM registros_entrada_salida r\n             WHERE r.id_persona = p.id_persona\n           ) as ultimo_acceso\n         FROM Personas p\n         LEFT JOIN Roles role ON p.id_rol = role.id_rol\n+        LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+        LEFT JOIN programas_formacion pf ON f.id_programa = pf.id_programa\n         WHERE 1=1\n       `;\n \n       const params = [];\n@@ -57,9 +61,9 @@\n       }\n \n       if (filters.rol) {\n         query += ` AND role.nombre_rol = ?`;\n-        params.push(filters.rol);\n+        params.push(filters.rol.toUpperCase());\n       }\n \n       if (filters.estado) {\n         query += ` AND p.estado = ?`;\n@@ -71,22 +75,24 @@\n         params.push(`%${filters.email}%`);\n       }\n \n       if (filters.programa) {\n-        query += ` AND p.programa LIKE ?`;\n+        query += ` AND pf.nombre_programa LIKE ?`;\n         params.push(`%${filters.programa}%`);\n       }\n-\n+      \n       if (filters.ficha) {\n-        query += ` AND p.ficha LIKE ?`;\n+        query += ` AND f.codigo_ficha LIKE ?`;\n         params.push(`%${filters.ficha}%`);\n       }\n \n       // Contar total para paginación (crear consulta COUNT separada sin subconsultas)\n       let countQuery = `\n         SELECT COUNT(*) as total\n         FROM Personas p\n-        LEFT JOIN Roles r ON p.id_rol = r.id_rol\n+        LEFT JOIN Roles role ON p.id_rol = role.id_rol\n+        LEFT JOIN fichas f ON p.id_ficha = f.id_ficha\n+        LEFT JOIN programas_formacion pf ON f.id_programa = pf.id_programa\n         WHERE 1=1\n       `;\n       const countParams = [];\n       \n@@ -112,9 +118,9 @@\n       }\n       \n       if (filters.rol) {\n         countQuery += ` AND role.nombre_rol = ?`;\n-        countParams.push(filters.rol);\n+        countParams.push(filters.rol.toUpperCase());\n       }\n       \n       if (filters.estado) {\n         countQuery += ` AND p.estado = ?`;\n@@ -126,14 +132,14 @@\n         countParams.push(`%${filters.email}%`);\n       }\n       \n       if (filters.programa) {\n-        countQuery += ` AND p.programa LIKE ?`;\n+        countQuery += ` AND pf.nombre_programa LIKE ?`;\n         countParams.push(`%${filters.programa}%`);\n       }\n       \n       if (filters.ficha) {\n-        countQuery += ` AND p.ficha LIKE ?`;\n+        countQuery += ` AND f.codigo_ficha LIKE ?`;\n         countParams.push(`%${filters.ficha}%`);\n       }\n \n       const [countRows] = await pool.execute(countQuery, countParams);\n@@ -151,15 +157,17 @@\n         data: rows.map(row => ({\n           id_persona: row.id_persona,\n           documento: row.documento,\n           tipo_documento: row.tipo_documento,\n-          nombre_completo: row.nombre,\n+          nombre_completo: row.nombre_completo,\n           email: row.email,\n           telefono: row.telefono,\n-          rol: row.nombre_rol || row.rol,\n+          rol: row.nombre_rol,\n           estado: row.estado,\n           fecha_registro: row.fecha_registro,\n-          ultimo_acceso: row.ultimo_acceso\n+          ultimo_acceso: row.ultimo_acceso,\n+          ficha: row.ficha || null,\n+          programa: row.programa || null\n         })),\n         pagination: {\n           total: total,\n           page: page,\n"
                },
                {
                    "date": 1764232818303,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,7 @@\n // Search Service - Servicio de búsqueda avanzada\n import pool from '../utils/dbPool.js';\n+import { getRegistroIdField } from '../utils/columnResolver.js';\n \n export class SearchService {\n   /**\n    * HU26 - Búsqueda avanzada de usuarios\n@@ -15,9 +16,14 @@\n         SELECT \n           p.id_persona,\n           p.documento,\n           p.tipo_documento,\n-          COALESCE(CONCAT(p.nombres, ' ', p.apellidos), p.nombre) as nombre_completo,\n+          COALESCE(\n+            CONCAT(p.nombres, ' ', p.apellidos),\n+            p.nombres,\n+            p.apellidos,\n+            'Sin nombre'\n+          ) as nombre_completo,\n           p.email,\n           p.telefono,\n           COALESCE(role.nombre_rol, 'sin rol') as nombre_rol,\n           p.estado,\n@@ -36,14 +42,15 @@\n         WHERE 1=1\n       `;\n \n       const params = [];\n+      const fullNameExpr = \"CONCAT(p.nombres, ' ', p.apellidos)\";\n \n       // Búsqueda por texto (query general)\n       if (filters.query) {\n         query += ` AND (\n           p.documento LIKE ? OR\n-          p.nombre LIKE ? OR\n+          ${fullNameExpr} LIKE ? OR\n           p.email LIKE ?\n         )`;\n         const searchTerm = `%${filters.query}%`;\n         params.push(searchTerm, searchTerm, searchTerm);\n@@ -55,9 +62,9 @@\n         params.push(`%${filters.documento}%`);\n       }\n \n       if (filters.nombre) {\n-        query += ` AND p.nombre LIKE ?`;\n+        query += ` AND ${fullNameExpr} LIKE ?`;\n         params.push(`%${filters.nombre}%`);\n       }\n \n       if (filters.rol) {\n@@ -99,9 +106,9 @@\n       // Aplicar los mismos filtros al COUNT\n       if (filters.query) {\n         countQuery += ` AND (\n           p.documento LIKE ? OR\n-          p.nombre LIKE ? OR\n+          ${fullNameExpr} LIKE ? OR\n           p.email LIKE ?\n         )`;\n         const searchTerm = `%${filters.query}%`;\n         countParams.push(searchTerm, searchTerm, searchTerm);\n@@ -112,9 +119,9 @@\n         countParams.push(`%${filters.documento}%`);\n       }\n       \n       if (filters.nombre) {\n-        countQuery += ` AND p.nombre LIKE ?`;\n+        countQuery += ` AND ${fullNameExpr} LIKE ?`;\n         countParams.push(`%${filters.nombre}%`);\n       }\n       \n       if (filters.rol) {\n@@ -190,11 +197,13 @@\n       const page = pagination.page || 1;\n       const limit = pagination.limit || 50;\n       const offset = (page - 1) * limit;\n \n+      const idColumn = await getRegistroIdField();\n+\n       let query = `\n         SELECT \n-          r.id_registro_entrada_salida as id_acceso,\n+          r.${idColumn} as id_acceso,\n           p.documento,\n           p.tipo_documento,\n           COALESCE(CONCAT(p.nombres, ' ', p.apellidos), p.nombre) as nombre_completo,\n           COALESCE(role.nombre_rol, 'sin rol') as nombre_rol,\n@@ -218,19 +227,19 @@\n         params.push(filters.documento);\n       }\n \n       if (filters.fecha) {\n-        query += ` AND DATE(a.fecha_entrada) = ?`;\n+        query += ` AND DATE(r.fecha_hora) = ?`;\n         params.push(filters.fecha);\n       }\n \n       if (filters.fecha_desde) {\n-        query += ` AND DATE(a.fecha_entrada) >= ?`;\n+        query += ` AND DATE(r.fecha_hora) >= ?`;\n         params.push(filters.fecha_desde);\n       }\n \n       if (filters.fecha_hasta) {\n-        query += ` AND DATE(a.fecha_entrada) <= ?`;\n+        query += ` AND DATE(r.fecha_hora) <= ?`;\n         params.push(filters.fecha_hasta);\n       }\n \n       if (filters.rol) {\n@@ -238,9 +247,9 @@\n         params.push(filters.rol);\n       }\n \n       if (filters.tipo_acceso) {\n-        query += ` AND a.tipo_acceso = ?`;\n+        query += ` AND r.tipo = ?`;\n         params.push(filters.tipo_acceso);\n       }\n \n       // Contar total para paginación\n@@ -248,9 +257,9 @@\n       const [countRows] = await pool.execute(countQuery, params);\n       const total = countRows[0]?.total || 0;\n \n       // Agregar ordenamiento y paginación\n-      query += ` ORDER BY a.fecha_entrada DESC LIMIT ? OFFSET ?`;\n+      query += ` ORDER BY r.fecha_hora DESC LIMIT ? OFFSET ?`;\n       params.push(limit, offset);\n \n       const [rows] = await pool.execute(query, params);\n \n"
                },
                {
                    "date": 1764307159316,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -292,8 +292,171 @@\n     }\n   }\n \n   /**\n+   * Obtener personas junto a su ficha y programa sin tocar el esquema (vista normalizada)\n+   */\n+  static async getPeopleWithFicha(filters = {}, pagination = {}) {\n+    try {\n+      const page = pagination.page || 1;\n+      const limit = pagination.limit || 50;\n+      const offset = (page - 1) * limit;\n+\n+      let query = `\n+        SELECT\n+          id_persona,\n+          documento,\n+          tipo_documento,\n+          nombre_completo,\n+          nombres,\n+          apellidos,\n+          email,\n+          telefono,\n+          rh,\n+          nombre_rol,\n+          rol_descripcion,\n+          id_ficha,\n+          codigo_ficha,\n+          codigo_programa,\n+          nombre_programa,\n+          jornada,\n+          cargo,\n+          tipo_contrato,\n+          codigo_qr,\n+          foto,\n+          estado,\n+          fecha_registro\n+        FROM v_personas_completo\n+        WHERE 1=1\n+      `;\n+\n+      const params = [];\n+\n+      if (filters.documento) {\n+        query += ` AND documento LIKE ?`;\n+        params.push(`%${filters.documento}%`);\n+      }\n+\n+      if (filters.nombre) {\n+        query += ` AND (\n+          nombre_completo LIKE ? OR\n+          nombres LIKE ? OR\n+          apellidos LIKE ?\n+        )`;\n+        const searchTerm = `%${filters.nombre}%`;\n+        params.push(searchTerm, searchTerm, searchTerm);\n+      }\n+\n+      if (filters.rol) {\n+        query += ` AND nombre_rol = ?`;\n+        params.push(filters.rol.toUpperCase());\n+      }\n+\n+      if (filters.ficha) {\n+        query += ` AND codigo_ficha LIKE ?`;\n+        params.push(`%${filters.ficha}%`);\n+      }\n+\n+      if (filters.programa) {\n+        query += ` AND (\n+          nombre_programa LIKE ? OR\n+          codigo_programa LIKE ?\n+        )`;\n+        const searchTerm = `%${filters.programa}%`;\n+        params.push(searchTerm, searchTerm);\n+      }\n+\n+      let countQuery = `\n+        SELECT COUNT(*) as total\n+        FROM v_personas_completo\n+        WHERE 1=1\n+      `;\n+      const countParams = [];\n+\n+      if (filters.documento) {\n+        countQuery += ` AND documento LIKE ?`;\n+        countParams.push(`%${filters.documento}%`);\n+      }\n+\n+      if (filters.nombre) {\n+        countQuery += ` AND (\n+          nombre_completo LIKE ? OR\n+          nombres LIKE ? OR\n+          apellidos LIKE ?\n+        )`;\n+        const searchTerm = `%${filters.nombre}%`;\n+        countParams.push(searchTerm, searchTerm, searchTerm);\n+      }\n+\n+      if (filters.rol) {\n+        countQuery += ` AND nombre_rol = ?`;\n+        countParams.push(filters.rol.toUpperCase());\n+      }\n+\n+      if (filters.ficha) {\n+        countQuery += ` AND codigo_ficha LIKE ?`;\n+        countParams.push(`%${filters.ficha}%`);\n+      }\n+\n+      if (filters.programa) {\n+        countQuery += ` AND (\n+          nombre_programa LIKE ? OR\n+          codigo_programa LIKE ?\n+        )`;\n+        const searchTerm = `%${filters.programa}%`;\n+        countParams.push(searchTerm, searchTerm);\n+      }\n+\n+      const [countRows] = await pool.execute(countQuery, countParams);\n+      const total = countRows[0]?.total || 0;\n+\n+      const safeLimit = Math.max(1, Math.min(parseInt(limit) || 50, 1000));\n+      const safeOffset = Math.max(0, parseInt(offset) || 0);\n+      query += ` ORDER BY fecha_registro DESC LIMIT ${safeLimit} OFFSET ${safeOffset}`;\n+\n+      const [rows] = await pool.execute(query, params);\n+\n+      return {\n+        success: true,\n+        data: rows.map(row => ({\n+          id_persona: row.id_persona,\n+          documento: row.documento,\n+          tipo_documento: row.tipo_documento,\n+          nombre_completo: row.nombre_completo,\n+          nombres: row.nombres,\n+          apellidos: row.apellidos,\n+          email: row.email,\n+          telefono: row.telefono,\n+          rh: row.rh,\n+          rol: row.nombre_rol,\n+          rol_descripcion: row.rol_descripcion,\n+          id_ficha: row.id_ficha,\n+          ficha_persona: row.codigo_ficha,\n+          programa_formacion_persona: row.codigo_programa,\n+          nombre_programa: row.nombre_programa,\n+          jornada: row.jornada,\n+          cargo: row.cargo,\n+          tipo_contrato: row.tipo_contrato,\n+          codigo_qr: row.codigo_qr,\n+          foto: row.foto,\n+          estado: row.estado,\n+          fecha_registro: row.fecha_registro\n+        })),\n+        pagination: {\n+          total,\n+          page,\n+          limit,\n+          totalPages: Math.ceil(total / limit)\n+        },\n+        filters\n+      };\n+    } catch (error) {\n+      console.error('Error en getPeopleWithFicha:', error);\n+      throw error;\n+    }\n+  }\n+\n+  /**\n    * HU33 - Búsqueda de visitantes\n    */\n   static async searchVisitors(filters = {}, pagination = {}) {\n     try {\n"
                }
            ],
            "date": 1764227753647,
            "name": "Commit-0",
            "content": "// Search Service - Servicio de búsqueda avanzada\nimport pool from '../utils/dbPool.js';\n\nexport class SearchService {\n  /**\n   * HU26 - Búsqueda avanzada de usuarios\n   */\n  static async searchUsers(filters = {}, pagination = {}) {\n    try {\n      const page = pagination.page || 1;\n      const limit = pagination.limit || 50;\n      const offset = (page - 1) * limit;\n\n      let query = `\n        SELECT \n          p.id_persona,\n          p.documento,\n          p.tipo_documento,\n          COALESCE(CONCAT(p.nombres, ' ', p.apellidos), p.nombre) as nombre_completo,\n          p.email,\n          p.telefono,\n          COALESCE(role.nombre_rol, 'sin rol') as nombre_rol,\n          p.estado,\n          p.fecha_registro,\n          (\n            SELECT MAX(r.fecha_hora)\n            FROM registros_entrada_salida r\n            WHERE r.id_persona = p.id_persona\n          ) as ultimo_acceso\n        FROM Personas p\n        LEFT JOIN Roles role ON p.id_rol = role.id_rol\n        WHERE 1=1\n      `;\n\n      const params = [];\n\n      // Búsqueda por texto (query general)\n      if (filters.query) {\n        query += ` AND (\n          p.documento LIKE ? OR\n          p.nombre LIKE ? OR\n          p.email LIKE ?\n        )`;\n        const searchTerm = `%${filters.query}%`;\n        params.push(searchTerm, searchTerm, searchTerm);\n      }\n\n      // Filtros específicos\n      if (filters.documento) {\n        query += ` AND p.documento LIKE ?`;\n        params.push(`%${filters.documento}%`);\n      }\n\n      if (filters.nombre) {\n        query += ` AND p.nombre LIKE ?`;\n        params.push(`%${filters.nombre}%`);\n      }\n\n      if (filters.rol) {\n        query += ` AND role.nombre_rol = ?`;\n        params.push(filters.rol);\n      }\n\n      if (filters.estado) {\n        query += ` AND p.estado = ?`;\n        params.push(filters.estado);\n      }\n\n      if (filters.email) {\n        query += ` AND p.email LIKE ?`;\n        params.push(`%${filters.email}%`);\n      }\n\n      if (filters.programa) {\n        query += ` AND p.programa LIKE ?`;\n        params.push(`%${filters.programa}%`);\n      }\n\n      if (filters.ficha) {\n        query += ` AND p.ficha LIKE ?`;\n        params.push(`%${filters.ficha}%`);\n      }\n\n      // Contar total para paginación (crear consulta COUNT separada sin subconsultas)\n      let countQuery = `\n        SELECT COUNT(*) as total\n        FROM Personas p\n        LEFT JOIN Roles r ON p.id_rol = r.id_rol\n        WHERE 1=1\n      `;\n      const countParams = [];\n      \n      // Aplicar los mismos filtros al COUNT\n      if (filters.query) {\n        countQuery += ` AND (\n          p.documento LIKE ? OR\n          p.nombre LIKE ? OR\n          p.email LIKE ?\n        )`;\n        const searchTerm = `%${filters.query}%`;\n        countParams.push(searchTerm, searchTerm, searchTerm);\n      }\n      \n      if (filters.documento) {\n        countQuery += ` AND p.documento LIKE ?`;\n        countParams.push(`%${filters.documento}%`);\n      }\n      \n      if (filters.nombre) {\n        countQuery += ` AND p.nombre LIKE ?`;\n        countParams.push(`%${filters.nombre}%`);\n      }\n      \n      if (filters.rol) {\n        countQuery += ` AND role.nombre_rol = ?`;\n        countParams.push(filters.rol);\n      }\n      \n      if (filters.estado) {\n        countQuery += ` AND p.estado = ?`;\n        countParams.push(filters.estado);\n      }\n      \n      if (filters.email) {\n        countQuery += ` AND p.email LIKE ?`;\n        countParams.push(`%${filters.email}%`);\n      }\n      \n      if (filters.programa) {\n        countQuery += ` AND p.programa LIKE ?`;\n        countParams.push(`%${filters.programa}%`);\n      }\n      \n      if (filters.ficha) {\n        countQuery += ` AND p.ficha LIKE ?`;\n        countParams.push(`%${filters.ficha}%`);\n      }\n\n      const [countRows] = await pool.execute(countQuery, countParams);\n      const total = countRows[0]?.total || 0;\n\n      // Agregar ordenamiento y paginación (usar interpolación segura ya que limit y offset están validados)\n      const safeLimit = Math.max(1, Math.min(parseInt(limit) || 50, 1000));\n      const safeOffset = Math.max(0, parseInt(offset) || 0);\n      query += ` ORDER BY p.fecha_registro DESC LIMIT ${safeLimit} OFFSET ${safeOffset}`;\n\n      const [rows] = await pool.execute(query, params);\n\n      return {\n        success: true,\n        data: rows.map(row => ({\n          id_persona: row.id_persona,\n          documento: row.documento,\n          tipo_documento: row.tipo_documento,\n          nombre_completo: row.nombre,\n          email: row.email,\n          telefono: row.telefono,\n          rol: row.nombre_rol || row.rol,\n          estado: row.estado,\n          fecha_registro: row.fecha_registro,\n          ultimo_acceso: row.ultimo_acceso\n        })),\n        pagination: {\n          total: total,\n          page: page,\n          limit: limit,\n          totalPages: Math.ceil(total / limit)\n        },\n        filters: filters\n      };\n    } catch (error) {\n      console.error('Error en searchUsers:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * HU12 - Búsqueda de accesos por documento y fecha\n   */\n  static async searchAccess(filters = {}, pagination = {}) {\n    try {\n      const page = pagination.page || 1;\n      const limit = pagination.limit || 50;\n      const offset = (page - 1) * limit;\n\n      let query = `\n        SELECT \n          r.id_registro_entrada_salida as id_acceso,\n          p.documento,\n          p.tipo_documento,\n          COALESCE(CONCAT(p.nombres, ' ', p.apellidos), p.nombre) as nombre_completo,\n          COALESCE(role.nombre_rol, 'sin rol') as nombre_rol,\n          r.tipo as tipo_acceso,\n          r.fecha_hora as fecha_entrada,\n          NULL as fecha_salida,\n          TIMESTAMPDIFF(MINUTE, r.fecha_hora, NOW()) as duracion_minutos,\n          CASE WHEN r.tipo = 'ENTRADA' THEN 'activo' ELSE 'finalizado' END as estado,\n          u.nombre as registrado_por\n        FROM registros_entrada_salida r\n        INNER JOIN Personas p ON r.id_persona = p.id_persona\n        LEFT JOIN Roles role ON p.id_rol = role.id_rol\n        LEFT JOIN Usuarios u ON r.id_usuario_registro = u.id_usuario\n        WHERE 1=1\n      `;\n\n      const params = [];\n\n      if (filters.documento) {\n        query += ` AND p.documento = ?`;\n        params.push(filters.documento);\n      }\n\n      if (filters.fecha) {\n        query += ` AND DATE(a.fecha_entrada) = ?`;\n        params.push(filters.fecha);\n      }\n\n      if (filters.fecha_desde) {\n        query += ` AND DATE(a.fecha_entrada) >= ?`;\n        params.push(filters.fecha_desde);\n      }\n\n      if (filters.fecha_hasta) {\n        query += ` AND DATE(a.fecha_entrada) <= ?`;\n        params.push(filters.fecha_hasta);\n      }\n\n      if (filters.rol) {\n        query += ` AND role.nombre_rol = ?`;\n        params.push(filters.rol);\n      }\n\n      if (filters.tipo_acceso) {\n        query += ` AND a.tipo_acceso = ?`;\n        params.push(filters.tipo_acceso);\n      }\n\n      // Contar total para paginación\n      const countQuery = `SELECT COUNT(*) as total FROM (${query}) as count_query`;\n      const [countRows] = await pool.execute(countQuery, params);\n      const total = countRows[0]?.total || 0;\n\n      // Agregar ordenamiento y paginación\n      query += ` ORDER BY a.fecha_entrada DESC LIMIT ? OFFSET ?`;\n      params.push(limit, offset);\n\n      const [rows] = await pool.execute(query, params);\n\n      return {\n        success: true,\n        data: rows.map(row => ({\n          id_acceso: row.id_acceso,\n          documento: row.documento,\n          tipo_documento: row.tipo_documento,\n          nombre_completo: row.nombre_completo,\n          rol: row.nombre_rol || row.rol,\n          tipo_acceso: row.tipo_acceso,\n          fecha_entrada: row.fecha_entrada,\n          fecha_salida: row.fecha_salida,\n          duracion_minutos: row.duracion_minutos,\n          estado: row.estado,\n          registrado_por: row.registrado_por\n        })),\n        pagination: {\n          total: total,\n          page: page,\n          limit: limit,\n          totalPages: Math.ceil(total / limit)\n        },\n        filters: filters\n      };\n    } catch (error) {\n      console.error('Error en searchAccess:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * HU33 - Búsqueda de visitantes\n   */\n  static async searchVisitors(filters = {}, pagination = {}) {\n    try {\n      const page = pagination.page || 1;\n      const limit = pagination.limit || 50;\n      const offset = (page - 1) * limit;\n\n      let query = `\n        SELECT \n          v.id_visitante,\n          p.documento,\n          p.tipo_documento,\n          p.nombre as nombre_completo,\n          v.motivo_visita,\n          v.contacto,\n          v.persona_visita,\n          v.fecha_inicio,\n          v.fecha_fin,\n          v.estado,\n          CASE \n            WHEN v.fecha_fin IS NULL AND v.estado = 'activo' THEN 'Dentro'\n            WHEN v.estado = 'finalizado' THEN 'Finalizado'\n            WHEN v.estado = 'expirado' THEN 'Expirado'\n            ELSE 'Inactivo'\n          END as estado_visita\n        FROM Visitantes v\n        INNER JOIN Personas p ON v.id_persona = p.id_persona\n        WHERE 1=1\n      `;\n\n      const params = [];\n\n      if (filters.empresa) {\n        query += ` AND v.contacto LIKE ?`;\n        params.push(`%${filters.empresa}%`);\n      }\n\n      if (filters.estado) {\n        query += ` AND v.estado = ?`;\n        params.push(filters.estado);\n      }\n\n      if (filters.fecha_desde) {\n        query += ` AND DATE(v.fecha_inicio) >= ?`;\n        params.push(filters.fecha_desde);\n      }\n\n      if (filters.fecha_hasta) {\n        query += ` AND DATE(v.fecha_inicio) <= ?`;\n        params.push(filters.fecha_hasta);\n      }\n\n      if (filters.documento) {\n        query += ` AND p.documento LIKE ?`;\n        params.push(`%${filters.documento}%`);\n      }\n\n      if (filters.nombre) {\n        query += ` AND p.nombre LIKE ?`;\n        params.push(`%${filters.nombre}%`);\n      }\n\n      // Contar total para paginación\n      const countQuery = `SELECT COUNT(*) as total FROM (${query}) as count_query`;\n      const [countRows] = await pool.execute(countQuery, params);\n      const total = countRows[0]?.total || 0;\n\n      // Agregar ordenamiento y paginación\n      query += ` ORDER BY v.fecha_inicio DESC LIMIT ? OFFSET ?`;\n      params.push(limit, offset);\n\n      const [rows] = await pool.execute(query, params);\n\n      return {\n        success: true,\n        data: rows.map(row => ({\n          id_visitante: row.id_visitante,\n          documento: row.documento,\n          tipo_documento: row.tipo_documento,\n          nombre_completo: row.nombre_completo,\n          motivo_visita: row.motivo_visita,\n          contacto: row.contacto,\n          persona_visita: row.persona_visita,\n          fecha_inicio: row.fecha_inicio,\n          fecha_fin: row.fecha_fin,\n          estado: row.estado,\n          estado_visita: row.estado_visita\n        })),\n        pagination: {\n          total: total,\n          page: page,\n          limit: limit,\n          totalPages: Math.ceil(total / limit)\n        },\n        filters: filters\n      };\n    } catch (error) {\n      console.error('Error en searchVisitors:', error);\n      throw error;\n    }\n  }\n}\n\n\n\n\n"
        }
    ]
}