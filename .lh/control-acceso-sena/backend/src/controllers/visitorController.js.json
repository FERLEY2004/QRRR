{
    "sourceFile": "control-acceso-sena/backend/src/controllers/visitorController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1764228933445,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764230575632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,11 +15,16 @@\n         message: 'Nombre, documento y motivo de visita son requeridos'\n       });\n     }\n \n+    const nombreCompleto = nombre.trim();\n+    const nameParts = nombreCompleto.split(' ').filter(Boolean);\n+    const nombresValue = nameParts.length > 1 ? nameParts.slice(0, -1).join(' ') : nombreCompleto;\n+    const apellidosValue = nameParts.length > 1 ? nameParts.slice(-1).join(' ') : 'Visitante';\n+\n     // Verificar si la persona ya existe\n     const [existingPerson] = await pool.execute(\n-      'SELECT id_persona FROM Personas WHERE documento = ? AND tipo_documento = ?',\n+      'SELECT id_persona FROM personas WHERE documento = ? AND tipo_documento = ?',\n       [documento, tipo_documento || 'CC']\n     );\n \n     let personId;\n@@ -27,33 +32,33 @@\n     if (existingPerson.length > 0) {\n       personId = existingPerson[0].id_persona;\n       // Actualizar estado\n       await pool.execute(\n-        `UPDATE Personas SET estado = 'activo' WHERE id_persona = ?`,\n-        [personId]\n+        `UPDATE personas SET estado = 'ACTIVO', nombres = ?, apellidos = ? WHERE id_persona = ?`,\n+        [nombresValue || 'Visitante', apellidosValue, personId]\n       );\n     } else {\n       // Crear nuevo registro de visitante en la tabla Personas\n       const [result] = await pool.execute(\n-        `INSERT INTO Personas (nombre, documento, tipo_documento, estado, fecha_registro)\n-         VALUES (?, ?, ?, 'activo', NOW())`,\n-        [nombre, documento, tipo_documento || 'CC']\n+        `INSERT INTO personas (nombres, apellidos, documento, tipo_documento, estado, fecha_registro)\n+         VALUES (?, ?, ?, ?, 'ACTIVO', NOW())`,\n+        [nombresValue || 'Visitante', apellidosValue, documento, tipo_documento || 'CC']\n       );\n       personId = result.insertId;\n     }\n \n     // Crear registro en tabla Visitantes\n     const [visitorResult] = await pool.execute(\n-      `INSERT INTO Visitantes (id_persona, motivo_visita, contacto, persona_visita, estado, fecha_inicio)\n-       VALUES (?, ?, ?, ?, 'activo', NOW())`,\n+      `INSERT INTO visitantes (id_persona, motivo_visita, contacto, persona_visita, estado, fecha_inicio)\n+       VALUES (?, ?, ?, ?, 'ACTIVO', NOW())`,\n       [personId, motivo_visita, contacto || null, persona_visita || null]\n     );\n \n     const visitorId = visitorResult.insertId;\n \n     // Obtener el rol ID de visitante\n     const [rolRows] = await pool.execute(\n-      \"SELECT id_rol FROM Roles WHERE nombre_rol = 'visitante' LIMIT 1\"\n+      \"SELECT id_rol FROM roles WHERE nombre_rol = 'VISITANTE' LIMIT 1\"\n     );\n     const visitanteRolId = rolRows.length > 0 ? rolRows[0].id_rol : null;\n \n     // Actualizar id_rol en Personas si existe el rol\n@@ -130,11 +135,11 @@\n   try {\n     const { estado, search } = req.query;\n     \n     let query = `SELECT p.*, COALESCE(role.nombre_rol, 'sin rol') as nombre_rol\n-                 FROM Personas p\n-                 LEFT JOIN Roles role ON p.id_rol = role.id_rol\n-                 WHERE role.nombre_rol = 'visitante'`;\n+                 FROM personas p\n+                 LEFT JOIN roles role ON p.id_rol = role.id_rol\n+                 WHERE role.nombre_rol = 'VISITANTE'`;\n     \n     const params = [];\n \n     if (estado) {\n@@ -142,9 +147,9 @@\n       params.push(estado);\n     }\n \n     if (search) {\n-      query += ' AND (p.nombre LIKE ? OR p.documento LIKE ?)';\n+      query += ' AND (CONCAT(p.nombres, \\' \\', p.apellidos) LIKE ? OR p.documento LIKE ?)';\n       params.push(`%${search}%`, `%${search}%`);\n     }\n \n     query += ' ORDER BY p.fecha_registro DESC LIMIT 100';\n@@ -170,9 +175,9 @@\n     const { id } = req.params;\n     const userId = req.user.id;\n \n     const [rows] = await pool.execute(\n-      'SELECT * FROM Personas WHERE id_persona = ?',\n+      'SELECT * FROM personas WHERE id_persona = ?',\n       [id]\n     );\n \n     if (rows.length === 0) {\n@@ -182,14 +187,15 @@\n       });\n     }\n \n     const visitor = rows[0];\n+    const nombreCompleto = `${visitor.nombres || ''} ${visitor.apellidos || ''}`.trim() || 'Visitante';\n \n     const qrData = {\n       type: 'visitor',\n       id: visitor.id_persona,\n       documento: visitor.documento,\n-      nombre: visitor.nombre,\n+      nombre: nombreCompleto,\n       rol: 'visitante',\n       timestamp: new Date().toISOString()\n     };\n \n"
                },
                {
                    "date": 1764231279628,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,11 +17,22 @@\n     }\n \n     const nombreCompleto = nombre.trim();\n     const nameParts = nombreCompleto.split(' ').filter(Boolean);\n-    const nombresValue = nameParts.length > 1 ? nameParts.slice(0, -1).join(' ') : nombreCompleto;\n+    const nombresValue = nameParts.length > 1 ? nameParts.slice(0, -1).join(' ') : nombreCompleto || 'Visitante';\n     const apellidosValue = nameParts.length > 1 ? nameParts.slice(-1).join(' ') : 'Visitante';\n \n+    const [rolRows] = await pool.execute(\n+      \"SELECT id_rol FROM roles WHERE nombre_rol = 'VISITANTE' LIMIT 1\"\n+    );\n+    const visitanteRolId = rolRows.length > 0 ? rolRows[0].id_rol : null;\n+    if (!visitanteRolId) {\n+      return res.status(500).json({\n+        success: false,\n+        message: 'No se encontró el rol de visitante en la base de datos'\n+      });\n+    }\n+\n     // Verificar si la persona ya existe\n     const [existingPerson] = await pool.execute(\n       'SELECT id_persona FROM personas WHERE documento = ? AND tipo_documento = ?',\n       [documento, tipo_documento || 'CC']\n@@ -32,17 +43,17 @@\n     if (existingPerson.length > 0) {\n       personId = existingPerson[0].id_persona;\n       // Actualizar estado\n       await pool.execute(\n-        `UPDATE personas SET estado = 'ACTIVO', nombres = ?, apellidos = ? WHERE id_persona = ?`,\n-        [nombresValue || 'Visitante', apellidosValue, personId]\n+        `UPDATE personas SET estado = 'ACTIVO', nombres = ?, apellidos = ?, id_rol = ? WHERE id_persona = ?`,\n+        [nombresValue, apellidosValue, visitanteRolId, personId]\n       );\n     } else {\n       // Crear nuevo registro de visitante en la tabla Personas\n       const [result] = await pool.execute(\n-        `INSERT INTO personas (nombres, apellidos, documento, tipo_documento, estado, fecha_registro)\n-         VALUES (?, ?, ?, ?, 'ACTIVO', NOW())`,\n-        [nombresValue || 'Visitante', apellidosValue, documento, tipo_documento || 'CC']\n+        `INSERT INTO personas (nombres, apellidos, documento, tipo_documento, id_rol, estado, fecha_registro)\n+         VALUES (?, ?, ?, ?, ?, 'ACTIVO', NOW())`,\n+        [nombresValue, apellidosValue, documento, tipo_documento || 'CC', visitanteRolId]\n       );\n       personId = result.insertId;\n     }\n \n@@ -54,22 +65,8 @@\n     );\n \n     const visitorId = visitorResult.insertId;\n \n-    // Obtener el rol ID de visitante\n-    const [rolRows] = await pool.execute(\n-      \"SELECT id_rol FROM roles WHERE nombre_rol = 'VISITANTE' LIMIT 1\"\n-    );\n-    const visitanteRolId = rolRows.length > 0 ? rolRows[0].id_rol : null;\n-\n-    // Actualizar id_rol en Personas si existe el rol\n-    if (visitanteRolId) {\n-      await pool.execute(\n-        'UPDATE Personas SET id_rol = ? WHERE id_persona = ?',\n-        [visitanteRolId, personId]\n-      );\n-    }\n-\n     // Generar QR temporal (válido por 24 horas)\n     const qrData = {\n       type: 'visitor',\n       id: personId,\n"
                }
            ],
            "date": 1764228933445,
            "name": "Commit-0",
            "content": "// Visitor Controller\nimport pool from '../utils/dbPool.js';\nimport { generateQRCode } from '../utils/qrGenerator.js';\nimport Access from '../models/Access.js';\nimport Person from '../models/Person.js';\n\nexport const createVisitor = async (req, res) => {\n  try {\n    const { nombre, documento, tipo_documento, motivo_visita, contacto, persona_visita } = req.body;\n    const userId = req.user.id;\n\n    if (!nombre || !documento || !motivo_visita) {\n      return res.status(400).json({\n        success: false,\n        message: 'Nombre, documento y motivo de visita son requeridos'\n      });\n    }\n\n    // Verificar si la persona ya existe\n    const [existingPerson] = await pool.execute(\n      'SELECT id_persona FROM Personas WHERE documento = ? AND tipo_documento = ?',\n      [documento, tipo_documento || 'CC']\n    );\n\n    let personId;\n    \n    if (existingPerson.length > 0) {\n      personId = existingPerson[0].id_persona;\n      // Actualizar estado\n      await pool.execute(\n        `UPDATE Personas SET estado = 'activo' WHERE id_persona = ?`,\n        [personId]\n      );\n    } else {\n      // Crear nuevo registro de visitante en la tabla Personas\n      const [result] = await pool.execute(\n        `INSERT INTO Personas (nombre, documento, tipo_documento, estado, fecha_registro)\n         VALUES (?, ?, ?, 'activo', NOW())`,\n        [nombre, documento, tipo_documento || 'CC']\n      );\n      personId = result.insertId;\n    }\n\n    // Crear registro en tabla Visitantes\n    const [visitorResult] = await pool.execute(\n      `INSERT INTO Visitantes (id_persona, motivo_visita, contacto, persona_visita, estado, fecha_inicio)\n       VALUES (?, ?, ?, ?, 'activo', NOW())`,\n      [personId, motivo_visita, contacto || null, persona_visita || null]\n    );\n\n    const visitorId = visitorResult.insertId;\n\n    // Obtener el rol ID de visitante\n    const [rolRows] = await pool.execute(\n      \"SELECT id_rol FROM Roles WHERE nombre_rol = 'visitante' LIMIT 1\"\n    );\n    const visitanteRolId = rolRows.length > 0 ? rolRows[0].id_rol : null;\n\n    // Actualizar id_rol en Personas si existe el rol\n    if (visitanteRolId) {\n      await pool.execute(\n        'UPDATE Personas SET id_rol = ? WHERE id_persona = ?',\n        [visitanteRolId, personId]\n      );\n    }\n\n    // Generar QR temporal (válido por 24 horas)\n    const qrData = {\n      type: 'visitor',\n      id: personId,\n      documento,\n      nombre,\n      rol: 'visitante',\n      timestamp: new Date().toISOString()\n    };\n\n    const qrCode = await generateQRCode(JSON.stringify(qrData));\n\n    // Registrar entrada automática del visitante al generar el QR\n    // Solo si no está ya dentro del centro\n    const isInside = await Person.isInside(personId);\n    if (!isInside) {\n      try {\n        await Access.registerEntry(personId, userId);\n        console.log(`✅ Entrada automática registrada para visitante ${documento} (${nombre})`);\n      } catch (error) {\n        console.error('Error al registrar entrada automática del visitante:', error);\n        // No fallar la creación del visitante si hay error al registrar entrada\n      }\n    }\n\n    res.status(201).json({\n      success: true,\n      message: 'Visitante registrado exitosamente',\n      visitor: {\n        id: personId,\n        visitor_id: visitorId,\n        nombre,\n        documento,\n        tipo_documento: tipo_documento || 'CC',\n        motivo_visita,\n        contacto,\n        persona_visita\n      },\n      qrCode,\n      qrData,\n      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),\n      entradaRegistrada: !isInside\n    });\n  } catch (error) {\n    console.error('Error en createVisitor:', error);\n    \n    // Manejar error de documento duplicado\n    if (error.code === 'ER_DUP_ENTRY') {\n      return res.status(409).json({\n        success: false,\n        message: 'Ya existe una persona con este documento'\n      });\n    }\n\n    res.status(500).json({\n      success: false,\n      message: 'Error al registrar visitante',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\nexport const getVisitors = async (req, res) => {\n  try {\n    const { estado, search } = req.query;\n    \n    let query = `SELECT p.*, COALESCE(role.nombre_rol, 'sin rol') as nombre_rol\n                 FROM Personas p\n                 LEFT JOIN Roles role ON p.id_rol = role.id_rol\n                 WHERE role.nombre_rol = 'visitante'`;\n    \n    const params = [];\n\n    if (estado) {\n      query += ' AND p.estado = ?';\n      params.push(estado);\n    }\n\n    if (search) {\n      query += ' AND (p.nombre LIKE ? OR p.documento LIKE ?)';\n      params.push(`%${search}%`, `%${search}%`);\n    }\n\n    query += ' ORDER BY p.fecha_registro DESC LIMIT 100';\n\n    const [rows] = await pool.execute(query, params);\n\n    res.json({\n      success: true,\n      count: rows.length,\n      visitors: rows\n    });\n  } catch (error) {\n    console.error('Error en getVisitors:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener visitantes'\n    });\n  }\n};\n\nexport const generateVisitorQR = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const userId = req.user.id;\n\n    const [rows] = await pool.execute(\n      'SELECT * FROM Personas WHERE id_persona = ?',\n      [id]\n    );\n\n    if (rows.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'Visitante no encontrado'\n      });\n    }\n\n    const visitor = rows[0];\n\n    const qrData = {\n      type: 'visitor',\n      id: visitor.id_persona,\n      documento: visitor.documento,\n      nombre: visitor.nombre,\n      rol: 'visitante',\n      timestamp: new Date().toISOString()\n    };\n\n    const qrCode = await generateQRCode(JSON.stringify(qrData));\n\n    // Registrar entrada automática si el visitante no está dentro\n    const isInside = await Person.isInside(visitor.id_persona);\n    let entradaRegistrada = false;\n    if (!isInside) {\n      try {\n        await Access.registerEntry(visitor.id_persona, userId);\n        entradaRegistrada = true;\n        console.log(`✅ Entrada automática registrada para visitante ${visitor.documento} al regenerar QR`);\n      } catch (error) {\n        console.error('Error al registrar entrada automática del visitante:', error);\n      }\n    }\n\n    res.json({\n      success: true,\n      qrCode,\n      qrData,\n      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),\n      entradaRegistrada,\n      yaDentro: isInside\n    });\n  } catch (error) {\n    console.error('Error en generateVisitorQR:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al generar QR'\n    });\n  }\n};\n"
        }
    ]
}