{
    "sourceFile": "control-acceso-sena/backend/src/controllers/diagnosticController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764232818031,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764232818030,
            "name": "Commit-0",
            "content": "// Diagnostic Controller - Para diagnosticar estructura de tablas\r\nimport pool from '../utils/dbPool.js';\r\nimport { getRegistroIdField } from '../utils/columnResolver.js';\r\n\r\n/**\r\n * Diagnosticar estructura de tablas de accesos\r\n */\r\nexport const diagnoseTables = async (req, res) => {\r\n  try {\r\n    console.log('üîç [DIAGN√ìSTICO] Iniciando diagn√≥stico de estructura de tablas...');\r\n    \r\n    const diagnostics = {\r\n      timestamp: new Date().toISOString(),\r\n      tables: {},\r\n      errors: []\r\n    };\r\n\r\n    // 1. Verificar tabla Accesos\r\n    try {\r\n      console.log('üìã Verificando tabla Accesos...');\r\n      const [accesosStructure] = await pool.execute(`\r\n        SELECT \r\n          COLUMN_NAME,\r\n          DATA_TYPE,\r\n          IS_NULLABLE,\r\n          COLUMN_DEFAULT,\r\n          COLUMN_KEY\r\n        FROM INFORMATION_SCHEMA.COLUMNS\r\n        WHERE TABLE_SCHEMA = DATABASE()\r\n          AND TABLE_NAME = 'Accesos'\r\n        ORDER BY ORDINAL_POSITION\r\n      `);\r\n      \r\n      const [accesosCount] = await pool.execute('SELECT COUNT(*) as total FROM Accesos');\r\n      const [accesosSample] = await pool.execute('SELECT * FROM Accesos LIMIT 3');\r\n      \r\n      diagnostics.tables.Accesos = {\r\n        exists: true,\r\n        structure: accesosStructure,\r\n        total_records: accesosCount[0]?.total || 0,\r\n        sample_records: accesosSample,\r\n        columns: accesosStructure.map(col => col.COLUMN_NAME)\r\n      };\r\n      \r\n      console.log(`‚úÖ Tabla Accesos encontrada: ${accesosCount[0]?.total || 0} registros`);\r\n      console.log(`üìã Columnas: ${diagnostics.tables.Accesos.columns.join(', ')}`);\r\n    } catch (error) {\r\n      console.error('‚ùå Error verificando tabla Accesos:', error.message);\r\n      diagnostics.tables.Accesos = {\r\n        exists: false,\r\n        error: error.message\r\n      };\r\n      diagnostics.errors.push({ table: 'Accesos', error: error.message });\r\n    }\r\n\r\n    // 2. Verificar tabla registros_entrada_salida\r\n    try {\r\n      console.log('üìã Verificando tabla registros_entrada_salida...');\r\n      const [registrosStructure] = await pool.execute(`\r\n        SELECT \r\n          COLUMN_NAME,\r\n          DATA_TYPE,\r\n          IS_NULLABLE,\r\n          COLUMN_DEFAULT,\r\n          COLUMN_KEY\r\n        FROM INFORMATION_SCHEMA.COLUMNS\r\n        WHERE TABLE_SCHEMA = DATABASE()\r\n          AND TABLE_NAME = 'registros_entrada_salida'\r\n        ORDER BY ORDINAL_POSITION\r\n      `);\r\n      \r\n      const [registrosCount] = await pool.execute('SELECT COUNT(*) as total FROM registros_entrada_salida');\r\n      const [registrosSample] = await pool.execute('SELECT * FROM registros_entrada_salida LIMIT 3');\r\n      \r\n      diagnostics.tables.registros_entrada_salida = {\r\n        exists: true,\r\n        structure: registrosStructure,\r\n        total_records: registrosCount[0]?.total || 0,\r\n        sample_records: registrosSample,\r\n        columns: registrosStructure.map(col => col.COLUMN_NAME)\r\n      };\r\n      \r\n      console.log(`‚úÖ Tabla registros_entrada_salida encontrada: ${registrosCount[0]?.total || 0} registros`);\r\n      console.log(`üìã Columnas: ${diagnostics.tables.registros_entrada_salida.columns.join(', ')}`);\r\n    } catch (error) {\r\n      console.error('‚ùå Error verificando tabla registros_entrada_salida:', error.message);\r\n      diagnostics.tables.registros_entrada_salida = {\r\n        exists: false,\r\n        error: error.message\r\n      };\r\n      diagnostics.errors.push({ table: 'registros_entrada_salida', error: error.message });\r\n    }\r\n\r\n    // 3. Verificar tabla Personas\r\n    try {\r\n      console.log('üìã Verificando tabla Personas...');\r\n      const [personasStructure] = await pool.execute(`\r\n        SELECT \r\n          COLUMN_NAME,\r\n          DATA_TYPE,\r\n          IS_NULLABLE,\r\n          COLUMN_DEFAULT,\r\n          COLUMN_KEY\r\n        FROM INFORMATION_SCHEMA.COLUMNS\r\n        WHERE TABLE_SCHEMA = DATABASE()\r\n          AND TABLE_NAME = 'Personas'\r\n        ORDER BY ORDINAL_POSITION\r\n      `);\r\n      \r\n      const [personasCount] = await pool.execute('SELECT COUNT(*) as total FROM Personas');\r\n      \r\n      diagnostics.tables.Personas = {\r\n        exists: true,\r\n        structure: personasStructure,\r\n        total_records: personasCount[0]?.total || 0,\r\n        columns: personasStructure.map(col => col.COLUMN_NAME)\r\n      };\r\n      \r\n      console.log(`‚úÖ Tabla Personas encontrada: ${personasCount[0]?.total || 0} registros`);\r\n    } catch (error) {\r\n      console.error('‚ùå Error verificando tabla Personas:', error.message);\r\n      diagnostics.tables.Personas = {\r\n        exists: false,\r\n        error: error.message\r\n      };\r\n      diagnostics.errors.push({ table: 'Personas', error: error.message });\r\n    }\r\n\r\n    // 4. Verificar relaciones entre tablas\r\n    try {\r\n      console.log('üìã Verificando relaciones entre tablas...');\r\n      \r\n      // Verificar registros en Accesos sin Persona\r\n      if (diagnostics.tables.Accesos?.exists) {\r\n        const [orphanAccesos] = await pool.execute(`\r\n          SELECT COUNT(*) as total\r\n          FROM Accesos a\r\n          LEFT JOIN Personas p ON a.id_persona = p.id_persona\r\n          WHERE p.id_persona IS NULL\r\n        `);\r\n        diagnostics.tables.Accesos.orphan_records = orphanAccesos[0]?.total || 0;\r\n        console.log(`‚ö†Ô∏è  Registros en Accesos sin Persona: ${diagnostics.tables.Accesos.orphan_records}`);\r\n      }\r\n\r\n      // Verificar registros en registros_entrada_salida sin Persona\r\n      if (diagnostics.tables.registros_entrada_salida?.exists) {\r\n        const [orphanRegistros] = await pool.execute(`\r\n          SELECT COUNT(*) as total\r\n          FROM registros_entrada_salida r\r\n          LEFT JOIN Personas p ON r.id_persona = p.id_persona\r\n          WHERE p.id_persona IS NULL\r\n        `);\r\n        diagnostics.tables.registros_entrada_salida.orphan_records = orphanRegistros[0]?.total || 0;\r\n        console.log(`‚ö†Ô∏è  Registros en registros_entrada_salida sin Persona: ${diagnostics.tables.registros_entrada_salida.orphan_records}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error verificando relaciones:', error.message);\r\n      diagnostics.errors.push({ operation: 'check_relations', error: error.message });\r\n    }\r\n\r\n    // 5. Probar consultas de ejemplo\r\n    try {\r\n      console.log('üìã Probando consultas de ejemplo...');\r\n      \r\n      if (diagnostics.tables.Accesos?.exists && diagnostics.tables.Accesos.total_records > 0) {\r\n        const [testQuery] = await pool.execute(`\r\n          SELECT \r\n            a.id_acceso,\r\n            a.tipo_acceso,\r\n            a.fecha_entrada,\r\n            a.id_persona,\r\n            p.documento,\r\n            p.nombres,\r\n            p.apellidos\r\n          FROM Accesos a\r\n          LEFT JOIN Personas p ON a.id_persona = p.id_persona\r\n          LIMIT 3\r\n        `);\r\n        diagnostics.tables.Accesos.test_query_result = testQuery;\r\n        console.log(`‚úÖ Consulta de prueba Accesos: ${testQuery.length} registros`);\r\n      }\r\n\r\n      if (diagnostics.tables.registros_entrada_salida?.exists && diagnostics.tables.registros_entrada_salida.total_records > 0) {\r\n        const idColumn = await getRegistroIdField();\r\n        const [testQuery] = await pool.execute(`\r\n          SELECT \r\n            r.${idColumn} as id_registro_acceso,\r\n            r.tipo,\r\n            r.fecha_hora,\r\n            r.id_persona,\r\n            p.documento,\r\n            p.nombres,\r\n            p.apellidos\r\n          FROM registros_entrada_salida r\r\n          LEFT JOIN Personas p ON r.id_persona = p.id_persona\r\n          LIMIT 3\r\n        `);\r\n        diagnostics.tables.registros_entrada_salida.test_query_result = testQuery;\r\n        console.log(`‚úÖ Consulta de prueba registros_entrada_salida: ${testQuery.length} registros`);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error en consultas de prueba:', error.message);\r\n      diagnostics.errors.push({ operation: 'test_queries', error: error.message });\r\n    }\r\n\r\n    console.log('‚úÖ Diagn√≥stico completado');\r\n    \r\n    res.json({\r\n      success: true,\r\n      diagnostics,\r\n      summary: {\r\n        accesos_total: diagnostics.tables.Accesos?.total_records || 0,\r\n        registros_total: diagnostics.tables.registros_entrada_salida?.total_records || 0,\r\n        personas_total: diagnostics.tables.Personas?.total_records || 0,\r\n        errors_count: diagnostics.errors.length\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('‚ùå Error en diagn√≥stico:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error.message,\r\n      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined\r\n    });\r\n  }\r\n};\r\n\r\n"
        }
    ]
}