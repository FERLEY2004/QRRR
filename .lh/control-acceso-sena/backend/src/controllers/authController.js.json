{
    "sourceFile": "control-acceso-sena/backend/src/controllers/authController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764960830814,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764960830814,
            "name": "Commit-0",
            "content": "// Auth Controller\nimport User from '../models/User.js';\nimport { generateToken } from '../config/jwt.js';\nimport LogService from '../services/LogService.js';\n\nexport const login = async (req, res) => {\n  try {\n    const { email, password } = req.body;\n\n    console.log('üì• Datos recibidos:', { \n      email: email ? `${email.substring(0, 10)}...` : 'undefined',\n      passwordLength: password ? password.length : 0,\n      bodyKeys: Object.keys(req.body)\n    });\n\n    if (!email || !password) {\n      console.log('‚ùå Faltan campos requeridos:', { email: !!email, password: !!password });\n      return res.status(400).json({\n        success: false,\n        message: 'Email y contrase√±a son requeridos'\n      });\n    }\n\n    console.log(`üîê Intento de login: ${email}`);\n\n    // Buscar usuario por email\n    let user;\n    try {\n      user = await User.findByEmail(email);\n    } catch (error) {\n      console.error('‚ùå Error al buscar usuario:', error.message);\n      console.error('‚ùå Error code:', error.code);\n      console.error('‚ùå Error stack:', error.stack);\n      \n      // Si la tabla no existe, dar mensaje espec√≠fico\n      if (error.code === 'ER_NO_SUCH_TABLE' || error.message.includes('no existe')) {\n        return res.status(500).json({\n          success: false,\n          message: 'Base de datos no inicializada. Ejecuta el script de inicializaci√≥n.',\n          error: process.env.NODE_ENV === 'development' ? error.message : undefined\n        });\n      }\n      \n      // Si hay error de datos incompletos\n      if (error.message.includes('incompletos')) {\n        return res.status(500).json({\n          success: false,\n          message: 'Usuario con datos incompletos. Ejecuta el script checkUsers.js para corregirlo.',\n          error: process.env.NODE_ENV === 'development' ? error.message : undefined\n        });\n      }\n      \n      throw error;\n    }\n\n    if (!user) {\n      console.log(`‚ùå Usuario no encontrado: ${email}`);\n      console.log(`üí° Sugerencia: Ejecuta el script checkUsers.js para crear usuarios por defecto`);\n      \n      // Registrar intento fallido\n      await LogService.loginFallido(email, 'Usuario no encontrado', req);\n      \n      return res.status(401).json({\n        success: false,\n        message: 'Credenciales inv√°lidas',\n        hint: process.env.NODE_ENV === 'development' ? 'Usuario no encontrado en la base de datos' : undefined\n      });\n    }\n\n    console.log(`‚úÖ Usuario encontrado: ${user.email}, Estado: ${user.estado}`);\n    console.log(`   ID: ${user.id_usuario}, Rol: ${user.rol}`);\n    console.log(`   Password hash existe: ${!!user.password_hash}`);\n    console.log(`   Password hash length: ${user.password_hash ? user.password_hash.length : 0}`);\n\n    // Verificar que tenga password_hash\n    if (!user.password_hash || user.password_hash.length < 20) {\n      console.error(`‚ùå Usuario sin password_hash v√°lido: ${email}`);\n      console.error(`üí° Ejecuta el script checkUsers.js para corregir este problema`);\n      return res.status(500).json({\n        success: false,\n        message: 'Error en datos del usuario. Ejecuta el script checkUsers.js para corregirlo.',\n        error: process.env.NODE_ENV === 'development' ? 'Password hash inv√°lido o faltante' : undefined\n      });\n    }\n\n    // Verificar contrase√±a\n    console.log(`üîê Verificando contrase√±a...`);\n    const isValidPassword = await User.verifyPassword(password, user.password_hash);\n\n    console.log(`üîê Resultado de verificaci√≥n de contrase√±a: ${isValidPassword}`);\n\n    if (!isValidPassword) {\n      console.log(`‚ùå Contrase√±a incorrecta para: ${email}`);\n      console.log(`üí° Usuario existe pero la contrase√±a no coincide`);\n      \n      // Registrar intento fallido\n      await LogService.loginFallido(email, 'Contrase√±a incorrecta', req);\n      \n      return res.status(401).json({\n        success: false,\n        message: 'Credenciales inv√°lidas',\n        hint: process.env.NODE_ENV === 'development' ? 'La contrase√±a proporcionada no coincide con el hash almacenado' : undefined\n      });\n    }\n\n    // Verificar que el usuario est√© activo (acepta 'ACTIVO' o 'activo')\n    if (user.estado && user.estado.toUpperCase() !== 'ACTIVO') {\n      console.log(`‚ö†Ô∏è  Usuario inactivo: ${email}, Estado: ${user.estado}`);\n      \n      // Registrar intento fallido\n      await LogService.loginFallido(email, 'Usuario inactivo', req);\n      \n      return res.status(403).json({\n        success: false,\n        message: 'Usuario inactivo. Contacte al administrador'\n      });\n    }\n\n    // Normalizar rol a may√∫sculas para consistencia\n    let normalizedRol = user.rol ? user.rol.toUpperCase() : 'GUARDA';\n    // Mapear roles antiguos a nuevos si es necesario\n    if (normalizedRol === 'ADMIN') {\n      normalizedRol = 'ADMINISTRADOR';\n    }\n\n    // Generar token\n    let token;\n    try {\n      token = generateToken({\n        id: user.id_usuario,\n        email: user.email,\n        rol: normalizedRol,\n        nombre: user.nombre\n      });\n    } catch (error) {\n      console.error('‚ùå Error al generar token:', error);\n      throw new Error('Error al generar token de autenticaci√≥n');\n    }\n\n    // Retornar datos del usuario (sin password)\n    const userData = {\n      id: user.id_usuario,\n      nombre: user.nombre,\n      email: user.email,\n      rol: normalizedRol,\n      estado: user.estado\n    };\n\n    console.log(`‚úÖ Login exitoso: ${email} (${user.rol})`);\n\n    // Registrar login exitoso\n    await LogService.loginExitoso(user.id_usuario, email, req);\n\n    res.json({\n      success: true,\n      message: 'Login exitoso',\n      user: userData,\n      token\n    });\n  } catch (error) {\n    console.error('‚ùå Error en login:', error);\n    console.error('Stack:', error.stack);\n    console.error('Error completo:', JSON.stringify(error, null, 2));\n    \n    res.status(500).json({\n      success: false,\n      message: 'Error interno del servidor',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      details: process.env.NODE_ENV === 'development' ? error.stack : undefined\n    });\n  }\n};\n\nexport const verify = async (req, res) => {\n  try {\n    // El middleware authenticate ya valid√≥ el token\n    const user = await User.findByEmail(req.user.email);\n    \n    if (!user || (user.estado && user.estado.toUpperCase() !== 'ACTIVO')) {\n      return res.status(401).json({\n        success: false,\n        message: 'Usuario no v√°lido'\n      });\n    }\n\n    const userData = {\n      id: user.id_usuario,\n      nombre: user.nombre,\n      email: user.email,\n      rol: user.rol,\n      estado: user.estado\n    };\n\n    res.json({\n      success: true,\n      user: userData\n    });\n  } catch (error) {\n    console.error('Error en verify:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error interno del servidor'\n    });\n  }\n};\n\n// Solicitar recuperaci√≥n de contrase√±a\nexport const requestPasswordReset = async (req, res) => {\n  try {\n    const { email } = req.body;\n\n    if (!email) {\n      return res.status(400).json({\n        success: false,\n        message: 'El email es requerido'\n      });\n    }\n\n    console.log(`üîë Solicitud de recuperaci√≥n de contrase√±a para: ${email}`);\n\n    // Verificar si el usuario existe\n    const user = await User.findByEmail(email);\n    \n    if (!user) {\n      // Por seguridad, no revelamos si el email existe o no\n      console.log(`‚ö†Ô∏è Usuario no encontrado: ${email}`);\n      return res.json({\n        success: true,\n        message: 'Si el email est√° registrado, se ha enviado la solicitud de recuperaci√≥n'\n      });\n    }\n\n    // Generar token de recuperaci√≥n\n    const resetToken = User.generateResetToken();\n    const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hora\n\n    // Guardar token en la base de datos\n    await User.saveResetToken(email, resetToken, expiresAt);\n\n    console.log(`‚úÖ Token de recuperaci√≥n generado para: ${email}`);\n    console.log(`üîê Token expira: ${expiresAt.toLocaleString('es-CO')}`);\n\n    // Registrar en logs\n    await LogService.logSeguridad(\n      'cambio_password',\n      user.id_usuario,\n      `Solicitud de recuperaci√≥n de contrase√±a para ${email}`,\n      { email, accion: 'solicitud_recuperacion' },\n      req\n    );\n\n    // En un sistema con email, aqu√≠ se enviar√≠a el correo\n    // Por ahora, el admin puede ver las solicitudes pendientes\n    res.json({\n      success: true,\n      message: 'Solicitud de recuperaci√≥n registrada. Contacte al administrador para completar el proceso.',\n      // Solo mostrar el token en desarrollo\n      ...(process.env.NODE_ENV === 'development' && { \n        dev_token: resetToken,\n        dev_expires: expiresAt \n      })\n    });\n  } catch (error) {\n    console.error('‚ùå Error en requestPasswordReset:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al procesar la solicitud'\n    });\n  }\n};\n\n// Restablecer contrase√±a con token\nexport const resetPassword = async (req, res) => {\n  try {\n    const { token, newPassword } = req.body;\n\n    if (!token || !newPassword) {\n      return res.status(400).json({\n        success: false,\n        message: 'Token y nueva contrase√±a son requeridos'\n      });\n    }\n\n    if (newPassword.length < 6) {\n      return res.status(400).json({\n        success: false,\n        message: 'La contrase√±a debe tener al menos 6 caracteres'\n      });\n    }\n\n    // Buscar usuario por token\n    const user = await User.findByResetToken(token);\n    \n    if (!user) {\n      return res.status(400).json({\n        success: false,\n        message: 'Token inv√°lido o expirado'\n      });\n    }\n\n    // Actualizar contrase√±a\n    const updated = await User.updatePassword(user.id_usuario, newPassword);\n    \n    if (!updated) {\n      return res.status(500).json({\n        success: false,\n        message: 'Error al actualizar la contrase√±a'\n      });\n    }\n\n    console.log(`‚úÖ Contrase√±a restablecida para: ${user.email}`);\n\n    // Registrar en logs\n    await LogService.cambioPassword(user.id_usuario, user.email, 'usuario', req);\n\n    res.json({\n      success: true,\n      message: 'Contrase√±a actualizada exitosamente. Ya puede iniciar sesi√≥n.'\n    });\n  } catch (error) {\n    console.error('‚ùå Error en resetPassword:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al restablecer la contrase√±a'\n    });\n  }\n};\n\n// Ver solicitudes pendientes de recuperaci√≥n (solo admin)\nexport const getPendingResets = async (req, res) => {\n  try {\n    const requests = await User.getPendingResetRequests();\n    \n    res.json({\n      success: true,\n      data: requests.map(r => ({\n        id: r.id_usuario,\n        nombre: r.nombre,\n        email: r.email,\n        expira: r.reset_token_expires\n      }))\n    });\n  } catch (error) {\n    console.error('‚ùå Error en getPendingResets:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener solicitudes pendientes'\n    });\n  }\n};\n\n// Restablecer contrase√±a por admin (sin token)\nexport const adminResetPassword = async (req, res) => {\n  try {\n    const { email, newPassword } = req.body;\n\n    if (!email || !newPassword) {\n      return res.status(400).json({\n        success: false,\n        message: 'Email y nueva contrase√±a son requeridos'\n      });\n    }\n\n    if (newPassword.length < 6) {\n      return res.status(400).json({\n        success: false,\n        message: 'La contrase√±a debe tener al menos 6 caracteres'\n      });\n    }\n\n    // Verificar que el usuario existe\n    const user = await User.findByEmail(email);\n    \n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'Usuario no encontrado'\n      });\n    }\n\n    // Actualizar contrase√±a\n    const updated = await User.updatePasswordByEmail(email, newPassword);\n    \n    if (!updated) {\n      return res.status(500).json({\n        success: false,\n        message: 'Error al actualizar la contrase√±a'\n      });\n    }\n\n    console.log(`‚úÖ Contrase√±a restablecida por admin para: ${email}`);\n\n    // Registrar en logs\n    await LogService.logSeguridad(\n      'cambio_password',\n      user.id_usuario,\n      `Contrase√±a restablecida por administrador para ${email}`,\n      { email, admin_id: req.user.id, accion: 'reset_admin' },\n      req\n    );\n\n    res.json({\n      success: true,\n      message: `Contrase√±a actualizada exitosamente para ${user.nombre}`\n    });\n  } catch (error) {\n    console.error('‚ùå Error en adminResetPassword:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al restablecer la contrase√±a'\n    });\n  }\n};\n"
        }
    ]
}