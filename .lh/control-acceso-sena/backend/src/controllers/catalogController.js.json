{
    "sourceFile": "control-acceso-sena/backend/src/controllers/catalogController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764319581657,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764319581657,
            "name": "Commit-0",
            "content": "// Catalog Controller - Controlador de catálogo\nimport { CatalogService } from '../services/CatalogService.js';\nimport { createSecurityLog } from './auditController.js';\n\n/**\n * Obtener todos los programas\n */\nexport const getAllPrograms = async (req, res) => {\n  try {\n    const filters = {\n      nivel: req.query.nivel,\n      area: req.query.area,\n      estado: req.query.estado,\n      search: req.query.search\n    };\n\n    const result = await CatalogService.getAllPrograms(filters);\n\n    // Intentar crear log de seguridad, pero no fallar si hay error\n    try {\n      await createSecurityLog({\n        tipo: 'operacion_admin',\n        id_usuario: req.user?.id,\n        ip_address: req.ip,\n        user_agent: req.get('user-agent'),\n        accion: 'Consulta de catálogo de programas',\n        detalles: { filters },\n        exito: true\n      });\n    } catch (logError) {\n      console.warn('Error creando log de seguridad (no crítico):', logError.message);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAllPrograms:', error);\n    console.error('Stack:', error.stack);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener programas',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      details: process.env.NODE_ENV === 'development' ? {\n        code: error.code,\n        sqlState: error.sqlState,\n        errno: error.errno\n      } : undefined\n    });\n  }\n};\n\n/**\n * Crear un nuevo programa de formación\n */\nexport const createProgram = async (req, res) => {\n  try {\n    const payload = {\n      codigo_programa: typeof req.body.codigo_programa === 'string'\n        ? req.body.codigo_programa.trim().toUpperCase()\n        : null,\n      nombre_programa: req.body.nombre_programa,\n      nivel: req.body.nivel,\n      area_conocimiento: req.body.area_conocimiento,\n      duracion_meses: req.body.duracion_meses,\n      descripcion: req.body.descripcion,\n      estado: req.body.estado || 'activo'\n    };\n\n    const result = await CatalogService.createProgram(payload);\n\n    if (!result.success) {\n      return res.status(400).json(result);\n    }\n\n    try {\n      await createSecurityLog({\n        tipo: 'operacion_admin',\n        id_usuario: req.user?.id,\n        ip_address: req.ip,\n        user_agent: req.get('user-agent'),\n        accion: 'Creación manual de programa de formación',\n        detalles: { payload, programId: result.data.id_programa },\n        exito: true\n      });\n    } catch (logError) {\n      console.warn('Error creando log de seguridad (no crítico):', logError.message);\n    }\n\n    res.status(201).json(result);\n  } catch (error) {\n    console.error('Error en createProgram:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al crear programa',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener programa por código\n */\nexport const getProgramByCode = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const result = await CatalogService.getProgramByCode(codigo);\n\n    if (!result.success) {\n      return res.status(404).json(result);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getProgramByCode:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener programa',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener todas las fichas\n */\nexport const getAllFichas = async (req, res) => {\n  try {\n    const filters = {\n      estado: req.query.estado,\n      jornada: req.query.jornada,\n      programa: req.query.programa,\n      search: req.query.search\n    };\n\n    const result = await CatalogService.getAllFichas(filters);\n\n    // Intentar crear log de seguridad, pero no fallar si hay error\n    try {\n      await createSecurityLog({\n        tipo: 'operacion_admin',\n        id_usuario: req.user?.id,\n        ip_address: req.ip,\n        user_agent: req.get('user-agent'),\n        accion: 'Consulta de catálogo de fichas',\n        detalles: { filters },\n        exito: true\n      });\n    } catch (logError) {\n      console.warn('Error creando log de seguridad (no crítico):', logError.message);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAllFichas:', error);\n    console.error('Stack:', error.stack);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener fichas',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      details: process.env.NODE_ENV === 'development' ? {\n        code: error.code,\n        sqlState: error.sqlState,\n        errno: error.errno\n      } : undefined\n    });\n  }\n};\n\n/**\n * Obtener ficha por código\n */\nexport const getFichaByCode = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const result = await CatalogService.getFichaByCode(codigo);\n\n    if (!result.success) {\n      return res.status(404).json(result);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getFichaByCode:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener ficha',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener aprendices por ficha\n */\nexport const getStudentsByFicha = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const filters = {\n      estado: req.query.estado\n    };\n\n    const result = await CatalogService.getStudentsByFicha(codigo, filters);\n\n    await createSecurityLog({\n      tipo: 'operacion_admin',\n      id_usuario: req.user.id,\n      ip_address: req.ip,\n      user_agent: req.get('user-agent'),\n      accion: `Consulta de aprendices por ficha: ${codigo}`,\n      detalles: { codigo, filters },\n      exito: true\n    });\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getStudentsByFicha:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener aprendices por ficha',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener todos los ambientes\n */\nexport const getAllAmbientes = async (req, res) => {\n  try {\n    const filters = {\n      tipo: req.query.tipo,\n      bloque: req.query.bloque,\n      estado: req.query.estado,\n      search: req.query.search\n    };\n\n    const result = await CatalogService.getAllAmbientes(filters);\n\n    await createSecurityLog({\n      tipo: 'operacion_admin',\n      id_usuario: req.user.id,\n      ip_address: req.ip,\n      user_agent: req.get('user-agent'),\n      accion: 'Consulta de catálogo de ambientes',\n      detalles: { filters },\n      exito: true\n    });\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAllAmbientes:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener ambientes',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener ambiente por código\n */\nexport const getAmbienteByCode = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const result = await CatalogService.getAmbienteByCode(codigo);\n\n    if (!result.success) {\n      return res.status(404).json(result);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAmbienteByCode:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener ambiente',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener ambientes por tipo\n */\nexport const getAmbientesByType = async (req, res) => {\n  try {\n    const { tipo } = req.params;\n    const result = await CatalogService.getAmbientesByType(tipo);\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAmbientesByType:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener ambientes por tipo',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener aprendices por programa\n */\nexport const getStudentsByProgram = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const filters = {\n      estado: req.query.estado,\n      ficha: req.query.ficha\n    };\n\n    const result = await CatalogService.getStudentsByProgram(codigo, filters);\n\n    await createSecurityLog({\n      tipo: 'operacion_admin',\n      id_usuario: req.user.id,\n      ip_address: req.ip,\n      user_agent: req.get('user-agent'),\n      accion: `Consulta de aprendices por programa: ${codigo}`,\n      detalles: { codigo, filters },\n      exito: true\n    });\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getStudentsByProgram:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener aprendices por programa',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener ocupación de ambiente\n */\nexport const getAmbientOccupation = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const result = await CatalogService.getAmbientOccupation(codigo);\n\n    if (!result.success) {\n      return res.status(404).json(result);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAmbientOccupation:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener ocupación del ambiente',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener accesos por programa\n */\nexport const getAccessByProgram = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const filters = {\n      fecha_desde: req.query.fecha_desde,\n      fecha_hasta: req.query.fecha_hasta\n    };\n\n    const result = await CatalogService.getAccessByProgram(codigo, filters);\n\n    await createSecurityLog({\n      tipo: 'generacion_reporte',\n      id_usuario: req.user.id,\n      ip_address: req.ip,\n      user_agent: req.get('user-agent'),\n      accion: `Reporte de accesos por programa: ${codigo}`,\n      detalles: { codigo, filters },\n      exito: true\n    });\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAccessByProgram:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener accesos por programa',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\nexport const createFicha = async (req, res) => {\n  try {\n    const payload = {\n      codigo_ficha: req.body.codigo_ficha,\n      codigo_programa: req.body.codigo_programa,\n      jornada: req.body.jornada,\n      fecha_inicio: req.body.fecha_inicio,\n      fecha_fin: req.body.fecha_fin,\n      estado: req.body.estado,\n      numero_aprendices: req.body.numero_aprendices,\n      capacidad_maxima: req.body.capacidad_maxima\n    };\n\n    const result = await CatalogService.createFicha(payload);\n\n    if (!result.success) {\n      return res.status(400).json(result);\n    }\n\n    try {\n      await createSecurityLog({\n        tipo: 'operacion_admin',\n        id_usuario: req.user?.id,\n        ip_address: req.ip,\n        user_agent: req.get('user-agent'),\n        accion: 'Creación manual de ficha',\n        detalles: { payload, fichaId: result.data.id_ficha },\n        exito: true\n      });\n    } catch (logError) {\n      console.warn('Error creando log de seguridad (no crítico):', logError.message);\n    }\n\n    res.status(201).json(result);\n  } catch (error) {\n    console.error('Error en createFicha:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al crear ficha',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n/**\n * Obtener accesos por ficha\n */\nexport const getAccessByFicha = async (req, res) => {\n  try {\n    const { codigo } = req.params;\n    const filters = {\n      fecha_desde: req.query.fecha_desde,\n      fecha_hasta: req.query.fecha_hasta\n    };\n\n    const result = await CatalogService.getAccessByFicha(codigo, filters);\n\n    try {\n      await createSecurityLog({\n        tipo: 'generacion_reporte',\n        id_usuario: req.user?.id,\n        ip_address: req.ip,\n        user_agent: req.get('user-agent'),\n        accion: `Consulta de accesos por ficha: ${codigo}`,\n        detalles: { codigo, filters },\n        exito: true\n      });\n    } catch (logError) {\n      console.warn('Error creando log de seguridad (no crítico):', logError.message);\n    }\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error en getAccessByFicha:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Error al obtener accesos por ficha',\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\n    });\n  }\n};\n\n\n\n\n"
        }
    ]
}